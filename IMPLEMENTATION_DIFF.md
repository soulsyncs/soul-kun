# ソウルくん実装差分（設計書からの変更点）

このファイルには、設計書と異なる実装をした場合の変更点を詳細に記録します。
設計書の意図を尊重しつつ、技術的・運用的理由で変更した箇所を明確にします。

**最終更新:** 2026-01-19
**管理者:** Claude Code（自動記録）
**設計書バージョン:** v10.1.4

---

## 記録のルール

1. 設計書と異なる実装をした場合、必ず記録する
2. `[DIFF-XXX]` と番号を振る
3. 以下の情報を必ず含める:
   - **設計書の記載内容**
   - **実際の実装内容**
   - **変更理由（技術的）**
   - **変更理由（素人向け説明）**
   - **影響範囲**
   - **将来の対応方針**

---

## Phase 1-B: タスク検知・監視

### [DIFF-001] 実装フレームワークの変更

| 項目 | 内容 |
|------|------|
| **設計書** | FastAPI + Cloud Run + Alembic |
| **実装** | Flask + Cloud Functions（既存システム拡張） |
| **コミット** | `674f4d3` (2026-01-02) |

**設計書の記載内容:**
```
docs/05_phase_1b_task_detection.md より:
- FastAPIでREST API実装（GET /api/v1/tasks/overdue）
- Cloud Run でデプロイ
- Alembicでマイグレーション
```

**実際の実装内容:**
- 既存の `chatwork-webhook/main.py` を拡張（Flask）
- 既存の Cloud Functions をそのまま利用
- マイグレーションはSQL直接実行

**変更理由（技術的）:**
1. 既存システム（Phase 1, 2）がFlask + Cloud Functionsで稼働中
2. 新しいフレームワークへの移行はPhase 4で計画済み
3. 短期間での実装を優先し、既存基盤を活用

**変更理由（素人向け説明）:**
> すでに動いているシステムがあったので、それを拡張した方が早くて確実でした。
> 新しい仕組みに作り変えるのは、もっと大きな改修（Phase 4）のときにまとめてやります。
> 家のリフォームで例えると、台所だけ直したいのに家全体を建て替えるのは大変すぎる、という判断です。

**影響範囲:**
- API形式が異なる（REST API → Cloud Functions HTTP トリガー）
- コード構造が異なる（分離されたモジュール → 単一ファイル）

**将来の対応方針:**
- Phase 4開始前（2026年Q4）にFlask → FastAPI移行予定
- 移行時に設計書通りの構造に変更

---

### [DIFF-002] 同期スケジュールの変更

| 項目 | 内容 |
|------|------|
| **設計書** | 30分ごと |
| **実装** | 1時間ごと（v10.3.4で変更） |
| **コミット** | `ad89a04` (2026-01-18) |

**設計書の記載内容:**
```
CLAUDE.md 及び設計書より:
- Cloud Scheduler 30分ごと実行
- 全ルームからget_room_tasks()でタスク取得
```

**実際の実装内容:**
- Cloud Scheduler 1時間ごと実行
- 4時間ごとに`include_done=true`で完了タスクも同期

**変更理由（技術的）:**
1. ChatWork APIのレート制限（5リクエスト/秒）への対応
2. 68ルーム × 2リクエスト（タスク取得 + メンバー取得）= 136リクエスト
3. 30分間隔だとAPIエラーが頻発した

**変更理由（素人向け説明）:**
> ChatWorkには「1秒に5回まで」という制限があります。
> 30分ごとに全部のチャットルームをチェックすると、この制限に引っかかってエラーになりました。
> 1時間に1回にしたら安定して動くようになりました。
> タスクの同期が30分遅れても、実運用では問題ありませんでした。

**影響範囲:**
- 手動で追加されたタスクの検知が最大1時間遅延
- 期限変更の検知も同様に遅延

**将来の対応方針:**
- 問題なく運用できているため、現状維持
- リアルタイム性が必要な場合はWebhook連携を検討

---

### [DIFF-003] テーブル名の統合

| 項目 | 内容 |
|------|------|
| **設計書** | 複数テーブル（reminder_logs, task_escalations, task_overdue_reminders） |
| **実装** | 単一テーブル（notification_logs）に統合 |
| **コミット** | `39f9cf0` (2026-01-18) |

**設計書の記載内容:**
```
docs/05_phase_1b_task_detection.md より:
- 方法A: reminder_logs テーブル（タスク専用）
- 方法B: notification_logs テーブル（汎用、推奨）
```

**実際の実装内容:**
- `notification_logs`テーブルを採用（設計書の方法B）
- レガシーテーブル（task_overdue_reminders, task_escalations）からデータ移行
- 移行関数: `migrate_legacy_to_notification_logs()` (remind-tasks/main.py 3333-3426行)

**変更理由（技術的）:**
1. 設計書v10.1.4の推奨に従った
2. Phase 2.5（目標達成支援）、Phase C（会議リマインド）にも対応できる汎用設計
3. 将来の手戻りを防止

**変更理由（素人向け説明）:**
> タスクのリマインド記録、エスカレーション記録、将来の会議リマインド記録を
> 別々のテーブルに保存すると、管理が大変になります。
> 1つの「通知ログ」テーブルにまとめることで、後から機能を追加しやすくなりました。
> 設計書でも「こちらの方が良い」と書いてあったので、そちらを採用しました。

**影響範囲:**
- 二重送信防止ロジックが`notification_logs`を参照
- 既存の`task_overdue_reminders`、`task_escalations`テーブルは移行後も残存（互換性のため）

**将来の対応方針:**
- 移行完了後、レガシーテーブルは削除可能
- Phase 2.5, Phase Cでも同じテーブルを使用

---

### [DIFF-004] 管理部サマリーの表示形式

| 項目 | 内容 |
|------|------|
| **設計書** | 🟡1日超過/🟠3日超過/🔴1週間超過の3段階 |
| **実装** | ⚠️期限超過/🔴今日/🟡明日/🟢3日後の4段階 |
| **コミット** | `848169a` (2026-01-18) |

**設計書の記載内容:**
```
カズさんの要件より:
- 🟡 1日以上超過
- 🟠 3日以上超過
- 🔴 1週間以上超過
- 最後に合計: X件（1日超過: X件 / 3日超過: X件 / 1週間超過: X件）
```

**実際の実装内容:**
- 個人DM向け: 🔴今日期限/🟡明日期限/🟢3日後期限/⚠️期限超過
- 管理部向け: 3日以上超過のみ抽出、担当者別グループ化

**変更理由（技術的）:**
1. 個人向けと管理部向けで異なるニーズがある
2. 個人には「いつまでにやるか」が重要（期限ベース）
3. 管理部には「どれくらい遅れているか」が重要（超過日数ベース）

**変更理由（素人向け説明）:**
> 設計書では「遅れている日数」で色分けする予定でした。
> でも実際に使ってみると、担当者には「いつが期限か」の方が大事で、
> 管理部には「どれくらい遅れているか」が大事だとわかりました。
> なので、担当者向けと管理部向けで違う形式にしました。

**影響範囲:**
- 管理部への報告形式が設計書と異なる
- 合計サマリーの段階別集計が未実装

**将来の対応方針:**
- 次回対応で管理部向け報告を設計書形式に変更予定
- 🟡🟠🔴の3段階表示を追加実装

---

### [DIFF-005] リマインド送信先の変更

| 項目 | 内容 |
|------|------|
| **設計書** | タスクが作成されたルーム（グループチャット） |
| **実装** | 担当者の個人DM |
| **コミット** | `848169a` (2026-01-18) |

**設計書の記載内容:**
```
初期設計より:
- notification_room_id にリマインド送信
- NULLの場合は管理部ルーム
```

**実際の実装内容:**
- 担当者（assigned_to_account_id）のDMに送信
- グループチャットへの送信を廃止
- `get_direct_room(account_id)` で個人チャット取得

**変更理由（技術的）:**
1. グループチャットだと他のメンバーにも通知が見える
2. 担当者ごとにタスクを集約して1通で送信した方が効率的
3. DMの方がプライバシーが守られる

**変更理由（素人向け説明）:**
> 最初はチャットグループに「○○さん、タスクが遅れてますよ」と送る予定でした。
> でもそれだと、他の人にも「○○さんがタスク遅れてる」と見えてしまいます。
> 本人だけにこっそり教えた方が、本人も気まずくないし、対応しやすいです。
> なので、個人チャット（DM）に送るように変更しました。

**影響範囲:**
- `chatwork_tasks.notification_room_id`カラムは未使用
- DM取得できないユーザーは管理部に通知（フォールバック）

**将来の対応方針:**
- 現状維持（DMベースの方がユーザー体験が良い）
- notification_room_idカラムは将来削除検討

---

### [DIFF-006] タスク要約のAIモデル

| 項目 | 内容 |
|------|------|
| **設計書** | 記載なし（Phase 1-Bでは要約機能は含まれていない） |
| **実装** | v10.5.0でClaude Haiku → v10.9.0でGemini 2.0 Flash |
| **コミット** | `8e9b812`, `a3922ba` (2026-01-18) |

**設計書の記載内容:**
- タスク要約機能は設計書に含まれていない追加機能

**実際の実装内容:**
- v10.5.0: Claude Haiku API でタスク本文を15文字に要約
- v10.9.0: Gemini 2.0 Flash API に移行、40文字に拡大
- `generate_task_summary()` 関数で実装
- `chatwork_tasks.summary`カラムに保存

**変更理由（技術的）:**
1. ChatWorkのタスク本文は長くなりがち（メンション、引用、詳細説明）
2. リマインドメッセージを見やすくするために要約が必要
3. Gemini 2.0 Flashの方がコスト効率が良い

**変更理由（素人向け説明）:**
> ChatWorkのタスクって、説明が長いことが多いですよね。
> 「これやって」「了解です」みたいなやり取りも入っていたりします。
> それをそのままリマインドに載せると読みにくいので、
> AIに「何のタスクか」を短くまとめてもらうことにしました。
> 最初は15文字でしたが、短すぎたので40文字に増やしました。

**影響範囲:**
- 追加機能のため、既存機能への影響なし
- API呼び出しコストが発生

**将来の対応方針:**
- 継続運用、コスト監視
- 必要に応じてローカルLLMへの移行検討

---

### [DIFF-007] target_idの型変更

| 項目 | 内容 |
|------|------|
| **設計書** | UUID型 |
| **実装** | TEXT型（BIGINT互換） |
| **コミット** | `39f9cf0` (2026-01-18) |

**設計書の記載内容:**
```
docs/05_phase_1b_task_detection.md より:
sa.Column('target_id', postgresql.UUID(as_uuid=True), nullable=True)
```

**実際の実装内容:**
```python
# remind-tasks/main.py 3211行
sa.Column('target_id', BIGINT, nullable=True)  # ChatWork task_id用
```

**変更理由（技術的）:**
1. ChatWorkのtask_idはBIGINT型（整数）
2. UUIDに変換するとオーバーヘッドが発生
3. 既存の`chatwork_tasks.task_id`がBIGINT型で定義済み

**変更理由（素人向け説明）:**
> 設計書では「どのシステムでも使える汎用的なID」としてUUIDを使う予定でした。
> でもChatWorkのタスクIDは数字（123456789みたいな形式）なので、
> わざわざ変換するより、そのまま数字で保存した方がシンプルです。
> 将来、他のシステムと連携するときは、その時に考えます。

**影響範囲:**
- Phase 2.5, Phase Cで別の型のIDを使う場合は再検討が必要
- 現状のPhase 1-Bでは問題なし

**将来の対応方針:**
- Phase 2.5でgoal_idがUUID型の場合、target_idをTEXT型に変更検討
- または、target_id_uuid / target_id_int を別カラムで持つ

---

## Phase 3.5: 組織階層連携

### [DIFF-008] Phase 1との連携未実装

| 項目 | 内容 |
|------|------|
| **設計書** | タスク検索時に組織階層でアクセス制御 |
| **実装** | 組織階層APIは実装済み、タスク検索との連携なし |
| **コミット** | `5d48d0a` (2026-01-18) |

**設計書の記載内容:**
```
docs/04_api_and_security.md より:
- ユーザーの所属部署から閲覧可能範囲を動的計算
- compute_accessible_departments() でアクセス権限判定
```

**実際の実装内容:**
- FastAPI版 `api/app/api/v1/organizations.py` に組織階層API実装
- Flask版（chatwork-webhook, remind-tasks）との連携なし
- `chatwork_tasks`テーブルに`department_id`カラムなし

**変更理由（技術的）:**
1. FastAPI（新API）とFlask（既存）が分離されている
2. 連携には共通ライブラリ（lib/）の整備が必要
3. Phase 4の統合移行で一括対応予定

**変更理由（素人向け説明）:**
> 組織図の情報を管理する新しいシステム（FastAPI）と、
> タスクを管理する古いシステム（Flask）がまだつながっていません。
> 新旧のシステムをつなぐ作業は、大きな改修（Phase 4）で一緒にやります。
> 今は「組織図システムは動く」「タスクシステムは動く」という状態です。

**影響範囲:**
- タスク検索で階層セキュリティが効かない
- 全ユーザーが全タスクを検索可能（自分のタスクフィルタはある）

**将来の対応方針:**
1. chatwork_tasksに`organization_id`, `department_id`追加
2. lib/に組織階層判定の共通関数を追加
3. Flask版からも呼び出せるようにする

---

## 変更履歴

- 2026-01-19: 全面更新（DIFF-001〜DIFF-008を記録）
- 2026-01-18: ファイル作成

---

## 差分一覧（クイックリファレンス）

| ID | 項目 | 設計書 | 実装 | 優先度 |
|----|------|--------|------|--------|
| DIFF-001 | フレームワーク | FastAPI | Flask | 低（Phase 4で対応） |
| DIFF-002 | 同期間隔 | 30分 | 1時間 | 低（運用に問題なし） |
| DIFF-003 | テーブル名 | 複数 | notification_logs統合 | -（設計書推奨に従った） |
| DIFF-004 | 管理部サマリー形式 | 3段階表示 | 4段階表示 | **高**（次回対応） |
| DIFF-005 | リマインド送信先 | グループ | DM | 低（改善として維持） |
| DIFF-006 | タスク要約AI | なし | Gemini | -（追加機能） |
| DIFF-007 | target_id型 | UUID | BIGINT | 中（Phase 2.5で再検討） |
| DIFF-008 | Phase 3.5連携 | 実装 | 未実装 | **高**（Phase 4前に対応） |
