# 設計書鮮度管理ポリシー

**作成日:** 2026-01-30
**目的:** 設計書が常に最新・正確な状態を維持し、「設計書を見れば正しい」という信頼を確保する

---

## Document Contract（SoT宣言）

| 項目 | 内容 |
|------|------|
| **この文書の役割** | 設計書の鮮度管理ルールと検証方法を定義 |
| **書くこと** | 更新ルール、レビュースケジュール、鮮度検証方法 |
| **書かないこと** | 設計書の内容詳細（→各設計書）、廃止手順（→DESIGN_DEPRECATION_POLICY.md） |
| **SoT（この文書が正）** | 設計書鮮度管理の全ルール |
| **Owner** | Tech Lead（連絡先: #dev チャンネル） |
| **更新トリガー** | レビュープロセス変更時、鮮度問題発見時 |

---

## 1. なぜ鮮度管理が必要か

### 1.1 鮮度が低下すると何が起きるか

```
【鮮度が低い設計書】
設計書: 「Aの手順で実装する」
実装:    「Bの手順で実装されている」（設計書と乖離）
        ↓
新人開発者: 「設計書通りにAで実装しよう」
        ↓
バグ発生 / 既存機能と矛盾 / 手戻り
```

### 1.2 鮮度管理の目的

| 目的 | 効果 |
|------|------|
| **信頼性確保** | 設計書を見れば正しいという安心感 |
| **学習効率向上** | 新規参入者が迷わない |
| **バグ予防** | 古い設計を参照した実装ミス防止 |
| **知識の継承** | 暗黙知を形式知として維持 |

---

## 2. 設計書の分類と更新頻度

### 2.1 設計書の分類

| 分類 | 説明 | 例 |
|------|------|-----|
| **Tier 1: 憲法** | システムの根幹、めったに変わらない | CLAUDE.md |
| **Tier 2: 基盤設計** | アーキテクチャ、主要コンポーネント | 25章、03章、04章 |
| **Tier 3: 機能設計** | 個別機能の詳細 | 各機能の設計書 |
| **Tier 4: 運用** | 手順書、トラブルシューティング | OPERATIONS_RUNBOOK.md |

### 2.2 分類別の更新頻度目安

| 分類 | 更新頻度 | レビュー頻度 |
|------|---------|-------------|
| **Tier 1: 憲法** | 半年に1回程度 | 四半期 |
| **Tier 2: 基盤設計** | 月に1回程度 | 月次 |
| **Tier 3: 機能設計** | 機能変更時 | 月次 |
| **Tier 4: 運用** | インシデント後 | 月次 |

---

## 3. 更新ルール

### 3.1 更新タイミング

| トリガー | 対応 |
|---------|------|
| **実装が設計と異なった** | 設計書を更新（実装が正しい場合）or 実装を修正（設計が正しい場合） |
| **新機能追加** | FEATURE_ADDITION_FRAMEWORK.md に従って更新 |
| **バグ修正で仕様変更** | 関連する設計書を更新 |
| **外部環境の変化** | API仕様変更、依存ライブラリ更新など |

### 3.2 更新時の必須事項

#### Document Contractの維持

```markdown
## Document Contract（SoT宣言）

| 項目 | 内容 |
|------|------|
| **この文書の役割** | [この設計書の責務] |
| **書くこと** | [この設計書で定義すること] |
| **書かないこと** | [他の設計書に委譲すること] |
| **SoT（この文書が正）** | [この設計書が正となる範囲] |
| **Owner** | [責任者と連絡先] |
| **更新トリガー** | [いつ更新すべきか] |
```

#### 更新履歴の記録

```markdown
## 更新履歴

| 日付 | 変更内容 |
|------|---------|
| YYYY-MM-DD | [変更内容の簡潔な説明] |
```

### 3.3 更新禁止事項

| 禁止事項 | 理由 |
|---------|------|
| **SoTを無視して別の場所に書く** | 情報が分散し混乱 |
| **古い内容を残したまま新内容を追記** | どちらが正しいか不明 |
| **更新履歴を書かない** | いつ何が変わったか追えない |
| **Document Contractと矛盾する内容を書く** | 設計書の責務が曖昧になる |

---

## 4. 定期レビュー

### 4.1 レビュースケジュール

| 頻度 | 対象 | 担当 | 目的 |
|------|------|------|------|
| **週次** | PROGRESS.md | 開発者全員 | 進捗確認 |
| **月次** | Tier 2-4の設計書 | Tech Lead | 鮮度チェック |
| **四半期** | Tier 1（CLAUDE.md等） | CTO + Tech Lead | 方針確認 |
| **半年** | 全設計書 | 全員 | 棚卸し |

### 4.2 月次レビューのチェックリスト

```markdown
## 月次設計書レビュー（YYYY-MM）

### 対象設計書
- [ ] docs/03_database_design.md
- [ ] docs/04_api_and_security.md
- [ ] docs/25_llm_native_brain_architecture.md
- [ ] docs/OPERATIONS_RUNBOOK.md
- [ ] ...（Tier 2-4の全設計書）

### チェック項目
| # | チェック項目 | 結果 |
|---|-------------|------|
| 1 | 最終更新から3ヶ月以上経過していないか | ✅ / ⚠️ |
| 2 | 実装と設計書の内容が一致しているか | ✅ / ⚠️ |
| 3 | Document Contractが正しく記載されているか | ✅ / ⚠️ |
| 4 | 更新履歴が記録されているか | ✅ / ⚠️ |
| 5 | 他の設計書との矛盾がないか | ✅ / ⚠️ |

### 発見された問題
| # | 設計書 | 問題 | 対応 | 担当 | 期限 |
|---|--------|------|------|------|------|
| 1 | | | | | |

### 次回レビュー予定
- 日時: YYYY-MM-DD
- 担当: [担当者名]
```

### 4.3 四半期レビューの追加チェック

- [ ] CLAUDE.mdの「10の鉄則」は現在の実装に適合しているか
- [ ] 脳アーキテクチャの記述は最新か
- [ ] 権限レベルの定義は最新か
- [ ] 技術スタックの記載は最新か

### 4.4 半年レビュー（棚卸し）

- [ ] 全設計書を一覧化
- [ ] 不要な設計書を特定（→廃止ポリシーへ）
- [ ] 重複・矛盾を特定
- [ ] 次の半年の方針を決定

---

## 5. 鮮度検証方法

### 5.1 自動検証（CI/CD）

```yaml
# .github/workflows/doc-freshness.yml
name: Documentation Freshness Check

on:
  schedule:
    - cron: '0 9 1 * *'  # 毎月1日9時に実行
  workflow_dispatch:

jobs:
  check-freshness:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check last modified dates
        run: |
          echo "# 設計書鮮度レポート" > freshness-report.md
          echo "" >> freshness-report.md
          echo "| ファイル | 最終更新 | 経過日数 | 状態 |" >> freshness-report.md
          echo "|---------|---------|---------|------|" >> freshness-report.md

          for file in docs/*.md; do
            last_modified=$(git log -1 --format="%ci" -- "$file" | cut -d' ' -f1)
            days_ago=$(( ($(date +%s) - $(date -d "$last_modified" +%s)) / 86400 ))

            if [ $days_ago -gt 90 ]; then
              status="🔴 要確認"
            elif [ $days_ago -gt 60 ]; then
              status="🟡 注意"
            else
              status="✅ OK"
            fi

            echo "| $file | $last_modified | ${days_ago}日 | $status |" >> freshness-report.md
          done

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: freshness-report
          path: freshness-report.md
```

### 5.2 手動検証コマンド

```bash
# 設計書の最終更新日を確認
for file in docs/*.md; do
  echo "$file: $(git log -1 --format='%ci' -- $file)"
done

# 特定の設計書と実装の差分を確認
git diff HEAD~10 -- docs/25_llm_native_brain_architecture.md

# 設計書で参照されているファイルの存在確認
grep -oP '`[^`]+\.(py|ts|js)`' docs/*.md | while read -r line; do
  file=$(echo "$line" | grep -oP '`[^`]+`' | tr -d '`')
  if [ ! -f "$file" ]; then
    echo "⚠️ Not found: $file (referenced in $line)"
  fi
done
```

### 5.3 鮮度スコアの計算

| 指標 | 配点 | 計算方法 |
|------|------|---------|
| **更新日** | 40点 | 30日以内: 40点、60日以内: 30点、90日以内: 20点、それ以上: 0点 |
| **Document Contract有無** | 20点 | あり: 20点、なし: 0点 |
| **更新履歴有無** | 20点 | あり: 20点、なし: 0点 |
| **実装との一致** | 20点 | 一致: 20点、不一致: 0点 |

| 合計スコア | 評価 |
|-----------|------|
| 80-100 | ✅ 良好 |
| 60-79 | 🟡 要注意 |
| 0-59 | 🔴 要対応 |

---

## 6. 鮮度問題の対応フロー

### 6.1 問題発見時の対応

```
鮮度問題を発見
      ↓
【Step 1】問題の種類を特定
  - 内容が古い
  - 実装と乖離
  - Document Contract不備
  - 更新履歴不備
      ↓
【Step 2】影響範囲を確認
  - 他の設計書への影響
  - 実装への影響
      ↓
【Step 3】対応方針を決定
  - 設計書を更新
  - 実装を修正
  - 廃止を検討
      ↓
【Step 4】対応を実施
      ↓
【Step 5】PROGRESS.mdに記録
```

### 6.2 緊急度別の対応期限

| 緊急度 | 状況 | 対応期限 |
|--------|------|---------|
| **P0** | セキュリティ関連の乖離 | 即日 |
| **P1** | 本番影響のある乖離 | 3日以内 |
| **P2** | 開発効率に影響する乖離 | 1週間以内 |
| **P3** | 軽微な不整合 | 次回月次レビューまで |

---

## 7. 鮮度維持のベストプラクティス

### 7.1 実装時のルール

| ルール | 説明 |
|--------|------|
| **実装前に設計書を確認** | 古い設計を参照しないため |
| **実装後に設計書を更新** | PRに設計書更新を含める |
| **PRで設計書変更をレビュー** | 実装レビューと同時に |

### 7.2 設計書作成時のルール

| ルール | 説明 |
|--------|------|
| **Document Contractを必ず書く** | 責務を明確に |
| **更新履歴を必ず書く** | 変更追跡のため |
| **参照リンクを正確に** | デッドリンク防止 |
| **具体例を含める** | 理解しやすさのため |

### 7.3 チーム運用のルール

| ルール | 説明 |
|--------|------|
| **設計書変更はPRで管理** | レビュー必須 |
| **月次レビューを必ず実施** | 定期的な鮮度確認 |
| **乖離発見時は即報告** | #dev チャンネルで共有 |

---

## 8. 鮮度管理の記録

### 8.1 月次レビュー記録

| 年月 | レビュー日 | 担当 | 発見問題数 | 対応完了 |
|------|-----------|------|-----------|---------|
| 2026-02 | - | - | - | - |

### 8.2 鮮度問題対応記録

| # | 発見日 | 設計書 | 問題内容 | 対応 | 完了日 |
|---|--------|--------|---------|------|--------|
| - | - | - | - | - | - |

---

## 9. 関連ドキュメント

| ドキュメント | 参照内容 |
|-------------|---------|
| DESIGN_COVERAGE_MATRIX.md | SoT一覧、設計書マッピング |
| FEATURE_ADDITION_FRAMEWORK.md | 新機能追加時の設計書更新 |
| DESIGN_DEPRECATION_POLICY.md | 設計書の廃止方法 |
| TROUBLESHOOTING_FRAMEWORK.md | 設計書が古い場合の対処 |

---

## 更新履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-30 | 初版作成 |

---

**このファイルについての質問は、Tech Leadに連絡してください。**
