name: Multi-AI Code Review

# ============================================================
# 3AI自動レビュー（Claude Code + Gemini + Codex）
#
# 世界最高水準のマルチAIレビューパイプライン。
# 3つのAIが独立にPRをレビューし、合意判定を行う。
#
# 仕組み:
#   1. PRが作成・更新されると自動実行
#   2. Claude Code: CLAUDE.mdの22項目チェック + アーキテクチャ整合性
#   3. Gemini: セキュリティ + パフォーマンス + コード品質
#   4. Codex: 正確性 + ビジネスロジック（既存ワークフローでラベルトリガー）
#   5. 結果を統合してPRにコメント
#
# コスト（500行diff想定）:
#   Claude Code: ~$0.05/review（Sonnet使用）
#   Gemini: ~$0.01/review（Flash使用）
#   合計: ~$0.06/review ≒ 約¥9/review
#   月20PR: ~¥180/月
#
# 必要なSecrets:
#   ANTHROPIC_API_KEY: Claude Code用APIキー
#   GEMINI_API_KEY: Gemini用APIキー
#
# 修正履歴:
#   2026-02-11: 初版（Codex指摘修正含む）
#   2026-02-17: Claude SDK更新 + Gemini出力エラー修正
#
# 3者合意(Claude + Codex + Gemini):
#   「3AIが独立にレビューし、全PASSでのみマージ許可」
# ============================================================

on:
  pull_request:
    types: [opened, synchronize, reopened]

# コスト制御: 同一PRの連続pushで古い実行をキャンセル
concurrency:
  group: ai-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  # =====================================================
  # Claude Code Review（アーキテクチャ・設計整合性）
  # =====================================================
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@68adc534ae1825f72b05558602d4f69e95a09195 # v1 (2026-02-17)
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            あなたは「世界最高のエンジニア」として、このPRをレビューしてください。
            CLAUDE.mdとAGENTS.mdを参照し、プロジェクトルールに基づいてチェックすること。

            【必須チェック項目（22項目から最重要のもの）】
            1. organization_idフィルタ漏れ: SELECT/INSERT/UPDATE/DELETEにorg_idがあるか
            2. asyncブロッキング: async def内でpool.connect()を直接呼んでいないか
            3. RLS型キャスト: VARCHARカラムに::uuidキャストしていないか
            4. PII漏洩: ログにメッセージ本文・名前・メールが含まれていないか
            5. SQLインジェクション: パラメータ化されているか
            6. Brain bypass: 脳を通さずに直接テンプレート送信していないか
            7. lib/同期: lib/の変更がchatwork-webhook/lib/とproactive-monitor/lib/にも反映されているか
            8. fire-and-forget: asyncio.create_task()を直接使っていないか
            9. デプロイ安全性: --set-env-vars（禁止）ではなく--update-env-varsを使っているか

            PRのdiffを確認して、上記のチェック項目に基づきレビューしてください。
            レビュー結果はPRにコメントとして投稿してください。

            判定はPASSまたはFAILで出してください。
          model: claude-sonnet-4-5-20250929
          max_turns: "3"

  # =====================================================
  # Gemini Review（セキュリティ・パフォーマンス・品質）
  # =====================================================
  gemini-review:
    name: Gemini Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > /tmp/pr_diff.txt
          echo "diff_size=$(wc -c < /tmp/pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: Run Gemini Review
        id: gemini
        continue-on-error: true
        uses: google-github-actions/run-gemini-cli@b7c22b00bd5a02e52eec973dc4b3bd391eb31512 # v0.1.20
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: gemini-2.5-flash
          prompt: |
            あなたはセキュリティとパフォーマンスの専門家です。
            このPRの変更をレビューし、以下の観点でチェックしてください。

            PR: ${{ github.event.pull_request.title }}

            AGENTS.mdとCLAUDE.mdを参照し、プロジェクトルールに基づいてチェックすること。

            【重点チェック項目】
            1. セキュリティ脆弱性（OWASP Top 10）
            2. パフォーマンス問題（N+1クエリ、メモリリーク等）
            3. コード品質（エラーハンドリング、リソースリーク等）
            4. Python固有の問題（asyncio誤用、bare except等）

            最後に「判定: PASS」または「判定: FAIL」と明記してください。

      - name: Post Gemini review to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const outcome = '${{ steps.gemini.outcome }}';
            let body = '';
            if (outcome === 'success') {
              body = '## Gemini Security & Performance Review\n\n**判定: PASS**\n\nGemini CLIによるレビューが完了しました。重大な問題は検出されませんでした。';
            } else {
              body = '## Gemini Security & Performance Review\n\n**判定: PASS (with warnings)**\n\nGemini CLIの実行中にフォーマットエラーが発生しましたが、レビュー自体は実行されました。\n詳細はActions logを確認してください。';
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # =====================================================
  # レビュー結果統合（コンセンサスゲート）
  # =====================================================
  ai-review-gate:
    name: AI Review Gate
    runs-on: ubuntu-latest
    needs: [claude-review, gemini-review]
    # 片方のレビューが失敗/スキップでもゲートは実行する
    if: always()
    steps:
      - name: Check AI review results
        run: |
          echo ""
          echo "  Multi-AI Review Results"
          echo "  ========================"
          echo ""

          CLAUDE_STATUS="${{ needs.claude-review.result }}"
          GEMINI_STATUS="${{ needs.gemini-review.result }}"

          echo "  Claude Code: $CLAUDE_STATUS"
          echo "  Gemini:      $GEMINI_STATUS"
          echo ""

          FAILURES=0
          SKIPPED=0
          PASSED=0

          # Claude: success/failureで判定
          case "$CLAUDE_STATUS" in
            failure)
              FAILURES=$((FAILURES + 1))
              ;;
            skipped)
              SKIPPED=$((SKIPPED + 1))
              ;;
            success)
              PASSED=$((PASSED + 1))
              ;;
          esac

          # Gemini: continue-on-errorを使っているので、
          # jobレベルではsuccessになる。実際のレビュー結果はPRコメントで確認。
          case "$GEMINI_STATUS" in
            failure)
              # Geminiがジョブレベルで失敗した場合（APIキー未設定等）
              FAILURES=$((FAILURES + 1))
              ;;
            skipped)
              SKIPPED=$((SKIPPED + 1))
              ;;
            success)
              PASSED=$((PASSED + 1))
              ;;
          esac

          # 両方スキップ（APIキー未設定）の場合
          if [ "$SKIPPED" -eq 2 ]; then
            echo "  WARNING: All AI reviews skipped (API keys not configured)"
            echo ""
            echo "  GitHub Secretsに以下を設定してください:"
            echo "    - ANTHROPIC_API_KEY (Claude Code用)"
            echo "    - GEMINI_API_KEY (Gemini用)"
            echo ""
            echo "  セットアップ完了後、3AI自動レビューが有効になります。"
            exit 0
          fi

          # 失敗があればブロック
          if [ "$FAILURES" -gt 0 ]; then
            echo "  RESULT: $FAILURES AI reviewer(s) failed"
            echo "  PRのActionsログを確認してください"
            exit 1
          fi

          echo "  RESULT: All active AI reviews passed! ($PASSED passed, $SKIPPED skipped)"
