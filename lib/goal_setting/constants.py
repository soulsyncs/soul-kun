"""
目標設定対話フロー - 定数・テンプレート定義

全てのパターン定数、テンプレート、設定値を集約。
"""

import logging
import os

logger = logging.getLogger(__name__)

# LLM API設定
OPENROUTER_API_KEY = os.environ.get("OPENROUTER_API_KEY", "")
LLM_MODEL = "google/gemini-2.0-flash-001"
LLM_TIMEOUT = 30.0

# 長文の閾値（この文字数以上ならLLM解析を実行）
LONG_RESPONSE_THRESHOLD = 100

# 不満検出パターン
FRUSTRATION_PATTERNS = [
    "答えたじゃん", "答えたよ", "言ったじゃん", "言ったよ",
    "さっき言った", "もう言った", "既に答えた", "同じこと",
    "何回言えば", "繰り返し", "ちゃんと読んで", "聞いてる？"
]

# 確認OKパターン（LLM抽出後の確認に使用）
CONFIRMATION_PATTERNS = [
    "ok", "OK", "ｏｋ", "ＯＫ", "おっけー", "オッケー",
    "合ってる", "あってる", "その通り", "そのとおり",
    "うん", "はい", "いいよ", "大丈夫", "問題ない",
    "それで", "それでいい", "いいです", "オーケー"
]

# v10.40.1: 否定接続パターン（「合ってるけど」等を検出）
# これらが含まれる場合、肯定語があっても confirmed=False にする
BUT_CONNECTOR_PATTERNS = [
    "けど", "だけど", "けれど", "だけれど",
    "が、", "が，", "ただ、", "ただ，",
    "でも", "しかし", "一方で", "ただし",
    "んだけど", "んですけど", "のですが", "んですが",
]

# v10.40.1: フィードバック要求パターン（「評価して」等を検出）
# これらが含まれる場合、登録せずに導きの対話に入る
FEEDBACK_REQUEST_PATTERNS = [
    # 評価・フィードバック要求
    "フィードバック", "評価", "見て", "どう思う", "どうかな",
    "正しい", "合ってるか", "間違ってない", "これでいい？",
    "これでいい", "大丈夫？", "大丈夫かな", "いいの？",
    # 改善・アドバイス要求
    "改善", "アドバイス", "教えて", "どうすれば", "どうしたら",
    "足りない", "不足", "抜けて", "漏れて",
    # 分解・具体化要求
    "分解", "細かく", "具体的", "ブレイクダウン",
    "目先", "短期", "今月", "今週", "今日",
    # 確認・質問要求
    "わかる？", "わかります？", "伝わって", "理解して",
    "聞いて", "聞きたい", "質問", "相談",
]

# v10.40.2: 迷い・不安パターン（「不安」「自信ない」等を検出）
# これらが含まれる場合も、登録せずに導きの対話に入る
DOUBT_ANXIETY_PATTERNS = [
    # 不安・自信のなさ
    "不安", "自信ない", "自信がない", "自信なさそう",
    "違うかも", "間違ってるかも", "これじゃない",
    "わからない", "わかんない", "迷う", "迷って",
    # 曖昧・不確実
    "曖昧", "あいまい", "ぼんやり", "漠然",
    "ふわっと", "なんとなく", "適当",
    # v10.40.6: 微妙な反応も迷いとして検出
    "微妙", "うーん", "びみょう",
    # 心配・懸念
    "心配", "不十分", "足りてる？", "ちゃんとして",
]

# v10.40.3: 明示的リスタートパターン
# これらが含まれる場合のみ、セッションをリセットして最初から開始
RESTART_PATTERNS = [
    "もう一度", "最初から", "やり直", "リセット", "リスタート",
    "初めから", "はじめから", "仕切り直", "やりなおし",
    "新しく目標", "別の目標", "違う目標",
]

# WHY充足パターン（将来像・ありたい姿・動機）
WHY_FULFILLED_PATTERNS = [
    # ありたい姿
    "なりたい", "目指して", "目指す", "理想",
    # 動機・理由
    "ために", "だから", "したくて", "したいから",
    # ビジョン・将来
    "将来", "いつか", "ゆくゆく", "最終的に",
    # 価値観
    "大事", "大切", "重要", "意味がある",
    # 願望
    "〜ようになりたい", "できるようになりたい", "認められたい",
]

# WHAT充足パターン（テーマ・目標・成果）
WHAT_FULFILLED_PATTERNS = [
    # テーマ・領域
    "テーマ", "領域", "分野", "方向性",
    # 目標・ゴール
    "目標", "ゴール", "達成", "成果",
    # 数値・KPI
    "件", "万", "円", "%", "人", "回",
    # 期限
    "今月", "今週", "月末", "週末", "年末", "月次", "年次",
]

# HOW充足パターン（行動・習慣・頻度）
HOW_FULFILLED_PATTERNS = [
    # 頻度
    "毎日", "毎週", "毎朝", "毎晩", "週に", "日に",
    # 行動
    "やる", "する", "行う", "実践", "実行",
    # 習慣
    "習慣", "ルーティン", "継続", "続ける",
    # 具体的行動
    "電話", "訪問", "メール", "報告", "確認",
]


# =====================================================
# 定数定義
# =====================================================

# セッションステップ
STEPS = {
    "intro": "導入",
    "why": "WHY（内発的動機）",
    "what": "WHAT（結果目標）",
    "how": "HOW（行動目標）",
    "confirm": "確認",  # v10.31.5: LLM抽出後の確認ステップ
    "complete": "完了"
}

# ステップ遷移
STEP_ORDER = ["intro", "why", "what", "how", "complete"]

# 最大リトライ回数（同じステップでの再質問上限）
MAX_RETRY_COUNT = 3


# =====================================================
# 対話テンプレート
# =====================================================

TEMPLATES = {
    # 導入（アジェンダ提示 + WHYへ）
    "intro": """🎯 目標設定を始めるウル！

ソウルくんと一緒に、{user_name}さんの目標を整理していこうウル🐺

📋 これから3つの質問をするウル：
1️⃣ WHY - なぜその目標を達成したいのか
2️⃣ WHAT - 具体的に何を達成したいのか
3️⃣ HOW - どんな行動で達成するのか

それでは最初の質問ウル！

━━━━━━━━━━━━━━━━━━
❓ 【WHY】この先、仕事を通じてどんな自分になりたいですか？
━━━━━━━━━━━━━━━━━━

「〇〇な存在になりたい」「△△を実現したい」など、
{user_name}さんの想いを自由に教えてウル🐺✨""",

    # WHY完了 → WHAT質問
    "why_to_what": """💡 なるほどウル！

{feedback}

━━━━━━━━━━━━━━━━━━
❓ 【WHAT】その想いを実現するために、具体的にどんな成果を出したいですか？
━━━━━━━━━━━━━━━━━━

数字や期限を入れてくれると、進捗が追いやすくなるウル🐺
例：「今月の粗利300万円達成」「月末までにプロジェクト完了」""",

    # WHAT完了 → HOW質問
    "what_to_how": """👍 素晴らしい目標ウル！

{feedback}

━━━━━━━━━━━━━━━━━━
❓ 【HOW】その目標を達成するために、毎日・毎週どんな行動をしますか？
━━━━━━━━━━━━━━━━━━

「毎日〇〇をする」「週に△回□□をする」など、
具体的なアクションを教えてウル🐺""",

    # HOW完了 → 目標登録
    "complete": """🎉 目標設定完了ウル！

{user_name}さんの目標をまとめたウル🐺

━━━━━━━━━━━━━━━━━━
📌 WHY（なりたい姿）
{why_answer}

🎯 WHAT（結果目標）
{what_answer}

💪 HOW（行動目標）
{how_answer}
━━━━━━━━━━━━━━━━━━

✅ 目標を登録したウル！

{user_name}さんなら絶対達成できるって、ソウルくんは信じてるウル💪🐺
毎日17時に進捗を聞くから、一緒に頑張っていこうウル✨""",

    # v10.40.2: 導きの対話（目標の質チェック）
    # フィードバック要求や迷い・不安を検出した場合に使用
    "quality_check": """🐺 {user_name}さん、確認してくれてありがとうウル！

ソウルくんも一緒に考えさせてウル。

{quality_feedback}

━━━━━━━━━━━━━━━━━━
{quality_questions}
━━━━━━━━━━━━━━━━━━

📋 この方向で登録する？それとも調整する？
「OK」で登録、もしくは修正したい部分を教えてウル🐺✨""",

    # NG応答: 抽象的すぎる
    "ng_abstract": """🤔 もう少し具体的に教えてほしいウル！

「{user_answer}」という気持ちはとてもわかるウル🐺

でも、もう少し詳しく教えてくれると嬉しいウル！

例えば...
- いつまでに？
- どのくらい？
- 何を？

もう一度、具体的に教えてウル🐺✨""",

    # NG応答: 転職・副業志向
    "ng_career": """💭 いろんな可能性を考えているんだね！

{user_name}さんがキャリアについて真剣に考えているのは素晴らしいウル🐺

ところで、もし今の会社で「これが実現できたら最高だな」って思うことはあるかな？

会社の中で達成したいこと、成し遂げたいことを教えてほしいウル🐺✨""",

    # NG応答: 他責思考
    "ng_other_blame": """😊 大変な状況なんだね...

{user_name}さんの気持ち、よくわかるウル🐺
環境や周りの人に影響を受けることってあるよね。

でもね、ソウルくんは{user_name}さんの可能性を信じてるウル！

「自分でコントロールできること」で、変えていきたいことはあるかな？
{user_name}さん自身が行動できることを教えてほしいウル🐺✨""",

    # NG応答: 目標がない
    "ng_no_goal": """🌟 目標がないって感じること、あるよね！

でもね、{user_name}さんにも必ず「こうなったらいいな」って思うことがあるはずウル🐺

小さなことでも大丈夫ウル！
- 「もう少し〇〇ができるようになりたい」
- 「△△な仕事がしてみたい」
- 「□□を達成してみたい」

どんな小さなことでもいいから、教えてほしいウル🐺✨""",

    # NG応答: 目標が高すぎる
    "ng_too_high": """🚀 大きな目標を持ってるんだね！

{user_name}さんの志の高さ、素晴らしいウル🐺

ただ、まずは「最初の一歩」を考えてみない？

その大きな目標に向かって、今月達成できそうなマイルストーンは何かな？
小さな成功を積み重ねていこうウル🐺✨""",

    # NG応答: 結果目標と繋がらない
    "ng_not_connected": """🔗 ちょっと確認させてウル！

さっき教えてくれた結果目標は「{what_answer}」だったよね？

今の行動目標「{user_answer}」が、どう結果につながるか教えてほしいウル🐺

もし別の行動のほうが結果に直結しそうなら、それを教えてほしいウル✨""",

    # NG応答: メンタルヘルス懸念
    "ng_mental_health": """💙 {user_name}さん、大丈夫...？

ちょっと辛そうに見えるウル🐺

もし今しんどい状態なら、無理に目標を立てなくてもいいウル。
まずは自分の心と体を大事にしてほしいウル。

もしよかったら、上司や人事の人に相談してみてもいいかもウル。
ソウルくんはいつでも{user_name}さんの味方ウル🐺💙

目標設定は、元気な時にまたやろうウル✨""",

    # NG応答: プライベート目標のみ
    "ng_private_only": """🏃 素敵な目標ウル！

「{user_answer}」、プライベートを充実させるのは大事ウル🐺

ところで、お仕事の方でも何か達成したいことはあるかな？

プライベートと仕事、両方充実させていけたら最高ウル！
仕事での目標も教えてほしいウル🐺✨""",

    # =====================================================
    # v1.7 新規: ヘルプ・質問対応テンプレート
    # =====================================================

    # 質問への回答: WHYステップ
    "help_question_why": """📝 良い質問ウル！説明するね！

【WHY】は「どんな自分になりたいか」を聞いているウル🐺

例えばこんな感じ：
• 「チームを引っ張れるリーダーになりたい」
• 「お客様から指名される営業になりたい」
• 「後輩に頼られる先輩になりたい」
• 「この分野の第一人者として認められたい」

仕事を通じて、{user_name}さんがどんな姿を目指しているか、
自由に教えてほしいウル🐺✨""",

    # 質問への回答: WHATステップ
    "help_question_what": """📝 良い質問ウル！説明するね！

【WHAT】は「具体的に何を達成したいか」を聞いているウル🐺

例えばこんな感じ：
• 「今月の売上を300万円達成する」
• 「今月中に新規顧客を5件獲得する」
• 「月末までにプロジェクトを完了させる」
• 「今週中に提案書を3本作成する」

**数字や期限**を入れてくれると、進捗が追いやすくなるウル！
{user_name}さんが達成したい成果を教えてほしいウル🐺✨""",

    # 質問への回答: HOWステップ
    "help_question_how": """📝 良い質問ウル！説明するね！

【HOW】は「毎日・毎週どんな行動をするか」を聞いているウル🐺

例えばこんな感じ：
• 「毎日30分、見込み客にアプローチの電話をする」
• 「週に3回、お客様訪問をする」
• 「毎朝10分、業界ニュースをチェックする」
• 「毎日退勤前に翌日のタスクを整理する」

目標達成のために、{user_name}さんが**習慣にしたい行動**を教えてほしいウル🐺✨""",

    # 困惑・迷い: WHYステップ
    "help_confused_why": """🤔 迷っちゃうよね、わかるウル！

{user_name}さん、急に「どんな自分になりたい？」って聞かれても、
すぐに答えが出ないこともあるウル🐺

こんな風に考えてみてほしいウル：

1. **最近「やった！」と思えた瞬間**は何かな？
2. **「こうなれたらいいな」**と憧れる先輩や同僚はいるかな？
3. **1年後の自分**がどうなっていたら嬉しいかな？

小さなことでも大丈夫ウル！
{user_name}さんの気持ちを教えてほしいウル🐺✨""",

    # 困惑・迷い: WHATステップ
    "help_confused_what": """🤔 具体的な数字って、難しいよね！

{user_name}さん、大丈夫ウル！一緒に考えようウル🐺

さっき「{why_summary}」って教えてくれたよね。

その想いを叶えるために、今月やれそうなことを考えてみようウル：

• **数で測れること**: 〇件、〇人、〇回など
• **期限で測れること**: 〇日までに完了、〇月末までに提出など
• **達成度で測れること**: 〇%達成、〇点以上など

どれかピンとくるものはあるかな？🐺✨""",

    # 困惑・迷い: HOWステップ
    "help_confused_how": """🤔 行動目標、迷うよね！

{user_name}さん、一緒に考えようウル🐺

目標は「{what_summary}」だったよね。

これを達成するために、**毎日または毎週できる小さな行動**を考えてみようウル：

• **毎日5分でもできること**は何かな？
• **週に1回は必ずやること**は何かな？
• **習慣にしたいこと**は何かな？

大きな行動じゃなくて、**続けられる小さな行動**でOKウル🐺✨""",

    # 極端に短い回答
    "too_short": """🤔 もう少し詳しく教えてほしいウル！

「{user_answer}」だけだと、ソウルくんには{user_name}さんの気持ちが
よくわからないウル🐺

{step_guidance}

{user_name}さんの考えを、もう少し詳しく教えてほしいウル🐺✨""",

    # リトライ2回目用（少し優しいトーン）
    "retry_gentle": """😊 大丈夫、ゆっくり考えようウル！

{user_name}さん、焦らなくていいウル🐺

{step_hint}

どんな小さなことでもいいから、{user_name}さんの言葉で教えてほしいウル🐺✨""",

    # リトライ3回目用（受け入れ準備）
    "retry_accepting": """👍 {user_name}さんの気持ち、受け取ったウル！

「{user_answer}」という想い、大事にしようウル🐺

これでいいなら、このまま次に進もうウル！
もし変えたい場合は、もう一度教えてほしいウル🐺✨""",

    # v10.22.1 新規: セッション終了
    "exit": """👋 目標設定を終了するウル！

{user_name}さん、また目標を設定したくなったらいつでも声をかけてウル🐺✨

「目標を設定したい」と言ってくれたら、いつでも始められるウル！""",

    # =====================================================
    # v10.40.3: スマート質問（フェーズ自動判定用）
    # ユーザーの回答から既に分かっている情報を活かした質問
    # =====================================================

    # テーマが分かっている場合のWHAT質問（具体化に絞る）
    "smart_what_with_themes": """🎯 なるほど！{themes}に力を入れていくんだね！

ありがとうウル🐺

では、この中でまず**今月具体的に達成したい成果**を教えてほしいウル！

例えば：
• 「{theme_example}で〇〇を達成」
• 「〇件」「〇%」「〇日までに」など数字で

どれか1つでいいから、具体的に教えてウル🐺✨""",

    # 方向性が分かっている場合のHOW質問
    "smart_how_with_goal": """💪 「{goal}」を目指すんだね！素敵ウル🐺

あと少し！**毎日・毎週の具体的な行動**を教えてほしいウル！

例えば：
• 「毎日〇〇分」「週に〇回」
• 「毎朝〇〇をする」「帰宅前に〇〇」

どんな行動を習慣にするか、教えてウル🐺✨""",

    # 複数情報が一度に来た時の確認
    "smart_confirm_extracted": """🐺 {user_name}さん、ありがとうウル！

ソウルくんなりに整理してみたウル：

━━━━━━━━━━━━━━━━━━
🔥 【WHY - 想い】
{why_summary}

🎯 【WHAT - 目指すゴール】
{what_summary}

💪 【HOW - 具体的な行動】
{how_summary}
━━━━━━━━━━━━━━━━━━

{missing_message}""",
}


# =====================================================
# パターン検出キーワード
# =====================================================

PATTERN_KEYWORDS = {
    "ng_abstract": [
        "成長", "頑張る", "良くなりたい", "向上", "スキルアップ",
        "もっと", "いい感じ", "いろいろ", "なんとなく", "とりあえず"
    ],
    "ng_career": [
        "転職", "副業", "市場価値", "どこでも通用", "独立",
        "フリーランス", "起業", "他社", "辞め", "退職"
    ],
    "ng_other_blame": [
        "上司が", "会社が", "環境が", "せいで", "のせい",
        "評価してくれない", "わかってくれない", "認めてくれない",
        "教えてくれない", "やらせてくれない"
    ],
    "ng_no_goal": [
        "特にない", "今のまま", "考えてない",
        "ないです", "ありません", "思いつかない"
    ],
    "ng_mental_health": [
        "疲れた", "しんどい", "辛い", "やる気が出ない", "限界",
        "無理", "死にたい", "辞めたい", "消えたい", "もう嫌",
        "つらい", "きつい", "病んで", "鬱", "うつ"
    ],
    "ng_private_only": [
        "ダイエット", "趣味", "旅行", "痩せたい", "筋トレ",
        "資格", "プライベート", "休み", "休暇"
    ],
    # v1.7 新規: 質問・ヘルプ要求パターン
    "help_question": [
        "どうしたらいい", "どうすれば", "何を書けば", "どんなこと",
        "どういう", "どのような", "何を言えば", "何を答えれば",
        "例えば", "具体的には", "教えて"
    ],
    # v1.7 新規: 困惑・迷いパターン（全ステップ共通）
    "help_confused": [
        "わからない", "わかりません", "難しい", "迷う", "悩む",
        "考え中", "思いつかない", "ピンとこない", "イメージできない"
    ],
    # v10.22.1 新規: 終了・キャンセルパターン
    "exit": [
        "終了", "やめる", "やめたい", "キャンセル", "中止", "中断",
        "やっぱりいい", "また今度", "後で", "今日はいい", "ストップ"
    ],
}

# v1.7 新規: 極端に短い回答の閾値
LENGTH_THRESHOLDS = {
    "extremely_short": 5,   # 5文字未満は極端に短い
    "very_short": 10,       # 10文字未満は非常に短い
    "short": 20,            # 20文字未満は短い
    "adequate": 30,         # 30文字以上は適切
}

# v1.7 新規: ステップ別の期待キーワード
STEP_EXPECTED_KEYWORDS = {
    "why": {
        "positive": ["なりたい", "したい", "目指", "実現", "達成", "貢献"],
        "numeric": False,
        "deadline": False,
    },
    "what": {
        "positive": ["達成", "完了", "獲得", "増やす", "減らす", "改善"],
        "numeric": True,   # 数値目標が望ましい
        "deadline": True,  # 期限が望ましい
    },
    "how": {
        "positive": ["する", "やる", "行う", "実施", "毎日", "毎週", "週に", "日に"],
        "numeric": False,
        "deadline": False,
    },
}
