# P2/P3/P4/P5 品質改善レビュー (2026-02-22)

## P2: drive_routes.py async修正 — PASS

- 旧コードの W-5 (MIMEバイパスバグ) 修正確認: `if content_type and ...` → `if not content_type or ...` で空文字時も拒否
- asyncio.to_thread() 全4ヘルパー適用済み確認
- 詳細は `drive_routes_review.md` 参照

## P3: str(e) 外部出力修正 — PASS（残存WARNINGあり）

### 変更対象と確認結果

| ファイル | 変更 | 結果 |
|---------|------|------|
| `lib/capabilities/multimodal/base.py` | `str(e)` → `type(e).__name__` (VisionAPIClient.analyze_image) | PASS |
| `lib/capabilities/multimodal/exceptions.py` | wrap_multimodal_error/wrap_sync_multimodal_error の message/details から str(e) 除去 | PASS |
| `lib/capabilities/multimodal/audio_processor.py` | WhisperAPIClient, AudioProcessor.process() の str(e) → type(e).__name__ | PASS |
| `lib/bot_persona_memory.py` | ユーザー向け return dict の message/error から str(e) → type(e).__name__ | PASS |
| `lib/long_term_memory.py` | ユーザー向け return dict の message/error から str(e) → type(e).__name__ | PASS |

### 残存 WARNING (今回の変更スコープ外・pre-existing)

1. **内部ログの f-string {e}**: `bot_persona_memory.py` lines 535, 567, 614, 641, 758, 871, 918 と `long_term_memory.py` lines 80, 356, 424, 536 の `logger.error(f"... {e}")` は今回変更対象外。ユーザーに返す文字列ではなく内部ログのみなので鉄則#8違反ではないが、エラーメッセージがDB接続文字列等を含む可能性あり（INFO/ERROR レベル）。

2. **VisionAPIError/WhisperAPIError の details["original_error"] = str(original_error)**: `exceptions.py` lines 403, 636。これらは例外オブジェクト内部の`details`フィールドに残存。`to_dict()`で辞書化されるが、`to_user_message()`は`self.message`のみ返すため外部露出なし。`bypass_handlers.py`の呼び出し側も`except Exception`で`type(e).__name__`のみログに残すため漏洩経路なし。ただし将来`to_dict()`をAPIレスポンスに使う実装が加わると漏洩リスクあり。

## P4: PersonInfo.to_safe_dict() PII保護 — PASS

- `description` フィールドに `[REDACTED]` マスキングを追加（個人の経歴・説明文）
- `attributes` フィールドに `[REDACTED]` マスキングを追加（稼働スタイル・余力などフォームデータ）
- 3コピー同期: lib/, chatwork-webhook/lib/, proactive-monitor/lib/ 全て同一コミット `88e2f8f` で更新 — PASS
- `to_dict()` は変更なし（内部LLM用のため生データ保持・正しい設計）

## P5: 月次コストアラート重複防止 — PASS（設計WARNINGあり）

### 確認結果

- `ai_monthly_cost_summary.alert_80pct_sent_at / alert_100pct_sent_at`: db_schema.json に反映済み
- マイグレーションSQL: `ADD COLUMN IF NOT EXISTS` で冪等 — PASS
- ロールバックSQL: ファイル内コメントに記載あり — PASS
- organization_id フィルタ: SELECT/UPDATE ともに `WHERE organization_id = :org_id` あり — PASS
- パラメータ化SQL: バインドパラメータ使用 — PASS
- asyncio.to_thread(): `_query()`, `_update_80()`, `_update_100()` 全てto_thread経由 — PASS
- 100%アラート送信時に `alert_80pct_sent_at = COALESCE(alert_80pct_sent_at, NOW())` で80%フラグも立てる設計 — 正しい
- エラー時は `logger.warning(..., type(e).__name__)` でエラー情報なし — PASS

### WARNING: Race Condition (設計上の限界)

- SELECT（read alert_80pct_sent_at = NULL）→ ChatWork送信 → UPDATE（alert_80pct_sent_at = NOW()）の間に、並行実行（Schedulerが二重起動した場合）は重複送信しうる
- Cloud Schedulerは「--workers 1」の単一プロセスで、通常二重起動はしないため実用上は問題なし
- 完全に防ぐには `UPDATE ... WHERE alert_80pct_sent_at IS NULL RETURNING id` のCAS的更新が必要
- WARNING レベル（実用上問題ないが設計メモとして記録）

### SUGGESTION

- `_try_cost_budget_alert()` 内でローカル関数 `_update_80` / `_update_100` を2つ定義しているが、Python のクロージャで `pool`, `org_id`, `year_month` を参照するため問題なし
- RLS set_config が不在: `ai_monthly_cost_summary` テーブルへのSELECT/UPDATEで `set_config('app.current_organization_id', ...)` を呼んでいない。ただしproactive-monitor は RLS 適用外テーブルで動作（proactive-monitor の同期poolはRLS不使用パターンのため）— pre-existing

## P5 マイグレーション db_schema.json 更新確認

コミット `438aba4` で `db_schema.json` も同時に更新されている（P5 の変更セット内）。
