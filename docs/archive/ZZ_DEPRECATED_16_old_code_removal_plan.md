> ⚠️ **DEPRECATED - 参照禁止**
>
> このファイルはアーカイブされました。削除計画は実装完了済みです。
>
> | 理由 | 実装完了済み（計画が遂行された） |
> |------|------------------------------|
> | 日付 | 2026-01-30 |
>
> **👉 参照すべきファイル:** Git履歴で削除内容を確認

---

# 旧コード削除計画書

## 概要

本ドキュメントは、`chatwork-webhook/main.py` および関連ファイルから削除可能な旧コードを特定し、安全な削除順序を定義する。

### 現状
- **main.py**: 9,198行
- **handlers/**: 7ファイル（分割済みハンドラー）
- **削除対象推定行数**: 約1,500〜2,000行

### 削除の目的
1. コードの可読性・保守性向上
2. 脳アーキテクチャ（BrainIntegration）への完全移行
3. フォールバック実装の整理
4. 技術的負債の解消

---

## 1. 削除対象の詳細

### 1.1 USE_NEW_*_HANDLER フラグ関連（Phase 1で削除）

| 対象 | 行番号 | 推定行数 | 優先度 |
|------|--------|----------|--------|
| USE_NEW_PROPOSAL_HANDLER | 223-242 | 20行 | 高 |
| USE_NEW_MEMORY_HANDLER | 244-263 | 20行 | 高 |
| USE_NEW_TASK_HANDLER | 265-284 | 20行 | 高 |
| USE_NEW_OVERDUE_HANDLER | 286-306 | 21行 | 高 |
| USE_NEW_GOAL_HANDLER | 308-328 | 21行 | 高 |
| USE_NEW_KNOWLEDGE_HANDLER | 330-350 | 21行 | 高 |
| USE_ANNOUNCEMENT_FEATURE | 352-370 | 19行 | 高 |

**計: 約142行**

**削除条件**:
- v10.32.0で「ハンドラー必須化」が完了済み
- 各ハンドラーが正常動作していることを確認済み

**削除後の影響**:
- ハンドラーが常に使用される
- 環境変数によるフォールバック切り替え不可（不要）
- フラグ参照箇所（2626, 2644, 2663, 2678, 5248, 7275行付近）も同時に削除

---

### 1.2 ハンドラー初期化時のフラグチェック（Phase 1で削除）

| 対象 | 行番号 | 推定行数 |
|------|--------|----------|
| _task_handler初期化のフラグチェック | 2626-2630 | 5行 |
| _overdue_handler初期化のフラグチェック | 2644-2650 | 7行 |
| _goal_handler初期化のフラグチェック | 2663-2670 | 8行 |
| _knowledge_handler初期化のフラグチェック | 2678-2690 | 13行 |
| _memory_handler初期化のフラグチェック | 5248-5260 | 13行 |
| _proposal_handler初期化のフラグチェック | 7275-7285 | 11行 |

**計: 約57行**

---

### 1.3 ai_commander() 旧AI司令塔（Phase 2で削除）

| 対象 | 行番号 | 推定行数 | 依存関係 |
|------|--------|----------|----------|
| ai_commander() | 5337-5533 | 約197行 | フォールバック関数で使用 |

**削除条件**:
- BrainIntegrationが100%稼働
- フォールバック処理（6074-6099行）が不要になった後

**注意**:
- 6088行で `ai_commander()` がフォールバック関数内で呼ばれている
- 脳アーキテクチャへの完全移行後に削除

---

### 1.4 execute_action() のレガシーフォールバック（Phase 2で削除）

| 対象 | 行番号 | 推定行数 |
|------|--------|----------|
| add_task フォールバック | 5594-5599 | 6行 |
| list_tasks フォールバック | 5601-5609 | 9行 |
| complete_task フォールバック | 5611-5619 | 9行 |
| delete_task フォールバック | 5621-5629 | 9行 |

**計: 約33行**

**削除条件**:
- SYSTEM_CAPABILITIESベースの動的実行が全アクションをカバー
- レガシーアクション（add_task, list_tasks等）が完全に使われていない

---

### 1.5 get_ai_response() 多言語対応（Phase 3で検討）

| 対象 | 行番号 | 推定行数 | 状態 |
|------|--------|----------|------|
| get_ai_response() | 5635-5829 | 約195行 | 要検討 |

**注意**:
- 脳アーキテクチャでも使用している可能性がある
- 削除前に依存関係を詳細調査
- 削除ではなくリファクタリング（脳への統合）が適切

---

### 1.6 バイパスルート（Phase 3以降で検討）

| 対象 | 行番号 | 推定行数 | 状態 |
|------|--------|----------|------|
| match_local_command() | 615-628 | 14行 | 要検討 |
| execute_local_command() | 4783-4843 | 61行 | 要検討 |
| LOCAL_COMMAND_PATTERNS | 別途確認 | 約50行 | 要検討 |

**計: 約125行**

**注意**:
- ローカルコマンドは脳をバイパスして直接処理する設計
- 「承認 123」「設定：キー=値」等の明確なコマンドに対応
- 削除ではなく、脳経由にリファクタリングする選択肢もある
- Phase 3以降で判断

---

### 1.7 main.pyに残る重複関数（Phase 1で削除）

handlers/に分割済みだが、main.pyにラッパー関数として残っているもの:

| 対象 | 行番号 | 推定行数 | ハンドラー |
|------|--------|----------|-----------|
| report_proposal_to_admin() | 4846-4860 | 15行 | proposal_handler.py |
| notify_proposal_result() | 4863-4876 | 14行 | proposal_handler.py |
| handle_query_company_knowledge() | 5012-5030+ | 約150行 | knowledge_handler.py |
| search_legacy_knowledge() | 7124-7200 | 77行 | knowledge_handler.py |
| integrated_knowledge_search() | 7066-7120 | 55行 | knowledge_handler.py |

**計: 約311行**

**削除条件**:
- 呼び出し元がハンドラーを直接参照するように変更済み
- 後方互換性が不要

---

### 1.8 フォールバック用インポート（Phase 1で削除）

| 対象 | 行番号 | 推定行数 |
|------|--------|----------|
| lib/admin_config.pyフォールバック | 36-42 | 7行 |
| lib/db.pyフォールバック | 51-57 | 7行 |
| utils/date_utils.pyフォールバック | 185-191 | 7行 |
| utils/chatwork_utils.pyフォールバック | 214-220 | 7行 |

**計: 約28行**

---

## 2. handlers/ 配下の分析結果

| ファイル | 行数 | フォールバック | 状態 |
|----------|------|----------------|------|
| proposal_handler.py | 640行 | なし | ✅ 完全 |
| memory_handler.py | 303行 | なし | ✅ 完全 |
| task_handler.py | 494行 | 内部のみ（_fallback_truncate）| ✅ 問題なし |
| overdue_handler.py | 934行 | 営業日判定のみ | ✅ 問題なし |
| goal_handler.py | 552行 | なし | ✅ 完全 |
| knowledge_handler.py | 1047行 | なし | ✅ 完全 |
| announcement_handler.py | 大 | 未確認 | 🔍 要確認 |

**結論**: handlers/配下は削除対象なし。main.pyからの呼び出しを整理するのみ。

---

## 3. 削除順序（依存関係を考慮）

### Phase 1: 即時削除可能（低リスク）

**優先度: 高 / リスク: 低**

1. **USE_NEW_*_HANDLER フラグ関連** (142行)
   - 環境変数チェックとインポート部分
   - フラグ参照箇所も同時に削除

2. **ハンドラー初期化時のフラグチェック** (57行)

3. **重複関数のラッパー削除** (311行)
   - 呼び出し元をハンドラー直接参照に変更
   - ラッパー関数を削除

4. **フォールバック用インポート** (28行)

**Phase 1 合計: 約538行削除**

---

### Phase 2: 脳アーキテクチャ移行後（中リスク）

**優先度: 中 / リスク: 中**

**前提条件**: BrainIntegrationが本番で100%稼働、フォールバック不要

1. **ai_commander()** (197行)
2. **execute_action() のレガシーフォールバック** (33行)
3. **フォールバック関数定義** (6074-6099行、26行)

**Phase 2 合計: 約256行削除**

---

### Phase 3: 将来検討（要設計判断）

**優先度: 低 / リスク: 要検討**

1. **get_ai_response()** → 脳への統合または維持
2. **ローカルコマンド** → 脳経由にリファクタリングまたは維持
3. **SYSTEM_CAPABILITIES** → 脳のSkill定義への移行検討

**Phase 3 合計: 要設計判断**

---

## 4. 削除後の推定行数

| フェーズ | 削除行数 | 残行数 |
|----------|----------|--------|
| 現状 | - | 9,198行 |
| Phase 1後 | -538行 | 約8,660行 |
| Phase 2後 | -256行 | 約8,404行 |
| Phase 3後 | 要検討 | 約7,500〜8,000行 |

---

## 5. リスク評価

### 低リスク（Phase 1）
- ハンドラーは既に本番稼働中
- フラグはすべてデフォルトでtrue
- テストカバレッジで検証可能

### 中リスク（Phase 2）
- ai_commander()はフォールバックで使用中
- 脳アーキテクチャの安定性に依存
- 段階的ロールアウト完了後に実施

### 要検討（Phase 3）
- ローカルコマンドは即座応答のUX
- get_ai_response()は多言語対応の中核
- 設計判断が必要

---

## 6. 実行手順チェックリスト

### Phase 1 実行前
- [ ] 全USE_NEW_*_HANDLERフラグがtrueで動作していることを確認
- [ ] handlers/の各ハンドラーが正常動作していることをテスト
- [ ] 呼び出し元がハンドラーを直接参照するよう変更
- [ ] CI/CDパイプラインが通ることを確認

### Phase 1 実行
- [ ] フラグ関連コードを削除
- [ ] 重複関数を削除
- [ ] インポートフォールバックを削除
- [ ] テスト実行
- [ ] PR作成・レビュー
- [ ] ステージング環境で検証
- [ ] 本番デプロイ

### Phase 2 実行前
- [ ] BrainIntegrationが100%稼働していることを確認
- [ ] フォールバック呼び出しが0件であることをログで確認
- [ ] 段階的ロールアウトが完了していること

### Phase 2 実行
- [ ] ai_commander()を削除
- [ ] execute_action()のレガシーフォールバックを削除
- [ ] フォールバック関数定義を削除
- [ ] テスト実行
- [ ] PR作成・レビュー

---

## 7. 補足: 削除しないコード

以下は削除対象外:

1. **SYSTEM_CAPABILITIES** - AI司令塔の機能カタログ、脳でも参照
2. **HANDLERS** - ハンドラーマッピング、脳でも参照
3. **LOCAL_COMMAND_PATTERNS** - ローカルコマンドパターン（Phase 3で検討）
4. **MVV関連コード** - 組織論的行動指針、削除不可
5. **lib/brain/配下** - 脳アーキテクチャ本体、別作業

---

## 更新履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2026-01-27 | v1.0 | 初版作成 |
