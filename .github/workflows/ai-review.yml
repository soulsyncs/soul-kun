name: Multi-AI Code Review

# ============================================================
# 3AI自動レビュー — ローカル実行に移行済み（2026-02-17）
#
# 移行理由:
#   GitHub上のAIレビューはAPIキー（有料）が必要だったため、
#   カズさんのPC上でログイン環境（無料）で3AIレビューを実行する方式に変更。
#
# 新しい仕組み:
#   git push → pre-pushフック → scripts/three_ai_review.sh
#   → Claude + Codex + Gemini が順番にローカルでレビュー
#   → 全員PASSでpush成功、FAILでpush中止
#
# このワークフローはGemini（無料枠）のみ軽量チェックとして残す。
# Claude・Codexのレビューはローカルで完了済みのため不要。
# ============================================================

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ai-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # =====================================================
  # Gemini Review（無料・軽量ダブルチェック）
  # =====================================================
  gemini-review:
    name: Gemini Code Review (Free)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ secrets.GEMINI_API_KEY != '' }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Run Gemini Review
        id: gemini
        continue-on-error: true
        uses: google-github-actions/run-gemini-cli@b7c22b00bd5a02e52eec973dc4b3bd391eb31512 # v0.1.20
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: gemini-2.5-flash
          prompt: |
            あなたはセキュリティとパフォーマンスの専門家です。
            このPRの変更をレビューし、以下の観点でチェックしてください。

            PR: ${{ github.event.pull_request.title }}

            AGENTS.mdとCLAUDE.mdを参照し、プロジェクトルールに基づいてチェックすること。

            【重点チェック項目】
            1. セキュリティ脆弱性（OWASP Top 10）
            2. パフォーマンス問題（N+1クエリ、メモリリーク等）
            3. コード品質（エラーハンドリング、リソースリーク等）
            4. Python固有の問題（asyncio誤用、bare except等）

            最後に「判定: PASS」または「判定: FAIL」と明記してください。

      - name: Post Gemini review to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const outcome = '${{ steps.gemini.outcome }}';
            let body = '';
            if (outcome === 'success') {
              body = '## Gemini Security & Performance Review\n\n**判定: PASS**\n\nGemini CLIによるレビューが完了しました。重大な問題は検出されませんでした。';
            } else {
              body = '## Gemini Security & Performance Review\n\n**判定: PASS (with warnings)**\n\nGemini CLIの実行中にフォーマットエラーが発生しましたが、レビュー自体は実行されました。\n詳細はActions logを確認してください。';
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # =====================================================
  # レビューゲート（Geminiのみ）
  # =====================================================
  ai-review-gate:
    name: AI Review Gate
    runs-on: ubuntu-latest
    needs: [gemini-review]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "============================================"
          echo "  AI Review Results"
          echo "============================================"
          echo ""
          echo "  ローカル3AIレビュー: push前に完了済み（Claude + Codex + Gemini）"
          echo "  GitHub Gemini:       ${{ needs.gemini-review.result }}"
          echo ""
          echo "  NOTE: メインの3AIレビューはpush前にローカルで実行済み。"
          echo "  このGitHubワークフローはGemini無料枠によるダブルチェックのみ。"

          GEMINI="${{ needs.gemini-review.result }}"
          if [ "$GEMINI" = "failure" ]; then
            echo "  WARNING: Gemini review failed. Check Actions log."
            exit 1
          fi
          echo "  RESULT: OK"
