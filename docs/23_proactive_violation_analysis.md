# Proactive Monitor CLAUDE.md違反 原因追求・再発防止策

**作成日:** 2026-01-29
**作成者:** Claude Code
**ステータス:** 確定

---

## 1. 事象の概要

### 1.1 何が起きたか

Proactive Monitor（Phase 2K）を本番有効化（`PROACTIVE_DRY_RUN=false`）した際、
CLAUDE.mdの「脳の7つの鉄則」に違反していることが判明した。

| 項目 | 内容 |
|------|------|
| 発見日時 | 2026-01-29 12:40頃 |
| 発見者 | カズさん |
| 影響 | 本番有効化から約10分後にドライランに戻した |
| 実害 | なし（トリガー検出0件だったため、メッセージは送信されなかった） |

### 1.2 違反していた鉄則

| 鉄則 | 内容 | 違反詳細 |
|------|------|---------|
| **3** | 脳が判断、機能は実行 | ProactiveMonitor自身が「何を送るか」を判断 |
| **2** | 脳は全記憶にアクセス | 記憶（過去の会話、ユーザーの好み）を参照していない |
| **5** | 確認が必要かは脳が決める | 送るべきかの最終判断を脳が行っていない |

---

## 2. 根本原因分析（5 Whys）

### Why 1: なぜProactive Monitorは脳を経由していなかったか？

**→ 設計書（docs/19_ultimate_brain_architecture.md）の4.2.3節で、脳を経由しない設計になっていたため**

```python
# 設計書のコード例（問題のあるコード）
class ProactiveMonitor:
    async def check_and_act(self):
        for user in users:
            triggers = await self._check_triggers(user)
            for trigger in triggers:
                if self._should_act(trigger, user):
                    await self._send_proactive_message(user, trigger)  # ← 脳を経由していない
```

### Why 2: なぜ設計書で脳を経由しない設計になっていたか？

**→ 「能動的モニタリング」を「Background」として別枠で設計し、メインの処理フローに組み込まなかったため**

設計書のアーキテクチャ図：
```
ユーザーメッセージ → Layer 0 → Layer 1 → ... → Layer 5 → 応答

Background: 能動的モニタリング（← 別枠扱い）
├── 定期チェック
├── パターン検出
└── 自発的アクション
```

「Background」という位置づけにより、「メインの処理フロー（脳）」とは別物という認識になった。

### Why 3: なぜ「Background」として別枠にしたか？

**→ 「ユーザーからの入力」と「システムからの出力」を異なるものと解釈したため**

CLAUDE.mdの鉄則1は「全入力は脳を通る」と記載されているが、
Proactive Monitorは「入力」ではなく「出力」（システムから能動的に送信）だと解釈した。

### Why 4: なぜその解釈が許容されたか？

**→ CLAUDE.mdに「出力」についての明示的なルールがなかったため**

現行のCLAUDE.md（抜粋）：
```markdown
| 1 | **全入力は脳を通る** | 例外なし。バイパス禁止。 |
```

「入力」のみ言及しており、「出力」（能動的メッセージ）については言及なし。

### Why 5: なぜCLAUDE.mdに「出力」についての記載がなかったか？

**→ 脳アーキテクチャ設計時（2026-01-26）に、能動的出力のユースケースを想定していなかったため**

脳アーキテクチャは「ユーザーからのメッセージを受けて応答する」パターンを主眼に設計された。
「システムが自発的にメッセージを送る」パターンは後から追加されたPhase 2K（2026-01-27）で初めて登場した。

---

## 3. 根本原因のまとめ

```
┌─────────────────────────────────────────────────────────────────────┐
│ 根本原因: 設計段階での見落とし                                      │
│                                                                     │
│ 1. CLAUDE.mdが「入力」のみ言及し、「出力」について明示していなかった │
│ 2. 設計書で「能動的モニタリング」を「Background」として別枠扱いした  │
│ 3. 設計レビュー時にCLAUDE.md鉄則との整合性チェックを行わなかった     │
└─────────────────────────────────────────────────────────────────────┘
```

**責任**: 設計を行った私（Claude Code）の見落とし。
設計時にCLAUDE.mdの鉄則を「精神」として理解せず、「文言」として解釈してしまった。

---

## 4. 再発防止策

### 4.1 CLAUDE.mdの改善（即時対応）

**変更前:**
```markdown
| 1 | **全入力は脳を通る** | 例外なし。バイパス禁止。 |
```

**変更後:**
```markdown
| 1 | **全入力は脳を通る** | 例外なし。バイパス禁止。 |
| 1b | **能動的出力も脳が生成** | システムが自発的に送るメッセージも脳が判断・生成する |
```

### 4.2 設計書テンプレートの改善（中期対応）

新機能の設計書には以下のセクションを必須化：

```markdown
## CLAUDE.md鉄則チェック

| 鉄則 | チェック | 準拠方法 |
|------|---------|---------|
| 1. 全入力は脳を通る | ✅/❌ | [どう準拠するか記載] |
| 1b. 能動的出力も脳が生成 | ✅/❌ | [どう準拠するか記載] |
| 2. 脳は全記憶にアクセス | ✅/❌ | [どう準拠するか記載] |
| 3. 脳が判断、機能は実行 | ✅/❌ | [どう準拠するか記載] |
| 4. 機能追加で脳構造は変えない | ✅/❌ | [どう準拠するか記載] |
| 5. 確認が必要かは脳が決める | ✅/❌ | [どう準拠するか記載] |
| 6. 状態管理は脳が統一管理 | ✅/❌ | [どう準拠するか記載] |
| 7. 速度より正確性を優先 | ✅/❌ | [どう準拠するか記載] |
```

### 4.3 実装前チェックリスト（即時対応）

本番有効化前に以下を確認：

```markdown
## 本番有効化チェックリスト

### CLAUDE.md準拠
- [ ] 全ての入力は脳を通っているか？
- [ ] 全ての能動的出力は脳が生成しているか？
- [ ] 脳が記憶（過去の会話、ユーザーの好み）を参照しているか？
- [ ] 機能は「実行」のみで、「判断」は脳が行っているか？
- [ ] 脳の構造を変更せず、機能カタログ追加のみで対応しているか？

### テスト
- [ ] 単体テストが全てパスしているか？
- [ ] 統合テストが全てパスしているか？
- [ ] ドライランで動作確認したか？
```

### 4.4 アーキテクチャ原則の明文化（中期対応）

CLAUDE.mdに以下を追加：

```markdown
## 脳を経由すべきケース

| ケース | 説明 | 例 |
|--------|------|-----|
| ユーザーからの入力 | メッセージ、コマンド | 「タスク追加して」 |
| 能動的出力 | システムが自発的に送るメッセージ | Proactive Monitorの声かけ |
| 定期処理の通知 | スケジュールされた通知 | リマインダー、日報 |
| エラー通知 | システムエラーの通知 | 「〇〇でエラーが発生しました」 |

**原則**: ユーザーに届くすべてのメッセージは、脳が生成または承認する。
```

---

## 5. 是正措置

### 5.1 即時対応（完了）

| 対応 | 状態 | 詳細 |
|------|------|------|
| ドライランに戻す | ✅ 完了 | proactive-monitor-00022-sul |
| 脳統合設計書作成 | ✅ 完了 | docs/22_proactive_brain_integration.md |
| 原因追求・再発防止策 | ✅ 完了 | 本文書 |

### 5.2 短期対応（今回実施）

| 対応 | 状態 | 詳細 |
|------|------|------|
| CLAUDE.md改善 | 🔧 実施中 | 鉄則1bを追加 |
| 脳統合実装 | 🔧 実施中 | SoulkunBrain.generate_proactive_message() |
| テスト作成 | 未着手 | 脳統合のテスト |

### 5.3 中期対応（今後）

| 対応 | 状態 | 詳細 |
|------|------|------|
| 設計書テンプレート改善 | 未着手 | CLAUDE.md鉄則チェックセクション追加 |
| 既存設計書の見直し | 未着手 | 他に同様の違反がないか確認 |

---

## 6. 教訓

1. **ルールは「精神」で理解する**: 「入力」と書いてあっても、本質は「ユーザーとのすべての接点で脳が介在する」こと
2. **新パターンは要注意**: 既存設計に想定されていないパターン（能動的出力）は、原則に立ち返って検討する
3. **設計レビューにチェックリスト**: CLAUDE.md鉄則との整合性を明示的にチェックする

---

## 7. 承認

| 役割 | 名前 | 日付 | 承認 |
|------|------|------|------|
| 作成者 | Claude Code | 2026-01-29 | ✅ |
| レビュー | カズさん | - | 未 |
