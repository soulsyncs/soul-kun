"""
Phase 2E: 学習基盤 - 定数定義

設計書: docs/18_phase2e_learning_foundation.md v1.1.0
"""

from enum import Enum
from typing import Dict, List, Set


# ============================================================================
# 学習カテゴリ
# ============================================================================

class LearningCategory(str, Enum):
    """学習カテゴリ（8種）"""
    ALIAS = "alias"              # 別名・略称
    PREFERENCE = "preference"    # 好み・やり方
    FACT = "fact"                # 事実・情報
    RULE = "rule"                # ルール・決まり
    CORRECTION = "correction"    # 間違いの修正
    CONTEXT = "context"          # 文脈・背景
    RELATIONSHIP = "relationship"  # 人間関係
    PROCEDURE = "procedure"      # 手順・やり方


# ============================================================================
# 学習スコープ
# ============================================================================

class LearningScope(str, Enum):
    """学習スコープ（4種）"""
    GLOBAL = "global"        # 全員に適用
    USER = "user"            # 特定ユーザーのみ
    ROOM = "room"            # 特定ルームのみ
    TEMPORARY = "temporary"  # 期間限定


# ============================================================================
# 権限レベル（Phase 2D連携）
# ============================================================================

class AuthorityLevel(str, Enum):
    """権限レベル（4段階）

    優先度: CEO > MANAGER > USER > SYSTEM
    """
    CEO = "ceo"          # CEOからの教え（最高優先度）
    MANAGER = "manager"  # 管理職からの教え
    USER = "user"        # 一般ユーザーからの教え
    SYSTEM = "system"    # システム自動学習（Phase 2F）


# 権限レベルの優先度マップ（数値が小さいほど高優先）
AUTHORITY_PRIORITY: Dict[str, int] = {
    AuthorityLevel.CEO.value: 1,
    AuthorityLevel.MANAGER.value: 2,
    AuthorityLevel.USER.value: 3,
    AuthorityLevel.SYSTEM.value: 4,
}


# ============================================================================
# トリガータイプ
# ============================================================================

class TriggerType(str, Enum):
    """トリガータイプ（4種）"""
    KEYWORD = "keyword"  # キーワード一致
    PATTERN = "pattern"  # 正規表現パターン
    CONTEXT = "context"  # 文脈条件
    ALWAYS = "always"    # 常に適用


# ============================================================================
# 関係タイプ（Phase 2G準備）
# ============================================================================

class RelationshipType(str, Enum):
    """学習間の関係タイプ"""
    IMPLIES = "implies"          # 含意（A→B）
    CONTRADICTS = "contradicts"  # 矛盾（A⇔B）
    EXTENDS = "extends"          # 拡張（AはBの詳細）
    SPECIALIZES = "specializes"  # 特殊化（AはBの特殊ケース）


# ============================================================================
# 判断影響度（Phase 2N準備）
# ============================================================================

class DecisionImpact(str, Enum):
    """判断への影響度"""
    POSITIVE = "positive"  # 良い判断につながった
    NEGATIVE = "negative"  # 悪い判断につながった
    NEUTRAL = "neutral"    # 影響なし


# ============================================================================
# 矛盾解決戦略
# ============================================================================

class ConflictResolutionStrategy(str, Enum):
    """矛盾解決戦略"""
    NEWER_WINS = "newer_wins"              # 新しい学習を優先
    HIGHER_AUTHORITY = "higher_authority"  # 権限が高い方を優先
    CONFIRM_USER = "confirm_user"          # ユーザーに確認


# ============================================================================
# 矛盾タイプ
# ============================================================================

class ConflictType(str, Enum):
    """矛盾タイプ"""
    CONTENT_MISMATCH = "content_mismatch"  # 同じトリガーで異なる内容
    RULE_CONFLICT = "rule_conflict"        # 同じ条件で異なるアクション
    CEO_CONFLICT = "ceo_conflict"          # CEO教えとの矛盾


# ============================================================================
# 確信度閾値
# ============================================================================

# 自動学習の確信度閾値（これ以上なら確認なしで学習）
CONFIDENCE_THRESHOLD_AUTO_LEARN: float = 0.7

# 確認モードの確信度閾値（これ以上なら確認モード、以下は無視）
CONFIDENCE_THRESHOLD_CONFIRM: float = 0.4

# 最低確信度（これ以下は学習候補とみなさない）
CONFIDENCE_THRESHOLD_MIN: float = 0.2


# ============================================================================
# デフォルト値
# ============================================================================

# デフォルトの確信度低下率（1日あたり）
DEFAULT_CONFIDENCE_DECAY_RATE: float = 0.0001

# デフォルトの学習コンテンツバージョン
DEFAULT_LEARNED_CONTENT_VERSION: int = 1

# デフォルトの機密区分
DEFAULT_CLASSIFICATION: str = "internal"


# ============================================================================
# 確認メッセージ用キーワード
# ============================================================================

# 肯定的な回答
POSITIVE_CONFIRMATION_KEYWORDS: Set[str] = {
    "うん", "そう", "はい", "yes", "ok", "おっけー", "オッケー",
    "そうだよ", "その通り", "そのとおり", "正解", "せいかい",
    "そうそう", "うんうん", "いいよ", "いいウル",
}

# 否定的な回答
NEGATIVE_CONFIRMATION_KEYWORDS: Set[str] = {
    "いや", "違う", "ちがう", "no", "だめ", "ダメ",
    "やめて", "やめ", "キャンセル", "取り消し", "とりけし",
    "ちゃう", "間違い", "まちがい", "誤り", "あやまり",
}


# ============================================================================
# 学習管理コマンド用キーワード
# ============================================================================

# 学習一覧表示
LIST_LEARNING_KEYWORDS: Set[str] = {
    "何覚えてる", "なにおぼえてる", "覚えてること", "おぼえてること",
    "学習内容", "がくしゅうないよう", "覚えたこと", "おぼえたこと",
    "学習一覧", "がくしゅういちらん", "何を覚えた", "なにをおぼえた",
}

# 学習削除
DELETE_LEARNING_KEYWORDS: Set[str] = {
    "忘れて", "わすれて", "削除して", "さくじょして",
    "消して", "けして", "取り消して", "とりけして",
    "なかったことに", "無かったことに",
}


# ============================================================================
# エラーメッセージテンプレート
# ============================================================================

ERROR_MESSAGES = {
    "ceo_conflict": (
        "ごめんウル！ソウルシンクスとして大事にしていることと異なるため、"
        "この内容は覚えることができないウル🐺"
    ),
    "save_failed": (
        "ごめんウル！うまく覚えられなかったウル🐺 "
        "もう一度教えてもらえるウル？"
    ),
    "delete_failed": (
        "ごめんウル！忘れようとしたけどうまくいかなかったウル🐺"
    ),
    "not_found": (
        "それは覚えていないウル🐺"
    ),
}


# ============================================================================
# 成功メッセージテンプレート
# ============================================================================

SUCCESS_MESSAGES = {
    "alias": "覚えたウル！『{from_value}』と言ったら『{to_value}』のことですねウル🐺",
    "preference": "覚えたウル！{user_name}さんは『{preference}』がお好みですねウル🐺",
    "fact": "覚えたウル！『{fact}』ですねウル🐺",
    "rule": "覚えたウル！『{rule}』というルールですねウル🐺",
    "correction": "覚えたウル！『{correction}』ですねウル🐺 次からそうするウル！",
    "context": "覚えたウル！『{context}』ですねウル🐺",
    "relationship": "覚えたウル！『{person1}と{person2}は{relationship}』ですねウル🐺",
    "procedure": "覚えたウル！『{procedure}』の手順ですねウル🐺",
    "deleted": "了解ウル！『{description}』を忘れたウル🐺",
    "updated": "修正したウル！『{new_description}』に変更したウル🐺",
}


# ============================================================================
# 確認メッセージテンプレート
# ============================================================================

CONFIRMATION_MESSAGES = {
    "alias": "『{from_value}』と言ったら『{to_value}』のことだと覚えていいウル？",
    "preference": "{user_name}さんは『{preference}』がお好みと覚えていいウル？",
    "fact": "『{fact}』と覚えていいウル？",
    "rule": "『{rule}』というルールを覚えていいウル？",
    "correction": "『{correction}』と覚えていいウル？",
    "context": "『{context}』と覚えていいウル？",
    "relationship": "『{person1}と{person2}は{relationship}』と覚えていいウル？",
    "procedure": "『{procedure}』という手順を覚えていいウル？",
}


# ============================================================================
# CEO教え矛盾時のメッセージテンプレート
# ============================================================================

CEO_CONFLICT_MESSAGE_TEMPLATE = """ごめんウル！ソウルシンクスとして大事にしていることと異なるため、
この内容は覚えることができないウル🐺

ソウルシンクスのルール:
「{ceo_teaching}」

カズさんに確認が必要な場合は、管理部チャットでお知らせできるウル"""


# ============================================================================
# 学習適用時の言及テンプレート
# ============================================================================

MENTION_TEMPLATES = {
    "alias_first_use": "{resolved_name}さん（{teacher_name}さんが『{alias}』と呼んでいる方）",
    "rule_applied": "{rule_description}のルールに従って、{action}したウル🐺",
}


# ============================================================================
# DB関連定数
# ============================================================================

# テーブル名
TABLE_BRAIN_LEARNINGS = "brain_learnings"
TABLE_BRAIN_LEARNING_LOGS = "brain_learning_logs"

# 最大取得件数
MAX_LEARNINGS_PER_QUERY = 100
MAX_LOGS_PER_QUERY = 1000

# 学習一覧表示時の最大件数（カテゴリごと）
MAX_LEARNINGS_PER_CATEGORY_DISPLAY = 10
