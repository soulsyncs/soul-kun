# promptfoo/promptfooconfig.yaml
# ソウルくん LLM Brain の品質回帰テスト
#
# 使い方:
#   cd promptfoo && promptfoo eval
#   promptfoo eval --no-cache  # キャッシュなし
#   promptfoo view             # 結果をブラウザで確認
#
# 環境変数:
#   OPENROUTER_API_KEY: OpenRouter API キー（必須）

description: "ソウルくん Brain 品質テスト"

prompts:
  - file://prompts/soulkun_system.txt

providers:
  - id: openrouter:openai/gpt-4o-mini
    config:
      apiBaseUrl: https://openrouter.ai/api/v1
      apiKeyEnvar: OPENROUTER_API_KEY
      temperature: 0.3
      max_tokens: 1024
      headers:
        HTTP-Referer: https://soulsyncs.co.jp
        X-Title: Soul-kun Promptfoo Test
      # Tool定義: handlers/registry.py の SYSTEM_CAPABILITIES と一致させる
      tools: &tools
        - type: function
          function:
            name: chatwork_task_create
            description: "ChatWorkで指定した担当者にタスクを作成する。タスクの追加、作成、依頼、お願いなどの要望に対応。"
            parameters:
              type: object
              properties:
                task_body:
                  type: string
                  description: "タスクの内容"
                assigned_to:
                  type: string
                  description: "担当者名（ChatWorkユーザー一覧から正確な名前を選択）。「俺」「自分」「私」の場合は「依頼者自身」"
                limit_date:
                  type: string
                  description: "期限日（YYYY-MM-DD形式）。ユーザーが明示的に言った場合のみ。推測禁止"
                limit_time:
                  type: string
                  description: "期限時刻（HH:MM形式）"
              required:
                - task_body
                - assigned_to
        - type: function
          function:
            name: chatwork_task_search
            description: "特定の人のタスクや、自分のタスクを検索して表示する。「〇〇のタスク」「自分のタスク」「未完了のタスク」などの要望に対応。"
            parameters:
              type: object
              properties:
                person_name:
                  type: string
                  description: "タスクを検索する人物名。「自分」「俺」「私」の場合は「sender」と出力"
                status:
                  type: string
                  enum: ["open", "done", "all"]
                  description: "タスクの状態"
                  default: "open"
                assigned_by:
                  type: string
                  description: "タスクを依頼した人物名（〇〇から振られたタスク）"
              required: []
        - type: function
          function:
            name: chatwork_task_complete
            description: "タスクを完了状態にする。「完了にして」「終わった」などの要望に対応。番号指定またはタスク内容で特定。"
            parameters:
              type: object
              properties:
                task_identifier:
                  type: string
                  description: "タスクを特定する情報（番号、タスク内容の一部、または「さっきの」など）"
              required:
                - task_identifier
        - type: function
          function:
            name: knowledge_search
            description: "社内ナレッジベースを検索する。質問や調べものに使う"
            parameters:
              type: object
              properties:
                query:
                  type: string
                  description: "検索クエリ"
              required:
                - query
        - type: function
          function:
            name: person_info
            description: "社員の情報を取得する"
            parameters:
              type: object
              properties:
                person_name:
                  type: string
                  description: "社員名"
              required:
                - person_name
        - type: function
          function:
            name: web_search
            description: "インターネット上の最新情報を検索する。社内ナレッジにない情報、最新ニュース、技術情報、一般知識などの検索に対応。"
            parameters:
              type: object
              properties:
                query:
                  type: string
                  description: "検索クエリ（日本語または英語）"
                max_results:
                  type: integer
                  description: "最大結果件数（1-10）"
              required:
                - query
        - type: function
          function:
            name: calendar_read
            description: "Googleカレンダーの予定を確認する。今日の予定、明日の予定、特定日の予定の表示に対応。"
            parameters:
              type: object
              properties:
                date_from:
                  type: string
                  description: "予定を表示する開始日（YYYY-MM-DD形式）。省略時は今日"
                date_to:
                  type: string
                  description: "予定を表示する終了日（YYYY-MM-DD形式）。省略時はdate_fromと同じ日"
              required: []
        - type: function
          function:
            name: general_conversation
            description: "雑談・挨拶・感謝への応答。Tool呼び出し不要な場合に使う"
            parameters:
              type: object
              properties:
                response_type:
                  type: string
                  enum: ["greeting", "thanks", "small_talk", "goodbye"]
              required: []

tests: file://test_cases.yaml

defaultTest:
  options:
    transformVars: "{ ...vars, sender_name: vars.sender_name || 'カズさん' }"

outputPath: ./results/latest.json
