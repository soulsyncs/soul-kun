# Step C: 手足を与える — コマンド実行機能 設計書

**作成日:** 2026-02-17
**作成者:** Claude Opus 4.6
**ステータス:** ドラフト（CEO + 3AIレビュー待ち）

---

## この設計書の目的

ソウル君に「自分でパソコンの操作ができる手足」を与えるための設計書です。
例えば「このデータを集計して」「この資料を作って」と言うだけで、
ソウル君が自分で作業して結果を返してくれるようになります。

**これは進化計画の中で最もパワフルだけど、最も慎重にやるべきステップです。**

---

## 現在の安全インフラ（既に稼働中）

Step 0で構築済みの安全装置がStep Cでも自動的に働きます。

| 安全装置 | 役割 | ファイル |
|---------|------|---------|
| **承認ゲート（ApprovalGate）** | 危険度に応じて自動実行/社長確認/二重チェックを振り分け | `lib/brain/approval_gate.py` |
| **番人（GuardianLayer）** | 7段階の安全チェック（危険操作、金額、PII等） | `lib/brain/guardian_layer.py` |
| **認可ゲート（AuthorizationGate）** | 価値観・記憶・整合性の3層チェック | `lib/brain/authorization_gate.py` |
| **緊急停止ボタン** | 1タップで全新機能を即停止 | `lib/brain/emergency_stop.py` |
| **監査ログ** | 全実行の記録（誰が・いつ・何を・なぜ・結果） | `lib/brain/audit_bridge.py` |
| **確認フロー** | 社長に「これ実行していい？」と聞く仕組み（10分で期限切れ） | `lib/brain/state_manager.py` |

---

## Step C-1: 安全な作業スペース（サンドボックス）

### 何をするか

ソウル君が操作できる「鍵付きの個室」を作ります。
この部屋の中でだけ作業ができ、外には出られません。

### 設計方針

| 項目 | 方針 |
|------|------|
| **実行方式** | Pythonのsubprocess（＝別プロセスで安全に実行） |
| **タイムアウト** | 最大30秒（超えたら自動で強制停止） |
| **メモリ制限** | 最大256MB |
| **ネットワーク** | 禁止（外部に接続できない） |
| **ファイルアクセス** | 専用の一時ディレクトリのみ（他の場所は見えない） |
| **実行ユーザー** | 制限付きサービスアカウント（管理者権限なし） |

### 新規ファイル

```
lib/brain/command_executor.py    — コマンド実行エンジン
lib/brain/command_validator.py   — コマンドの安全性チェック
```

---

## Step C-2: やっていいことリスト（読み取りのみ）

### ホワイトリスト方式

**リストにない操作は、理由を問わず拒否**します。

| 許可する操作 | 例 | 危険度 |
|-------------|-----|--------|
| ファイル一覧表示 | `ls`, `find` | 低 |
| ファイル内容の表示 | `cat`, `head`, `tail` | 低 |
| テキスト検索 | `grep`, `wc` | 低 |
| データ集計 | `sort`, `uniq`, `awk`（読み取りのみ） | 低 |
| Pythonスクリプト（読み取り系） | `python3 -c "..."` | 中 |

### 絶対禁止リスト（ブラックリスト）

どんな理由があっても実行させない操作：

| 禁止する操作 | 理由 |
|-------------|------|
| `rm`, `rmdir` | ファイル削除 |
| `chmod`, `chown` | 権限変更 |
| `curl`, `wget` | 外部通信 |
| `sudo`, `su` | 権限昇格 |
| `kill`, `pkill` | プロセス強制停止 |
| `dd`, `mkfs` | ディスク操作 |
| パイプで外部送信 | `> /dev/tcp/...` 等 |
| 環境変数の参照 | `$SECRET_KEY` 等 |

---

## Step C-3: テストと安全性チェック

### 自動テスト項目

| テスト | 確認すること |
|--------|------------|
| ホワイトリスト検証 | 許可されたコマンドだけ通るか |
| ブラックリスト検証 | 禁止コマンドが確実にブロックされるか |
| タイムアウト検証 | 30秒で確実に停止するか |
| メモリ制限検証 | 256MB超えで停止するか |
| インジェクション検証 | `; rm -rf /` 等の攻撃が防げるか |
| 出力サイズ制限 | 大量出力が切り詰められるか（10KB上限） |
| PII除去検証 | 出力にパスワード等が含まれないか |

### 手動テスト（社長と一緒に）

- 「売上データを集計して」→ 正しく集計できるか
- 「先月のレポートを作って」→ ファイルが作成されるか
- 「全ファイルを削除して」→ 確実にブロックされるか
- 緊急停止ボタン → コマンド実行が即座に止まるか

---

## Step C-4: 番人の強化

### 追加するGuardianルール

| ルール | チェック内容 | アクション |
|--------|------------|----------|
| コマンド文字列チェック | ブラックリストのコマンドが含まれていないか | BLOCK |
| パラメータ長チェック | コマンドが異常に長くないか（>500文字） | CONFIRM |
| 連続実行チェック | 短時間に大量のコマンド実行がないか（>10回/分） | BLOCK |
| ファイルパスチェック | 許可されたディレクトリ外へのアクセスがないか | BLOCK |
| 環境変数参照チェック | `$`, `env`, `export` が含まれていないか | BLOCK |

---

## Step C-5: 安全な書き込み

### 第2段階で追加する操作

C-2の読み取りが2週間安定稼働した後に開放。

| 許可する操作 | 例 | 条件 |
|-------------|-----|------|
| ファイル作成 | `echo "..." > report.txt` | 専用ディレクトリ内のみ |
| レポート生成 | `python3 generate_report.py` | 事前登録されたスクリプトのみ |
| CSVエクスポート | `python3 export_csv.py` | 読み取り元はDB、書き込み先は専用ディレクトリ |

**削除は引き続き禁止。**

---

## Step C-6: 全体テストと安定化

### 安定化期間: 2週間

| 確認項目 | 基準 |
|---------|------|
| エラー率 | 1%以下 |
| タイムアウト発生率 | 5%以下 |
| ブロック正常動作率 | 100%（禁止操作が1回でも通ったら失格） |
| 緊急停止テスト | 週1回実施、3秒以内に停止 |

---

## 承認フロー（既存の仕組みを活用）

```
ユーザー: 「売上データを集計して」
    ↓
[1] 脳（Brain）が意図を判断 → action: execute_command
    ↓
[2] 番人（GuardianLayer）がコマンドを検査
    ↓
[3] 承認ゲート（ApprovalGate）が危険度を判定
    ├─ 低リスク（読み取り系）→ 自動実行
    ├─ 中リスク（書き込み系）→ 社長に確認
    └─ 高リスク → ブロック
    ↓
[4] サンドボックス内でコマンド実行（30秒制限）
    ↓
[5] 結果をPII除去してユーザーに返す
    ↓
[6] 監査ログに記録
```

---

## スケジュール案

| ステップ | 内容 | 期間 |
|---------|------|------|
| C-1 | サンドボックス構築 | 2週間 |
| C-2 | 読み取り系コマンド実装 | 1週間 |
| C-3 | テスト・安全性検証 | 1〜2週間 |
| C-4 | 番人強化 | 1週間 |
| — | **読み取り系の安定運用期間** | **2週間** |
| C-5 | 書き込み系コマンド追加 | 1週間 |
| C-6 | 全体安定化 | 2週間 |

**合計: 約10〜11週間**（実行計画の「6〜10週間」と整合）

---

## 次のアクション

1. **この設計書を3AIレビュー（Claude + Codex + Gemini）にかける**
2. カズさんに承認をもらう
3. C-1（サンドボックス構築）から着手

---

## 参照

- 実行計画: `docs/execution_plan_mcp_evolution.md` Step C
- 脳の設計: `docs/25_llm_native_brain_architecture.md`
- 承認ゲート: `lib/brain/approval_gate.py`
- 番人: `lib/brain/guardian_layer.py`
- 緊急停止: `lib/brain/emergency_stop.py`
