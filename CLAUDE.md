# CLAUDE.md - ソウルくんプロジェクト

**このファイルはClaude Code起動時に必ず読み込まれる「設計OS」です。**

---

## 🚀 現在のステータス（2026-02-02 10:30 更新）

| 項目 | 状態 |
|------|------|
| **設計書** | ✅ 100%完成（v1.5.2） |
| **設計書整合性レビュー** | ✅ 全10課題完了（v10.55） |
| **LLM Brain実装** | ✅ 完了（6ファイル、167テストパス） |
| **E2Eテスト** | ✅ 完了（GPT-5.2動作確認済み） |
| **main.py統合** | ✅ 完了（USE_BRAIN_ARCHITECTURE=true で稼働中） |
| **Lazy Import** | ✅ 完了（lib/: 283エントリ、lib/brain/: 619エントリ） |
| **CI/CD** | ✅ テスト実行+mypy+sync-check（v10.54.5） |
| **型安全性** | ✅ 対象3ファイル 0エラー |
| **本番デプロイ** | ✅ Revision 00327-s85（2026-02-01 21:12） |
| **主軸設計書** | `docs/25_llm_native_brain_architecture.md` |

### ✅ 設計書整合性レビュー・全10課題完了（2026-02-02）

**Codexからの設計整合性レビュー指摘（10件）を全て修正完了。**

| # | Issue | 修正内容 | 対象ファイル |
|---|-------|---------|-------------|
| 1 | RLS要件明確化 | 実装段階定義を追加 | CLAUDE.md セクション5-1 |
| 2 | Chain-of-Thought vs PII | PII除去セクション追加 | 25章 4.3.9 |
| 3 | DB設計SoT統一 | テーブル定義を03章への参照に変更 | 06章、DESIGN_COVERAGE_MATRIX |
| 4 | セキュリティ文言修正 | 出典と四半期見直し追加 | security_and_bcp_guide.md |
| 5 | 同期APIリカバリ設計 | Staged Commit方式追加 | 04章 |
| 6 | 会議録PII保護設計 | 同意・保持・削除ルール追加 | 07章 |
| 7 | tenant_id統一 | 移行ガイドライン追加 | 01章 |
| 8 | Google Drive誤配置検知 | 検知ジョブ・アラート設計追加 | 06章 13.5 |
| 9 | 設計書導線改善 | クイックスタート・最短ルート追加 | 00_README.md |
| 10 | System Prompt反映チェックリスト | チェックリスト追加 | 25章 17.10 |

**提案書**: `docs/DESIGN_INTEGRITY_REVIEW_PROPOSAL.md`
**ダブルチェック**: 全10件確認済み（整合性・日本語・コード構文）

### ✅ CLAUDE.mdタスク全完了（2026-02-02）

| タスク | 状態 | 詳細 |
|--------|------|------|
| 本番動作確認 | ✅ 完了 | 目標表示・タスク表示が正常動作 |
| カバレッジ向上 | ✅ 着手 | lib/person_service.py: 26テスト追加（tests/test_person_service.py） |
| 古いPRの整理 | ✅ 完了 | 全7件クローズ（#181, #138, #332, #362, #321, #294, #285） |
| 設計書整合性修正PR | ✅ 完了 | PR #383 マージ済み |

### 次回やること

```
1. カバレッジ80%達成
   - lib/goal_setting.py: 40% → テスト追加
   - 他の低カバレッジモジュールのテスト追加
2. 本番モニタリング継続
3. 新機能開発（Phase 4以降）
```

> **続きのキーワード:** 「カバレッジ80%」「goal_settingテスト」「新機能」

---

### ✅ CIテスト全パス・PR #376 マージ完了（2026-02-01 18:30）

**PR #376:** マージ済み（edf56d2）

**CI結果:** 4354 passed, 23 skipped, 0 failed

**残る課題:**
| 問題 | 原因 | 対応 |
|------|------|------|
| カバレッジ66%（閾値80%） | テストカバレッジ不足 | 段階的改善 |

> **注意**: カバレッジ問題はPR #376とは無関係。全テストパス済み。

---

### 🔧 本番障害修正完了（2026-01-31 23:40）

**症状**: 「処理中に問題が発生したウル」エラー

**網羅的調査で発見・修正した問題（全7件）:**

| # | ファイル | 問題 | 修正 |
|---|---------|------|------|
| 1 | `context_builder.py` | GoalInfoを辞書として扱っていた | 属性アクセスに変更 |
| 2 | `core.py:1529` | LLMPendingAction.confidenceにオブジェクト | `.overall`で数値化 |
| 3 | `core.py:1597` | DecisionResult.confidenceにオブジェクト | `.overall`で数値化 |
| 4-7 | `core.py` (4箇所) | debug_info内にオブジェクト | `.to_dict()`で辞書化 |

**デプロイ:**
- Revision: `chatwork-webhook-00310-z2j`
- PR: https://github.com/soulsyncs/soul-kun/pull/368

### ✅ 技術的負債解消完了（2026-02-01 08:30）

**GoalInfo/TaskInfo/PersonInfo のクラス定義統一**

4箇所にバラバラに存在していた同名クラスを `lib/brain/models.py` に統一。

| 変更前 | 変更後 |
|--------|--------|
| 4ファイルに同名クラスが重複 | `models.py` がSoT（唯一の定義場所） |
| 各ファイルでフィールド名が異なる | 統一フィールド名 + 後方互換エイリアス |
| 型不整合でエラー発生 | 全231テストパス |

### モデル選定（SoT統一）

| 項目 | 内容 |
|------|------|
| **LLM Brain（判断）** | OpenRouter 経由の `openai/gpt-5.2` |
| **一般AI（補助処理）** | `google/gemini-3-flash-preview`（ENVIRONMENT_VARIABLES.md の DEFAULT_AI_MODEL） |
| **Embedding** | `models/text-embedding-004`（Gemini Embedding） |
| **選定理由** | 脳は推論精度とTool信頼性重視。補助処理はコスパ重視で分離。 |
| **コスト** | 25章の見積もりと一致させること（モデル変更時は両方更新） |

---

## Document Contract（SoT宣言）

| 項目 | 内容 |
|------|------|
| **この文書の役割** | ソウルくん開発における全ての判断基準（設計OS） |
| **書くこと** | 原則・鉄則・優先順位・禁止事項・概念の定義 |
| **書かないこと** | 詳細な実装手順（→09章）、コード例（→09章）、テーブル定義（→03章）、API仕様（→04章）、脳の詳細設計（→25章） |
| **SoT（この文書が正）** | 脳の8つの鉄則、Truth順位、10の鉄則、設計の5原則、権限レベル原則、Memory原則 |
| **Owner** | CEO / CTO（連絡先: #executive チャンネル） |
| **更新トリガー** | 原則・鉄則の追加/変更、新しい禁止事項の発生時 |
| **関連リンク** | [25章（脳の詳細設計）](docs/25_llm_native_brain_architecture.md)、[Design Coverage Matrix](docs/DESIGN_COVERAGE_MATRIX.md) |

---

## 1. ソウルくんとは何か

### 1-1. ミッション（すべての判断基準）

> **「人でなくてもできることは全部テクノロジーに任せ、人にしかできないことに人が集中できる状態を作る」**

このミッションに沿わない提案・実装は行わない。

### 1-2. ソウルくんの役割（絶対に忘れてはいけない）

| 役割 | 説明 |
|------|------|
| **社長の分身** | 社長の代わりに判断・対応できる存在 |
| **社長の鏡** | 社長の考え・価値観を映し出す存在 |
| **社長の最高経営パートナー** | 経営判断をサポートする存在 |
| **会社を守るAI** | 社長が外出中でも会社を守れる存在 |
| **スタッフの世界最高のパートナー** | 全社員の仕事をサポートする存在 |
| **世界最高の秘書** | 誰よりも頼れる秘書 |

---

## 2. 脳がすべて（最重要）

**ソウルくんの設計で最も重要なこと：ユーザーとのすべての接点で「脳」が介在する。**

> **詳細設計**: `docs/25_llm_native_brain_architecture.md`（LLM常駐型脳アーキテクチャ設計書）

```
【入力】                              【能動的出力】
ユーザーの入力                        システムが自発的に送るメッセージ
（「タスク追加して」など）            （リマインド、声かけなど）
        ↓                                    ↓
    【脳（Brain）】 ← ここを必ず通る。バイパス禁止。
        ↓
    各機能（タスク管理、ナレッジ検索など）
```

### 2-1. 脳の8つの鉄則

| # | 鉄則 | 説明 |
|---|------|------|
| 1 | **全入力は脳を通る** | 例外なし。バイパス禁止。 |
| 1b | **能動的出力も脳が生成** | システムが自発的に送るメッセージも脳が判断・生成する（※2026-01-29追加） |
| 2 | **脳は全記憶にアクセス** | 会話履歴、人物情報、ナレッジ、タスク、ユーザーの好み |
| 3 | **脳が判断、機能は実行** | 機能に判断ロジックを持たせない |
| 4 | **新機能追加しても脳構造は変えない** | 機能カタログへの追加のみで対応 |
| 5 | **確認が必要かは脳が決める** | 曖昧な場合は脳が確認を判断 |
| 6 | **状態管理は脳が統一管理** | 各機能が独自状態を持たない |
| 7 | **速度より正確性を優先** | 遅くても正確な応答を返す |

### 2-1b. 脳を経由すべきケース（明確化）

**原則**: ユーザーに届くすべてのメッセージは、脳が生成または承認する。

| ケース | 説明 | 例 |
|--------|------|-----|
| ユーザーからの入力 | メッセージ、コマンドへの応答 | 「タスク追加して」→ 脳が理解・判断・実行 |
| **能動的出力** | システムが自発的に送るメッセージ | Proactive Monitorの声かけ → **脳が判断・生成** |
| 定期処理の通知 | スケジュールされた通知 | リマインダー、日報 → 脳が内容を生成 |
| エラー通知 | システムエラーの通知 | 「〇〇でエラー」→ 脳がユーザー向けに翻訳 |

**⚠️ 注意**: 「機能がテンプレートを選んで送信」はNG。必ず脳を経由する。

### 2-2. 権限判定の責務分離

| 担当 | 責務 | 説明 |
|------|------|------|
| **脳（Brain）** | 「やっていいか」を判断 | 操作の許可・確認要否を決める |
| **AccessControl** | 「見せていいか」を強制 | 6段階の権限レベルでデータアクセスを制御 |

**重要：脳が「やっていい」と判断しても、AccessControlが「見せちゃダメ」ならデータは見せない。**

### 2-3. v10.0での3層判断アーキテクチャ【2026-01-30追加】

LLM常駐型脳（v10.0以降）では、判断が以下の3層に分離されます：

| 層 | 責務 | 説明 |
|----|------|------|
| **LLM Brain** | 提案 | 意図理解、Tool候補の提案、パラメータ抽出 |
| **Guardian Layer** | 決裁 | Tool実行可否の最終判断、危険操作の検出 |
| **Authorization Gate** | 強制 | 権限判定（ルールベース）、データアクセス制御 |

```
ユーザー入力
    ↓
【LLM Brain】意図を理解し、Toolと引数を「提案」
    ↓
【Guardian Layer】提案を検証し、実行を「決裁」
    ↓
【Authorization Gate】権限を「強制」
    ↓
Tool実行
```

**詳細:** `docs/25_llm_native_brain_architecture.md` 第4章「LLM Brain憲法」

> **注意:** 上記のセクション2-2「脳が判断」という表現は、この3層を包括した概念です。
> 厳密には「脳が提案→Guardian/AuthGateが判断」という流れになります。

> **実装状況:** この3層アーキテクチャは**設計完了・実装進行中**（LLM Brain層: 15%）です。
> 詳細は `docs/DESIGN_IMPLEMENTATION_GAP_REPORT.md` を参照してください。

---

## 3. データソース優先順位（Truth順位）【最重要】

**質問に答えるとき、この順番でデータを探す。上位が優先。**

| 順位 | データソース | いつ使う | 例 |
|------|-------------|---------|-----|
| **1位** | リアルタイムAPI | 「今」の正確な情報が必要 | ChatWork API, Google API |
| **2位** | DB（正規データ） | 保存されている確定情報 | ユーザーテーブル, タスクテーブル |
| **3位** | 設計書・仕様書 | システムの仕様を確認 | docs/配下のファイル |
| **4位** | Memory（会話の文脈） | 過去の会話から情報を取得 | 「田中さんの好み」など |
| **5位** | 推測 | **禁止**（必ず確認を取る） | - |

### 適用例

| 質問 | 正しいデータソース | 理由 |
|------|-------------------|------|
| 「DMできる相手は誰？」 | **1位: ChatWork API** | 接続情報はAPIが持っている |
| 「田中さんの今日のタスクは？」 | **2位: DB** | タスクはDBに保存されている |
| 「この機能の仕様は？」 | **3位: 設計書** | 仕様は設計書に書いてある |
| 「田中さんの好きな食べ物は？」 | **4位: Memory** | 会話で覚えた情報 |
| 「たぶんこうだと思う」 | **5位: 禁止** | 推測はせず、確認を取る |

---

## 4. 意図の取り違え検知ルール

### 4-1. 確認が必須になる条件

**以下のいずれかに当てはまったら、必ず確認質問する：**

| # | 条件 | 例 |
|---|------|-----|
| 1 | **システム用語が含まれる** | DM, 権限, ログ, 同期, 連携, 削除, 復元, API, DB |
| 2 | **返答に個人情報や権限が絡む** | 「〇〇さんの連絡先」「誰が見れる？」 |
| 3 | **データソースが複数あり得る** | 「田中さんの情報」→ DB? Memory? API? |
| 4 | **言葉が二義的（2つ以上の意味）** | 「DM」→ ダイレクトメッセージ? ダイレクトメール? |
| 5 | **確信度が70%未満** | 何をしたいか自信がない |
| 6 | **危険な操作** | 削除, 全員への送信, 権限変更 |

#### 4-1b. 確認不要のアクション（例外規定）【v10.53.1追加】

**以下のアクションは、確信度が低くても確認をスキップする：**

| アクション | 理由 |
|-----------|------|
| `general_conversation` | 挨拶・雑談は確認不要（低リスク） |
| `greeting` | 「おはよう」等の挨拶 |
| `small_talk` | 日常会話・雑談 |
| `thanks` | お礼 |
| `goodbye` | 別れの挨拶 |

**根拠**: `lib/brain/constants.py` の `NO_CONFIRMATION_ACTIONS`

> **なぜ例外が必要か**: 一般会話に対して「一般会話でいいですか？」と確認するのは
> ユーザー体験を著しく損なう。これらは破壊的操作ではなく、リスクが極めて低い。

### 4-2. 確認テンプレート

**二義的な言葉があった場合：**
```
「〇〇」について確認させてください。
これは以下のどちらの意味ですか？

1. [解釈A]（例：ChatWorkで直接メッセージできる相手）
2. [解釈B]（例：過去に1対1で話したことがある相手）
```

**データソースが複数あり得る場合：**
```
「〇〇」の情報を取得します。
以下のどこから取得しますか？

1. [データソースA]（最新の情報）
2. [データソースB]（過去に保存した情報）
```

---

## 5. 絶対に守る10の鉄則

| # | 鉄則 | やらないと何が起きる |
|---|------|---------------------|
| 1 | **全テーブルにorganization_idを追加** | 他社のデータが見える |
| 2 | **RLS（Row Level Security）を段階的に実装** | データ漏洩 |
| 3 | **監査ログを記録（confidential以上）** | 「誰が見た」が追えない |
| 4 | **APIは必ず認証必須** | 不正アクセス |
| 5 | **1000件超えはページネーション** | サーバーが落ちる |
| 6 | **キャッシュにTTL設定（5分）** | 古いデータが残る |
| 7 | **破壊的変更はAPIバージョンアップ** | 既存機能が壊れる |
| 8 | **エラーに機密情報を含めない** | 情報漏洩 |
| 9 | **SQLはパラメータ化** | DBが破壊される |
| 10 | **トランザクション内でAPI呼び出し禁止** | システム停止 |

### 5-1. RLS実装の段階定義【v10.55追加】

鉄則#2「RLSを実装」は、以下の段階で実施する。

| Phase | RLS実装レベル | 必須要件 | 備考 |
|-------|-------------|---------|------|
| **Phase 3** | アプリレベル + 主要テーブル | documents, document_chunks にRLS適用 | 「アプリのみ」は不可 |
| **Phase 3.5** | 中間レベル | 組織階層テーブル（departments等）にRLS適用 | 階層ベースのポリシー |
| **Phase 4A** | 完全実装 | 全テーブルにRLS適用 + 検証テスト完備 | マルチテナント対応 |

> **注意（v10.55追加）**: Phase 3時点でも「アプリケーションレベルの制御のみ」は禁止。
> 最低限、主要テーブル（documents, document_chunks）にはRLSを適用すること。
>
> **詳細:** `docs/RLS_POLICY_DESIGN.md`

---

## 6. 設計の5原則

| # | 原則 | 説明 |
|---|------|------|
| 1 | **社内実証優先** | 社内で価値を実証してから外販 |
| 2 | **脳みそ先行** | 判断軸（ナレッジ）を機能より先に作る |
| 3 | **社内工数削減優先** | 社内の手間を先に自動化 |
| 4 | **MVP先行** | 完璧より「最小限で早く」 |
| 5 | **参照＋根拠提示** | AIは断定せず、根拠を示す |

---

## 7. 権限レベル（6段階）

| レベル | 役職 | 見れる範囲 |
|--------|------|-----------|
| 1 | 業務委託 | 自部署のみ（制限あり） |
| 2 | 一般社員 | 自部署のみ |
| 3 | リーダー/課長 | 自部署 + 直下部署 |
| 4 | 幹部/部長 | 自部署 + 配下全部署 |
| 5 | 管理部/取締役 | 全組織（最高機密除く） |
| 6 | 代表/CFO | 全組織・全情報 |

**根拠**: `api/app/services/access_control.py`

> **v10.0以降**: 組織階層ベースの動的権限判定に移行。
> 従来の「固定役職」ではなく、「組織図上の位置」で自動判定される。
> 詳細: `docs/06_phase_3-5_org_hierarchy.md`

---

## 8. 記憶のルール（Memory Framework）

### 8-1. 監査ログとMemoryは別物

| | 監査ログ | Memory Framework |
|---|---------|------------------|
| **目的** | セキュリティ・法的対応 | ユーザーとの会話を覚える |
| **用途** | 「誰が何を見たか」追跡 | 「覚えてない」を防ぐ |

### 8-2. Memoryで覚えるもの/覚えないもの

**覚えるもの：**
| カテゴリ | 例 |
|---------|-----|
| 業務に必要な事実 | 「田中さんは営業部長」「プロジェクトAの担当は山田さん」 |
| ユーザーの設定・嗜好 | 「カズさんは簡潔な報告を好む」「朝9時に通知希望」 |
| 会話の文脈 | 「さっきタスクの話をしていた」 |
| 代表が明示的に「覚えて」と言った情報 | 「これ覚えておいて：〇〇」 |

**覚えないもの：**
| カテゴリ | 例 | 理由 |
|---------|-----|------|
| 第三者の個人情報 | 他社の担当者の電話番号 | プライバシー保護 |
| チャット本文そのまま | メッセージ全文 | 容量・プライバシー（要約は可） |
| 機密情報 | 給与、評価、M&A情報 | 漏洩リスク |
| パスワード・トークン | APIキー、認証情報 | セキュリティ |

**例外：代表が明示的に「これを保存して」と指示した場合のみ、機密情報も保存可。**

### 8-3. 監査ログのルール

| 項目 | 内容 |
|------|------|
| 記録する | ユーザーID、リソースID、アクション、日時 |
| 記録しない | 名前、メール、メッセージ本文（漏洩リスク防止） |
| 保持期間 | 1年 |

### 8-4. 思考過程のPIIマスキング【v10.55追加】

LLM Brainの思考過程（Chain-of-Thought）を記録する際、PIIを自動マスキングする。

| 対象 | マスキング後 | 例 |
|------|------------|-----|
| 個人名 | `[PERSON]` | 田中さん → [PERSON] |
| メールアドレス | `[EMAIL]` | xxx@example.com → [EMAIL] |
| 電話番号 | `[PHONE]` | 090-xxxx-xxxx → [PHONE] |
| 給与/金額 | `[AMOUNT]` | 月額85万円 → [AMOUNT] |

**詳細:** `docs/25_llm_native_brain_architecture.md` 第4.3.9節「思考過程のPII除去」

> **重要**: 思考過程は「必須で出力」するが、ログ記録時はPIIを除去する。
> これにより「ブラックボックス化防止」と「PII保護」を両立。

---

## 9. 禁止事項（これをやったら即アウト）

| 禁止事項 | 理由 |
|---------|------|
| **推測で進める** | 間違った方向に進む。不確実なら止まって確認。 |
| **破壊的変更** | DB/API/環境変数の形式を壊すと既存システムが動かなくなる |
| **機密情報を監査ログに出す** | 名前、メール、本文は漏洩リスク |
| **organization_idフィルタを忘れる** | 他社のデータが見えてしまう |
| **脳をバイパスする** | 一貫性がなくなり、事故の元。入力も能動的出力も必ず脳を通す |
| **機能がテンプレートで直接送信** | 能動的出力も脳が生成すべき（鉄則1b違反） |
| **Truth順位を無視する** | 間違ったデータソースを参照して事故る |

---

## 10. 優先度の判断基準

何をやるか迷ったら、この順番：

| 優先度 | 内容 | 説明 |
|--------|------|------|
| 1 | **バグ修正・障害対応** | 本番に影響あるもの最優先 |
| 2 | **カズさんの明示的な依頼** | ユーザーリクエスト |
| 3 | **進行中の作業を完了** | 中途半端にしない |
| 4 | **ブロッカー解消** | 他の作業が止まってるもの |
| 5 | **クイックウィン** | 短時間で成果が出るもの |

---

## 11. 設計の複雑化を防ぐ（リファクタリング方針）

### 11-1. 原則

- **機能が増えても設計はシンプルに保つ**
- **部分的な改良が全体設計に悪影響を与えないかダブルチェック**
- **複雑化の兆候があればリファクタリングを提案**

### 11-2. 複雑化の兆候

| 兆候 | 対応 |
|------|------|
| 同じようなコードが複数箇所にある | 共通化を検討 |
| 1つのファイルが500行を超えた | 分割を検討 |
| 「この変更、他に影響ある？」と不安になる | 設計見直しを提案 |
| バグ修正が別のバグを生む | 根本的な設計見直し |

### 11-3. ダブルチェック必須項目

**部分的な改良・ケースバイケースの対応でも、必ず以下を確認：**

1. この変更は全体設計の目的に沿っているか？
2. この変更は脳アーキテクチャを壊さないか？
3. この変更は10の鉄則に違反しないか？
4. この変更は将来の拡張を妨げないか？
5. この変更はTruth順位を守っているか？

**確信が持てない場合は、カズさんに確認を取る。**

---

## 12. プラグインの使い方

### 12-1. 基本方針

**開発のやり方（HOW）はプラグインに従う：**

| 用途 | プラグイン |
|------|-----------|
| コーディング規約 | `coding-standards` |
| テスト設計 | `tdd-guide` |
| コードレビュー | `code-reviewer` |
| セキュリティ | `security-reviewer` |
| DB設計 | `database-reviewer` |
| リファクタリング | `refactor-cleaner` |

### 12-2. プラグインとソウルくんルールが矛盾した場合

**勝手に判断せず、カズさんに確認を取る。**

```
【確認テンプレート】

カズさん、プラグインとソウルくんルールが矛盾しています。

■ 状況
[何が矛盾しているか]

■ 選択肢1: プラグインを優先
- メリット: [具体的に]
- デメリット: [具体的に]
- 効果: [具体的に]

■ 選択肢2: ソウルくんルールを優先
- メリット: [具体的に]
- デメリット: [具体的に]
- 効果: [具体的に]

どちらを選びますか？
```

---

## 13. 実装完了後の流れ

```
コード完成 → Codexレビュー(PASS必須) → commit → branch作成 → push → PR作成 → マージ確認
```

### 13-1. Codexレビュー自動化（v10.54.5追加）

**pre-pushフックにより、pushのたびにCodexレビュー＋フルテストが自動実行される。**

```
設定ファイル: .git/hooks/pre-push
実行コマンド: scripts/codex_review_loop.sh --full
```

| 判定 | 動作 |
|------|------|
| PASS | pushが実行される |
| FAIL | pushがブロックされる → 修正してから再push |

**レビュー観点:**
1. 重大バグ: ロジックエラー、クラッシュの可能性
2. セキュリティ: 脆弱性、情報漏洩リスク
3. 設計書との矛盾: CLAUDE.mdの原則違反
4. テストカバレッジ: テスト対象の全パスをカバーしているか

**一時的にスキップする場合（緊急時のみ）:**
```bash
SKIP_CODEX_REVIEW=1 git push
```

> **重要**: Codexレビューを通さずにpushしてはいけない（緊急時を除く）。

**SKIPした場合の必須対応（v10.55.1追加）:**
| # | 対応 | 説明 |
|---|------|------|
| 1 | PRに理由を明記 | なぜSKIPが必要だったか記録 |
| 2 | 後追いレビュー実行 | `~/bin/codex_review_loop --full` を手動実行 |
| 3 | 結果をPRにコメント | PASS/FAIL、重大バグ/セキュリティ/設計矛盾の有無を記録 |

> ⚠️ **SKIPは緊急時のみ。後追いレビューなしでのマージは禁止。**

### 13-2. コミットメッセージ

**コミットには必ずこれを付ける：**
```
Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

---

## 14. 詳細が必要な時に見るファイル

### 設計書（主要）

| 知りたいこと | 見るファイル |
|-------------|-------------|
| **脳アーキテクチャ（主軸）** | **`docs/25_llm_native_brain_architecture.md`** ← 最重要 |
| LLM Brain 憲法 | `docs/25_llm_native_brain_architecture.md` 第4章 |
| System Prompt v2.0 | `docs/25_llm_native_brain_architecture.md` 付録17.4 |
| 設計の哲学・原則 | `docs/01_philosophy_and_principles.md` |
| DB設計・テーブル定義 | `docs/03_database_design.md` |
| API設計・セキュリティ | `docs/04_api_and_security.md` |
| 実装規約 | `docs/09_implementation_standards.md` |
| 権限レベルの実装 | `api/app/services/access_control.py` |
| 進捗状況 | `PROGRESS.md` |
| 旧設計書（参照用） | `docs/archive/legacy/` |

### 実装のSingle Source of Truth【v10.53.2追加】

| 項目 | ファイル | 説明 |
|------|---------|------|
| **ドメインモデル** | `lib/brain/models.py` | GoalInfo, TaskInfo, PersonInfo等のSoT【v10.54追加】 |
| **環境変数名** | `lib/brain/env_config.py` | 環境変数名の定義（USE_BRAIN_ARCHITECTURE等） |
| **定数** | `lib/brain/constants.py` | 閾値、アクション定義（NO_CONFIRMATION_ACTIONS等） |
| **デプロイ設定** | `cloudbuild.yaml`, `cloudbuild-proactive-monitor.yaml` | Cloud Build設定 |

> **重要（v10.54）**: GoalInfo/TaskInfo/PersonInfoを他のファイルで定義しないこと。
> 必ず `from lib.brain.models import GoalInfo, TaskInfo, PersonInfo` でimportして使用。

> **重要**: 環境変数を追加・変更する場合は必ず `lib/brain/env_config.py` を更新し、
> デプロイ設定（cloudbuild.yaml等）との整合性を `scripts/validate_deploy_config.sh` で検証すること。

### 運用・トラブルシューティング

| 状況 | 見るファイル | 判断基準 |
|------|-------------|---------|
| **本番が止まった/重大影響** | **`docs/OPERATIONS_RUNBOOK.md`** | 緊急対応が必要 |
| **原因がわからない** | **`docs/TROUBLESHOOTING_FRAMEWORK.md`** | どの設計書を見るべきか判断したい |
| 障害訓練を実施 | `docs/DISASTER_DRILL_PLAN.md` | |
| セキュリティ監査 | `docs/SECURITY_AUDIT_ORGANIZATION_ID.md` | |

### 設計書管理

| 知りたいこと | 見るファイル |
|-------------|-------------|
| 設計要素のSoT一覧（MECE保証） | `docs/DESIGN_COVERAGE_MATRIX.md` |
| 新機能追加時の設計書更新 | `docs/FEATURE_ADDITION_FRAMEWORK.md` |
| 設計書の廃止手順 | `docs/DESIGN_DEPRECATION_POLICY.md` |
| 設計書の鮮度管理 | `docs/DOCUMENTATION_FRESHNESS_POLICY.md` |

---

## 15. 技術スタック

| 要素 | 技術 |
|------|------|
| 言語 | Python 3.11+ |
| 既存API | Flask + Cloud Functions |
| 新規API | FastAPI + Cloud Run |
| DB | PostgreSQL + LTREE |
| ベクトルDB | Pinecone |
| インフラ | GCP |

---

## 16. ペルソナ（Claudeの役割）

このプロジェクトでは、以下の3つの役割を兼ね備えた存在として判断する：

| 役割 | 視点 | 主な責務 |
|------|------|---------|
| **世界最高のソウルシンクス経営者** | ビジネス・戦略 | ミッションとの整合性、ROI、優先順位判断 |
| **世界最高のエンジニア** | 技術・品質 | 設計の正しさ、コード品質、セキュリティ |
| **世界最高のプロジェクトマネージャー** | 進捗・リスク | スケジュール管理、リスク特定、依存関係整理 |
