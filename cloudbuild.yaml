# =============================================================================
# Cloud Build è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
# =============================================================================
#
# ç›®çš„:
#   mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã«è‡ªå‹•ã§Cloud Runã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
#   â€»ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãªã„
#
# ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼ˆGCPã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è¨­å®šãŒå¿…è¦ï¼‰:
#   - ã‚¤ãƒ™ãƒ³ãƒˆ: Push to a branch
#   - ãƒ–ãƒ©ãƒ³ãƒ: ^main$
#   - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚£ãƒ«ã‚¿: chatwork-webhook/**, lib/**, cloudbuild.yaml
#
# v10.53.0: åˆç‰ˆä½œæˆï¼ˆå¤§è¦æ¨¡ä¿®ç¹•å¯¾å¿œï¼‰
# v10.54.3: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»mypyè¿½åŠ ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å“è³ªãƒã‚§ãƒƒã‚¯ï¼‰
# =============================================================================

steps:
  # =============================================================================
  # Step 1: lib/ åŒæœŸãƒã‚§ãƒƒã‚¯
  # =============================================================================
  - name: 'gcr.io/cloud-builders/git'
    id: 'sync-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ” lib/ åŒæœŸãƒã‚§ãƒƒã‚¯..."

        # chatwork-webhook/lib/brain/ ã¨ lib/brain/ ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯
        if ! diff -rq lib/brain chatwork-webhook/lib/brain --exclude='__pycache__' --exclude='*.pyc' --exclude='handler_wrappers.py' > /dev/null 2>&1; then
          echo "âŒ lib/brain/ ãŒåŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼"
          echo "   ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
          exit 1
        fi

        echo "âœ… lib/ ã¯åŒæœŸã•ã‚Œã¦ã„ã¾ã™"

  # =============================================================================
  # Step 2: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— + ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # =============================================================================
  - name: 'python:3.11-slim'
    id: 'run-tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå¤±æ•—ã—ãŸã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­æ­¢ï¼‰"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        pip install --quiet pytest pytest-asyncio
        pip install --quiet -r chatwork-webhook/requirements.txt 2>/dev/null || true

        # é‡è¦ãªãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼ˆé«˜é€ŸåŒ–ã®ãŸã‚ï¼‰
        # å…¨ãƒ†ã‚¹ãƒˆã¯æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã€é‡è¦ãªçµ±åˆãƒ†ã‚¹ãƒˆã«çµã‚‹
        echo ""
        echo "ğŸ“‹ é‡è¦æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
        cd /workspace
        python -m pytest tests/test_critical_functions.py tests/test_brain_type_safety.py -v --tb=short

        if [ $? -ne 0 ]; then
          echo ""
          echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—ï¼ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
          exit 1
        fi

        echo ""
        echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ"
    waitFor: ['sync-check']

  # =============================================================================
  # Step 3: é™çš„å‹ãƒã‚§ãƒƒã‚¯ï¼ˆmypyï¼‰
  # =============================================================================
  - name: 'python:3.11-slim'
    id: 'mypy-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” é™çš„å‹ãƒã‚§ãƒƒã‚¯ï¼ˆå­˜åœ¨ã—ãªã„é–¢æ•°ã®æ¤œå‡ºãªã©ï¼‰"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        pip install --quiet mypy

        # é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­æ­¢ï¼‰
        # --ignore-missing-imports: å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å‹æƒ…å ±ãŒãªãã¦ã‚‚OK
        # --no-error-summary: æœ€å¾Œã®ã‚µãƒãƒªãƒ¼ã‚’çœç•¥
        echo ""
        echo "ğŸ“‹ lib/brain/ ã®å‹ãƒã‚§ãƒƒã‚¯..."
        python -m mypy chatwork-webhook/lib/brain/models.py \
                       chatwork-webhook/lib/brain/core.py \
                       chatwork-webhook/lib/brain/handler_wrappers.py \
                       --ignore-missing-imports \
                       --no-error-summary 2>&1 | head -50

        # mypyã¯ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚è­¦å‘Šãƒ¬ãƒ™ãƒ«ãªã®ã§ã€ä»Šã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ­¢ã‚ãªã„
        # å°†æ¥çš„ã«ã¯å³æ ¼åŒ–ã™ã‚‹
        echo ""
        echo "âœ… å‹ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼ˆè­¦å‘Šã¯è¨˜éŒ²ã®ã¿ï¼‰"
    waitFor: ['run-tests']

  # =============================================================================
  # Step 4: chatwork-webhook ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
  # =============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-chatwork-webhook'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'chatwork-webhook'
      - '--source=chatwork-webhook'
      - '--region=asia-northeast1'
      - '--allow-unauthenticated'
      - '--memory=512Mi'
      - '--timeout=540s'
      - '--set-env-vars=USE_BRAIN_ARCHITECTURE=true,LOG_EXECUTION_ID=true'
    waitFor: ['mypy-check']

  # =============================================================================
  # Step 5: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
  # =============================================================================
  - name: 'gcr.io/cloud-builders/curl'
    id: 'notify'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… chatwork-webhook ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ã‚³ãƒŸãƒƒãƒˆ: $COMMIT_SHA"
        echo "ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"
        echo ""
        echo "å“è³ªãƒã‚§ãƒƒã‚¯:"
        echo "  âœ… lib/ åŒæœŸãƒã‚§ãƒƒã‚¯"
        echo "  âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        echo "  âœ… é™çš„å‹ãƒã‚§ãƒƒã‚¯"
        echo ""
    waitFor: ['deploy-chatwork-webhook']

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ15åˆ† - ãƒ†ã‚¹ãƒˆæ™‚é–“ã‚’è€ƒæ…®ï¼‰
timeout: '900s'

# ãƒ­ã‚°è¨­å®š
options:
  logging: CLOUD_LOGGING_ONLY
