# トラブルシューティングフレームワーク

**作成日:** 2026-01-30
**目的:** バグ発生時に「どの設計書を見るか」を即座に判断できるようにする

---

## Document Contract（SoT宣言）

| 項目 | 内容 |
|------|------|
| **この文書の役割** | エラー→原因→対処の導線を定義 |
| **書くこと** | エラーカテゴリ、参照すべき設計書、対処パターン |
| **書かないこと** | 具体的な対処手順（→OPERATIONS_RUNBOOK.md） |
| **SoT（この文書が正）** | トラブルシューティングの導線 |
| **Owner** | Tech Lead（連絡先: #dev チャンネル） |
| **更新トリガー** | 新しいエラーパターン発見時 |

---

## 0. このドキュメントとOPERATIONS_RUNBOOKの使い分け

> **迷ったらこのフローで判断**

```
問題が発生した
      ↓
【Q1】本番環境が停止/重大な影響が出ている？
  → YES → OPERATIONS_RUNBOOK.md を開く（緊急対応手順）
  → NO → このドキュメントを続けて読む
      ↓
【Q2】原因は既に特定されている？
  → YES → OPERATIONS_RUNBOOK.md で具体的手順を確認
  → NO → このドキュメントで原因を特定（下のフローへ）
```

| ドキュメント | いつ使う | 内容 |
|-------------|---------|------|
| **OPERATIONS_RUNBOOK.md** | 本番障害の緊急対応、具体的な手順が必要な時 | コマンド、設定変更、復旧手順 |
| **このドキュメント** | 原因がわからない時、どの設計書を見るべきか迷う時 | 原因の特定、参照先の判断 |

---

## 1. エラー発生時の最初のステップ

```
エラー発生
    ↓
【Step 1】4大カテゴリのどれか特定（下のフロー参照）
    ↓
【Step 2】該当する設計書を開く
    ↓
【Step 3】対処パターンに従って修正
    ↓
【Step 4】再発防止策を記録
```

---

## 2. エラーの4大カテゴリ【最重要】

> **全てのエラーは、この4つのどれかに分類できる**

```
┌─────────────────────────────────────────────────────────────┐
│                    ソウルくんのエラー                        │
├─────────────┬─────────────┬─────────────┬─────────────────┤
│  カテゴリA   │  カテゴリB   │  カテゴリC   │   カテゴリD     │
│   脳みそ    │ 脳と手足の  │   手足自体   │  外部リソース    │
│   の問題    │  接続の問題  │   の問題    │    の問題       │
├─────────────┼─────────────┼─────────────┼─────────────────┤
│・意図理解   │・Toolが     │・Tool内の   │・ChatWork API  │
│・判断ミス   │ 呼ばれない  │ バグ        │・LLM API       │
│・確認過多   │・間違った   │・処理時間   │・DB接続        │
│・確認不足   │ Toolが      │ 超過        │・Pinecone      │
│            │ 呼ばれる    │・権限エラー │・Google API    │
└─────────────┴─────────────┴─────────────┴─────────────────┘
```

### カテゴリ判定フロー

```
エラー発生
    ↓
【Q1】外部サービス（ChatWork/LLM/DB/Pinecone等）は正常か？
  → NO → 【カテゴリD: 外部リソースの問題】
  → YES → 次へ
    ↓
【Q2】脳は正しいToolを選んでいるか？
  → NO → 【カテゴリB: 脳と手足の接続の問題】
  → YES → 次へ
    ↓
【Q3】Tool（手足）自体は正常に動作しているか？
  → NO → 【カテゴリC: 手足自体の問題】
  → YES → 次へ
    ↓
【Q4】脳の判断（意図理解、確認要否）は正しいか？
  → NO → 【カテゴリA: 脳みその問題】
  → YES → 原因不明（エスカレーション）
```

---

## 3. カテゴリ別・参照すべき設計書

### 3.1 カテゴリA: 脳みその問題

> **脳の理解・判断・推論に問題がある**

| 症状 | 原因の可能性 | 参照すべき設計書 | 参照セクション |
|------|-------------|-----------------|---------------|
| 確認が多すぎる | confidence閾値が低すぎる | 25章 | 第4章「LLM Brain憲法」 |
| 確認が少なすぎる | confidence閾値が高すぎる | 25章 | 第4章「LLM Brain憲法」 |
| 意図が取り違えられる | キーワードマッチの限界 | DESIGN_IMPLEMENTATION_GAP_REPORT.md | LLM Brain層 |
| 曖昧な言葉で勝手に判断 | 確認フローが不十分 | CLAUDE.md | セクション4「意図の取り違え検知」 |
| 推測でデータを作り出す | Truth順位の違反 | CLAUDE.md | セクション3「Truth順位」 |

**典型的な対処:**
- A-1) System Promptの調整
- A-2) confidence閾値の調整
- A-3) LLM Brain層の実装を進める（根本対処）

### 3.2 カテゴリB: 脳と手足の接続の問題

> **脳は理解しているが、正しいToolを呼べない**

| 症状 | 原因の可能性 | 参照すべき設計書 | 参照セクション |
|------|-------------|-----------------|---------------|
| Toolが呼ばれない | Tool定義がSystem Promptにない | 25章 | 第7章「Tool定義」 |
| 間違ったToolが呼ばれる | Tool名・説明が曖昧 | 25章 | 第7章「Tool定義」 |
| Toolのパラメータが間違う | パラメータスキーマの不備 | 25章 | 第7章「Tool定義」 |
| 新しいToolが認識されない | Tool登録漏れ | FEATURE_ADDITION_FRAMEWORK.md | セクション4「カテゴリB」 |
| 削除したToolが呼ばれる | Tool削除処理の不備 | TOOL_LIFECYCLE_POLICY.md | 全体 |

**典型的な対処:**
- B-1) Tool定義の修正（名前・説明の明確化）
- B-2) System Promptへの登録確認
- B-3) パラメータスキーマの修正

### 3.3 カテゴリC: 手足自体の問題

> **Toolは正しく呼ばれているが、Tool内でエラー**

| 症状 | 原因の可能性 | 参照すべき設計書 | 参照セクション |
|------|-------------|-----------------|---------------|
| 処理時間が長すぎる | ロジックの非効率 | 09章 | パフォーマンステスト |
| 権限エラーが出る | AccessControl判定 | CLAUDE.md | セクション7「権限レベル」 |
| データが取得できない | organization_idフィルタ漏れ | SECURITY_AUDIT_ORGANIZATION_ID.md | 全体 |
| Tool内で例外発生 | バグ | 該当ToolのソースコードReadme | - |
| 結果が不正確 | ロジックバグ | 該当機能の設計書 | - |

**典型的な対処:**
- C-1) Tool内のバグ修正
- C-2) 権限設定の確認・修正
- C-3) organization_idフィルタの追加

### 3.4 カテゴリD: 外部リソースの問題

> **外部サービスやインフラの障害**

| 症状 | 原因の可能性 | 参照すべき設計書 | 参照セクション |
|------|-------------|-----------------|---------------|
| ChatWork送信失敗 | ChatWork API障害/制限 | OPERATIONS_RUNBOOK.md | セクション2.4 |
| LLM応答なし | Anthropic API障害 | OPERATIONS_RUNBOOK.md | セクション2.3 |
| DB接続エラー | Cloud SQL障害 | OPERATIONS_RUNBOOK.md | セクション2.2 |
| ベクトル検索エラー | Pinecone障害 | OPERATIONS_RUNBOOK.md | セクション12.2 |
| ファイル取得エラー | Google Drive API障害 | OPERATIONS_RUNBOOK.md | セクション12.1 |
| 認証エラー | トークン期限切れ | OPERATIONS_RUNBOOK.md | セクション2 |

**典型的な対処:**
- D-1) 外部サービスのステータスページ確認
- D-2) フォールバック応答の有効化
- D-3) サービス復旧後に正常化確認

---

## 4. 4大カテゴリ早見表

| カテゴリ | 一言で言うと | 最初に見る設計書 |
|---------|-------------|-----------------|
| **A: 脳みそ** | 脳の理解・判断がおかしい | 25章、CLAUDE.md |
| **B: 脳と手足の接続** | 正しいToolが呼ばれない | 25章 第7章、TOOL_LIFECYCLE_POLICY.md |
| **C: 手足自体** | Tool内でエラー | 該当Toolの設計書、09章 |
| **D: 外部リソース** | 外部サービスが壊れてる | OPERATIONS_RUNBOOK.md |

---

## 5. 権限・セキュリティに関するエラー（カテゴリ横断）

> **セキュリティ問題は複数カテゴリにまたがることが多い**

| 症状 | カテゴリ | 原因の可能性 | 参照すべき設計書 |
|------|---------|-------------|-----------------|
| 「権限がありません」と言われる | C | AccessControlの判定 | CLAUDE.md セクション7 |
| 他組織のデータが見える | C | organization_idフィルタ漏れ | SECURITY_AUDIT_ORGANIZATION_ID.md |
| 機密情報がログに出る | C | ログマスキング不備 | OPERATIONS_RUNBOOK.md セクション4 |
| 権限外の操作を脳が許可 | A | 脳の判断ミス | 25章 第4章 |

---

## 6. よくあるエラーパターンと対処

### パターン1: 確認フローが多発する【カテゴリA】

**症状:** 「〇〇でいいですか？」が過度に出現

**原因特定フロー:**

```
1. PROGRESS.md で過去の類似バグを検索
   → v10.48.6〜v10.48.11 の修正履歴を確認

2. proactive-monitor/lib/brain/decision.py を確認
   → confidence 閾値の設定を確認

3. 25章 第4章「LLM Brain憲法」を参照
   → 設計意図を再確認
```

**対処パターン:**
- A) confidence 閾値を調整
- B) 特定パターンをハードコード例外に追加（一時対処）
- C) LLM Brain 実装を進める（根本対処）

---

### パターン2: 他組織のデータが見えた【カテゴリC】

**症状:** 「他の会社のタスクが見えた」と報告

**原因特定フロー:**

```
1. OPERATIONS_RUNBOOK.md セクション3「権限事故対応」を開く
   → 即座にサービス停止を判断

2. SECURITY_AUDIT_ORGANIZATION_ID.md を確認
   → 該当テーブルのorganization_idフィルタ状況を確認

3. 監査ログを確認（OPERATIONS_RUNBOOK.md セクション4）
   → 影響範囲を特定
```

**対処パターン:**
- A) 該当クエリにorganization_idフィルタを追加
- B) RLSポリシーを有効化（Phase 4移行時）

---

### パターン3: LLM APIがエラーを返す【カテゴリD】

**症状:** Claude APIが断続的にタイムアウト

**原因特定フロー:**

```
1. Anthropicステータスページを確認
   → https://status.anthropic.com/

2. OPERATIONS_RUNBOOK.md セクション2.3 を開く
   → フォールバック有効化手順を確認

3. Cloud Monitoringでエラー率を確認
```

**対処パターン:**
- A) フォールバック応答を有効化
- B) ユーザーへの説明メッセージを設定
- C) API復旧後にフォールバック解除

---

## 7. 設計書が古い可能性の検知

### チェックリスト

設計書を参照する前に、以下を確認：

- [ ] この設計書の「最終更新日」はいつか？
- [ ] DESIGN_COVERAGE_MATRIX.md でこの項目のSoTは確認したか？
- [ ] 実装コードと設計書の内容は一致しているか？
- [ ] PROGRESS.md に関連する最近の変更はないか？

### 乖離が疑われる場合

```
1. DESIGN_IMPLEMENTATION_GAP_REPORT.md を確認
   → 該当領域の実装度を確認

2. git log で該当ファイルの変更履歴を確認
   → git log --oneline docs/該当ファイル.md

3. 不明な場合は #dev チャンネルで確認
```

---

## 8. 再発防止の記録方法

### バグ修正後の必須アクション

1. **PROGRESS.md に修正内容を記録**
   ```markdown
   ### v10.XX.X（YYYY-MM-DD）
   - fix: [症状の簡潔な説明]
     - 原因: [根本原因]
     - 対処: [修正内容]
     - 参照: [関連する設計書]
   ```

2. **設計書の更新が必要な場合**
   - 該当設計書を更新
   - DESIGN_COVERAGE_MATRIX.md を更新
   - このTROUBLESHOOTING_FRAMEWORK.md にパターンを追加

3. **テストケースの追加**
   - 09章のテスト戦略に従ってテストを追加
   - プロンプト回帰テストに該当ケースを追加（脳判断の場合）

---

## 9. エスカレーションパス

| 状況 | エスカレーション先 | 連絡方法 |
|------|------------------|---------|
| 通常のバグ | Tech Lead | #dev チャンネル |
| セキュリティ関連 | CTO + Tech Lead | 即座にDM |
| 本番障害 | オンコール担当 | PagerDuty |
| データ漏洩の疑い | 経営層 | 即座に電話 |

---

## 関連ドキュメント

| ドキュメント | 用途 |
|-------------|------|
| OPERATIONS_RUNBOOK.md | 具体的な対処手順 |
| DESIGN_IMPLEMENTATION_GAP_REPORT.md | 設計と実装の乖離 |
| SECURITY_AUDIT_ORGANIZATION_ID.md | セキュリティ監査結果 |
| PROGRESS.md | 過去の修正履歴 |
| TOOL_LIFECYCLE_POLICY.md | Tool（手足）の追加・削除ルール |
| 25章（25_llm_native_brain_architecture.md） | 脳と手足の接続設計 |

---

## 更新履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-30 | 初版作成 |
| 2026-01-30 | 4大カテゴリ（脳/接続/手足/外部リソース）を明確化、カテゴリ判定フロー追加 |
