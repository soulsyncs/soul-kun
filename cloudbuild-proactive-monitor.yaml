# =============================================================================
# Cloud Build è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šï¼ˆproactive-monitorï¼‰
# =============================================================================
#
# ç›®çš„:
#   mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã«è‡ªå‹•ã§proactive-monitorã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
#
# ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼ˆGCPã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è¨­å®šãŒå¿…è¦ï¼‰:
#   - åå‰: proactive-monitor-auto-deploy
#   - ã‚¤ãƒ™ãƒ³ãƒˆ: Push to a branch
#   - ãƒ–ãƒ©ãƒ³ãƒ: ^main$
#   - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚£ãƒ«ã‚¿: proactive-monitor/**, lib/brain/**, lib/feature_flags.py
#   - æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«: cloudbuild-proactive-monitor.yaml
#
# v10.53.0: åˆç‰ˆä½œæˆï¼ˆå¤§è¦æ¨¡ä¿®ç¹•å¯¾å¿œï¼‰
# =============================================================================

steps:
  # =============================================================================
  # Step 1: lib/ åŒæœŸãƒã‚§ãƒƒã‚¯
  # =============================================================================
  - name: 'gcr.io/cloud-builders/git'
    id: 'sync-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ” lib/ åŒæœŸãƒã‚§ãƒƒã‚¯ (proactive-monitor)..."

        # proactive-monitor/lib/brain/ ã¨ lib/brain/ ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯
        if ! diff -rq lib/brain proactive-monitor/lib/brain --exclude='__pycache__' --exclude='*.pyc' > /dev/null 2>&1; then
          echo "âŒ lib/brain/ ãŒåŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼"
          echo "   ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
          echo ""
          echo "ä¿®æ­£æ–¹æ³•:"
          echo "   make sync"
          exit 1
        fi

        echo "âœ… lib/ ã¯åŒæœŸã•ã‚Œã¦ã„ã¾ã™"

  # =============================================================================
  # Step 2: proactive-monitor ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
  # =============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-proactive-monitor'
    entrypoint: 'gcloud'
    args:
      - 'functions'
      - 'deploy'
      - 'proactive-monitor'
      - '--source=proactive-monitor'
      - '--runtime=python311'
      - '--trigger-http'
      - '--region=asia-northeast1'
      - '--memory=512MB'
      - '--timeout=540s'
      - '--no-allow-unauthenticated'
      - '--set-env-vars=USE_BRAIN_ARCHITECTURE=true,LOG_EXECUTION_ID=true'
    waitFor: ['sync-check']

  # =============================================================================
  # Step 3: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
  # =============================================================================
  - name: 'gcr.io/cloud-builders/curl'
    id: 'notify'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… proactive-monitor ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ã‚³ãƒŸãƒƒãƒˆ: $COMMIT_SHA"
        echo "ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"
        echo ""
    waitFor: ['deploy-proactive-monitor']

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10åˆ†ï¼‰
timeout: '600s'

# ãƒ­ã‚°è¨­å®š
options:
  logging: CLOUD_LOGGING_ONLY
