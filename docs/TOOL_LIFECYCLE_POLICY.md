# Tool（手足）ライフサイクルポリシー

**作成日:** 2026-01-30
**目的:** Tool（手足）の追加・拡張・削除を安全かつ確実に行う

---

## Document Contract（SoT宣言）

| 項目 | 内容 |
|------|------|
| **この文書の役割** | Tool（手足）のライフサイクル管理ルール |
| **書くこと** | Tool追加/拡張/削除の手順、安全確認チェックリスト、ロールバック手順 |
| **書かないこと** | 個別Toolの仕様（→25章、各機能設計書） |
| **SoT（この文書が正）** | Toolライフサイクルの全プロセス |
| **Owner** | Tech Lead（連絡先: #dev チャンネル） |
| **更新トリガー** | Toolの追加/削除実績時、プロセス変更時 |

---

## 1. なぜこのポリシーが必要か

### 1.1 間違った削除が起きるとどうなるか

```
【最悪のシナリオ】
正しいToolを間違って削除
    ↓
脳が「Toolがない」と判断
    ↓
ユーザーの依頼に応えられない
    ↓
「ソウルくんが壊れた」と報告
    ↓
復旧作業（数時間〜数日）
```

### 1.2 このポリシーで防ぐこと

| 防ぐこと | 方法 |
|---------|------|
| **正しいToolの誤削除** | 多段階確認、使用状況分析 |
| **削除後の動作不良** | 段階的削除（非推奨→削除） |
| **復旧不能** | ロールバック手順の事前準備 |
| **他機能への影響** | 依存関係の事前分析 |

---

## 2. Toolのライフサイクル

```
【ライフサイクル全体像】

  追加                拡張              非推奨            削除
┌──────┐          ┌──────┐          ┌──────┐         ┌──────┐
│ NEW  │ ──────→ │ACTIVE│ ──────→ │DEPR. │ ──────→ │REMOVED│
└──────┘          └──────┘          └──────┘         └──────┘
                      │                  │
                      │                  │
                      └──────────────────┘
                      問題発覚時は戻せる
```

| ステータス | 説明 | 脳からの呼び出し |
|-----------|------|-----------------|
| **NEW** | 新規追加（テスト中） | 制限付き |
| **ACTIVE** | 本番稼働中 | 可能 |
| **DEPRECATED** | 非推奨（削除予定） | 警告付きで可能 |
| **REMOVED** | 削除済み | 不可 |

---

## 3. Tool追加の手順

### 3.1 追加フロー

```
【Step 1】Tool設計
    ↓
【Step 2】実装 + ユニットテスト
    ↓
【Step 3】脳への登録（Tool定義追加）
    ↓
【Step 4】統合テスト（脳→Tool接続）
    ↓
【Step 5】プロンプト回帰テスト追加
    ↓
【Step 6】本番デプロイ（ACTIVE化）
```

### 3.2 追加時のチェックリスト

- [ ] Tool名は明確で他Toolと区別できるか
- [ ] Tool説明は脳が理解できる文章か
- [ ] パラメータスキーマは正確か
- [ ] 25章 第7章「Tool定義」に登録したか
- [ ] FEATURE_ADDITION_FRAMEWORK.md の手順を実行したか
- [ ] ユニットテストを追加したか（カバレッジ80%以上）
- [ ] プロンプト回帰テストを追加したか
- [ ] DESIGN_COVERAGE_MATRIX.md を更新したか

**詳細:** → `FEATURE_ADDITION_FRAMEWORK.md` セクション4「カテゴリB: Tool追加」

---

## 4. Tool拡張の手順

### 4.1 拡張の種類

| 種類 | 説明 | 例 |
|------|------|-----|
| **パラメータ追加** | 新しいオプション引数 | `send_message`に`priority`追加 |
| **機能追加** | 既存Toolに新機能 | `task_add`に繰り返し設定追加 |
| **パフォーマンス改善** | 処理速度向上 | キャッシュ導入 |

### 4.2 拡張時のルール

| ルール | 理由 |
|--------|------|
| **後方互換性を維持** | 既存の呼び出しが壊れない |
| **新パラメータはオプション** | 必須にすると既存が壊れる |
| **デフォルト値を設定** | 未指定時の挙動を保証 |

### 4.3 拡張時のチェックリスト

- [ ] 既存のTool呼び出しが壊れないか確認
- [ ] 新パラメータにデフォルト値があるか
- [ ] Tool定義（25章）を更新したか
- [ ] 既存のテストがパスするか
- [ ] 新機能のテストを追加したか

---

## 5. Tool削除の手順【最重要・絶対に間違えない】

> **⚠️ 削除は取り消せない操作。この手順を必ず守ること。**

### 5.1 削除前の絶対確認事項

#### ■ 削除してよいToolの条件（全て満たす必要あり）

| # | 条件 | 確認方法 |
|---|------|---------|
| 1 | **6ヶ月以上使用されていない** | ログ/監査記録で確認 |
| 2 | **代替となるToolがある**（または不要と判断） | 機能分析 |
| 3 | **依存している他Toolがない** | コード検索 |
| 4 | **ユーザーから使用報告がない** | フィードバック確認 |
| 5 | **削除承認を得ている** | Tech Lead + カズさん承認 |

#### ■ 削除してはいけないToolの条件（1つでも該当したら削除不可）

| # | 条件 | 理由 |
|---|------|------|
| 1 | **現在ACTIVEで使用中** | ユーザー影響 |
| 2 | **代替Toolがない** | 機能喪失 |
| 3 | **他Toolが依存している** | 連鎖障害 |
| 4 | **過去1ヶ月以内に呼ばれた** | まだ使われている |
| 5 | **カズさんの承認がない** | 最終判断権限 |

### 5.2 削除フロー（3段階・必ず守る）

```
【絶対に守る削除フロー】

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase 1: 削除候補の特定と分析（1週間）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ┌─────────────────────────────────────────────┐
  │ 1. 削除理由の明文化                          │
  │ 2. 使用状況の分析（過去6ヶ月のログ）          │
  │ 3. 依存関係の分析（コード検索）               │
  │ 4. 代替手段の確認                            │
  │ 5. 影響範囲の特定                            │
  └─────────────────────────────────────────────┘
                        ↓
              【承認ゲート1】
         Tech Lead + カズさんの承認
                        ↓

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase 2: 非推奨化（DEPRECATED）（2週間）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ┌─────────────────────────────────────────────┐
  │ 1. ToolステータスをDEPRECATEDに変更           │
  │ 2. 脳に「このToolは非推奨」と通知             │
  │ 3. 呼び出し時に警告ログ出力                   │
  │ 4. 代替Toolへの誘導メッセージ設定             │
  │ 5. 2週間の観察期間                           │
  └─────────────────────────────────────────────┘
                        ↓
            【観察期間中に確認】
    - 警告ログが出ていないか？（出ていたら中止）
    - ユーザーから問い合わせがないか？
                        ↓
              【承認ゲート2】
           削除実行の最終承認
                        ↓

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase 3: 削除実行（REMOVED）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ┌─────────────────────────────────────────────┐
  │ 1. Tool定義から削除（25章）                   │
  │ 2. 実装コードを削除（またはアーカイブ）        │
  │ 3. テストコードを削除（またはアーカイブ）      │
  │ 4. 関連設計書を更新                          │
  │ 5. 削除記録を本ファイルに追加                 │
  └─────────────────────────────────────────────┘
```

### 5.3 Phase 1: 削除候補の分析

#### 使用状況分析テンプレート

```markdown
## Tool削除分析: [Tool名]

### 1. 基本情報
- Tool名: [名前]
- 追加日: [日付]
- 最終使用日: [日付]
- 作成者: [名前]

### 2. 削除理由
[なぜ削除したいのか、明確に記載]

### 3. 使用状況（過去6ヶ月）
| 月 | 呼び出し回数 | 成功率 | 主な呼び出し元 |
|----|-------------|--------|--------------|
| [月] | [回] | [%] | [どこから] |

### 4. 依存関係
| 依存元 | 依存内容 | 削除時の影響 |
|--------|---------|-------------|
| [なし/あれば記載] | | |

### 5. 代替手段
- 代替Tool: [あり/なし]
- 代替方法: [具体的に]
- 移行手順: [必要な場合]

### 6. 影響範囲
- 影響を受けるユーザー: [人数/なし]
- 影響を受ける機能: [機能名/なし]

### 7. リスク評価
| リスク | 可能性 | 影響度 | 対策 |
|--------|--------|--------|------|
| 間違って使用中のToolを削除 | [高/中/低] | [高/中/低] | [対策] |

### 8. 承認
- [ ] Tech Lead承認: [名前] [日付]
- [ ] カズさん承認: [名前] [日付]
```

### 5.4 Phase 2: 非推奨化の実装

#### Tool定義に警告を追加

```python
# 25章 Tool定義に追加
{
    "name": "old_tool_name",
    "description": "【非推奨】このToolは2026-03-01に削除予定です。代わりに new_tool_name を使用してください。",
    "deprecated": True,
    "deprecated_date": "2026-02-15",
    "removal_date": "2026-03-01",
    "replacement": "new_tool_name",
    # ... 既存の定義
}
```

#### 呼び出し時の警告ログ

```python
def execute_tool(tool_name, params):
    tool_def = get_tool_definition(tool_name)

    if tool_def.get("deprecated"):
        logger.warning(
            f"⚠️ DEPRECATED TOOL CALLED: {tool_name}"
            f" - Removal date: {tool_def.get('removal_date')}"
            f" - Replacement: {tool_def.get('replacement')}"
        )
        # 監査ログにも記録
        audit_log.record(
            action="DEPRECATED_TOOL_CALL",
            tool_name=tool_name,
            removal_date=tool_def.get('removal_date')
        )

    # 通常の実行
    return tool_def["handler"](params)
```

### 5.5 Phase 3: 削除実行チェックリスト

> **このチェックリストを全て確認してから削除する**

#### 削除前の最終確認（全てチェック必須）

- [ ] Phase 1の分析が完了している
- [ ] Tech Leadの承認を得ている
- [ ] **カズさんの承認を得ている**（必須）
- [ ] 2週間以上DEPRECATEDステータスだった
- [ ] DEPRECATED期間中に呼び出しがなかった
- [ ] 代替Toolが正常に動作している（該当する場合）
- [ ] ロールバック手順を準備した

#### 削除実行

- [ ] 25章のTool定義から削除
- [ ] System Promptから該当Toolを削除
- [ ] 実装コードを`_archived/tools/`に移動（削除ではなくアーカイブ）
- [ ] テストコードを`_archived/tests/`に移動
- [ ] DESIGN_COVERAGE_MATRIX.md を更新
- [ ] 本ファイルの「削除済みTool一覧」に追加

#### 削除後の確認

- [ ] 脳が削除済みToolを呼び出そうとしていないか確認
- [ ] 他のToolが正常に動作しているか確認
- [ ] エラーログに異常がないか確認

---

## 6. ロールバック手順

### 6.1 削除を取り消す場合

```
【ロールバック手順】

1. アーカイブからコードを復元
   git checkout HEAD~1 -- path/to/archived/tool.py

2. Tool定義を復元（25章）

3. System Promptを復元

4. テストを実行して動作確認

5. 本番デプロイ

6. 削除記録に「ロールバック」を追記
```

### 6.2 ロールバックが必要なケース

| ケース | 判断基準 | 対応 |
|--------|---------|------|
| 削除後にエラー多発 | エラー率が削除前の2倍以上 | 即座にロールバック |
| ユーザーから「使えない」報告 | 1件でも報告あり | 調査後、必要ならロールバック |
| 代替Toolが不十分と判明 | 機能不足が判明 | 代替Tool改修またはロールバック |

---

## 7. 削除記録

### 7.1 削除済みTool一覧

| # | Tool名 | 削除日 | 理由 | 代替Tool | 承認者 |
|---|--------|--------|------|---------|--------|
| - | （まだなし） | - | - | - | - |

### 7.2 ロールバック履歴

| # | Tool名 | 削除日 | ロールバック日 | 理由 |
|---|--------|--------|---------------|------|
| - | （まだなし） | - | - | - |

---

## 8. 間違い防止のルール

### 8.1 絶対に守るルール

| # | ルール | 理由 |
|---|--------|------|
| 1 | **1度に削除するToolは1つまで** | 問題切り分けのため |
| 2 | **削除前に必ずカズさん承認** | 最終判断権限 |
| 3 | **コードは削除ではなくアーカイブ** | ロールバック可能にするため |
| 4 | **非推奨期間は最低2週間** | 使用状況の観察 |
| 5 | **削除後1週間は監視強化** | 問題の早期発見 |

### 8.2 やってはいけないこと

| NG行為 | 理由 |
|--------|------|
| **ACTIVEなToolをいきなり削除** | ユーザー影響が大きい |
| **承認なしで削除** | 判断ミスのリスク |
| **コードを完全削除** | ロールバックできなくなる |
| **複数Toolを同時削除** | 問題の切り分けができない |
| **非推奨期間をスキップ** | 使用状況が把握できない |

---

## 9. 関連ドキュメント

| ドキュメント | 参照内容 |
|-------------|---------|
| FEATURE_ADDITION_FRAMEWORK.md | Tool追加の詳細手順 |
| 25章（25_llm_native_brain_architecture.md） | Tool定義の仕様 |
| DESIGN_DEPRECATION_POLICY.md | 設計書の廃止ポリシー |
| TROUBLESHOOTING_FRAMEWORK.md | Tool問題のトラブルシュート |
| DESIGN_COVERAGE_MATRIX.md | SoT管理 |

---

## 更新履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-30 | 初版作成 |

---

**このファイルについての質問は、Tech Leadに連絡してください。**
