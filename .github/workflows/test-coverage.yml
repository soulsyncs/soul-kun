name: Test Coverage

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  # =====================================================
  # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬ï¼ˆ80%åŸºæº–ï¼‰
  # =====================================================
  #
  # 09ç«  å®Ÿè£…è¦ç´„ã§å®šç¾©ã•ã‚ŒãŸ80%ã‚«ãƒãƒ¬ãƒƒã‚¸åŸºæº–ã‚’
  # CI/CDã§è‡ªå‹•æ¤œè¨¼ã™ã‚‹ã€‚
  #
  # å‚ç…§: docs/09_implementation_standards.md 11ç« 
  # =====================================================
  coverage:
    name: Test Coverage Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio

          # å„Cloud Functionsã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

          # ãƒ†ã‚¹ãƒˆç”¨ã®è¿½åŠ ä¾å­˜é–¢ä¿‚
          # - httpx: HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ†ã‚¹ãƒˆç”¨
          # - fakeredis: Redisãƒ¢ãƒƒã‚¯ç”¨
          # - freezegun: æ™‚åˆ»ãƒ¢ãƒƒã‚¯ç”¨ï¼ˆtest_brain_core.pyç­‰ã§ä½¿ç”¨ï¼‰
          pip install httpx fakeredis freezegun

      - name: Run tests with coverage
        run: |
          echo "ğŸ§ª Running tests with coverage measurement..."
          echo ""

          # ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          # - lib/: å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒª
          # - chatwork-webhook/: Webhookå‡¦ç†
          # - sync-chatwork-tasks/: ã‚¿ã‚¹ã‚¯åŒæœŸ
          # - remind-tasks/: ãƒªãƒã‚¤ãƒ³ãƒ‰
          # - api/: FastAPIï¼ˆæ–°è¦APIï¼‰

          pytest tests/ \
            --cov=lib \
            --cov-report=term-missing \
            --cov-report=html:coverage_html \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=80 \
            -v \
            --tb=short \
            --ignore-glob='**/embedding.py' \
            || COVERAGE_FAILED=1

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "${COVERAGE_FAILED:-0}" = "1" ]; then
            echo "âŒ Coverage below 80% threshold!"
            echo ""
            echo "å¯¾å¿œæ–¹æ³•:"
            echo "  1. ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèª: coverage_html/index.html"
            echo "  2. ãƒ†ã‚¹ãƒˆãŒä¸è¶³ã—ã¦ã„ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç‰¹å®š"
            echo "  3. ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ”¹å–„"
            echo ""
            echo "å‚ç…§: docs/09_implementation_standards.md ç¬¬11ç« "
            exit 1
          fi
          echo "âœ… Coverage meets 80% threshold!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            coverage_html/
            coverage.xml
          retention-days: 7

  # =====================================================
  # organization_id ãƒ•ã‚£ãƒ«ã‚¿ãƒ†ã‚¹ãƒˆ
  # =====================================================
  #
  # Phase 4ï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆï¼‰æº–å‚™ã®ãŸã‚ã€
  # organization_idã«ã‚ˆã‚‹ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ãŒæ­£ã—ã
  # æ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚
  #
  # å‚ç…§: docs/SECURITY_AUDIT_ORGANIZATION_ID.md
  # =====================================================
  tenant-isolation:
    name: Tenant Isolation Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

      - name: Run tenant isolation tests
        run: |
          echo "ğŸ” Running tenant isolation tests..."
          echo ""
          echo "ãƒ†ã‚¹ãƒˆå¯¾è±¡:"
          echo "  - organization_idã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†é›¢"
          echo "  - ã‚¯ãƒ­ã‚¹ãƒ†ãƒŠãƒ³ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã®æ‹’å¦"
          echo "  - RLSãƒãƒªã‚·ãƒ¼ã®æ¤œè¨¼ï¼ˆPhase 4æº–å‚™ï¼‰"
          echo ""

          if [ -d "tests/tenant_isolation" ]; then
            pytest tests/tenant_isolation/ -v --tb=short -m "tenant"
          else
            echo "âš ï¸ tests/tenant_isolation/ not found. Skipping tenant isolation tests."
            echo "   Phase 4é–‹å§‹å‰ã«ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚"
            echo "   å‚ç…§: docs/SECURITY_AUDIT_ORGANIZATION_ID.md"
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Tenant isolation check completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # =====================================================
  # ã‚³ã‚¹ãƒˆä¸Šé™ãƒ†ã‚¹ãƒˆ
  # =====================================================
  #
  # LLM APIå‘¼ã³å‡ºã—ã®ã‚³ã‚¹ãƒˆãŒæƒ³å®šä¸Šé™ã‚’è¶…ãˆãªã„ã“ã¨ã‚’æ¤œè¨¼ã€‚
  # 25ç«  1.4ç¯€ã§å®šç¾©ã•ã‚ŒãŸã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Šã«åŸºã¥ãã€‚
  #
  # å‚ç…§: docs/25_llm_brain_design.md 1.4
  # =====================================================
  cost-limit:
    name: Cost Limit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check cost limit configurations
        run: |
          echo "ğŸ’° Checking cost limit configurations..."
          echo ""

          # =====================================================
          # ã‚³ã‚¹ãƒˆä¸Šé™è¨­å®šã®ç¢ºèª
          # =====================================================
          #
          # æ¤œè¨¼é …ç›®:
          #   1. DAILY_COST_LIMIT_USD ç’°å¢ƒå¤‰æ•°ã®å­˜åœ¨
          #   2. æœˆé–“ä¸Šé™ã®è¨­å®š
          #   3. ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤ã®è¨­å®š
          #
          # 25ç« ï¼ˆ25_llm_native_brain_architecture.mdï¼‰1.4ç¯€ã®è¦‹ç©ã‚‚ã‚Š:
          #   - ç¤¾å“¡40å Ã— æ—¥10å› = 400ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥
          #   - ä¸Šé™: æœˆ$150ï¼ˆPhase 2æƒ³å®šï¼‰
          # =====================================================

          ERRORS_FOUND=0

          # ã‚³ã‚¹ãƒˆé–¢é€£ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          echo "ğŸ“‹ Checking for cost limit configurations..."

          # ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç¢ºèª
          if [ -f ".env.example" ]; then
            if grep -q "DAILY_COST_LIMIT" .env.example 2>/dev/null; then
              echo "âœ… DAILY_COST_LIMIT found in .env.example"
            else
              echo "âš ï¸ DAILY_COST_LIMIT not found in .env.example"
              echo "   æ¨å¥¨: DAILY_COST_LIMIT_USD=5.0 ã‚’è¿½åŠ "
            fi
          fi

          # ã‚³ã‚¹ãƒˆç›£è¦–ã‚³ãƒ¼ãƒ‰ã®å­˜åœ¨ç¢ºèª
          if grep -rq "cost_limit\|COST_LIMIT\|daily_cost" lib/ 2>/dev/null || \
             grep -rq "cost_limit\|COST_LIMIT\|daily_cost" api/ 2>/dev/null; then
            echo "âœ… Cost limit logic found in codebase"
          else
            echo "âš ï¸ Cost limit logic not found"
            echo "   Phase 4ã¾ã§ã«å®Ÿè£…ãŒå¿…è¦"
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Cost limit configuration check completed!"
          echo ""
          echo "ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€‘"
          echo "  - ãƒ†ã‚¹ãƒˆåŸºç›¤: âœ… æº–å‚™å®Œäº†ï¼ˆã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼‰"
          echo "  - ãƒ†ã‚¹ãƒˆä»•æ§˜: âœ… å®šç¾©æ¸ˆï¼ˆ09ç«  11.8ç¯€ï¼‰"
          echo "  - å®Ÿè£…: â³ Phase 4ã§å®Ÿè£…äºˆå®š"
          echo ""
          echo "ã‚³ã‚¹ãƒˆä¸Šé™ã®è©³ç´°ã¯ä»¥ä¸‹ã‚’å‚ç…§:"
          echo "  - docs/25_llm_native_brain_architecture.md 1.4ç¯€"
          echo "  - docs/09_implementation_standards.md 11.8ç¯€"
          echo "  - docs/OPERATIONS_RUNBOOK.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³5"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # =====================================================
  # æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  # =====================================================
  coverage-gate:
    name: Coverage Gate
    runs-on: ubuntu-latest
    needs: [coverage, tenant-isolation, cost-limit]
    steps:
      - name: All coverage checks passed
        run: |
          echo "âœ… All coverage and quality checks passed!"
          echo ""
          echo "Checks completed:"
          echo "  - Test coverage (80% threshold)"
          echo "  - Tenant isolation tests"
          echo "  - Cost limit configuration"
