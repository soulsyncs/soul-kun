# ソウルくん実装状況

このファイルには、設計書に対する実装の進捗状況を詳細に記録します。

**最終更新:** 2026-01-19
**管理者:** Claude Code（自動記録）
**設計書バージョン:** v10.1.4（Phase 1-B実装ガイド）

---

## 全体進捗サマリー

| Phase | 進捗率 | 状況 | 最終更新 |
|-------|--------|------|----------|
| Phase 1: タスク管理基盤 | 100% | ✅ 完了 | 2026-01-03 |
| Phase 1-B: タスク検知・監視 | 95% | ✅ 本番稼働 | 2026-01-19 |
| Phase 2: AI応答・評価機能 | 100% | ✅ 完了 | 2025-12 |
| Phase 2.5: 目標達成支援 | 30% | 🔄 実装中 | - |
| Phase 3: ナレッジ検索 | 0% | ❌ 未着手 | - |
| Phase 3.5: 組織階層連携 | 40% | 🔄 実装中 | 2026-01-18 |
| Phase C: 会議系 | 0% | ❌ 未着手 | - |
| Phase 4: BPaaS機能 | 0% | ❌ 未着手 | - |

---

## Phase 1: タスク管理基盤（ChatWork連携）

### 概要

| 項目 | 内容 |
|------|------|
| 設計書 | `docs/05_phase_1b_task_detection.md` |
| 実装方式 | Flask + Cloud Functions（設計書はFastAPIだが変更） |
| 主要ファイル | `chatwork-webhook/main.py`, `remind-tasks/main.py`, `sync-chatwork-tasks/main.py` |
| 初期コミット | 2026-01-02 `674f4d3` |
| 最新バージョン | v10.10.0 |

### カテゴリ①：タスク作成・完了（ChatWork連携）

| 機能 | 設計書 | 実装状況 | コミット | ファイル:行番号 | 備考 |
|------|--------|---------|---------|-----------------|------|
| 【1-1】「タスク作成して」 | ✅ 完了 | ✅ 実装済み | `674f4d3` | chatwork-webhook/main.py:1964-2161 | `handle_chatwork_task_create()` |
| 【1-2】「完了」 | ✅ 完了 | ✅ 実装済み | `674f4d3` | chatwork-webhook/main.py:2450-2516 | `handle_chatwork_task_complete()` |
| 【1-3】手動タスク追加検知 | ✅ 完了 | ✅ 実装済み | `3260ef3` | sync-chatwork-tasks/main.py:6744-7400 | `sync_chatwork_tasks()` |
| 【1-4】手動タスク完了検知 | ✅ 完了 | ✅ 実装済み | `3260ef3` | sync-chatwork-tasks/main.py:6950-6989 | 同期時検知 |

**詳細実装記録:**

#### 【1-1】タスク作成機能
- **初期実装:** 2026-01-02 `674f4d3`
- **処理フロー:** `ai_commander()` (3388行) → `execute_action()` (3567行) → `handle_chatwork_task_create()` (1964行)
- **主要関数:**
  - `get_chatwork_account_id_by_name()` (406-426行): 担当者名からaccount_id解決
  - `create_chatwork_task()` (428-459行): ChatWork API呼び出し
  - `save_chatwork_task_to_db()` (461-486行): DB保存
- **追加機能:** 不足項目時はFirestore `pending_tasks`で会話継続

#### 【1-2】タスク完了機能
- **初期実装:** 2026-01-02 `674f4d3`
- **処理フロー:** `handle_chatwork_task_complete()` (2450行)
- **主要関数:**
  - `search_tasks_from_db()` (2020-2063行): タスク検索
  - `complete_chatwork_task()` (1994-2017行): ChatWork API完了
  - `update_task_status_in_db()` (2066-2082行): DB更新

#### 【1-3】手動タスク追加検知
- **初期実装:** 2026-01-03 `3260ef3`
- **スケジュール:** Cloud Scheduler 1時間ごと（v10.3.4で30分から変更）
- **処理フロー:** `sync_chatwork_tasks()` (6744行)
- **追加機能:**
  - 期限変更検知 `detect_and_report_limit_changes()` (5805-5925行)
  - 管理部報告＋担当者への理由質問

#### 【1-4】手動タスク完了検知
- **初期実装:** 2026-01-03 `3260ef3`
- **変更:** v10.7.0で個別通知廃止、日次サマリーに統合

---

### カテゴリ②：タスク検索のセキュリティ

| 機能 | 設計書 | 実装状況 | コミット | ファイル:行番号 | 備考 |
|------|--------|---------|---------|-----------------|------|
| 【2-1】タスク検索機能 | ✅ 完了 | ✅ 実装済み | `674f4d3` | chatwork-webhook/main.py:2233-2295 | `handle_chatwork_task_search()` |
| 【2-2】自分のタスクのみ表示 | ✅ 完了 | ✅ 実装済み | `674f4d3` | remind-tasks/main.py:1243-1286 | `search_tasks_from_db()` |
| 【2-3】階層セキュリティ | ✅ 完了 | ❌ 未実装 | - | - | Phase 3.5連携待ち |
| 【2-4】管理部は全権限 | ✅ 完了 | ✅ 実装済み | `674f4d3` | chatwork-webhook/main.py:4549-4551 | `is_admin()` 固定ID判定 |
| 【2-5】Phase 3.5連動 | ✅ 完了 | ❌ 未実装 | - | - | API連携未実装 |

**詳細実装記録:**

#### 【2-3】階層セキュリティ（未実装）
- **課題:** `chatwork_tasks`テーブルに`department_id`カラムなし
- **Phase 3.5準備:** `api/app/api/v1/organizations.py`に組織階層APIは実装済み
- **必要作業:**
  1. chatwork_tasksテーブルに`organization_id`, `department_id`追加
  2. `compute_accessible_departments()`との連携

#### 【2-4】管理部は全権限
- **実装方式:** `ADMIN_ACCOUNT_ID = "1728974"`との単純比較
- **制限:** 複数管理者対応不可
- **将来対応:** Phase 4で`user_departments`経由の判定に変更予定

---

### カテゴリ③：事前リマインド機能

| 機能 | 設計書 | 実装状況 | コミット | ファイル:行番号 | 備考 |
|------|--------|---------|---------|-----------------|------|
| 【3-1】3日前リマインド | ✅ 完了 | ✅ 実装済み | `ffbfabf`, `848169a` | remind-tasks/main.py:5264-5265 | reminder_type='three_days' |
| 【3-2】前日リマインド | ✅ 完了 | ✅ 実装済み | `ffbfabf`, `848169a` | remind-tasks/main.py:5262-5263 | reminder_type='tomorrow' |
| 【3-3】当日リマインド | ✅ 完了 | ✅ 実装済み | `ffbfabf`, `848169a` | remind-tasks/main.py:5260-5261 | reminder_type='today' |
| 【3-4】送信先制限 | ✅ 完了 | ✅ 実装済み | `848169a` | remind-tasks/main.py:5340-5352 | 担当者DMのみ |
| 【3-5】二重送信防止 | ✅ 完了 | ✅ 実装済み | `ffbfabf` | remind-tasks/main.py:5270-5279 | task_reminders UNIQUE |

**詳細実装記録:**

#### v10.6.0 DM基盤リマインド（2026-01-18 `848169a`）
- **大改修内容:**
  - グループチャット送信を廃止 → 担当者DMに統一
  - 担当者ごとにタスクを集約して1通で送信
  - テストガード実装（REMINDER_TEST_MODE）
  - メッセージフォーマット改善（🔴今日/🟡明日/🟢3日後）

---

### カテゴリ④：期限ガードレール（追加時アラート）

| 機能 | 設計書 | 実装状況 | コミット | ファイル:行番号 | 備考 |
|------|--------|---------|---------|-----------------|------|
| 【4-1】当日期限アラート | ✅ 完了 | ✅ 実装済み | `6ccb50b` | chatwork-webhook/main.py:1785-1823 | v10.3.0 |
| 【4-2】明日期限アラート | ✅ 完了 | ✅ 実装済み | `6ccb50b` | chatwork-webhook/main.py:1785-1823 | v10.3.0 |
| 【4-3】アラートメッセージ | ✅ 完了 | ✅ 実装済み | `6ccb50b` | chatwork-webhook/main.py:1826-1874 | v10.3.0 |
| 【4-4】期限編集の案内 | ✅ 完了 | ✅ 実装済み | `6ccb50b` | chatwork-webhook/main.py:1869 | v10.3.0 |

**詳細実装記録:**

#### v10.3.0 期限ガードレール実装（2026-01-18 `6ccb50b`）
- **追加関数:**
  - `check_deadline_proximity()` (1785-1823行): 期限チェック
  - `generate_deadline_alert_message()` (1826-1874行): メッセージ生成
  - `log_deadline_alert()` (1877-1961行): ログ記録
- **定数:** `DEADLINE_ALERT_DAYS = {0: "今日", 1: "明日"}` (140-143行)
- **テスト:** 11件すべてPASS (`test_deadline_alert.py`)

#### v10.3.1 手動追加タスク対応（2026-01-18 `fe997da`）
- sync-chatwork-tasks/main.pyに`check_deadline_proximity_for_sync()`追加
- `send_deadline_alert_to_requester()` (6641-6740行)

#### v10.3.2 メンション機能（2026-01-18 `7003dce`）
- グループチャットでのアラート時に依頼者にメンション
- `[To:{requester_account_id}]`形式

---

### カテゴリ⑤：遅延タスク報告（管理部サマリー）

| 機能 | 設計書 | 実装状況 | コミット | ファイル:行番号 | 備考 |
|------|--------|---------|---------|-----------------|------|
| 【5-1】日次サマリー送信 | ✅ 完了 | 🔄 一部実装 | `848169a` | remind-tasks/main.py:5464-5621 | 形式が異なる |
| 【5-2】管理部メンション | ✅ 完了 | ❌ 未実装 | - | - | [To:]メンションなし |
| 【5-3】3段階表示 | ✅ 完了 | 🔄 一部実装 | `848169a` | remind-tasks/main.py:5409-5461 | 独自4段階 |
| 【5-4】担当者別グルーピング | ✅ 完了 | ✅ 実装済み | `848169a` | remind-tasks/main.py:5232-5310 | tasks_by_assignee |
| 【5-5】対象期間 | ✅ 完了 | 🔄 一部実装 | `848169a` | remind-tasks/main.py:3872-3884 | 上限なし |
| 【5-6】合計サマリー | ✅ 完了 | 🔄 一部実装 | `848169a` | remind-tasks/main.py:5567-5571 | 段階別集計なし |

**詳細実装記録:**

#### v10.6.0 管理部向け遅延タスク報告（2026-01-18 `848169a`）
- **実装関数:** `process_overdue_tasks_v2()` (5464-5621行)
- **送信先:** `ADMIN_ROOM_ID = 405315911` (48行)
- **現状形式:** 「📊 長期遅延タスク報告（計X件）」
- **未実装:**
  - 🟡1日超過/🟠3日超過/🔴1週間超過の3段階表示
  - [To:管理部account_id]メンション
  - 対象期間上限（1ヶ月以内）

---

### カテゴリ⑥：超過後の督促機能

| 機能 | 設計書 | 実装状況 | コミット | ファイル:行番号 | 備考 |
|------|--------|---------|---------|-----------------|------|
| 【6-1】超過後督促 | ✅ 完了 | ✅ 実装済み | `ffbfabf`, `39f9cf0` | remind-tasks/main.py:3956-4110 | v10.2.0テストモード |
| 【6-2】エスカレーション | ✅ 完了 | ✅ 実装済み | `ffbfabf` | remind-tasks/main.py:4112-4243 | 3日超過時 |
| 【6-3】二重送信防止 | ✅ 完了 | ✅ 実装済み | `39f9cf0` | remind-tasks/main.py:3207-3225 | notification_logs UPSERT |

**詳細実装記録:**

#### v10.1.4 notification_logs統合（2026-01-18 `39f9cf0`）
- **設計書との対応:** 設計書通り`notification_logs`テーブル採用
- **UNIQUE制約:** `(organization_id, target_type, target_id, notification_date, notification_type)`
- **UPSERT:** `ON CONFLICT DO UPDATE SET retry_count = retry_count + 1`
- **通知タイプ:**
  - `task_reminder`: 期限超過督促
  - `task_escalation`: エスカレーション
  - `deadline_alert`: 期限ガードレール

#### v10.2.0 テストモード（2026-01-18 `39f9cf0`）
- **DRY_RUN:** ログのみ、実送信なし
- **TEST_ACCOUNT_ID:** 指定ユーザーのみ送信
- **TEST_ROOM_ID:** グループメッセージをリダイレクト

---

## Phase 3.5: 組織階層連携

### 概要

| 項目 | 内容 |
|------|------|
| 設計書 | `docs/06_phase_3-5_org_hierarchy.md` |
| 実装方式 | FastAPI + Cloud Run（設計書通り） |
| 主要ファイル | `api/app/api/v1/organizations.py` |
| 初期コミット | 2026-01-18 `5d48d0a` |

### 機能実装状況

| 機能 | 設計書 | 実装状況 | コミット | ファイル:行番号 | 備考 |
|------|--------|---------|---------|-----------------|------|
| 組織図同期API | ✅ 完了 | ✅ 実装済み | `5d48d0a` | api/app/api/v1/organizations.py | POST /sync-org-chart |
| 部署一覧取得 | ✅ 完了 | ✅ 実装済み | `5d48d0a` | api/app/api/v1/organizations.py | GET /departments |
| 兼務対応 | ✅ 完了 | ✅ 実装済み | `c501b53` | api/app/api/v1/organizations.py | user_departments複数行 |
| Phase 1連携 | ✅ 完了 | ❌ 未実装 | - | - | タスク検索との統合なし |

---

## バージョン履歴

| バージョン | 日付 | コミット | 主な変更内容 |
|------------|------|----------|-------------|
| v10.10.0 | 2026-01-19 | `1bbcd67` | **本番稼働開始**: 全スタッフにリマインドDM送信 |
| v10.9.0 | 2026-01-18 | `a3922ba` | タスク要約40文字、Gemini API移行 |
| v10.6.0 | 2026-01-18 | `848169a` | DM基盤リマインド、管理部報告改善 |
| v10.5.0 | 2026-01-18 | `8e9b812` | タスク要約機能（Claude API） |
| v10.4.0 | 2026-01-18 | `02ddc29` | 全タスク同期（Bot以外も） |
| v10.3.4 | 2026-01-18 | `ad89a04` | API呼び出し最適化（30分→1時間） |
| v10.3.3 | 2026-01-18 | `c50a38f` | APIレート制限対策 |
| v10.3.2 | 2026-01-18 | `7003dce` | 期限ガードレールにメンション追加 |
| v10.3.1 | 2026-01-18 | `fe997da` | 手動追加タスクの期限ガードレール |
| v10.3.0 | 2026-01-18 | `6ccb50b` | 期限ガードレール機能（カテゴリ④） |
| v10.2.0 | 2026-01-18 | `39f9cf0` | テストモード、notification_logs統合 |
| 初期 | 2026-01-02 | `674f4d3` | chatwork-webhook 6051行 |
| 初期 | 2026-01-03 | `ffbfabf` | remind-tasks 4737行 |
| 初期 | 2026-01-03 | `3260ef3` | sync-chatwork-tasks |

---

## 実装状況の凡例

- ✅ **実装済み** = 完了・テスト完了・デプロイ済み
- 🔄 **一部実装** = 基本機能は動作、追加要件あり
- ⚠️ **修正中** = バグ修正中・改善中
- ❌ **未実装** = まだ着手していない

---

## 次回対応予定

### 高優先度
1. カテゴリ⑤の3段階表示（🟡🟠🔴）
2. カテゴリ②の階層セキュリティ（Phase 3.5連携）

### 中優先度
3. 管理部メンション追加
4. 対象期間の上限（1ヶ月以内）追加

### 低優先度（Phase 4で対応）
5. `chatwork_tasks`テーブルに`organization_id`追加
6. 管理部判定を`user_departments`経由に変更

---

## 既知の問題・改善予定

### ✅ BUG-001: 「自分のタスク」が見つからない問題 【修正完了】

**発見日:** 2026-01-19
**報告者:** カズさん
**修正完了:** 2026-01-24（v10.22.0, PR #71）

**現象:**
- 「自分のタスクを教えて」と聞くと「タスクは見つからなかった」と返答
- 実際にはタスクが存在するのに検索結果が0件

**原因:**
- `search_tasks_from_db()` 関数が常に `WHERE room_id = :room_id` でフィルタ
- 質問したチャットルームのタスクしか検索していなかった

**修正内容（v10.22.0）:**
1. `search_tasks_from_db()` に `search_all_rooms` パラメータを追加
2. 自分のタスク検索時（`is_self_search=True`）は全ルームから検索
3. 検索結果をルーム別にグループ化して表示
4. `room_id`, `room_name` を検索結果に追加

**修正後の表示例:**
```
📋 **あなたの未完了タスク**ウル！

📁 **営業部チャット**
  1. 報告書を作成する（期限: 01/24）
  2. 週次レポート提出（期限: 01/26）

📁 **プロジェクトAチャット**
  3. 顧客対応（期限: 01/25）

この3つが未完了タスクだよウル！頑張ってねウル💪✨
```

**変更ファイル:**
- chatwork-webhook/main.py: `search_tasks_from_db()`, `handle_chatwork_task_search()`
- tests/test_task_search.py: 9件のテスト追加

**デプロイ状況:** ✅ 完了（revision 00109-dek, 2026-01-24 18:10 JST）

---

## 変更履歴

- 2026-01-24: BUG-001修正完了（v10.22.0, PR #71）
- 2026-01-19: BUG-001記録（タスク検索がルーム限定になっている問題）
- 2026-01-19: v10.10.0 本番稼働開始（全スタッフにリマインドDM送信）
- 2026-01-19: 全面更新（v10.9.0時点の詳細記録）
- 2026-01-18: ファイル作成
