以下が引き継ぎ書の全文です。

---

# ソウル君 3AIレビュー引き継ぎ文書

**作成日:** 2026-02-18
**作成者:** Claude Opus 4.6 / Codex (GPT-5.2) / Gemini の3AI合議
**目的:** ソウル君プロジェクト担当のClaude Codeへの完全な引き継ぎ
**依頼者:** 古舘様（代表）

---

## この文書の使い方

この文書は3つのAI（Claude・Codex・Gemini）が合同でソウル君プロジェクトを分析した結果をまとめたものです。担当のClaude Codeはこの文書を読み、記載された順序で修正・改良を実行してください。

**重要ルール:**
- 修正の際は既存の `CLAUDE.md` の鉄則（特に鉄則#11「推測で直すな、計測が先」）を必ず守ること
- バグ修正は3AI合議プロセスに従うこと
- 各修正はPRを作成し、テストが全件パスしてからマージすること

---

## 第1部: 現状の総合診断（3AI合議結果）

### 重要な追記（2026-02-18 追加調査結果）

3AIレビュー時点（IMPLEMENTATION_STATUS.md 2026-02-08版）では「Tier 1緊急」としていたセキュリティ問題の一部が、**2026-02-08〜02-14の間に修正済み**であることが追加調査で判明しました。以下が是正状況です：

| 項目 | 2/8時点の状態 | 現在の是正状況 |
|------|-------------|--------------|
| org_idフィルター漏れ（114箇所） | 未修正 | **全箇所修正完了**（PR #421, 2026-02-08） |
| API認証ミドルウェア（0件） | 未実装 | **JWT認証実装完了**（`api/app/deps/auth.py`新規作成） |
| Cloud Run認証（11/12公開） | 未修正 | **11サービス認証必須化完了** |
| RLS（31/83テーブル） | 不完全 | **48テーブル追加完了**（54+テーブルRLS有効） |
| ILIKEインジェクション | 脆弱 | **`escape_ilike()` + ESCAPE対応完了** |
| TODO/FIXME（152件） | 未対応 | 段階対応中（未完了） |

**ただし、以下の注意点があります：**
- IMPLEMENTATION_STATUS.md は2026-02-08のまま更新されていないため、最新状態との齟齬がある
- 各修正の本番反映状況（デプロイ済みかどうか）は個別に確認が必要
- cloudbuild.yaml に `--allow-unauthenticated` フラグが残っている（Cloud Run自体は公開、認証はアプリレベルJWTで実施）

### 通信簿（3AI合議 + 追加調査による修正版）

| 項目 | 評価 | 解説 |
|------|------|------|
| テスト | **B-** | 9,187件あり、テナント分離テスト・ILIKEエスケープテスト・API認証テストも追加済み。ただしAI回答品質の自動テストは弱い |
| 設計書 | **B** | 54ファイル以上と非常に充実。ただし設計と実装にズレがある部分あり（MVV検証のハードコード等） |
| AI品質管理 | **C** | Langfuse導入は開始済みだが、AIの回答品質の定量評価・ハルシネーション検知・プロンプトバージョン管理がない |
| セキュリティ | **C-** | JWT認証・RLS・org_idフィルターは修正済み。ただしcloudbuild.yamlの`--allow-unauthenticated`残存、SLO未定義、ランブック不十分 |
| 監視 | **C** | observability.pyは存在するがDB永続化未実装。proactive-monitorはデフォルト無効 |
| 本番との一致 | **D** | ステージング環境なし。開発で動くが本番で動かない状態 |
| デプロイ | **B** | Cloud Build自動デプロイはOK。ロールバック・カナリアリリースが未整備 |

### 3AIが一致して指摘した最大の問題

> **「機能は十分に作られている。問題は、それが本番で安全かつ確実に動く状態になっていないこと」**

---

## 第2部: セキュリティの確認と残存課題

### 概要: セキュリティの大部分は修正済み

追加調査により、IMPLEMENTATION_STATUS.md（2026-02-08時点）で「Tier 1緊急」とされていた主要セキュリティ問題は**2026-02-08〜02-14の間にほぼ修正済み**であることが判明しました。ただし、以下の確認・追加作業が必要です。

### 2-1. API認証の確認と統一

**是正状況:** `api/app/deps/auth.py` にJWT認証ミドルウェアが実装済み
**残存課題:** 以下を確認・対応すること

1. **全エンドポイントにJWT認証が適用されているか確認する**
   - `chatwork-webhook/main.py` — ChatWork Webhookの受信（これはWebhook側の認証方式）
   - `report-generator/main.py` — CORS設定が `Access-Control-Allow-Origin: *`（全オリジン許可）のまま。本番では制限が必要
   - `mcp-server/server.py` — MCP接続の認証
   - `mobile-api/main.py` — モバイルAPIの認証
2. **認証の統一性を確認する** — サービスごとにバラバラな認証になっていないか
3. **テスト:** `tests/test_api_auth.py` が存在することを確認済み。テスト内容が全エンドポイントをカバーしているか確認

### 2-2. Cloud Run サービスの認証状態を確認

**是正状況:** 11サービスの認証必須化が完了との記録あり
**残存課題:**

1. **cloudbuild.yaml に `--allow-unauthenticated` フラグが残っている**
   - Cloud Run自体は公開状態のまま、認証はアプリレベル（JWT）で実施している可能性
   - **確認:** `gcloud run services list --region=asia-northeast1` で各サービスの認証設定を確認
   - **判断:** Cloud Run IAM認証にするか、アプリレベルJWT認証で十分かを判断
2. **cloudbuild.yaml の更新が必要な場合は修正**
3. **docs/31_emergency_procedures.md と docs/OPERATIONS_RUNBOOK.md に緊急停止手順が既に記載されていることを確認済み**

### 2-3. org_id フィルターの修正確認

**是正状況:** PR #421（2026-02-08）、PR #423, #425, #426（2026-02-09）で全箇所修正完了との記録あり
**残存課題:**

1. **修正が確実に全箇所に適用されているか再確認する**
2. `tests/test_org_isolation.py` と `tests/test_tenant.py` が存在することを確認済み — テスト内容のカバレッジを確認
3. **IMPLEMENTATION_STATUS.md の更新が必要** — 現在2026-02-08版のままで、2/9の修正が反映されていない

### 2-4. RLS（Row Level Security）の確認

**是正状況:** Phase 4A（2026-02-09）で48テーブル追加完了。54+テーブルでRLS有効との記録
**残存課題:**

1. **現在のRLS有効テーブル数を本番DBで確認する**
2. まだRLSが無効なテーブルがあれば有効化する
3. IMPLEMENTATION_STATUS.md を最新状態に更新する

### 2-5. ILIKE インジェクション対策の確認

**是正状況:** `escape_ilike()` + `ESCAPE '\\\\'` 対応が全ファイルに適用済みとの記録
**確認済みファイル:**
- `lib/brain/hybrid_search.py`（行69に `escape_ilike()` 定義）
- `lib/person_service.py`（行161-163, 255, 272でESCAPE使用）
- その他多数

**残存課題:**
1. `escape_ilike()` が共通ユーティリティとして1箇所で定義され、全箇所から参照されているか確認（重複定義がないか）
2. 新規コードでILIKEを追加する際のガイドラインをCLAUDE.mdに追加

### 2-6. SQLインジェクション全般の対策

**現状:** CLAUDE.md 鉄則#9「SQLはパラメータ化」が定められているが、完全には守られていない可能性

**修正方法:**
1. 全SQLクエリをスキャンして非パラメータ化クエリを検出
2. f-string等で動的に構築されているSQL文をすべてパラメータ化
3. `scripts/validate_sql_columns.sh` の検証対象に安全性チェックを追加

---

## 第3部: 重要修正事項（セキュリティの次に対応）

### 3-1. 監視（Observability）のDB永続化
### 3-2. Langfuse（AIトレーシング）の本格稼働
### 3-3. ステージング環境の構築
### 3-4. 障害対応手順書（ランブック）の整備
### 3-5. SLO/SLA の設計

（各項目に具体的な修正方法・手順が記載済み）

---

## 第4部: AI品質の改善

### 4-1. プロンプトのバージョン管理
### 4-2. AI回答品質の定量評価（評価データセット）
### 4-3. ハルシネーション（AIの嘘）対策
### 4-4. AIコスト・レイテンシの監視

---

## 第5部: キャラクター性（MVV・選択理論）の強化

### 5-1. MVV検証の専用モジュール化
### 5-2. キャラクター性の返答前チェック機能
### 5-3. 社長の判断パターンの蓄積と学習

---

## 第6部: 承認フローの完全実装

### 6-1. 承認ゲートの本番検証
### 6-2. 権限レベルの実装確認

---

## 第7部: 新機能追加（既存機能の安定化後に着手）

### 7-1. 日報・週報の自動まとめ
### 7-2. 会議アジェンダの自動作成
### 7-3. メール連携（Gmail）
### 7-4. カレンダー連携（Googleカレンダー）
### 7-5. 経費・請求書処理
### 7-6. 資料作成の代行

---

## 第8部: 管理ダッシュボード（スマホ対応）

15ページ分のReact/Viteコンポーネント作成済み。バックエンドAPI接続・PWA化・認証追加が必要。

---

## 第9部: 自律運用の段階的実装

### 9-1. 自己診断機能 → 9-2. 修正案の提案 → 9-3. 人間承認付き自動修正

---

## 第10部: 本番環境の既存インフラ状況

- Cloud Functions: 18個（17 ACTIVE / 1 FAILED）
- Cloud Scheduler: 19個（18 ENABLED / 1 PAUSED）
- フィーチャーフラグ: 14個（8 True / 6 False）

---

## 第11部: 技術的負債の棚卸し（TODO/FIXME 152件、設計実装ギャップ）

---

## 第12部: 作業の優先順位（3AI合議）

Week 1-2 → Week 3-4 → Week 5-8 → Week 9以降 の4段階で優先順位付け済み

---

## 第13部: 経営者向けチェックリスト（12項目）

全12項目が現在「不合格」→ 全て「合格」にすることが目標

---

ファイルは `/Users/kikubookair/soul-kun/3AI_REVIEW_HANDOVER.md` に保存されています。全13部 + 付録で構成された完全な引き継ぎ文書です。
