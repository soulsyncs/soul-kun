# ã‚½ã‚¦ãƒ«ãã‚“çµ„ç¹”å›³ãƒ»æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  è©³ç´°è¨­è¨ˆæ›¸ v1.0

**ä½œæˆæ—¥:** 2026å¹´1æœˆ19æ—¥
**ä½œæˆè€…:** Claude Codeï¼ˆä¸–ç•Œæœ€é«˜ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ï¼‰
**æ‰¿èªè€…:** ã‚«ã‚ºã•ã‚“ï¼ˆCEOï¼‰
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡

---

## ç›®æ¬¡

1. [ã“ã®è¨­è¨ˆæ›¸ã®èª­ã¿æ–¹](#ç¬¬1ç« ã“ã®è¨­è¨ˆæ›¸ã®èª­ã¿æ–¹)
2. [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦](#ç¬¬2ç« ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦)
3. [ç¾çŠ¶åˆ†æ](#ç¬¬3ç« ç¾çŠ¶åˆ†æ)
4. [æ¨©é™ãƒ¬ãƒ™ãƒ«è¨­è¨ˆ](#ç¬¬4ç« æ¨©é™ãƒ¬ãƒ™ãƒ«è¨­è¨ˆ)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#ç¬¬5ç« ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
6. [APIè¨­è¨ˆ](#ç¬¬6ç« apiè¨­è¨ˆ)
7. [UIè¨­è¨ˆ](#ç¬¬7ç« uiè¨­è¨ˆ)
8. [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»](#ç¬¬8ç« ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»)
9. [ãƒ†ã‚¹ãƒˆè¨ˆç”»](#ç¬¬9ç« ãƒ†ã‚¹ãƒˆè¨ˆç”»)
10. [å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—](#ç¬¬10ç« å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—)
11. [å°†æ¥ã®æ‹¡å¼µæ€§](#ç¬¬11ç« å°†æ¥ã®æ‹¡å¼µæ€§)
12. [ç”¨èªé›†](#ç¬¬12ç« ç”¨èªé›†)

---

# ç¬¬1ç« ï¼šã“ã®è¨­è¨ˆæ›¸ã®èª­ã¿æ–¹

## 1-1. å¯¾è±¡èª­è€…

ã“ã®è¨­è¨ˆæ›¸ã¯ä»¥ä¸‹ã®æ–¹ã€…ã«å‘ã‘ã¦æ›¸ã‹ã‚Œã¦ã„ã¾ã™ï¼š

| èª­è€… | èª­ã‚€ã¹ãã‚»ã‚¯ã‚·ãƒ§ãƒ³ |
|------|-------------------|
| ã‚«ã‚ºã•ã‚“ï¼ˆCEOï¼‰ | å…¨ç« ï¼ˆç‰¹ã«ç¬¬2ç« ã€ç¬¬4ç« ã€ç¬¬10ç« ï¼‰ |
| é–‹ç™ºè€… | å…¨ç« ï¼ˆç‰¹ã«ç¬¬5ç« ã€œç¬¬9ç« ï¼‰ |
| ç´ äººã®æ–¹ | ç¬¬1ç« ã€œç¬¬4ç« ã€ç¬¬12ç« ï¼ˆç”¨èªé›†ï¼‰ |

## 1-2. è¨˜å·ã®æ„å‘³

| è¨˜å· | æ„å‘³ |
|------|------|
| âœ… | å®Œäº†ãƒ»å®Ÿè£…æ¸ˆã¿ |
| ğŸ”„ | é€²è¡Œä¸­ãƒ»å®Ÿè£…ä¸­ |
| ğŸ“‹ | æœªç€æ‰‹ãƒ»è¨ˆç”»ä¸­ |
| âš ï¸ | æ³¨æ„ãƒ»ãƒªã‚¹ã‚¯ã‚ã‚Š |
| ğŸ’¡ | ãƒã‚¤ãƒ³ãƒˆãƒ»ãƒ’ãƒ³ãƒˆ |

## 1-3. å›³ã®è¦‹æ–¹

ã“ã®è¨­è¨ˆæ›¸ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå›³ã‚’ä½¿ã£ã¦èª¬æ˜ã—ã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã“ã‚Œã¯ç®±       â”‚  â† ç®±ã¯ã‚·ã‚¹ãƒ†ãƒ ã‚„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ã™
â”‚  ï¼ˆèª¬æ˜ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼            â† çŸ¢å°ã¯ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã‚’è¡¨ã™
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ¥ã®ç®±         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ç¬¬2ç« ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

## 2-1. ãªãœã“ã®ã‚·ã‚¹ãƒ†ãƒ ãŒå¿…è¦ã‹ï¼Ÿ

### ã‚«ã‚ºã•ã‚“ã®è¦æœ›ï¼ˆåŸæ–‡ï¼‰

> ã€Œç¤¾å“¡ã‚„ä¸€èˆ¬ã®æ¥­å‹™å§”è¨—ã®äººã«é–‹ç¤ºã—ã¦ã„ã„ã‚‚ã®ã€éƒ¨é•·ã˜ã‚ƒãªã„ã¨ãƒ€ãƒ¡ãªã‚‚ã®ã€å¹¹éƒ¨ã˜ã‚ƒãªã„ã¨ãƒ€ãƒ¡ãªã‚‚ã®ã€ä»£è¡¨ã˜ã‚ƒãªã„ã¨è¦‹ã¡ã‚ƒã„ã‘ãªã„ã‚‚ã®ã¨ã‹ã€ãã†ã„ã†ã®ã‚’ç®¡ç†ã—ãŸã„ã€

### ç¾çŠ¶ã®å•é¡Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¾åœ¨ã®ã‚½ã‚¦ãƒ«ãã‚“                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ‘¤ èª°ã§ã‚‚ â†’ ğŸ“‹ å…¨ã¦ã®ã‚¿ã‚¹ã‚¯ãŒè¦‹ãˆã‚‹                       â”‚
â”‚                                                             â”‚
â”‚  ğŸ‘¤ èª°ã§ã‚‚ â†’ ğŸ“š å…¨ã¦ã®æƒ…å ±ãŒè¦‹ãˆã‚‹ï¼ˆå°†æ¥ã®ãƒŠãƒ¬ãƒƒã‚¸æ©Ÿèƒ½ï¼‰   â”‚
â”‚                                                             â”‚
â”‚  âŒ å•é¡Œ: ã€Œä»£è¡¨ã ã‘ãŒè¦‹ã‚‹ã¹ãè²¡å‹™æƒ…å ±ã€ã‚‚è¦‹ãˆã¦ã—ã¾ã†     â”‚
â”‚  âŒ å•é¡Œ: ã€Œè‡ªåˆ†ã®éƒ¨ç½²ã®ã‚¿ã‚¹ã‚¯ã€ã ã‘è¦‹ãŸã„ã®ã«å…¨éƒ¨è¦‹ãˆã‚‹   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§£æ±ºå¾Œã®å§¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ”¹å–„å¾Œã®ã‚½ã‚¦ãƒ«ãã‚“                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ‘‘ ä»£è¡¨ãƒ»CFO(Level 6) â†’ ğŸ“‹ å…¨ã¦ã®ã‚¿ã‚¹ã‚¯ + ğŸ’° è²¡å‹™æƒ…å ±    â”‚
â”‚                                                             â”‚
â”‚  ğŸ‘” å¹¹éƒ¨ãƒ»éƒ¨é•·(Level 4) â†’ ğŸ“‹ è‡ªéƒ¨ç½²ï¼‹é…ä¸‹ã®ã‚¿ã‚¹ã‚¯          â”‚
â”‚                                                             â”‚
â”‚  ğŸ‘· ä¸€èˆ¬ç¤¾å“¡(Level 2) â†’ ğŸ“‹ è‡ªéƒ¨ç½²ã®ã‚¿ã‚¹ã‚¯ã®ã¿              â”‚
â”‚                                                             â”‚
â”‚  âœ… è§£æ±º: å½¹è·ã«å¿œã˜ã¦è¦‹ãˆã‚‹æƒ…å ±ãŒè‡ªå‹•çš„ã«åˆ¶å¾¡ã•ã‚Œã‚‹       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2-2. ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½œã‚‹ã‚‚ã®

### å®Ÿè£…ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆPhase A-Dï¼‰

| Phase | å†…å®¹ | ä¸€è¨€ã§è¨€ã†ã¨ |
|-------|------|-------------|
| **A** | åŸºç›¤æ•´å‚™ | å½¹è·ãƒã‚¹ã‚¿ã‚’ä½œã‚‹ |
| **B** | åŒæœŸæ©Ÿèƒ½å¼·åŒ– | çµ„ç¹”å›³ã¨ã‚½ã‚¦ãƒ«ãã‚“ã‚’ç¹‹ã’ã‚‹ |
| **C** | ã‚¿ã‚¹ã‚¯ç®¡ç†é€£æº | ã‚¿ã‚¹ã‚¯ã«éƒ¨ç½²ã‚’ç´ã¥ã‘ã‚‹ |
| **D** | ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | æ¨©é™ã§è¦‹ãˆã‚‹ç¯„å›²ã‚’åˆ¶å¾¡ |

### ä»Šå›å®Ÿè£…ã—ãªã„ã‚‚ã®ï¼ˆPhase Eï¼‰

| å†…å®¹ | ç†ç”± |
|------|------|
| æ©Ÿå¯†åŒºåˆ†ï¼ˆ5æ®µéšï¼‰ | Phase 3ï¼ˆãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ï¼‰ã¨çµ±åˆè¨­è¨ˆã™ã‚‹ãŸã‚ |
| å…„å¼Ÿéƒ¨ç½²ã®é–²è¦§ | é‹ç”¨å¾Œã«å¿…è¦æ€§ã‚’åˆ¤æ–­ã—ã¦ã‹ã‚‰å®Ÿè£… |

## 2-3. æˆåŠŸã®å®šç¾©

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæˆåŠŸã—ãŸã¨è¨€ãˆã‚‹ã®ã¯ï¼š

1. âœ… çµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ ã§å½¹è·ã‚’é¸æŠã§ãã‚‹
2. âœ… ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ã‚½ã‚¦ãƒ«ãã‚“ã«è‡ªå‹•åŒæœŸã•ã‚Œã‚‹
3. âœ… ã€Œè‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯ã‚’æ•™ãˆã¦ã€ã§è‡ªéƒ¨ç½²ã®ã‚¿ã‚¹ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã‚‹
4. âœ… Level 4ä»¥ä¸Šã¯é…ä¸‹éƒ¨ç½²ã®ã‚¿ã‚¹ã‚¯ã‚‚è¦‹ãˆã‚‹
5. âœ… Level 6ã¯å…¨ã¦ã®ã‚¿ã‚¹ã‚¯ãŒè¦‹ãˆã‚‹

---

# ç¬¬3ç« ï¼šç¾çŠ¶åˆ†æ

## 3-1. 2ã¤ã®ã‚·ã‚¹ãƒ†ãƒ ã®é–¢ä¿‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€çµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ ã€‘                    ã€ã‚½ã‚¦ãƒ«ãã‚“ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase           â”‚              â”‚  Cloud SQL          â”‚
â”‚  ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰DBï¼‰     â”‚              â”‚  ï¼ˆGCPä¸Šã®DBï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚              â”‚                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   åŒæœŸAPI    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ departments     â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚ â”‚ departments     â”‚ â”‚
â”‚ â”‚ (éƒ¨ç½²)          â”‚ â”‚              â”‚ â”‚ (éƒ¨ç½²)          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚              â”‚                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   åŒæœŸAPI    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ employees       â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚ â”‚ users           â”‚ â”‚
â”‚ â”‚ (ç¤¾å“¡)          â”‚ â”‚              â”‚ â”‚ (ãƒ¦ãƒ¼ã‚¶ãƒ¼)      â”‚ â”‚
â”‚ â”‚ position:ãƒ†ã‚­ã‚¹ãƒˆâ”‚ â”‚              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚                     â”‚
â”‚                     â”‚              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚ â”‚ roles           â”‚ â”‚
â”‚ â”‚ roles           â”‚ â”‚   åŒæœŸAPI    â”‚ â”‚ (å½¹è·)          â”‚ â”‚
â”‚ â”‚ âŒ å­˜åœ¨ã—ãªã„ï¼  â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚ â”‚ level: Integer  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚              â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â†‘                                    â†‘
    ã€å•é¡Œ1ã€‘                           ã€å•é¡Œ2ã€‘
    å½¹è·ãƒã‚¹ã‚¿ãŒ                       external_idã‚«ãƒ©ãƒ ãŒ
    å­˜åœ¨ã—ãªã„                         ãƒ¢ãƒ‡ãƒ«ã«ãªã„
```

## 3-2. ç™ºè¦‹ã—ãŸå•é¡Œç‚¹

### å•é¡Œ1: çµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ ã«å½¹è·ãƒã‚¹ã‚¿ãŒãªã„

**ç¾çŠ¶ï¼š**
- ç¤¾å“¡ç™»éŒ²æ™‚ã€å½¹è·ã¯ã€Œãƒ†ã‚­ã‚¹ãƒˆè‡ªç”±å…¥åŠ›ã€
- ã€Œéƒ¨é•·ã€ã€Œãƒ–ãƒãƒ§ã‚¦ã€ã€Œéƒ¨é•·ã•ã‚“ã€ãŒå…¨ã¦åˆ¥æ‰±ã„
- åŒæœŸæ™‚ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã§ãƒ¬ãƒ™ãƒ«ã‚’æ¨å®š

**app.js:3466-3476ï¼ˆç¾åœ¨ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼‰ï¼š**
```javascript
const rolelevels = {
    'CEO': 1, 'ä»£è¡¨': 1, 'ç¤¾é•·': 1,      // â† 1=æœ€é«˜æ¨©é™
    'å–ç· å½¹': 2, 'å½¹å“¡': 2,
    'éƒ¨é•·': 4, 'GM': 4,
    // ...
    'ä¸€èˆ¬': 10, 'ãƒ¡ãƒ³ãƒãƒ¼': 10           // â† 10=æœ€ä½æ¨©é™
};
```

**å•é¡Œï¼š**
- ãƒ¬ãƒ™ãƒ«ãŒé€†ï¼ˆ1=æœ€é«˜ã€10=æœ€ä½ï¼‰
- æ–°è¨­è¨ˆã¯ï¼ˆ6=æœ€é«˜ã€1=æœ€ä½ï¼‰
- è¡¨è¨˜ã‚†ã‚Œã«å¯¾å¿œã§ããªã„

### å•é¡Œ2: ã‚½ã‚¦ãƒ«ãã‚“ã®rolesãƒ†ãƒ¼ãƒ–ãƒ«ã«external_idãŒãªã„

**ç¾çŠ¶ï¼š**
- `organization_sync.py`ã¯`external_id`ã‚’ä½¿ã£ã¦åŒæœŸ
- ã—ã‹ã—`user.py`ã®Roleãƒ¢ãƒ‡ãƒ«ã«`external_id`ãŒãªã„
- DBã«ã‚«ãƒ©ãƒ ãŒã‚ã‚‹ã‹ä¸æ˜

**organization_sync.py:373-374ï¼š**
```python
result = self.conn.execute(
    text("SELECT id FROM roles WHERE external_id = :external_id"),
    {"external_id": role.id},
)
```

**è§£æ±ºç­–ï¼š**
- DBã«external_idãŒã‚ã‚Œã°ã€ãƒ¢ãƒ‡ãƒ«ã«è¿½åŠ 
- ãªã‘ã‚Œã°ã€DBã«ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 

### å•é¡Œ3: chatwork_tasksã«department_idãŒãªã„

**ç¾çŠ¶ã®chatwork_tasksã‚«ãƒ©ãƒ ï¼š**
```
task_id, room_id, assigned_to_account_id, assigned_by_account_id,
body, limit_time, status, skip_tracking, last_synced_at,
room_name, assigned_to_name, assigned_by_name
```

**ä¸è¶³ï¼š**
- `department_id`ãŒãªã„ â†’ ã‚¿ã‚¹ã‚¯ãŒã©ã®éƒ¨ç½²ã®ã‚‚ã®ã‹åˆ†ã‹ã‚‰ãªã„

## 3-3. ç¾çŠ¶ã®ã¾ã¨ã‚

| é …ç›® | çµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ  | ã‚½ã‚¦ãƒ«ãã‚“ | å¯¾å¿œ |
|------|---------------|-----------|------|
| rolesãƒ†ãƒ¼ãƒ–ãƒ« | âŒ ãªã— | âœ… ã‚ã‚Š | Supabaseã«æ–°è¦ä½œæˆ |
| roles.level | - | âœ… ã‚ã‚Š | 6æ®µéšã«çµ±ä¸€ |
| roles.external_id | - | âš ï¸ è¦ç¢ºèª | ãƒ¢ãƒ‡ãƒ«ã«è¿½åŠ  |
| å½¹è·å…¥åŠ›UI | ãƒ†ã‚­ã‚¹ãƒˆ | - | ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«å¤‰æ›´ |
| chatwork_tasks.department_id | - | âŒ ãªã— | ã‚«ãƒ©ãƒ è¿½åŠ  |
| åŒæœŸæ©Ÿèƒ½ | âœ… å®Ÿè£…æ¸ˆã¿ | âœ… å®Ÿè£…æ¸ˆã¿ | ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å‰Šé™¤ |

---

# ç¬¬4ç« ï¼šæ¨©é™ãƒ¬ãƒ™ãƒ«è¨­è¨ˆ

## 4-1. 6æ®µéšã®æ¨©é™ãƒ¬ãƒ™ãƒ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆ6æ®µéšï¼‰                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Level 6 â”â”â”â”â” ä»£è¡¨ãƒ»CFO â”â”â”â”â”â”â”â”â” å…¨çµ„ç¹” + æœ€é«˜æ©Ÿå¯†       â”‚
â”‚     â–²         ä¾‹ï¼šã‚«ã‚ºã•ã‚“ã€CFO                            â”‚
â”‚     â”‚                                                       â”‚
â”‚  Level 5 â”â”â”â”â” ç®¡ç†éƒ¨ â”â”â”â”â”â”â”â”â”â”â” å…¨çµ„ç¹”ï¼ˆæœ€é«˜æ©Ÿå¯†é™¤ãï¼‰   â”‚
â”‚     â–²         ä¾‹ï¼šç®¡ç†éƒ¨ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€äººäº‹æ‹…å½“             â”‚
â”‚     â”‚                                                       â”‚
â”‚  Level 4 â”â”â”â”â” å¹¹éƒ¨ãƒ»éƒ¨é•· â”â”â”â”â”â”â” è‡ªéƒ¨ç½² + å…¨é…ä¸‹          â”‚
â”‚     â–²         ä¾‹ï¼šå–ç· å½¹ã€å–¶æ¥­éƒ¨é•·ã€é–‹ç™ºéƒ¨é•·               â”‚
â”‚     â”‚                                                       â”‚
â”‚  Level 3 â”â”â”â”â” ãƒªãƒ¼ãƒ€ãƒ¼ â”â”â”â”â”â”â”â”â” è‡ªéƒ¨ç½² + ç›´ä¸‹            â”‚
â”‚     â–²         ä¾‹ï¼šèª²é•·ã€ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼                     â”‚
â”‚     â”‚                                                       â”‚
â”‚  Level 2 â”â”â”â”â” ä¸€èˆ¬ç¤¾å“¡ â”â”â”â”â”â”â”â”â” è‡ªéƒ¨ç½²ã®ã¿               â”‚
â”‚     â–²         ä¾‹ï¼šæ­£ç¤¾å“¡                                   â”‚
â”‚     â”‚                                                       â”‚
â”‚  Level 1 â”â”â”â”â” æ¥­å‹™å§”è¨— â”â”â”â”â”â”â”â”â” è‡ªéƒ¨ç½²ã®ã¿ï¼ˆåˆ¶é™ã‚ã‚Šï¼‰   â”‚
â”‚               ä¾‹ï¼šå¤–éƒ¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆï¼šæ•°å­—ãŒå¤§ãã„ã»ã©æ¨©é™ãŒé«˜ã„ï¼ˆ6=æœ€é«˜ã€1=æœ€ä½ï¼‰
```

## 4-2. å„ãƒ¬ãƒ™ãƒ«ã®è©³ç´°

### Level 6ï¼šä»£è¡¨ãƒ»CFO

| é …ç›® | å†…å®¹ |
|------|------|
| **å¯¾è±¡å½¹è·** | ä»£è¡¨å–ç· å½¹ã€CFOã€COO |
| **è¦‹ã‚Œã‚‹ç¯„å›²** | **å…¨çµ„ç¹”ã®å…¨æƒ…å ±**ï¼ˆæœ€é«˜æ©Ÿå¯†å«ã‚€ï¼‰ |
| **å…·ä½“ä¾‹** | è²¡å‹™æƒ…å ±ã€M&Aæƒ…å ±ã€å…¨ç¤¾å“¡ã®è©•ä¾¡ã€çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ |
| **ã‚¿ã‚¹ã‚¯è¡¨ç¤º** | å…¨éƒ¨ç½²ã®å…¨ã‚¿ã‚¹ã‚¯ |

### Level 5ï¼šç®¡ç†éƒ¨

| é …ç›® | å†…å®¹ |
|------|------|
| **å¯¾è±¡å½¹è·** | ç®¡ç†éƒ¨ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€ç®¡ç†éƒ¨ã‚¹ã‚¿ãƒƒãƒ• |
| **è¦‹ã‚Œã‚‹ç¯„å›²** | **å…¨çµ„ç¹”ã®æƒ…å ±**ï¼ˆæœ€é«˜æ©Ÿå¯†é™¤ãï¼‰ |
| **å…·ä½“ä¾‹** | äººäº‹æƒ…å ±ã€æ¡ç”¨è¨ˆç”»ã€å…¨ç¤¾äºˆç®—ã€å¥‘ç´„æƒ…å ± |
| **ã‚¿ã‚¹ã‚¯è¡¨ç¤º** | å…¨éƒ¨ç½²ã®å…¨ã‚¿ã‚¹ã‚¯ |
| **è¦‹ã‚Œãªã„ã‚‚ã®** | è²¡å‹™æ©Ÿå¯†ï¼ˆLevel 6é™å®šï¼‰ |

ğŸ’¡ **ãªãœç®¡ç†éƒ¨ã¯ç‰¹åˆ¥ï¼Ÿ**
- äººäº‹ãƒ»ç·å‹™ãƒ»çµŒç†ã¯å…¨éƒ¨ç½²ã®æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ãŸã ã—ã€è²¡å‹™ã®æœ€é«˜æ©Ÿå¯†ï¼ˆM&Aæƒ…å ±ãªã©ï¼‰ã¯ä»£è¡¨ãƒ»CFOã®ã¿

### Level 4ï¼šå¹¹éƒ¨ãƒ»éƒ¨é•·

| é …ç›® | å†…å®¹ |
|------|------|
| **å¯¾è±¡å½¹è·** | å–ç· å½¹ã€éƒ¨é•· |
| **è¦‹ã‚Œã‚‹ç¯„å›²** | **è‡ªéƒ¨ç½² + å…¨é…ä¸‹** |
| **å…·ä½“ä¾‹** | è‡ªéƒ¨ç½²ã®äºˆç®—ã€é…ä¸‹ã®èª²ã®ã‚¿ã‚¹ã‚¯ã€éƒ¨ä¸‹ã®è©•ä¾¡ |
| **ã‚¿ã‚¹ã‚¯è¡¨ç¤º** | è‡ªéƒ¨ç½²ï¼‹é…ä¸‹éƒ¨ç½²ã®ã‚¿ã‚¹ã‚¯ |

```
ä¾‹ï¼šå–¶æ¥­éƒ¨é•·ï¼ˆLevel 4ï¼‰ã®è¦‹ã‚Œã‚‹ç¯„å›²

æœ¬ç¤¾
â”œâ”€â”€ å–¶æ¥­éƒ¨ â† è‡ªéƒ¨ç½²ï¼ˆâœ… è¦‹ã‚Œã‚‹ï¼‰
â”‚   â”œâ”€â”€ æ±äº¬å–¶æ¥­èª² â† é…ä¸‹ï¼ˆâœ… è¦‹ã‚Œã‚‹ï¼‰
â”‚   â””â”€â”€ å¤§é˜ªå–¶æ¥­èª² â† é…ä¸‹ï¼ˆâœ… è¦‹ã‚Œã‚‹ï¼‰
â”œâ”€â”€ é–‹ç™ºéƒ¨ â† ä»–éƒ¨ç½²ï¼ˆâŒ è¦‹ã‚Œãªã„ï¼‰
â””â”€â”€ ç®¡ç†éƒ¨ â† ä»–éƒ¨ç½²ï¼ˆâŒ è¦‹ã‚Œãªã„ï¼‰
```

### Level 3ï¼šãƒªãƒ¼ãƒ€ãƒ¼

| é …ç›® | å†…å®¹ |
|------|------|
| **å¯¾è±¡å½¹è·** | èª²é•·ã€ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ã€ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ |
| **è¦‹ã‚Œã‚‹ç¯„å›²** | **è‡ªéƒ¨ç½² + ç›´ä¸‹1éšå±¤** |
| **å…·ä½“ä¾‹** | è‡ªèª²ã®ã‚¿ã‚¹ã‚¯ã€ç›´ä¸‹ãƒãƒ¼ãƒ ã®ã‚¿ã‚¹ã‚¯ |
| **ã‚¿ã‚¹ã‚¯è¡¨ç¤º** | è‡ªéƒ¨ç½²ï¼‹ç›´ä¸‹ã®ã‚¿ã‚¹ã‚¯ |

```
ä¾‹ï¼šæ±äº¬å–¶æ¥­èª²é•·ï¼ˆLevel 3ï¼‰ã®è¦‹ã‚Œã‚‹ç¯„å›²

å–¶æ¥­éƒ¨
â”œâ”€â”€ æ±äº¬å–¶æ¥­èª² â† è‡ªéƒ¨ç½²ï¼ˆâœ… è¦‹ã‚Œã‚‹ï¼‰
â”‚   â”œâ”€â”€ ç¬¬ä¸€ãƒãƒ¼ãƒ  â† ç›´ä¸‹ï¼ˆâœ… è¦‹ã‚Œã‚‹ï¼‰
â”‚   â””â”€â”€ ç¬¬äºŒãƒãƒ¼ãƒ  â† ç›´ä¸‹ï¼ˆâœ… è¦‹ã‚Œã‚‹ï¼‰
â””â”€â”€ å¤§é˜ªå–¶æ¥­èª² â† å…„å¼Ÿï¼ˆâŒ è¦‹ã‚Œãªã„ï¼‰
```

### Level 2ï¼šä¸€èˆ¬ç¤¾å“¡

| é …ç›® | å†…å®¹ |
|------|------|
| **å¯¾è±¡å½¹è·** | ç¤¾å“¡ã€æ­£ç¤¾å“¡ |
| **è¦‹ã‚Œã‚‹ç¯„å›²** | **è‡ªéƒ¨ç½²ã®ã¿** |
| **å…·ä½“ä¾‹** | è‡ªéƒ¨ç½²ã®ã‚¿ã‚¹ã‚¯ã€ç¤¾å†…è¦å®šã€ç¦åˆ©åšç”Ÿ |
| **ã‚¿ã‚¹ã‚¯è¡¨ç¤º** | è‡ªéƒ¨ç½²ã®ã‚¿ã‚¹ã‚¯ã®ã¿ |

### Level 1ï¼šæ¥­å‹™å§”è¨—

| é …ç›® | å†…å®¹ |
|------|------|
| **å¯¾è±¡å½¹è·** | æ¥­å‹™å§”è¨—ã€å¤–éƒ¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ |
| **è¦‹ã‚Œã‚‹ç¯„å›²** | **è‡ªéƒ¨ç½²ã®ã¿ï¼ˆåˆ¶é™ã‚ã‚Šï¼‰** |
| **å…·ä½“ä¾‹** | æ¥­å‹™ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã€æ¥­å‹™å§”è¨—å‘ã‘å¥‘ç´„æƒ…å ± |
| **ã‚¿ã‚¹ã‚¯è¡¨ç¤º** | è‡ªéƒ¨ç½²ã®ã‚¿ã‚¹ã‚¯ã®ã¿ |
| **è¦‹ã‚Œãªã„ã‚‚ã®** | åŠ´å‹™æƒ…å ±ã€ç¤¾å“¡å‘ã‘ç¦åˆ©åšç”Ÿ |

ğŸ’¡ **Level 1ã¨Level 2ã®é•ã„ï¼š**
- Level 2ï¼ˆç¤¾å“¡ï¼‰ï¼šåŠ´å‹™æƒ…å ±ã€ç¦åˆ©åšç”Ÿã‚’è¦‹ã‚Œã‚‹
- Level 1ï¼ˆæ¥­å‹™å§”è¨—ï¼‰ï¼šæ¥­å‹™ã«å¿…è¦ãªæƒ…å ±ã®ã¿

## 4-3. å½¹è·ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿

| id | name | level | description |
|----|------|-------|-------------|
| `role_ceo` | ä»£è¡¨å–ç· å½¹ | 6 | æœ€é«˜çµŒå–¶è²¬ä»»è€… |
| `role_cfo` | CFO | 6 | æœ€é«˜è²¡å‹™è²¬ä»»è€… |
| `role_coo` | COO | 6 | æœ€é«˜åŸ·è¡Œè²¬ä»»è€… |
| `role_admin_mgr` | ç®¡ç†éƒ¨ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ | 5 | ç®¡ç†éƒ¨é–€è²¬ä»»è€… |
| `role_admin_staff` | ç®¡ç†éƒ¨ã‚¹ã‚¿ãƒƒãƒ• | 5 | ç®¡ç†éƒ¨é–€æ‹…å½“è€… |
| `role_director` | å–ç· å½¹ | 4 | å¹¹éƒ¨ |
| `role_dept_head` | éƒ¨é•· | 4 | éƒ¨é–€è²¬ä»»è€… |
| `role_section_head` | èª²é•· | 3 | èª²è²¬ä»»è€… |
| `role_leader` | ãƒªãƒ¼ãƒ€ãƒ¼ | 3 | ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ |
| `role_employee` | ç¤¾å“¡ | 2 | ä¸€èˆ¬ç¤¾å“¡ |
| `role_contractor` | æ¥­å‹™å§”è¨— | 1 | å¤–éƒ¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ |

---

# ç¬¬5ç« ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

## 5-1. å…¨ä½“åƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å…¨ä½“åƒ                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Supabaseï¼ˆçµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã€‘         ã€Cloud SQLï¼ˆã‚½ã‚¦ãƒ«ãã‚“ï¼‰ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚               â”‚                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ roles ğŸ†•        â”‚ â”‚    åŒæœŸ       â”‚ â”‚ roles           â”‚ â”‚
â”‚ â”‚ - id            â”‚â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ â”‚ - id            â”‚ â”‚
â”‚ â”‚ - name          â”‚ â”‚               â”‚ â”‚ - external_idğŸ†• â”‚ â”‚
â”‚ â”‚ - level ğŸ†•      â”‚ â”‚               â”‚ â”‚ - name          â”‚ â”‚
â”‚ â”‚ - description   â”‚ â”‚               â”‚ â”‚ - level         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚               â”‚                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    åŒæœŸ       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ departments     â”‚â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ â”‚ departments     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚               â”‚                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    åŒæœŸ       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ employees       â”‚â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ â”‚ users +         â”‚ â”‚
â”‚ â”‚ - role_id ğŸ†•    â”‚ â”‚               â”‚ â”‚ user_departmentsâ”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚               â”‚                     â”‚
â”‚                     â”‚               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                     â”‚               â”‚ â”‚ chatwork_tasks  â”‚ â”‚
â”‚                     â”‚               â”‚ â”‚ - department_idğŸ†•â”‚ â”‚
â”‚                     â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚               â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ†• = æ–°è¦è¿½åŠ 
```

## 5-2. Supabaseï¼ˆçµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ ï¼‰

### 5-2-1. rolesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ä½œæˆï¼‰

**ç›®çš„ï¼š** å½¹è·ãƒã‚¹ã‚¿ã‚’ç®¡ç†ã™ã‚‹

```sql
-- rolesãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE roles (
    id TEXT PRIMARY KEY,               -- å½¹è·IDï¼ˆä¾‹ï¼šrole_ceoï¼‰
    name TEXT NOT NULL,                -- å½¹è·åï¼ˆä¾‹ï¼šä»£è¡¨å–ç· å½¹ï¼‰
    level INTEGER NOT NULL DEFAULT 1,  -- æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆ1-6ï¼‰
    description TEXT,                  -- èª¬æ˜
    display_order INTEGER DEFAULT 0,   -- è¡¨ç¤ºé †
    is_active BOOLEAN DEFAULT TRUE,    -- æœ‰åŠ¹ãƒ•ãƒ©ã‚°
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_roles_level ON roles(level);
CREATE INDEX idx_roles_active ON roles(is_active) WHERE is_active = TRUE;
```

**ã‚«ãƒ©ãƒ èª¬æ˜ï¼š**

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ | ä¾‹ |
|--------|---|------|-----|
| id | TEXT | å½¹è·IDï¼ˆäººé–“ãŒèª­ã‚ã‚‹IDï¼‰ | `role_ceo` |
| name | TEXT | å½¹è·å | `ä»£è¡¨å–ç· å½¹` |
| level | INTEGER | æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆ1-6ï¼‰ | `6` |
| description | TEXT | èª¬æ˜ | `æœ€é«˜çµŒå–¶è²¬ä»»è€…` |
| display_order | INTEGER | ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§ã®è¡¨ç¤ºé † | `1` |
| is_active | BOOLEAN | æœ‰åŠ¹/ç„¡åŠ¹ | `TRUE` |

### 5-2-2. employeesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¿®æ­£ï¼‰

**å¤‰æ›´å†…å®¹ï¼š** `role_id`ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 

```sql
-- role_idã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE employees
ADD COLUMN role_id TEXT REFERENCES roles(id);

-- æ—¢å­˜ç¤¾å“¡ã¯NULLè¨±å¯ï¼ˆæ‰‹å‹•ç§»è¡Œï¼‰
-- positionã‚«ãƒ©ãƒ ã¯æ®‹ã™ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
```

**ä¿®æ­£å¾Œã®ã‚«ãƒ©ãƒ ï¼š**

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ | å¤‰æ›´ |
|--------|---|------|------|
| id | TEXT | ç¤¾å“¡ID | æ—¢å­˜ |
| name | TEXT | ç¤¾å“¡å | æ—¢å­˜ |
| department_id | TEXT | éƒ¨ç½²ID | æ—¢å­˜ |
| position | TEXT | å½¹è·ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ | æ—¢å­˜ï¼ˆéæ¨å¥¨åŒ–ï¼‰ |
| **role_id** | TEXT | å½¹è·IDï¼ˆFKï¼‰ | **æ–°è¦è¿½åŠ ** |
| email | TEXT | ãƒ¡ãƒ¼ãƒ« | æ—¢å­˜ |
| ... | ... | ... | æ—¢å­˜ |

## 5-3. Cloud SQLï¼ˆã‚½ã‚¦ãƒ«ãã‚“ï¼‰

### 5-3-1. rolesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¿®æ­£ï¼‰

**å¤‰æ›´å†…å®¹ï¼š** `external_id`ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã€`level`ã‚’6æ®µéšã«çµ±ä¸€

```sql
-- external_idã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
ALTER TABLE roles
ADD COLUMN IF NOT EXISTS external_id VARCHAR(100) UNIQUE;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
CREATE INDEX IF NOT EXISTS idx_roles_external_id ON roles(external_id);
```

**ä¿®æ­£å¾Œã®ã‚«ãƒ©ãƒ ï¼š**

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ | å¤‰æ›´ |
|--------|---|------|------|
| id | UUID | å†…éƒ¨ID | æ—¢å­˜ |
| organization_id | UUID | ãƒ†ãƒŠãƒ³ãƒˆID | æ—¢å­˜ |
| **external_id** | VARCHAR(100) | Supabaseå´ã®ID | **æ–°è¦è¿½åŠ ** |
| name | VARCHAR(100) | å½¹è·å | æ—¢å­˜ |
| level | INTEGER | æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆ1-6ï¼‰ | å€¤ã‚’ä¿®æ­£ |
| description | TEXT | èª¬æ˜ | æ—¢å­˜ |
| is_active | BOOLEAN | æœ‰åŠ¹ãƒ•ãƒ©ã‚° | æ—¢å­˜ |

### 5-3-2. Roleãƒ¢ãƒ‡ãƒ«ï¼ˆuser.pyï¼‰ã®ä¿®æ­£

```python
class Role(Base, TimestampMixin):
    """å½¹è·ãƒã‚¹ã‚¿"""

    __tablename__ = "roles"

    id = Column(UUID(as_uuid=False), primary_key=True, default=generate_uuid)
    organization_id = Column(
        UUID(as_uuid=False),
        ForeignKey("organizations.id"),
        nullable=False,
    )
    external_id = Column(String(100), unique=True, nullable=True)  # ğŸ†• è¿½åŠ 
    name = Column(String(100), nullable=False)
    level = Column(Integer, default=1)  # 1-6ã®ç¯„å›²
    description = Column(Text, nullable=True)
    is_active = Column(Boolean, default=True)

    # Relationships
    organization = relationship("Organization", back_populates="roles")
```

### 5-3-3. chatwork_tasksãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¿®æ­£ï¼‰

**å¤‰æ›´å†…å®¹ï¼š** `department_id`ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 

```sql
-- department_idã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE chatwork_tasks
ADD COLUMN department_id UUID REFERENCES departments(id);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
CREATE INDEX idx_chatwork_tasks_department ON chatwork_tasks(department_id);
```

### 5-3-4. user_departmentsãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç¢ºèªï¼‰

**ç¾çŠ¶ï¼š** `role_in_dept`ã¯ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå¤‰æ›´ãªã—ï¼‰

å°†æ¥çš„ã«ã¯`role_id`ï¼ˆFKï¼‰ã«ç§»è¡Œã™ã‚‹ãŒã€ä»Šå›ã¯å¯¾è±¡å¤–ã€‚

---

# ç¬¬6ç« ï¼šAPIè¨­è¨ˆ

## 6-1. åŒæœŸAPIï¼ˆæ—¢å­˜ã®æ”¹ä¿®ï¼‰

### 6-1-1. æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŒæœŸAPIã®ãƒ•ãƒ­ãƒ¼                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€çµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ ã€‘                    ã€ã‚½ã‚¦ãƒ«ãã‚“ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚              â”‚                     â”‚
â”‚  ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³     â”‚              â”‚  åŒæœŸAPI            â”‚
â”‚       â”‚             â”‚              â”‚  /api/v1/           â”‚
â”‚       â–¼             â”‚    POST      â”‚  organizations/     â”‚
â”‚  syncToSoulSyncs()  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚  {org_id}/          â”‚
â”‚       â”‚             â”‚              â”‚  sync-org-chart     â”‚
â”‚       â”‚             â”‚              â”‚       â”‚             â”‚
â”‚       â”‚             â”‚              â”‚       â–¼             â”‚
â”‚       â”‚             â”‚              â”‚  organization_      â”‚
â”‚       â”‚             â”‚              â”‚  sync.py            â”‚
â”‚       â”‚             â”‚              â”‚       â”‚             â”‚
â”‚       â”‚             â”‚              â”‚       â–¼             â”‚
â”‚       â”‚             â”‚              â”‚  DBæ›´æ–°             â”‚
â”‚       â”‚             â”‚              â”‚  - roles            â”‚
â”‚       â”‚             â”‚              â”‚  - departments      â”‚
â”‚       â”‚             â”‚              â”‚  - users            â”‚
â”‚       â”‚             â”‚    200 OK    â”‚  - user_departments â”‚
â”‚  å®Œäº†é€šçŸ¥           â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                     â”‚
â”‚                     â”‚              â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6-1-2. çµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ å´ã®æ”¹ä¿®ï¼ˆapp.jsï¼‰

**ç¾çŠ¶ã®ã‚³ãƒ¼ãƒ‰ï¼ˆå‰Šé™¤ï¼‰ï¼š**
```javascript
// app.js:3458-3493ï¼ˆå‰Šé™¤å¯¾è±¡ï¼‰
// å½¹è·ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆï¼ˆemployeesã®positionã‹ã‚‰ä¸€æ„ãªå½¹è·ã‚’æŠ½å‡ºï¼‰
const positionSet = new Set();
employees.forEach(e => {
    if (e.position) positionSet.add(e.position);
});
const rolelevels = {
    'CEO': 1, 'ä»£è¡¨': 1, 'ç¤¾é•·': 1,
    // ...ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰
};
const mappedRoles = positions.map((pos, idx) => ({
    id: `role_${pos.replace(/\s+/g, '_').toLowerCase()}`,
    name: pos,
    level: rolelevels[pos] || 10,
    description: null
}));
```

**æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ï¼š**
```javascript
// app.js:3458-3470ï¼ˆæ–°è¦ï¼‰
// å½¹è·ãƒ‡ãƒ¼ã‚¿ã‚’Supabaseã‹ã‚‰å–å¾—ï¼ˆrolesãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
// â€»loadData()ã§globalå¤‰æ•° roles ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿
const mappedRoles = roles
    .filter(r => r.is_active !== false)
    .map(r => ({
        id: r.id,
        name: r.name,
        level: r.level,
        description: r.description
    }));

// ç¤¾å“¡ãƒ‡ãƒ¼ã‚¿ã«role_idã‚’å«ã‚ã‚‹
const mappedEmployees = employees.map(e => ({
    id: String(e.id),
    name: e.name,
    email: e.email || `${String(e.id).replace(/-/g, '')}@example.com`,
    departmentId: String(e.department_id),
    roleId: e.role_id || null,  // ğŸ†• role_idã‚’ä½¿ç”¨
    isPrimary: true,
    startDate: null,
    endDate: null
}));
```

### 6-1-3. ã‚½ã‚¦ãƒ«ãã‚“å´ã®æ”¹ä¿®ï¼ˆorganization_sync.pyï¼‰

**ç¾çŠ¶ï¼š** å¤‰æ›´ä¸è¦ï¼ˆæ—¢ã«external_idã§åŒæœŸï¼‰

ãŸã ã—ã€Roleãƒ¢ãƒ‡ãƒ«ã«`external_id`ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ã‚ã‚Šã€‚

## 6-2. æ¨©é™è¨ˆç®—APIï¼ˆæ–°è¦å®Ÿè£…ï¼‰

### 6-2-1. æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               compute_accessible_departments()              â”‚
â”‚               ã€Œã“ã®äººãŒè¦‹ã‚Œã‚‹éƒ¨ç½²ã‚’è¨ˆç®—ã™ã‚‹ã€              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…¥åŠ›ï¼šuser_idï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼‰

å‡¦ç†ï¼š
  1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰€å±éƒ¨ç½²ã‚’å–å¾—
  2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆrole.levelï¼‰ã‚’å–å¾—
  3. ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªéƒ¨ç½²ã‚’è¨ˆç®—

å‡ºåŠ›ï¼šã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªéƒ¨ç½²IDã®ãƒªã‚¹ãƒˆ
```

### 6-2-2. ãƒ­ã‚¸ãƒƒã‚¯è©³ç´°

```python
async def compute_accessible_departments(user_id: str) -> List[str]:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªéƒ¨ç½²IDã®ãƒªã‚¹ãƒˆã‚’è¿”ã™

    æ¨©é™ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼š
    - Level 6: å…¨éƒ¨ç½²ï¼ˆæœ€é«˜æ¨©é™ï¼‰
    - Level 5: å…¨éƒ¨ç½²ï¼ˆç®¡ç†éƒ¨ç‰¹æ¨©ï¼‰
    - Level 4: è‡ªéƒ¨ç½² + å…¨é…ä¸‹
    - Level 3: è‡ªéƒ¨ç½² + ç›´ä¸‹1éšå±¤
    - Level 2: è‡ªéƒ¨ç½²ã®ã¿
    - Level 1: è‡ªéƒ¨ç½²ã®ã¿
    """
    # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    user = await get_user_with_departments(user_id)
    if not user:
        return []

    # 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—
    role_level = await get_user_role_level(user_id)

    # 3. ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦è¨ˆç®—
    accessible = set()

    # Level 6, 5: å…¨éƒ¨ç½²
    if role_level >= 5:
        all_depts = await get_all_departments(user.organization_id)
        return [d.id for d in all_depts]

    # Level 4ä»¥ä¸‹: è‡ªéƒ¨ç½²ã‚’èµ·ç‚¹ã«è¨ˆç®—
    for user_dept in user.departments:
        dept = user_dept.department
        accessible.add(dept.id)  # è‡ªéƒ¨ç½²ã¯å¿…ãšå«ã‚€

        if role_level >= 4:
            # Level 4: å…¨é…ä¸‹
            descendants = await get_all_descendants(dept.id)
            accessible.update([d.id for d in descendants])
        elif role_level >= 3:
            # Level 3: ç›´ä¸‹ã®ã¿
            children = await get_direct_children(dept.id)
            accessible.update([d.id for d in children])
        # Level 2, 1: è‡ªéƒ¨ç½²ã®ã¿ï¼ˆè¿½åŠ ãªã—ï¼‰

    return list(accessible)
```

### 6-2-3. è£œåŠ©é–¢æ•°

```python
async def get_user_role_level(user_id: str) -> int:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—"""
    # user_departments.role_in_dept ã¾ãŸã¯ roles.level ã‹ã‚‰å–å¾—
    # è¤‡æ•°ã®éƒ¨ç½²ã«æ‰€å±ã—ã¦ã„ã‚‹å ´åˆã¯ã€æœ€ã‚‚é«˜ã„ãƒ¬ãƒ™ãƒ«ã‚’è¿”ã™
    ...

async def get_all_descendants(dept_id: str) -> List[Department]:
    """éƒ¨ç½²ã®å…¨é…ä¸‹ã‚’å–å¾—ï¼ˆLTREEä½¿ç”¨ï¼‰"""
    # SELECT * FROM departments WHERE path <@ (SELECT path FROM departments WHERE id = :dept_id)
    ...

async def get_direct_children(dept_id: str) -> List[Department]:
    """éƒ¨ç½²ã®ç›´ä¸‹ã®å­ã‚’å–å¾—"""
    # SELECT * FROM departments WHERE parent_id = :dept_id
    ...
```

### 6-2-4. å°†æ¥ã®æ‹¡å¼µï¼šå…„å¼Ÿéƒ¨ç½²å¯¾å¿œï¼ˆD2ï¼‰

```python
# å°†æ¥ã®æ‹¡å¼µç‰ˆï¼ˆä»Šå›ã¯å®Ÿè£…ã—ãªã„ï¼‰
if role_level >= 4 and can_view_sibling:
    # å…„å¼Ÿéƒ¨ç½²ã‚’å–å¾—
    siblings = await get_sibling_departments(dept.id)
    accessible.update([s.id for s in siblings])

async def get_sibling_departments(dept_id: str) -> List[Department]:
    """åŒã˜è¦ªã‚’æŒã¤éƒ¨ç½²ã‚’å–å¾—"""
    # SELECT * FROM departments d2
    # WHERE d2.parent_id = (SELECT parent_id FROM departments WHERE id = :dept_id)
    #   AND d2.id != :dept_id
    ...
```

---

# ç¬¬7ç« ï¼šUIè¨­è¨ˆ

## 7-1. å½¹è·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åŒ–

### 7-1-1. å¤‰æ›´ç®‡æ‰€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UIå¤‰æ›´ç®‡æ‰€ä¸€è¦§                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å¤‰æ›´1ã€‘loadDataé–¢æ•°ã«rolesèª­ã¿è¾¼ã¿ã‚’è¿½åŠ 
  â””â”€ app.js:89-133

ã€å¤‰æ›´2ã€‘ç¤¾å“¡è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®å½¹è·å…¥åŠ›ã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«
  â””â”€ app.js è©²å½“ç®‡æ‰€ï¼ˆpopulateRoleSelecté–¢æ•°ã‚’æ–°è¦ä½œæˆï¼‰

ã€å¤‰æ›´3ã€‘ç¤¾å“¡ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®å½¹è·å…¥åŠ›ã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«
  â””â”€ app.js è©²å½“ç®‡æ‰€

ã€å¤‰æ›´4ã€‘ç¤¾å“¡ã‚«ãƒ¼ãƒ‰ã®å½¹è·è¡¨ç¤º
  â””â”€ app.js:423ï¼ˆcreateEmployeeCardé–¢æ•°ï¼‰
```

### 7-1-2. loadDataé–¢æ•°ã®ä¿®æ­£

```javascript
// app.js:89-133ï¼ˆä¿®æ­£å¾Œï¼‰
async function loadData() {
    try {
        // éƒ¨ç½²ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        const deptResponse = await fetch(`${SUPABASE_REST_URL}/departments?limit=100`, {
            headers: {
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'apikey': SUPABASE_ANON_KEY,
                'Content-Type': 'application/json'
            }
        });
        departments = await deptResponse.json() || [];

        // ğŸ†• å½¹è·ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        const rolesResponse = await fetch(`${SUPABASE_REST_URL}/roles?is_active=eq.true&order=display_order`, {
            headers: {
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'apikey': SUPABASE_ANON_KEY,
                'Content-Type': 'application/json'
            }
        });
        roles = await rolesResponse.json() || [];

        // ç¤¾å“¡ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        const empResponse = await fetch(`${SUPABASE_REST_URL}/employees?limit=200`, {
            headers: {
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'apikey': SUPABASE_ANON_KEY,
                'Content-Type': 'application/json'
            }
        });
        employees = await empResponse.json() || [];

        // ... ä»¥ä¸‹æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
    } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        showNotification('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}
```

### 7-1-3. å½¹è·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆé–¢æ•°

```javascript
// æ–°è¦é–¢æ•°ï¼šå½¹è·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
function populateRoleSelect(selectElementId, selectedRoleId = null) {
    const select = document.getElementById(selectElementId);
    if (!select) return;

    // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
    select.innerHTML = '<option value="">å½¹è·ã‚’é¸æŠ...</option>';

    // å½¹è·ã‚’è¿½åŠ 
    roles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.id;
        option.textContent = `${role.name}ï¼ˆLevel ${role.level}ï¼‰`;
        if (selectedRoleId === role.id) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}
```

### 7-1-4. ãƒ•ã‚©ãƒ¼ãƒ ã®HTMLå¤‰æ›´

**å¤‰æ›´å‰ï¼ˆãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼‰ï¼š**
```html
<input type="text" id="addEmpPosition" placeholder="å½¹è·">
```

**å¤‰æ›´å¾Œï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠï¼‰ï¼š**
```html
<select id="addEmpRoleId" class="form-select">
    <option value="">å½¹è·ã‚’é¸æŠ...</option>
    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
</select>
<!-- æ—¢å­˜ã®positionã‚‚æ®‹ã™ï¼ˆæ‰‹å‹•å…¥åŠ›ç”¨ï¼‰ -->
<input type="text" id="addEmpPosition" placeholder="ãã®ä»–ã®å½¹è·ï¼ˆä»»æ„ï¼‰">
```

### 7-1-5. ç¤¾å“¡ã‚«ãƒ¼ãƒ‰ã®å½¹è·è¡¨ç¤º

```javascript
// createEmployeeCardé–¢æ•°å†…
function getRoleName(roleId) {
    if (!roleId) return '-';
    const role = roles.find(r => r.id === roleId);
    return role ? role.name : '-';
}

// è¡¨ç¤º
const displayPosition = emp.role_id
    ? getRoleName(emp.role_id)
    : (emp.position || '-');
```

---

# ç¬¬8ç« ï¼šãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»

## 8-1. å…¨ä½“ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ãƒ•ãƒ­ãƒ¼                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Step 1ã€‘Supabase: rolesãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    â”‚
    â–¼
ã€Step 2ã€‘Supabase: employeesã«role_idè¿½åŠ 
    â”‚
    â–¼
ã€Step 3ã€‘Cloud SQL: rolesã«external_idè¿½åŠ 
    â”‚
    â–¼
ã€Step 4ã€‘Cloud SQL: chatwork_tasksã«department_idè¿½åŠ 
    â”‚
    â–¼
ã€Step 5ã€‘app.js: å½¹è·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åŒ–
    â”‚
    â–¼
ã€Step 6ã€‘æ‰‹å‹•ç§»è¡Œ: æ—¢å­˜ç¤¾å“¡ã«role_idã‚’è¨­å®š
```

## 8-2. Supabaseãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### 8-2-1. rolesãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

```sql
-- ================================================================
-- Supabase Migration: roles ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
-- å®Ÿè¡Œæ—¥: 2026-01-XX
-- ä½œæˆè€…: Claude Code
-- ================================================================

-- 1. rolesãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE IF NOT EXISTS roles (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    level INTEGER NOT NULL DEFAULT 1 CHECK (level >= 1 AND level <= 6),
    description TEXT,
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX IF NOT EXISTS idx_roles_level ON roles(level);
CREATE INDEX IF NOT EXISTS idx_roles_active ON roles(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_roles_display_order ON roles(display_order);

-- 3. åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆ11ä»¶ï¼‰
INSERT INTO roles (id, name, level, description, display_order) VALUES
    ('role_ceo', 'ä»£è¡¨å–ç· å½¹', 6, 'æœ€é«˜çµŒå–¶è²¬ä»»è€…', 1),
    ('role_cfo', 'CFO', 6, 'æœ€é«˜è²¡å‹™è²¬ä»»è€…', 2),
    ('role_coo', 'COO', 6, 'æœ€é«˜åŸ·è¡Œè²¬ä»»è€…', 3),
    ('role_admin_mgr', 'ç®¡ç†éƒ¨ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼', 5, 'ç®¡ç†éƒ¨é–€è²¬ä»»è€…', 4),
    ('role_admin_staff', 'ç®¡ç†éƒ¨ã‚¹ã‚¿ãƒƒãƒ•', 5, 'ç®¡ç†éƒ¨é–€æ‹…å½“è€…', 5),
    ('role_director', 'å–ç· å½¹', 4, 'å¹¹éƒ¨', 6),
    ('role_dept_head', 'éƒ¨é•·', 4, 'éƒ¨é–€è²¬ä»»è€…', 7),
    ('role_section_head', 'èª²é•·', 3, 'èª²è²¬ä»»è€…', 8),
    ('role_leader', 'ãƒªãƒ¼ãƒ€ãƒ¼', 3, 'ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼', 9),
    ('role_employee', 'ç¤¾å“¡', 2, 'ä¸€èˆ¬ç¤¾å“¡', 10),
    ('role_contractor', 'æ¥­å‹™å§”è¨—', 1, 'å¤–éƒ¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼', 11)
ON CONFLICT (id) DO UPDATE SET
    name = EXCLUDED.name,
    level = EXCLUDED.level,
    description = EXCLUDED.description,
    display_order = EXCLUDED.display_order,
    updated_at = NOW();

-- 4. RLSï¼ˆRow Level Securityï¼‰ãƒãƒªã‚·ãƒ¼
ALTER TABLE roles ENABLE ROW LEVEL SECURITY;

-- èª­ã¿å–ã‚Šã¯å…¨å“¡å¯èƒ½
CREATE POLICY "roles_select_policy" ON roles
    FOR SELECT USING (true);

-- æ›´æ–°ã¯ç®¡ç†è€…ã®ã¿ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
-- CREATE POLICY "roles_update_policy" ON roles
--     FOR UPDATE USING (auth.role() = 'admin');
```

### 8-2-2. employeesãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£

```sql
-- ================================================================
-- Supabase Migration: employees ãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£
-- å®Ÿè¡Œæ—¥: 2026-01-XX
-- ä½œæˆè€…: Claude Code
-- ================================================================

-- 1. role_idã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE employees
ADD COLUMN IF NOT EXISTS role_id TEXT REFERENCES roles(id);

-- 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX IF NOT EXISTS idx_employees_role_id ON employees(role_id);

-- 3. positionã‚«ãƒ©ãƒ ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ï¼ˆéæ¨å¥¨åŒ–ã‚’æ˜ç¤ºï¼‰
COMMENT ON COLUMN employees.position IS 'ã€éæ¨å¥¨ã€‘role_idã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã—ã¦ã„ã¾ã™ã€‚';
```

## 8-3. Cloud SQLãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### 8-3-1. rolesãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£

```sql
-- ================================================================
-- Cloud SQL Migration: roles ãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£
-- å®Ÿè¡Œæ—¥: 2026-01-XX
-- ä½œæˆè€…: Claude Code
-- ================================================================

-- 1. external_idã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE roles
ADD COLUMN IF NOT EXISTS external_id VARCHAR(100) UNIQUE;

-- 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX IF NOT EXISTS idx_roles_external_id ON roles(external_id);

-- 3. levelã®ç¯„å›²ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§æ˜ç¤º
COMMENT ON COLUMN roles.level IS 'æ¨©é™ãƒ¬ãƒ™ãƒ«: 1=æ¥­å‹™å§”è¨—, 2=ç¤¾å“¡, 3=ãƒªãƒ¼ãƒ€ãƒ¼, 4=å¹¹éƒ¨/éƒ¨é•·, 5=ç®¡ç†éƒ¨, 6=ä»£è¡¨/CFO';
```

### 8-3-2. chatwork_tasksãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£

```sql
-- ================================================================
-- Cloud SQL Migration: chatwork_tasks ãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£
-- å®Ÿè¡Œæ—¥: 2026-01-XX
-- ä½œæˆè€…: Claude Code
-- ================================================================

-- 1. department_idã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE chatwork_tasks
ADD COLUMN IF NOT EXISTS department_id UUID REFERENCES departments(id);

-- 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX IF NOT EXISTS idx_chatwork_tasks_department ON chatwork_tasks(department_id);

-- 3. æ—¢å­˜ã‚¿ã‚¹ã‚¯ã¸ã®éƒ¨ç½²è¨­å®šï¼ˆæ‰‹å‹•ã¾ãŸã¯å¾Œæ—¥ãƒãƒƒãƒå‡¦ç†ï¼‰
-- æ‹…å½“è€…ã®ãƒ¡ã‚¤ãƒ³éƒ¨ç½²ã‚’è¨­å®š
-- UPDATE chatwork_tasks ct
-- SET department_id = (
--     SELECT ud.department_id
--     FROM user_departments ud
--     JOIN users u ON ud.user_id = u.id
--     WHERE u.chatwork_account_id = ct.assigned_to_account_id
--       AND ud.is_primary = TRUE
--       AND ud.ended_at IS NULL
--     LIMIT 1
-- )
-- WHERE ct.department_id IS NULL;
```

## 8-4. æ‰‹å‹•ç§»è¡Œè¨ˆç”»

### 8-4-1. æ—¢å­˜ç¤¾å“¡ã¸ã®å½¹è·è¨­å®š

**ä½œæ¥­è€…ï¼š** ã‚«ã‚ºã•ã‚“ ã¾ãŸã¯ ç®¡ç†éƒ¨

**æ‰‹é †ï¼š**
1. çµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³
2. å„ç¤¾å“¡ã®ç·¨é›†ç”»é¢ã‚’é–‹ã
3. å½¹è·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰é©åˆ‡ãªå½¹è·ã‚’é¸æŠ
4. ä¿å­˜

**ç§»è¡Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼š**

| ç¤¾å“¡å | ç¾åœ¨ã®position | æ–°ã—ã„role_id | ç§»è¡Œæ¸ˆã¿ |
|--------|---------------|---------------|----------|
| ã‚«ã‚ºã•ã‚“ | ä»£è¡¨ | role_ceo | [ ] |
| ã€‡ã€‡ã•ã‚“ | éƒ¨é•· | role_dept_head | [ ] |
| ... | ... | ... | [ ] |

### 8-4-2. ç§»è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| æ—¥ | ä½œæ¥­ | æ‹…å½“ |
|---|------|------|
| Day 1 | Supabaseãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ | ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ |
| Day 1 | app.jsæ”¹ä¿®ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ | ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ |
| Day 2 | Cloud SQLãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ | ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ |
| Day 2-3 | æ—¢å­˜ç¤¾å“¡ã®å½¹è·è¨­å®šï¼ˆæ‰‹å‹•ï¼‰ | ã‚«ã‚ºã•ã‚“/ç®¡ç†éƒ¨ |
| Day 4 | å‹•ä½œç¢ºèªãƒ»ãƒ†ã‚¹ãƒˆ | å…¨å“¡ |

---

# ç¬¬9ç« ï¼šãƒ†ã‚¹ãƒˆè¨ˆç”»

## 9-1. ãƒ†ã‚¹ãƒˆã®ç¨®é¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  E2E    â”‚ â† å°‘æ•°ï¼ˆ5ä»¶ï¼‰
                    â”‚ ãƒ†ã‚¹ãƒˆ  â”‚   ãƒ–ãƒ©ã‚¦ã‚¶ã§å…¨ä½“å‹•ä½œç¢ºèª
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                   â”‚  çµåˆ     â”‚ â† ä¸­ç¨‹åº¦ï¼ˆ10ä»¶ï¼‰
                   â”‚  ãƒ†ã‚¹ãƒˆ   â”‚   APIé–“ã®é€£æºç¢ºèª
                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚       å˜ä½“ãƒ†ã‚¹ãƒˆ    â”‚ â† å¤šæ•°ï¼ˆ30ä»¶ï¼‰
              â”‚  é–¢æ•°ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰å˜ä½ â”‚   ãƒ­ã‚¸ãƒƒã‚¯ã®æ­£ç¢ºæ€§
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 9-2. å˜ä½“ãƒ†ã‚¹ãƒˆ

### 9-2-1. æ¨©é™è¨ˆç®—ãƒ†ã‚¹ãƒˆï¼ˆ18ã‚±ãƒ¼ã‚¹ï¼‰

| # | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | å…¥åŠ› | æœŸå¾…çµæœ |
|---|-------------|------|----------|
| 1 | Level 6ã¯å…¨éƒ¨ç½²è¦‹ã‚Œã‚‹ | user(level=6) | å…¨éƒ¨ç½²ID |
| 2 | Level 5ã¯å…¨éƒ¨ç½²è¦‹ã‚Œã‚‹ | user(level=5) | å…¨éƒ¨ç½²ID |
| 3 | Level 4ã¯è‡ªéƒ¨ç½²ï¼‹é…ä¸‹ | user(level=4, dept=å–¶æ¥­éƒ¨) | å–¶æ¥­éƒ¨ï¼‹æ±äº¬å–¶æ¥­èª²ï¼‹å¤§é˜ªå–¶æ¥­èª² |
| 4 | Level 4ã¯ä»–éƒ¨ç½²è¦‹ã‚Œãªã„ | user(level=4, dept=å–¶æ¥­éƒ¨) | é–‹ç™ºéƒ¨ã‚’å«ã¾ãªã„ |
| 5 | Level 3ã¯è‡ªéƒ¨ç½²ï¼‹ç›´ä¸‹ | user(level=3, dept=æ±äº¬å–¶æ¥­èª²) | æ±äº¬å–¶æ¥­èª²ï¼‹ç¬¬ä¸€ãƒãƒ¼ãƒ  |
| 6 | Level 3ã¯2éšå±¤ä¸‹è¦‹ã‚Œãªã„ | user(level=3, dept=å–¶æ¥­éƒ¨) | ç¬¬ä¸€ãƒãƒ¼ãƒ ï¼ˆ2éšå±¤ä¸‹ï¼‰ã‚’å«ã¾ãªã„ |
| 7 | Level 2ã¯è‡ªéƒ¨ç½²ã®ã¿ | user(level=2, dept=æ±äº¬å–¶æ¥­èª²) | æ±äº¬å–¶æ¥­èª²ã®ã¿ |
| 8 | Level 2ã¯é…ä¸‹è¦‹ã‚Œãªã„ | user(level=2, dept=æ±äº¬å–¶æ¥­èª²) | ç¬¬ä¸€ãƒãƒ¼ãƒ ã‚’å«ã¾ãªã„ |
| 9 | Level 1ã¯è‡ªéƒ¨ç½²ã®ã¿ | user(level=1, dept=æ±äº¬å–¶æ¥­èª²) | æ±äº¬å–¶æ¥­èª²ã®ã¿ |
| 10 | è¤‡æ•°éƒ¨ç½²æ‰€å±ï¼ˆæœ€é«˜ãƒ¬ãƒ™ãƒ«é©ç”¨ï¼‰ | user(level=4@å–¶æ¥­, level=2@é–‹ç™º) | å–¶æ¥­éƒ¨é…ä¸‹ï¼‹é–‹ç™ºéƒ¨ |
| 11 | éƒ¨ç½²æœªæ‰€å± | user(no_dept) | ç©ºãƒªã‚¹ãƒˆ |
| 12 | ç„¡åŠ¹ãªéƒ¨ç½² | user(invalid_dept) | ç©ºãƒªã‚¹ãƒˆ |
| 13-18 | å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ | level=0, level=7, etc. | é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ |

### 9-2-2. åŒæœŸAPIãƒ†ã‚¹ãƒˆï¼ˆ6ã‚±ãƒ¼ã‚¹ï¼‰

| # | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | å…¥åŠ› | æœŸå¾…çµæœ |
|---|-------------|------|----------|
| 1 | æ–°è¦å½¹è·ã®åŒæœŸ | roles=[{id: 'role_new', level: 3}] | roles.count += 1 |
| 2 | æ—¢å­˜å½¹è·ã®æ›´æ–° | roles=[{id: 'role_ceo', level: 6}] | æ›´æ–°æˆåŠŸ |
| 3 | é‡è¤‡IDã®å‡¦ç† | roles=[{id: 'dup'}, {id: 'dup'}] | ã‚¨ãƒ©ãƒ¼ |
| 4 | ç„¡åŠ¹ãªlevel | roles=[{level: 10}] | ã‚¨ãƒ©ãƒ¼ |
| 5 | ç©ºã®å½¹è·ãƒªã‚¹ãƒˆ | roles=[] | æˆåŠŸï¼ˆå¤‰æ›´ãªã—ï¼‰ |
| 6 | å†ªç­‰æ€§ç¢ºèª | åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’2å› | åŒã˜çµæœ |

### 9-2-3. UIãƒ†ã‚¹ãƒˆï¼ˆ6ã‚±ãƒ¼ã‚¹ï¼‰

| # | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æ“ä½œ | æœŸå¾…çµæœ |
|---|-------------|------|----------|
| 1 | å½¹è·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è¡¨ç¤º | ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ | 11ä»¶ã®å½¹è·ãŒè¡¨ç¤º |
| 2 | å½¹è·é¸æŠ | ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§é¸æŠ | role_idãŒã‚»ãƒƒãƒˆ |
| 3 | ç¤¾å“¡ä¿å­˜ | ä¿å­˜ãƒœã‚¿ãƒ³ | role_idãŒDBã«ä¿å­˜ |
| 4 | ç¤¾å“¡ç·¨é›† | ç·¨é›†ç”»é¢è¡¨ç¤º | æ—¢å­˜ã®role_idãŒé¸æŠçŠ¶æ…‹ |
| 5 | å½¹è·ãªã—ã§ä¿å­˜ | æœªé¸æŠã§ä¿å­˜ | æˆåŠŸï¼ˆrole_id=nullï¼‰ |
| 6 | ç„¡åŠ¹ãªå½¹è·ID | ä¸æ­£ãªIDã‚’é€ä¿¡ | ã‚¨ãƒ©ãƒ¼è¡¨ç¤º |

## 9-3. çµåˆãƒ†ã‚¹ãƒˆ

### 9-3-1. åŒæœŸãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ

| # | ã‚·ãƒŠãƒªã‚ª | ç¢ºèªé …ç›® |
|---|----------|----------|
| 1 | çµ„ç¹”å›³â†’ã‚½ã‚¦ãƒ«ãã‚“åŒæœŸ | rolesãŒæ­£ã—ãåŒæœŸã•ã‚Œã‚‹ |
| 2 | ç¤¾å“¡ã®å½¹è·åŒæœŸ | user_departments.role_in_deptãŒæ›´æ–°ã•ã‚Œã‚‹ |
| 3 | éƒ¨ç½²éšå±¤ã®åŒæœŸ | department_hierarchiesãŒæ­£ã—ãæ§‹ç¯‰ |
| 4 | åŒæœŸã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | éƒ¨åˆ†æ›´æ–°ã•ã‚Œãªã„ |

### 9-3-2. æ¨©é™ãƒ•ã‚£ãƒ«ã‚¿ãƒ†ã‚¹ãƒˆ

| # | ã‚·ãƒŠãƒªã‚ª | æ“ä½œ | æœŸå¾…çµæœ |
|---|----------|------|----------|
| 1 | Level 4ã§ã‚¿ã‚¹ã‚¯æ¤œç´¢ | ã€Œè‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯ã‚’æ•™ãˆã¦ã€ | è‡ªéƒ¨ç½²ï¼‹é…ä¸‹ã®ã‚¿ã‚¹ã‚¯ã®ã¿ |
| 2 | Level 2ã§ã‚¿ã‚¹ã‚¯æ¤œç´¢ | ã€Œè‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯ã‚’æ•™ãˆã¦ã€ | è‡ªéƒ¨ç½²ã®ã‚¿ã‚¹ã‚¯ã®ã¿ |
| 3 | Level 6ã§ã‚¿ã‚¹ã‚¯æ¤œç´¢ | ã€Œè‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯ã‚’æ•™ãˆã¦ã€ | å…¨ã‚¿ã‚¹ã‚¯ |

## 9-4. E2Eãƒ†ã‚¹ãƒˆ

| # | ã‚·ãƒŠãƒªã‚ª | æ‰‹é † | æœŸå¾…çµæœ |
|---|----------|------|----------|
| 1 | æ–°è¦ç¤¾å“¡ç™»éŒ²â†’åŒæœŸâ†’ã‚¿ã‚¹ã‚¯æ¤œç´¢ | 1. ç¤¾å“¡è¿½åŠ  2. å½¹è·é¸æŠ 3. ä¿å­˜ 4. åŒæœŸ 5. ã‚¿ã‚¹ã‚¯æ¤œç´¢ | æ¨©é™ã«å¿œã˜ãŸã‚¿ã‚¹ã‚¯è¡¨ç¤º |
| 2 | å½¹è·å¤‰æ›´â†’æ¨©é™åæ˜  | 1. ç¤¾å“¡ã®å½¹è·å¤‰æ›´ 2. åŒæœŸ 3. ã‚¿ã‚¹ã‚¯æ¤œç´¢ | æ–°ã—ã„æ¨©é™ãŒåæ˜  |

## 9-5. ãƒ†ã‚¹ãƒˆå„ªå…ˆé †ä½

| å„ªå…ˆåº¦ | ãƒ†ã‚¹ãƒˆ | ç†ç”± |
|--------|--------|------|
| **é«˜** | æ¨©é™è¨ˆç®—ï¼ˆLevel 4-6ï¼‰ | ã‚³ã‚¢æ©Ÿèƒ½ |
| **é«˜** | åŒæœŸã®å†ªç­‰æ€§ | ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ |
| **ä¸­** | UIã®å½¹è·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ |
| **ä¸­** | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° | é‹ç”¨å®‰å®šæ€§ |
| **ä½** | å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ | ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ |

---

# ç¬¬10ç« ï¼šå®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

## 10-1. å…¨ä½“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Day 1          Day 2          Day 3          Day 4          Day 5          Day 6
â”‚              â”‚              â”‚              â”‚              â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Phase A    â”‚   Phase B    â”‚   Phase C    â”‚   Phase D    â”‚    ãƒ†ã‚¹ãƒˆ    â”‚
â”‚  åŸºç›¤æ•´å‚™    â”‚  åŒæœŸå¼·åŒ–    â”‚ ã‚¿ã‚¹ã‚¯é€£æº   â”‚ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ â”‚   å‹•ä½œç¢ºèª   â”‚
â”‚   (14h)      â”‚    (6h)      â”‚    (6h)      â”‚   (12h)      â”‚   (12h)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç·å·¥æ•°: 50æ™‚é–“ï¼ˆç´„6æ—¥ï¼‰
```

## 10-2. Phase Aï¼šåŸºç›¤æ•´å‚™ï¼ˆ14æ™‚é–“ï¼‰

### A1. Supabaseã«rolesãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆï¼ˆ3æ™‚é–“ï¼‰

```markdown
â–¡ A1-1. Supabaseç®¡ç†ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³
â–¡ A1-2. SQLã‚¨ãƒ‡ã‚£ã‚¿ã§rolesãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆSQLã‚’å®Ÿè¡Œ
â–¡ A1-3. 11ä»¶ã®åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã‚’ç¢ºèª
â–¡ A1-4. RLSãƒãƒªã‚·ãƒ¼ã‚’è¨­å®š
â–¡ A1-5. ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚’ç¢ºèªï¼ˆSELECT * FROM rolesï¼‰
```

**ç¢ºèªã‚³ãƒãƒ³ãƒ‰ï¼š**
```sql
SELECT id, name, level FROM roles ORDER BY display_order;
-- æœŸå¾…: 11ä»¶ã®å½¹è·ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

### A2. Supabaseã®employeesãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£ï¼ˆ1æ™‚é–“ï¼‰

```markdown
â–¡ A2-1. role_idã‚«ãƒ©ãƒ è¿½åŠ SQLã‚’å®Ÿè¡Œ
â–¡ A2-2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã‚’ç¢ºèª
â–¡ A2-3. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ãŒãªã„ã“ã¨ã‚’ç¢ºèª
```

**ç¢ºèªã‚³ãƒãƒ³ãƒ‰ï¼š**
```sql
SELECT id, name, position, role_id FROM employees LIMIT 5;
-- æœŸå¾…: role_idåˆ—ãŒè¿½åŠ ã•ã‚Œã€å…¨ã¦NULL
```

### A3. Cloud SQLã®rolesãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£ï¼ˆ2æ™‚é–“ï¼‰

```markdown
â–¡ A3-0. ç¾åœ¨ã®rolesãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç¢ºèª
â–¡ A3-1. external_idã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆã€è¿½åŠ 
â–¡ A3-2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
â–¡ A3-3. Roleãƒ¢ãƒ‡ãƒ«ï¼ˆuser.pyï¼‰ã«external_idè¿½åŠ 
â–¡ A3-4. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
```

**ç¢ºèªã‚³ãƒãƒ³ãƒ‰ï¼š**
```sql
\d roles
-- æœŸå¾…: external_id VARCHAR(100) ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

### A4. çµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ ï¼ˆapp.jsï¼‰ã®æ”¹ä¿®ï¼ˆ8æ™‚é–“ï¼‰

```markdown
â–¡ A4-1. loadDataé–¢æ•°ã«rolesèª­ã¿è¾¼ã¿ã‚’è¿½åŠ 
â–¡ A4-2. populateRoleSelecté–¢æ•°ã‚’æ–°è¦ä½œæˆ
â–¡ A4-3. ç¤¾å“¡è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®å½¹è·ã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åŒ–
â–¡ A4-4. ç¤¾å“¡ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®å½¹è·ã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åŒ–
â–¡ A4-5. createEmployeeCardé–¢æ•°ã§role_idã‚’ä½¿ç”¨
â–¡ A4-6. ç¤¾å“¡ä¿å­˜å‡¦ç†ã§role_idã‚’é€ä¿¡
â–¡ A4-7. ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ä½œç¢ºèª
â–¡ A4-8. æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
```

## 10-3. Phase Bï¼šåŒæœŸæ©Ÿèƒ½å¼·åŒ–ï¼ˆ6æ™‚é–“ï¼‰

### B1. åŒæœŸAPIã®æ”¹ä¿®ï¼ˆ4æ™‚é–“ï¼‰

```markdown
â–¡ B1-1. app.jsã®å½¹è·ãƒãƒƒãƒ”ãƒ³ã‚°ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
â–¡ B1-2. rolesãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å‹•çš„ã«å–å¾—ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´
â–¡ B1-3. mappedEmployeesã«role_idã‚’å«ã‚ã‚‹
â–¡ B1-4. åŒæœŸå‡¦ç†ã®ãƒ†ã‚¹ãƒˆ
â–¡ B1-5. æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
```

### B2. åŒæœŸãƒœã‚¿ãƒ³ã®å‹•ä½œç¢ºèªï¼ˆ2æ™‚é–“ï¼‰

```markdown
â–¡ B2-1. çµ„ç¹”å›³ã§ã€Œã‚½ã‚¦ãƒ«ãã‚“ã«åŒæœŸã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹
â–¡ B2-2. ã‚½ã‚¦ãƒ«ãã‚“ã®rolesãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª
â–¡ B2-3. åŒæœŸãƒ­ã‚°ã‚’ç¢ºèª
â–¡ B2-4. ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ç¢ºèª
```

## 10-4. Phase Cï¼šã‚¿ã‚¹ã‚¯ç®¡ç†é€£æºï¼ˆ6æ™‚é–“ï¼‰

### C1. chatwork_tasksã«department_idè¿½åŠ ï¼ˆ2æ™‚é–“ï¼‰

```markdown
â–¡ C1-1. Cloud SQLã§ALTER TABLEã‚’å®Ÿè¡Œ
â–¡ C1-2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
â–¡ C1-3. æ—¢å­˜ã‚¿ã‚¹ã‚¯ã¸ã®å½±éŸ¿ãŒãªã„ã“ã¨ã‚’ç¢ºèª
```

### C2. ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã«éƒ¨ç½²ã‚’è‡ªå‹•è¨­å®šï¼ˆ4æ™‚é–“ï¼‰

```markdown
â–¡ C2-1. ã‚¿ã‚¹ã‚¯ä½œæˆå‡¦ç†ã‚’ç¢ºèªï¼ˆmain.py, chatwork-webhook/main.pyï¼‰
â–¡ C2-2. æ‹…å½“è€…ã®éƒ¨ç½²ã‚’å–å¾—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
â–¡ C2-3. department_idã‚’è¨­å®šã™ã‚‹ã‚³ãƒ¼ãƒ‰è¿½åŠ 
â–¡ C2-4. ãƒ†ã‚¹ãƒˆ
â–¡ C2-5. æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
```

## 10-5. Phase Dï¼šã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆ12æ™‚é–“ï¼‰

### D1. compute_accessible_departmentså®Ÿè£…ï¼ˆ6æ™‚é–“ï¼‰

```markdown
â–¡ D1-1. é–¢æ•°ã®ã‚¹ã‚±ãƒ«ãƒˆãƒ³ä½œæˆ
â–¡ D1-2. Level 6, 5ã®ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆå…¨éƒ¨ç½²ï¼‰
â–¡ D1-3. Level 4ã®ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆè‡ªéƒ¨ç½²ï¼‹é…ä¸‹ï¼‰
â–¡ D1-4. Level 3ã®ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆè‡ªéƒ¨ç½²ï¼‹ç›´ä¸‹ï¼‰
â–¡ D1-5. Level 2, 1ã®ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆè‡ªéƒ¨ç½²ã®ã¿ï¼‰
â–¡ D1-6. å˜ä½“ãƒ†ã‚¹ãƒˆä½œæˆãƒ»å®Ÿè¡Œ
```

### D2. ã‚¿ã‚¹ã‚¯æ¤œç´¢ã¸ã®çµ±åˆï¼ˆ6æ™‚é–“ï¼‰

```markdown
â–¡ D2-1. search_tasks_from_dbé–¢æ•°ã‚’ç¢ºèª
â–¡ D2-2. compute_accessible_departmentsã‚’å‘¼ã³å‡ºã—
â–¡ D2-3. WHEREå¥ã«department_idãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
â–¡ D2-4. ãƒ†ã‚¹ãƒˆ
â–¡ D2-5. æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
```

## 10-6. ãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ12æ™‚é–“ï¼‰

### å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆ4æ™‚é–“ï¼‰

```markdown
â–¡ æ¨©é™è¨ˆç®—ãƒ†ã‚¹ãƒˆ18ã‚±ãƒ¼ã‚¹
â–¡ åŒæœŸAPIãƒ†ã‚¹ãƒˆ6ã‚±ãƒ¼ã‚¹
â–¡ UIãƒ†ã‚¹ãƒˆ6ã‚±ãƒ¼ã‚¹
```

### çµåˆãƒ†ã‚¹ãƒˆï¼ˆ4æ™‚é–“ï¼‰

```markdown
â–¡ åŒæœŸãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ4ã‚±ãƒ¼ã‚¹
â–¡ æ¨©é™ãƒ•ã‚£ãƒ«ã‚¿ãƒ†ã‚¹ãƒˆ3ã‚±ãƒ¼ã‚¹
```

### E2Eãƒ†ã‚¹ãƒˆï¼ˆ2æ™‚é–“ï¼‰

```markdown
â–¡ æ–°è¦ç¤¾å“¡ç™»éŒ²â†’åŒæœŸâ†’ã‚¿ã‚¹ã‚¯æ¤œç´¢
â–¡ å½¹è·å¤‰æ›´â†’æ¨©é™åæ˜ 
```

### ãƒã‚°ä¿®æ­£ãƒ»èª¿æ•´ï¼ˆ2æ™‚é–“ï¼‰

```markdown
â–¡ ç™ºè¦‹ã—ãŸãƒã‚°ã®ä¿®æ­£
â–¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª¿æ•´
â–¡ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
```

## 10-7. å·¥æ•°ã‚µãƒãƒªãƒ¼

| Phase | å†…å®¹ | å·¥æ•° |
|-------|------|------|
| A1 | Supabase rolesãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ | 3æ™‚é–“ |
| A2 | Supabase employeesä¿®æ­£ | 1æ™‚é–“ |
| A3 | Cloud SQL rolesä¿®æ­£ | 2æ™‚é–“ |
| A4 | app.jsæ”¹ä¿® | 8æ™‚é–“ |
| **Phase A è¨ˆ** | **åŸºç›¤æ•´å‚™** | **14æ™‚é–“** |
| B1 | åŒæœŸAPIæ”¹ä¿® | 4æ™‚é–“ |
| B2 | å‹•ä½œç¢ºèª | 2æ™‚é–“ |
| **Phase B è¨ˆ** | **åŒæœŸæ©Ÿèƒ½å¼·åŒ–** | **6æ™‚é–“** |
| C1 | chatwork_tasksä¿®æ­£ | 2æ™‚é–“ |
| C2 | ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã®éƒ¨ç½²è¨­å®š | 4æ™‚é–“ |
| **Phase C è¨ˆ** | **ã‚¿ã‚¹ã‚¯é€£æº** | **6æ™‚é–“** |
| D1 | compute_accessible_departments | 6æ™‚é–“ |
| D2 | ã‚¿ã‚¹ã‚¯æ¤œç´¢ã¸ã®çµ±åˆ | 6æ™‚é–“ |
| **Phase D è¨ˆ** | **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡** | **12æ™‚é–“** |
| **é–‹ç™ºåˆè¨ˆ** | | **38æ™‚é–“** |
| ãƒ†ã‚¹ãƒˆ | å˜ä½“ï¼‹çµåˆï¼‹E2E | 12æ™‚é–“ |
| **ç·å·¥æ•°** | | **50æ™‚é–“ï¼ˆç´„6æ—¥ï¼‰** |

---

# ç¬¬11ç« ï¼šå°†æ¥ã®æ‹¡å¼µæ€§

## 11-1. ä»Šå›å®Ÿè£…ã—ãªã„ãŒã€å°†æ¥å¯¾å¿œäºˆå®šã®æ©Ÿèƒ½

### 11-1-1. å…„å¼Ÿéƒ¨ç½²ã®é–²è¦§ï¼ˆPhase D2ï¼‰

**ç¾çŠ¶ï¼š** Level 4ã¯ã€Œè‡ªéƒ¨ç½²ï¼‹é…ä¸‹ã€ã®ã¿

**å°†æ¥ï¼š** Level 4ã¯ã€Œè‡ªéƒ¨ç½²ï¼‹é…ä¸‹ï¼‹å…„å¼Ÿã€ã‚‚å¯èƒ½

```python
# å°†æ¥ã®æ‹¡å¼µç®‡æ‰€
# compute_accessible_departmentsé–¢æ•°å†…
if role_level >= 4 and scope.can_view_sibling_departments:
    siblings = await get_sibling_departments(dept.id)
    accessible.update([s.id for s in siblings])
```

**æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆï¼š**
- `department_access_scopes.can_view_sibling_departments`ã¯æ—¢ã«å­˜åœ¨
- ãƒ•ãƒ©ã‚°ã‚’TRUEã«ã™ã‚‹ã ã‘ã§æœ‰åŠ¹åŒ–å¯èƒ½

### 11-1-2. æ©Ÿå¯†åŒºåˆ†ï¼ˆPhase E / Phase 3çµ±åˆï¼‰

**ç¾çŠ¶ï¼š** æœªå®Ÿè£…

**å°†æ¥ï¼š** 5æ®µéšã®æ©Ÿå¯†åŒºåˆ†

```sql
-- documents.classification ã‚«ãƒ©ãƒ 
ALTER TABLE documents
ADD COLUMN classification VARCHAR(20) DEFAULT 'internal'
CHECK (classification IN ('top_secret', 'restricted', 'confidential', 'internal', 'public'));
```

**æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆï¼š**
- documentsãƒ†ãƒ¼ãƒ–ãƒ«ã«classificationã‚«ãƒ©ãƒ è¿½åŠ 
- æ¤œç´¢æ™‚ã«æ¨©é™ãƒ¬ãƒ™ãƒ«ã¨classificationã‚’ç…§åˆ

### 11-1-3. BPaaSå¯¾å¿œï¼ˆPhase 4ï¼‰

**ç¾çŠ¶ï¼š** ã‚·ãƒ³ã‚°ãƒ«ãƒ†ãƒŠãƒ³ãƒˆï¼ˆã‚½ã‚¦ãƒ«ã‚·ãƒ³ã‚¯ã‚¹å°‚ç”¨ï¼‰

**å°†æ¥ï¼š** ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆï¼ˆè¤‡æ•°ä¼æ¥­ã§åˆ©ç”¨å¯èƒ½ï¼‰

**æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆï¼š**
- å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«`organization_id`ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ—¢ã«å¯¾å¿œæ¸ˆã¿ï¼‰
- Row Level Securityï¼ˆRLSï¼‰ã®æœ‰åŠ¹åŒ–
- ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã®å½¹è·ãƒã‚¹ã‚¿

## 11-2. è¨­è¨ˆä¸Šã®æ‹¡å¼µæ€§æ‹…ä¿

### 11-2-1. roles.levelã®è¨­è¨ˆ

**ãªãœ1-6ã«ã—ãŸã‹ï¼š**
- å°†æ¥ã®ãƒ¬ãƒ™ãƒ«è¿½åŠ ã«å¯¾å¿œï¼ˆä¾‹ï¼šLevel 7ã‚’è¿½åŠ å¯èƒ½ï¼‰
- 0ã‚„è² ã®å€¤ã‚’ä½¿ã‚ãªã„ï¼ˆç›´æ„Ÿçš„ã§ãªã„ï¼‰
- 10æ®µéšã«ã—ãªã„ï¼ˆç²’åº¦ãŒç´°ã‹ã™ãã‚‹ï¼‰

### 11-2-2. external_idã®è¨­è¨ˆ

**ãªãœå¿…è¦ã‹ï¼š**
- Supabaseã®rolesã¨ã‚½ã‚¦ãƒ«ãã‚“ã®rolesã‚’ç´ã¥ã‘ã‚‹
- UUIDã§ã¯ãªãäººé–“ãŒèª­ã‚ã‚‹IDï¼ˆ`role_ceo`ï¼‰ã‚’ä½¿ç”¨
- å°†æ¥ã®ä»–ã‚·ã‚¹ãƒ†ãƒ é€£æºã«ã‚‚å¯¾å¿œå¯èƒ½

### 11-2-3. department_access_scopesã®è¨­è¨ˆ

**ãªãœãƒ†ãƒ¼ãƒ–ãƒ«ã‚’åˆ†ã‘ãŸã‹ï¼š**
- éƒ¨ç½²ã”ã¨ã«ç•°ãªã‚‹ã‚¢ã‚¯ã‚»ã‚¹ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šå¯èƒ½
- `max_depth`ã§éšå±¤ã®æ·±ã•ã‚’åˆ¶å¾¡
- å°†æ¥ã®è¤‡é›‘ãªãƒ«ãƒ¼ãƒ«ã«å¯¾å¿œï¼ˆä¾‹ï¼šç‰¹å®šéƒ¨ç½²ã®ã¿é–²è¦§å¯èƒ½ï¼‰

## 11-3. è¨­è¨ˆåˆ¤æ–­ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•

| åˆ¤æ–­ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ | é¸æŠç†ç”± |
|------|----------|-----------|---------|
| ãƒ¬ãƒ™ãƒ«ã‚’6æ®µéš | ã‚·ãƒ³ãƒ—ãƒ« | ç´°ã‹ã„åˆ¶å¾¡ä¸å¯ | é‹ç”¨ã§ååˆ† |
| å…„å¼Ÿéƒ¨ç½²ã¯å¾Œå›ã— | å·¥æ•°å‰Šæ¸› | åˆæœŸã¯æ©Ÿèƒ½åˆ¶é™ | å¿…è¦æ€§ã‚’ç¢ºèªå¾Œ |
| æ‰‹å‹•ç§»è¡Œ | å®‰å…¨ãƒ»ç¢ºå®Ÿ | æ‰‹é–“ãŒã‹ã‹ã‚‹ | è¡¨è¨˜ã‚†ã‚Œãƒªã‚¹ã‚¯å›é¿ |
| role_idã¨positionä¸¡æ–¹æ®‹ã™ | å¾Œæ–¹äº’æ›æ€§ | å†—é•· | ç§»è¡ŒæœŸé–“ã®å®‰å…¨ç­– |

---

# ç¬¬12ç« ï¼šç”¨èªé›†

| ç”¨èª | æ„å‘³ | ä¾‹ |
|------|------|-----|
| **æ¨©é™ãƒ¬ãƒ™ãƒ«** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã®é«˜ã•ã‚’è¡¨ã™æ•°å€¤ï¼ˆ1-6ï¼‰ | Level 6 = ä»£è¡¨ãƒ»CFO |
| **å½¹è·ãƒã‚¹ã‚¿** | å½¹è·ã®ä¸€è¦§ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ« | rolesãƒ†ãƒ¼ãƒ–ãƒ« |
| **æ©Ÿå¯†åŒºåˆ†** | æƒ…å ±ã®æ©Ÿå¯†åº¦ã‚’è¡¨ã™åˆ†é¡ï¼ˆPhase 3ã§å®Ÿè£…ï¼‰ | top_secret, internal, etc. |
| **Supabase** | çµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ ãŒä½¿ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¦ãƒ‰DB | PostgreSQLäº’æ› |
| **Cloud SQL** | ã‚½ã‚¦ãƒ«ãã‚“ãŒä½¿ç”¨ã™ã‚‹GCPã®DB | PostgreSQL |
| **åŒæœŸ** | 2ã¤ã®DBã®é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€è‡´ã•ã›ã‚‹ã“ã¨ | çµ„ç¹”å›³â†’ã‚½ã‚¦ãƒ«ãã‚“ |
| **external_id** | å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã®IDã‚’ä¿å­˜ã™ã‚‹ã‚«ãƒ©ãƒ  | Supabaseã®roles.id |
| **LTREE** | PostgreSQLã®éšå±¤æ§‹é€ ã‚’æ‰±ã†æ‹¡å¼µæ©Ÿèƒ½ | `soulsyncs.sales.tokyo` |
| **é…ä¸‹** | ã‚ã‚‹éƒ¨ç½²ã®ä¸‹ã«ã‚ã‚‹å…¨ã¦ã®éƒ¨ç½² | å–¶æ¥­éƒ¨ã®é…ä¸‹ = æ±äº¬å–¶æ¥­èª²ã€å¤§é˜ªå–¶æ¥­èª² |
| **å…„å¼Ÿ** | åŒã˜è¦ªã‚’æŒã¤ä»–ã®éƒ¨ç½² | å–¶æ¥­éƒ¨ã®å…„å¼Ÿ = é–‹ç™ºéƒ¨ã€ç®¡ç†éƒ¨ |
| **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³** | DBã®æ§‹é€ ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ | ã‚«ãƒ©ãƒ è¿½åŠ ã€ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ |
| **å†ªç­‰æ€§** | åŒã˜æ“ä½œã‚’ä½•åº¦å®Ÿè¡Œã—ã¦ã‚‚çµæœãŒåŒã˜ | åŒæœŸã‚’2å›å®Ÿè¡Œã—ã¦ã‚‚åŒã˜çµæœ |

---

# ä»˜éŒ²

## ä»˜éŒ²Aï¼šãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQLä¸€è¦§

### Supabaseç”¨

```sql
-- ================================================================
-- Supabase å…¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQL
-- ================================================================

-- 1. rolesãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE IF NOT EXISTS roles (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    level INTEGER NOT NULL DEFAULT 1 CHECK (level >= 1 AND level <= 6),
    description TEXT,
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_roles_level ON roles(level);
CREATE INDEX IF NOT EXISTS idx_roles_active ON roles(is_active) WHERE is_active = TRUE;
CREATE INDEX IF NOT EXISTS idx_roles_display_order ON roles(display_order);

-- 2. åˆæœŸãƒ‡ãƒ¼ã‚¿
INSERT INTO roles (id, name, level, description, display_order) VALUES
    ('role_ceo', 'ä»£è¡¨å–ç· å½¹', 6, 'æœ€é«˜çµŒå–¶è²¬ä»»è€…', 1),
    ('role_cfo', 'CFO', 6, 'æœ€é«˜è²¡å‹™è²¬ä»»è€…', 2),
    ('role_coo', 'COO', 6, 'æœ€é«˜åŸ·è¡Œè²¬ä»»è€…', 3),
    ('role_admin_mgr', 'ç®¡ç†éƒ¨ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼', 5, 'ç®¡ç†éƒ¨é–€è²¬ä»»è€…', 4),
    ('role_admin_staff', 'ç®¡ç†éƒ¨ã‚¹ã‚¿ãƒƒãƒ•', 5, 'ç®¡ç†éƒ¨é–€æ‹…å½“è€…', 5),
    ('role_director', 'å–ç· å½¹', 4, 'å¹¹éƒ¨', 6),
    ('role_dept_head', 'éƒ¨é•·', 4, 'éƒ¨é–€è²¬ä»»è€…', 7),
    ('role_section_head', 'èª²é•·', 3, 'èª²è²¬ä»»è€…', 8),
    ('role_leader', 'ãƒªãƒ¼ãƒ€ãƒ¼', 3, 'ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼', 9),
    ('role_employee', 'ç¤¾å“¡', 2, 'ä¸€èˆ¬ç¤¾å“¡', 10),
    ('role_contractor', 'æ¥­å‹™å§”è¨—', 1, 'å¤–éƒ¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼', 11)
ON CONFLICT (id) DO UPDATE SET
    name = EXCLUDED.name,
    level = EXCLUDED.level,
    description = EXCLUDED.description,
    display_order = EXCLUDED.display_order,
    updated_at = NOW();

-- 3. RLS
ALTER TABLE roles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "roles_select_policy" ON roles FOR SELECT USING (true);

-- 4. employeesä¿®æ­£
ALTER TABLE employees ADD COLUMN IF NOT EXISTS role_id TEXT REFERENCES roles(id);
CREATE INDEX IF NOT EXISTS idx_employees_role_id ON employees(role_id);
```

### Cloud SQLç”¨

```sql
-- ================================================================
-- Cloud SQL å…¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQL
-- ================================================================

-- 1. rolesä¿®æ­£
ALTER TABLE roles ADD COLUMN IF NOT EXISTS external_id VARCHAR(100) UNIQUE;
CREATE INDEX IF NOT EXISTS idx_roles_external_id ON roles(external_id);

-- 2. chatwork_tasksä¿®æ­£
ALTER TABLE chatwork_tasks ADD COLUMN IF NOT EXISTS department_id UUID REFERENCES departments(id);
CREATE INDEX IF NOT EXISTS idx_chatwork_tasks_department ON chatwork_tasks(department_id);
```

## ä»˜éŒ²Bï¼šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å®Ÿè£…å‰ãƒã‚§ãƒƒã‚¯

- [ ] Supabaseã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹
- [ ] Cloud SQLã«æ¥ç¶šã§ãã‚‹
- [ ] çµ„ç¹”å›³ã‚·ã‚¹ãƒ†ãƒ ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã§ãã‚‹
- [ ] ã‚½ã‚¦ãƒ«ãã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã§ãã‚‹

### å®Ÿè£…å¾Œãƒã‚§ãƒƒã‚¯

- [ ] rolesãƒ†ãƒ¼ãƒ–ãƒ«ã«11ä»¶ã®å½¹è·ãŒã‚ã‚‹
- [ ] employeesãƒ†ãƒ¼ãƒ–ãƒ«ã«role_idã‚«ãƒ©ãƒ ãŒã‚ã‚‹
- [ ] å½¹è·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] åŒæœŸãƒœã‚¿ãƒ³ãŒå‹•ä½œã™ã‚‹
- [ ] ã‚¿ã‚¹ã‚¯æ¤œç´¢ãŒæ¨©é™ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚Œã‚‹

---

**ä»¥ä¸Šã€è©³ç´°è¨­è¨ˆæ›¸ v1.0**

ä½œæˆæ—¥ï¼š2026å¹´1æœˆ19æ—¥
ä½œæˆè€…ï¼šClaude Code
ç·ãƒšãƒ¼ã‚¸æ•°ï¼šç´„50ãƒšãƒ¼ã‚¸ç›¸å½“
