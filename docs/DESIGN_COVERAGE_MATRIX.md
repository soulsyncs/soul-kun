# Design Coverage Matrix（設計要素カバレッジ表）

**作成日:** 2026-01-30
**目的:** MECEを機械的に保証する（空欄=漏れ、複数=重複として検知）

---

## Document Contract（SoT宣言）

| 項目 | 内容 |
|------|------|
| **この文書の役割** | 設計要素のカバレッジを一覧化し、MECEを機械的に保証 |
| **書くこと** | 設計要素一覧、SoT（正のファイル）、漏れ/重複の状態 |
| **書かないこと** | 設計内容そのもの（→各SoTファイル）、実装詳細（→09章）、運用手順（→OPERATIONS_RUNBOOK） |
| **SoT（この文書が正）** | 全設計要素のSoT定義、Matrix更新ルール、粒度定義 |
| **Owner** | Tech Lead（連絡先: #dev チャンネル） |
| **更新トリガー** | 設計書の新規作成/削除/SoT移動時 |
| **関連リンク** | [00_README](00_README.md)、[CLAUDE.md](../CLAUDE.md) |

---

## 粒度定義（この表の1行は何を意味するか）

### 設計要素の定義

**1行 = 「1つの判断や実装で迷ったときに参照する単位」**

| 粒度レベル | 定義 | 例 |
|-----------|------|-----|
| **原則・概念** | 判断基準となる抽象的なルール | 脳の8つの鉄則、10の鉄則、権限レベル原則 |
| **アーキテクチャ層** | システム構成上の独立した層 | Context Builder、Guardian Layer、LLM Brain |
| **機能別設計** | Phase単位の機能仕様 | タスク管理、ナレッジ管理、組織階層 |
| **実装仕様** | コードレベルで参照する具体的仕様 | API設計、DB設計、テスト戦略 |
| **運用手順** | 本番運用時に参照する手順 | 緊急停止、障害対応、PII処理 |

### SoTルール

| ルール | 説明 |
|--------|------|
| **SoTは原則1つ** | 1つの設計要素に対してSoTは1ファイルのみ |
| **例外：原則と実装の分離** | 「原則」と「実装」が別ファイルになる場合のみ、2行に分けてよい |
| **例外の例** | 権限レベル（原則）→ CLAUDE.md、権限レベル（実装）→ 04章 |
| **重複検知** | 同じ内容が2ファイルに書かれていたら、片方を「参照のみ」に降格 |

### 行追加の原則（粒度爆発防止）

> **迷った場合は「新規行を追加」より「既存行への統合」を先に検討する**

新しい設計要素を追加するとき、以下の順で判断する：

1. **既存行に統合できないか？** → 統合できるなら新規行は作らない
2. **既存の粒度レベルに合っているか？** → 合わないなら粒度定義を見直す
3. **本当に独立した設計要素か？** → 独立していなければ既存行の備考に追記

**理由:** 行が増えすぎるとMatrix自体が管理不能になる。「少ない行で漏れなく」が理想。

### 粒度の判断基準

```
Q: この設計要素は1行にすべき？分割すべき？

判断フロー:
1. 「これを変更するとき、別の箇所も同時に変更が必要か？」
   → YES: 1行にまとめる
   → NO: 分割してよい

2. 「原則と実装で担当者が違うか？」
   → YES: 分割する（原則/実装）
   → NO: 1行でよい
```

---

## 使い方

1. 新しい設計要素を追加する → この表にSoTを追加
2. 設計書を変更する → この表のSoTを確認し、正しいファイルを編集
3. 空欄を見つけた → 漏れ。対応するドキュメントを作成する
4. 複数セルがある → 重複。SoTを1つに統一する

---

## Matrix更新ルール（PRマージ条件）

### 必須チェック項目

**以下のいずれかに該当するPRは、このMatrixの更新が必須：**

| 変更タイプ | Matrix更新 | 更新内容 |
|-----------|-----------|---------|
| 新しい設計要素を追加 | **必須** | 該当カテゴリに行を追加、SoTを明記 |
| 既存設計要素のSoTを移動 | **必須** | SoT列を更新 |
| 設計書を新規作成 | **必須** | 該当する設計要素すべてのSoTを更新 |
| 設計書を削除/アーカイブ | **必須** | 該当SoTを別ファイルに移動または「未定義」に変更 |
| 設計書の内容のみ変更 | 不要 | SoTは変わらないため |

### PRレビュー時の確認事項

```
□ 新しい設計要素を追加した場合、Matrixに行を追加したか？
□ SoTが「未定義」の項目を増やしていないか？
□ 既存のSoTと重複する記述を追加していないか？
□ 削除した設計要素のMatrix行を「未定義」または削除したか？
```

### 違反時の対応

- **Matrixに記載なく設計要素を追加** → PRを差し戻し、Matrix更新を依頼
- **SoTが重複したまま放置** → どちらか1つをSoTとして明確化してからマージ

---

## 1. アーキテクチャ層

| 設計要素 | SoT（正のファイル） | セクション | 状態 | 備考 |
|---------|-------------------|-----------|------|------|
| Context Builder | 25章 | 第5章 | ✅ | |
| LLM Brain（概念） | 25章 | 第5-6章 | ✅ | CLAUDE.mdは要点のみ |
| LLM Brain（鉄則） | CLAUDE.md | セクション2 | ✅ | 25章は詳細設計 |
| Guardian Layer | 25章 | 第4章、第9章 | ✅ | |
| Authorization Gate（原則） | 25章 | 第4章 | ✅ | |
| Authorization Gate（実装） | 04章 | 5.6 | ✅ | 03章はテーブル設計のみ |
| Observability Layer | OPERATIONS_RUNBOOK | セクション9-10 | ✅ | 2026-01-30追加（KPI・アラート対応表） |
| Tool Execution | 25章 | 第7章 | ✅ | |
| **設計vs実装の差分** | DESIGN_IMPLEMENTATION_GAP_REPORT | 全体 | ✅ | 2026-01-30追加 |

---

## 2. コア概念・原則

| 設計要素 | SoT（正のファイル） | セクション | 状態 | 備考 |
|---------|-------------------|-----------|------|------|
| 脳の8つの鉄則 | CLAUDE.md | セクション2-1 | ✅ | 25章は設計詳細 |
| LLM Brain 憲法 | 25章 | 第4章 | ✅ | |
| データソース優先順位（Truth順位） | CLAUDE.md | セクション3 | ✅ | |
| 10の鉄則 | CLAUDE.md | セクション5 | ✅ | 09章は参照のみ |
| 設計の5原則 | CLAUDE.md | セクション6 | ✅ | 01章は詳細・背景 |
| 権限レベル（6段階）原則 | CLAUDE.md | セクション7 | ✅ | |
| 権限レベル（6段階）実装 | 04章 | 5.6 | ✅ | |
| System Prompt v2.0 | 25章 | 付録17.4 | ✅ | |

---

## 3. データ・セキュリティ

| 設計要素 | SoT（正のファイル） | セクション | 状態 | 備考 |
|---------|-------------------|-----------|------|------|
| Memory Framework（原則） | CLAUDE.md | セクション8 | ✅ | |
| Memory Framework（詳細設計） | 10_phase2_b | 全体 | ✅ | |
| 監査ログ（原則） | CLAUDE.md | セクション8-3 | ✅ | |
| 監査ログ（実装） | 04章 | 5.6.3 | ✅ | |
| PII処理（原則） | CLAUDE.md | セクション8-2 | ✅ | |
| PII処理（マスキング仕様） | OPERATIONS_RUNBOOK | セクション7.2 | ✅ | 2026-01-30追加 |
| PII処理（削除手順） | OPERATIONS_RUNBOOK | セクション7.3 | ✅ | 2026-01-30追加 |
| Row Level Security | 04章 | 5.6 | ✅ | |
| organization_id必須ルール | CLAUDE.md | セクション5 | ✅ | |
| organization_id初期化・移行 | OPERATIONS_RUNBOOK | セクション11 | ✅ | 2026-01-30追加 |

---

## 4. 運用

| 設計要素 | SoT（正のファイル） | セクション | 状態 | 備考 |
|---------|-------------------|-----------|------|------|
| 障害対応（BCP） | security_and_bcp_guide | 全体 | ✅ | |
| 緊急停止手順 | OPERATIONS_RUNBOOK | セクション1 | ✅ | 2026-01-30追加 |
| 権限事故対応 | OPERATIONS_RUNBOOK | セクション3 | ✅ | 2026-01-30追加 |
| コスト管理（見積もり） | 25章 | 1.4 | ✅ | |
| コスト管理（本番運用戦略） | OPERATIONS_RUNBOOK | セクション5 | ✅ | 2026-01-30追加 |
| レート制限 | OPERATIONS_RUNBOOK | セクション6 | ✅ | 2026-01-30追加 |
| 失敗時の挙動（API） | 03章 | 5.2.5 | ✅ | |
| 失敗時の挙動（全体原則） | OPERATIONS_RUNBOOK | セクション8 | ✅ | 2026-01-30追加 |

---

## 5. テスト

| 設計要素 | SoT（正のファイル） | セクション | 状態 | 備考 |
|---------|-------------------|-----------|------|------|
| テスト戦略（全体） | 09章 | 第11章 | ✅ | |
| 単体テスト基準 | 09章 | 11.1 | ✅ | |
| 統合テスト基準 | 09章 | 11.2 | ✅ | |
| E2Eテスト基準 | 09章 | 11.3 | ✅ | |
| セキュリティテスト | 09章 | 11.5 | ✅ | |
| パフォーマンステスト | 09章 | 11.4 | ✅ | |
| 権限境界テスト | 09章 | 11.5 | ✅ | |
| プロンプト回帰テスト | 09章 | 11.7 | ✅ | 2026-01-30追加 |
| コスト上限テスト | 09章 + test-coverage.yml | 11.8 + CI/CD | ✅ | 2026-01-30追加（仕様・基盤のみ、実装はPhase 4） |

---

## 6. 機能別設計（Phase）

| 設計要素 | SoT（正のファイル） | 状態 | 備考 |
|---------|-------------------|------|------|
| タスク管理（Phase 1-B） | 05_phase_1b | ✅ | |
| パターン検出（Phase 2A1） | 06_phase2_a1 | ✅ | |
| 属人化検出（Phase 2A2） | 07_phase2_a2 | ✅ | |
| ボトルネック検出（Phase 2A3） | 08_phase2_a3 | ✅ | |
| 感情検出（Phase 2A4） | 09_phase2_a4 | ✅ | |
| 記憶フレームワーク（Phase 2B） | 10_phase2_b | ✅ | |
| MVV・秘書機能（Phase 2C） | 10_phase2c | ✅ | |
| 目標達成支援（Phase 2.5） | 05_phase2-5 | ✅ | |
| ナレッジ管理（Phase 3） | 05_phase3 | ✅ | |
| 組織階層（Phase 3.5） | 06_phase_3-5, PHASE_3-5_DETAILED | ✅ | |
| BPaaS（Phase 4） | 08_phase_4 | ✅ | |
| 会議系（Phase C） | 07_phase_c | ✅ | |

---

## 7. 技術基盤

| 設計要素 | SoT（正のファイル） | セクション | 状態 | 備考 |
|---------|-------------------|-----------|------|------|
| DB設計（スキーマ） | 03章 | 全体 | ✅ | |
| API設計 | 04章 | 全体 | ✅ | |
| 実装規約 | 09章 | 全体 | ✅ | |
| 環境変数 | ENVIRONMENT_VARIABLES | 全体 | ✅ | |
| 技術スタック | CLAUDE.md | セクション15 | ✅ | |

---

## 8. セキュリティ監査・マルチテナント

| 設計要素 | SoT（正のファイル） | セクション | 状態 | 備考 |
|---------|-------------------|-----------|------|------|
| organization_id監査結果 | SECURITY_AUDIT_ORGANIZATION_ID | 全体 | ✅ | 2026-01-30追加 |
| RLSポリシー設計 | RLS_POLICY_DESIGN | 全体 | ✅ | 2026-01-30追加（Phase 4準備） |
| テナント分離テスト | RLS_POLICY_DESIGN | セクション6 | ✅ | |

---

## 9. 設計書管理・運用

| 設計要素 | SoT（正のファイル） | セクション | 状態 | 備考 |
|---------|-------------------|-----------|------|------|
| 設計要素カバレッジ | DESIGN_COVERAGE_MATRIX | 全体 | ✅ | この文書 |
| 設計vs実装の差分管理 | DESIGN_IMPLEMENTATION_GAP_REPORT | 全体 | ✅ | |
| トラブルシューティング導線 | TROUBLESHOOTING_FRAMEWORK | 全体 | ✅ | 2026-01-30追加 |
| 障害訓練計画 | DISASTER_DRILL_PLAN | 全体 | ✅ | 2026-01-30追加 |
| 設計書廃止ポリシー | DESIGN_DEPRECATION_POLICY | 全体 | ✅ | 2026-01-30追加 |
| 新機能追加フレームワーク | FEATURE_ADDITION_FRAMEWORK | 全体 | ✅ | 2026-01-30追加 |
| 設計書鮮度管理 | DOCUMENTATION_FRESHNESS_POLICY | 全体 | ✅ | 2026-01-30追加 |
| Tool（手足）ライフサイクル | TOOL_LIFECYCLE_POLICY | 全体 | ✅ | 2026-01-30追加 |

---

## 漏れサマリー（❌ 要対応）

| # | 漏れている設計要素 | 優先度 | 対応状況 |
|---|-------------------|--------|----------|
| 1 | ~~Observability Layer全体戦略~~ | 高 | ✅ OPERATIONS_RUNBOOK セクション9-10追加 |
| 2 | ~~緊急停止手順~~ | 高 | ✅ OPERATIONS_RUNBOOK追加 |
| 3 | ~~レート制限~~ | 高 | ✅ OPERATIONS_RUNBOOK追加 |
| 4 | ~~PII処理（マスキング・削除）~~ | 高 | ✅ OPERATIONS_RUNBOOK追加 |
| 5 | ~~権限事故対応~~ | 中 | ✅ OPERATIONS_RUNBOOK追加 |
| 6 | ~~コスト管理（本番運用）~~ | 中 | ✅ OPERATIONS_RUNBOOK追加 |
| 7 | ~~失敗時の挙動（全体原則）~~ | 中 | ✅ OPERATIONS_RUNBOOK追加 |
| 8 | ~~organization_id初期化・移行~~ | 中 | ✅ OPERATIONS_RUNBOOK セクション11追加 |
| 9 | ~~プロンプト回帰テスト~~ | 低 | ✅ 09章 11.7追加 |
| 10 | ~~コスト上限テスト~~ | 低 | ✅ 09章 11.8 + test-coverage.yml追加 |

**2026-01-30対応:** 漏れ10項目すべて対応完了。

---

## 重複サマリー（⚠️ SoT明確化済み）

以下は重複が発生しやすい領域だが、SoTを明確化済み：

| 設計要素 | SoT | 参照のみ |
|---------|-----|---------|
| LLM Brain | 25章（詳細）、CLAUDE.md（要点） | - |
| 10の鉄則 | CLAUDE.md | 09章（参照） |
| Memory Framework | CLAUDE.md（原則）、10_phase2_b（詳細） | - |
| 監査ログ | CLAUDE.md（原則）、04章（実装） | 03章（テーブル） |
| 権限レベル | CLAUDE.md（原則）、04章（実装） | 03章（テーブル） |

---

## SoT参照ルール

1. **原則・概念を知りたい** → CLAUDE.md
2. **脳の詳細設計を知りたい** → 25章
3. **API・セキュリティ実装を知りたい** → 04章
4. **DB・テーブル設計を知りたい** → 03章
5. **コーディング・テスト基準を知りたい** → 09章
6. **特定機能の詳細を知りたい** → 該当Phase設計書

---

## 更新履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-30 | 初版作成（全設計要素のカバレッジ分析） |
| 2026-01-30 | OPERATIONS_RUNBOOK.md追加により漏れ7項目を解消 |
| 2026-01-30 | セクション8「セキュリティ監査・マルチテナント」追加 |
| 2026-01-30 | セクション9「設計書管理・運用」追加（7文書） |
| 2026-01-30 | コスト上限テスト追加（09章 11.8 + test-coverage.yml）、漏れ10項目すべて対応完了 |
| 2026-01-30 | TOOL_LIFECYCLE_POLICY.md追加（Tool追加/拡張/削除の安全手順） |

---

**このファイルについての質問は、CLAUDE.mdを参照してください。**
