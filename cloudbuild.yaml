# =============================================================================
# Cloud Build è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
# =============================================================================
#
# ç›®çš„:
#   mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã«è‡ªå‹•ã§Cloud Functionsã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
#
# ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼ˆGCPã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è¨­å®šãŒå¿…è¦ï¼‰:
#   - ã‚¤ãƒ™ãƒ³ãƒˆ: Push to a branch
#   - ãƒ–ãƒ©ãƒ³ãƒ: ^main$
#   - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚£ãƒ«ã‚¿: chatwork-webhook/**
#
# v10.53.0: åˆç‰ˆä½œæˆï¼ˆå¤§è¦æ¨¡ä¿®ç¹•å¯¾å¿œï¼‰
# =============================================================================

steps:
  # =============================================================================
  # Step 1: lib/ åŒæœŸãƒã‚§ãƒƒã‚¯
  # =============================================================================
  - name: 'gcr.io/cloud-builders/git'
    id: 'sync-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ” lib/ åŒæœŸãƒã‚§ãƒƒã‚¯..."

        # chatwork-webhook/lib/brain/ ã¨ lib/brain/ ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯
        if ! diff -rq lib/brain chatwork-webhook/lib/brain --exclude='__pycache__' --exclude='*.pyc' --exclude='handler_wrappers.py' > /dev/null 2>&1; then
          echo "âŒ lib/brain/ ãŒåŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼"
          echo "   ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
          exit 1
        fi

        echo "âœ… lib/ ã¯åŒæœŸã•ã‚Œã¦ã„ã¾ã™"

  # =============================================================================
  # Step 2: chatwork-webhook ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
  # =============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-chatwork-webhook'
    entrypoint: 'gcloud'
    args:
      - 'functions'
      - 'deploy'
      - 'chatwork-webhook'
      - '--source=chatwork-webhook'
      - '--runtime=python311'
      - '--trigger-http'
      - '--region=asia-northeast1'
      - '--memory=512MB'
      - '--timeout=540s'
      - '--allow-unauthenticated'
    waitFor: ['sync-check']

  # =============================================================================
  # Step 3: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  # =============================================================================
  - name: 'gcr.io/cloud-builders/curl'
    id: 'notify'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… chatwork-webhook ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ã‚³ãƒŸãƒƒãƒˆ: $COMMIT_SHA"
        echo "ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"
        echo ""
    waitFor: ['deploy-chatwork-webhook']

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10åˆ†ï¼‰
timeout: '600s'

# ãƒ­ã‚°è¨­å®š
options:
  logging: CLOUD_LOGGING_ONLY
