# ç¬¬25ç« ï¼šLLMå¸¸é§å‹è„³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** v1.0.0
**ä½œæˆæ—¥:** 2026-01-30
**ä½œæˆè€…:** Claude Codeï¼ˆçµŒå–¶å‚è¬€ãƒ»SEãƒ»PMï¼‰
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** è¨­è¨ˆç¢ºå®š
**æ‰¿èªè€…:** ã‚«ã‚ºã•ã‚“ï¼ˆä»£è¡¨ï¼‰

---

## ç›®æ¬¡

1. [ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼](#1-ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼)
2. [è¨­è¨ˆé€²åŒ–ã®èƒŒæ™¯ã¨ç›®çš„](#2-è¨­è¨ˆé€²åŒ–ã®èƒŒæ™¯ã¨ç›®çš„)
3. [è¨­è¨ˆåŸå‰‡](#3-è¨­è¨ˆåŸå‰‡)
4. [æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ](#4-æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ)
5. [å„å±¤ã®è©³ç´°è¨­è¨ˆ](#5-å„å±¤ã®è©³ç´°è¨­è¨ˆ)
6. [Toolå®šç¾©ï¼ˆFunction Callingï¼‰](#6-toolå®šç¾©function-calling)
7. [System Promptã®è¨­è¨ˆ](#7-system-promptã®è¨­è¨ˆ)
8. [ãƒªã‚¹ã‚¯å¯¾ç­–ã®è©³ç´°](#8-ãƒªã‚¹ã‚¯å¯¾ç­–ã®è©³ç´°)
9. [ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«](#9-ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«)
10. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#10-ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)
11. [æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã®ç§»è¡Œè¨ˆç”»](#11-æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã®ç§»è¡Œè¨ˆç”»)
12. [ãƒ†ã‚¹ãƒˆæˆ¦ç•¥](#12-ãƒ†ã‚¹ãƒˆæˆ¦ç•¥)
13. [ã‚³ã‚¹ãƒˆç®¡ç†](#13-ã‚³ã‚¹ãƒˆç®¡ç†)
14. [ç›£è¦–ãƒ»é‹ç”¨](#14-ç›£è¦–é‹ç”¨)
15. [å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#15-å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)
16. [ä»˜éŒ²](#16-ä»˜éŒ²)

---

## 1. ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### 1.1 ã“ã®è¨­è¨ˆæ›¸ã®ç›®çš„

**ã‚½ã‚¦ãƒ«ãã‚“ã®ã€Œè„³ã€ã‚’ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°æ–¹å¼ã‹ã‚‰ã€ŒLLMå¸¸é§å‹ã€ã¸é€²åŒ–ã•ã›ã€äººé–“ã®ç§˜æ›¸ã®ã‚ˆã†ãªã€Œæ±²ã¿å–ã‚ŠåŠ›ã€ã‚’å®Ÿç¾ã™ã‚‹ã€‚**

### 1.2 3è¡Œã§è¦ç´„

1. **ä½•ã‚’ã™ã‚‹ã‹**: è„³ã®ä¸­æ ¸ã«Claude Opus 4.5ã‚’å¸¸é§ã•ã›ã€å…¨ã¦ã®åˆ¤æ–­ã‚’LLMã®æ¨è«–ã«å§”ã­ã‚‹
2. **ãªãœå¿…è¦ã‹**: ç¾åœ¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒã§ã¯ã€Œæ±²ã¿å–ã‚ŠåŠ›ã€ã«é™ç•ŒãŒã‚ã‚Šã€å ´å½“ãŸã‚Šçš„æ”¹å–„ã®ç¹°ã‚Šè¿”ã—ã«ãªã‚‹
3. **ã©ã†ä½œã‚‹ã‹**: Context Builder â†’ LLM Brain â†’ Guardian â†’ AuthGate â†’ Observability ã®6å±¤æ§‹é€ ã«é€²åŒ–

### 1.3 ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š

| ä¼šè©±å›æ•°/æœˆ | LLMåˆ©ç”¨æ–™ | ã‚¤ãƒ³ãƒ•ãƒ© | æœˆé¡åˆè¨ˆ |
|------------|----------|---------|----------|
| 1,000å› | ç´„5,900å†† | ç´„15,000å†† | **ç´„21,000å††** |
| 5,000å› | ç´„29,500å†† | ç´„15,000å†† | **ç´„44,500å††** |
| 10,000å› | ç´„59,000å†† | ç´„15,000å†† | **ç´„74,000å††** |

â€»äººé–“ã®ç§˜æ›¸ï¼ˆæœˆ30ã€œ50ä¸‡å††ï¼‰ã®**1/4ã€œ1/7ã®ã‚³ã‚¹ãƒˆ**ã§ã€24æ™‚é–“å¯¾å¿œå¯èƒ½

### 1.4 ã“ã®è¨­è¨ˆæ›¸ã®ä½ç½®ã¥ã‘

```
è¨­è¨ˆæ›¸ä½“ç³»
â”œâ”€ 01_philosophy_and_principles.md  â† å“²å­¦ãƒ»åŸå‰‡ï¼ˆãªãœä½œã‚‹ã‹ï¼‰
â”œâ”€ 13_brain_architecture.md         â† æ—§ãƒ»è„³è¨­è¨ˆï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒæ–¹å¼ï¼‰
â”œâ”€ 19_ultimate_brain_architecture.mdâ† Ultimate Brainæ§‹æƒ³
â””â”€ â˜… 25_llm_native_brain_architecture.md â† ã€æœ¬è¨­è¨ˆæ›¸ã€‘LLMå¸¸é§å‹è„³
```

### 1.5 é–¢é€£ã™ã‚‹æ—¢å­˜è¨­è¨ˆæ›¸

| è¨­è¨ˆæ›¸ | é–¢ä¿‚ |
|--------|------|
| 13_brain_architecture.md | æœ¬è¨­è¨ˆæ›¸ã§ç½®ãæ›ãˆã‚‹ï¼ˆ7ã¤ã®é‰„å‰‡ã¯ç¶™æ‰¿ï¼‰ |
| 19_ultimate_brain_architecture.md | Chain-of-Thoughtç­‰ã®æ§‹æƒ³ã‚’çµ±åˆ |
| 17_brain_completion_roadmap.md | Phase 2Eã€œ2Oã®ä¸€éƒ¨ã‚’æœ¬è¨­è¨ˆæ›¸ã§å®Ÿç¾ |
| handlers/registry.py | SYSTEM_CAPABILITIESã‚’Toolå®šç¾©ã«å¤‰æ› |

---

## 2. è¨­è¨ˆé€²åŒ–ã®èƒŒæ™¯ã¨ç›®çš„

### 2.1 ã‚«ã‚ºã•ã‚“ã®èª²é¡Œèªè­˜

> ã€Œå…¨ç„¶ã¾ã¨ã‚‚ã«ä¼šè©±ãŒä»Šã§ãã¦ãªãã¦ã€ã™ã£ã”ã„å›°ã£ã¦ã‚“ã ã‚ˆã­ã€
>
> ã€Œã‚±ãƒ¼ã‚¹ã”ã¨ã®æ”¹è‰¯ã§ã¯ãªãã€ãã‚‚ãã‚‚ã®"æ¨è«–èƒ½åŠ›ãã®ã‚‚ã®"ã‚’è¨­è¨ˆã¨ã—ã¦åº•ä¸Šã’ã—ãªã„ã¨ã€å°†æ¥ãšã£ã¨"å ´å½“ãŸã‚Šçš„ãªæ”¹å–„"ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã¯ãªã„ã‹ï¼Ÿã€

### 2.2 ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®é™ç•Œ

#### 2.2.1 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°ã®é™ç•Œ

```python
# ç¾åœ¨ã®å®Ÿè£…ï¼ˆunderstanding.py / decision.pyï¼‰
INTENT_KEYWORDS = {
    "chatwork_task_create": {
        "primary": ["ã‚¿ã‚¹ã‚¯ä½œæˆ", "ã‚¿ã‚¹ã‚¯è¿½åŠ ", "ã‚¿ã‚¹ã‚¯ä½œã£ã¦"],
        "secondary": ["ã‚¿ã‚¹ã‚¯", "ä»•äº‹", "ã‚„ã‚‹ã“ã¨"],
        "negative": ["æ¤œç´¢", "ä¸€è¦§"],
    }
}

# å•é¡Œ: ä»¥ä¸‹ã®ã‚ˆã†ãªè‡ªç„¶ãªè¨€ã„æ–¹ãŒé€šã˜ãªã„
# âœ— ã€Œç”°ä¸­ã•ã‚“ã«ã“ã‚Œé ¼ã‚“ã§ã€â†’ ã€Œã‚¿ã‚¹ã‚¯ã€ã¨ã„ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãªã„
# âœ— ã€Œã•ã£ãã®ä»¶ã€ãŠé¡˜ã„ã§ãã‚‹ï¼Ÿã€â†’ ã€Œã•ã£ãã®ä»¶ã€ãŒä½•ã‹åˆ†ã‹ã‚‰ãªã„
# âœ— ã€Œã‚ã‚Œã©ã†ãªã£ãŸï¼Ÿã€â†’ ã€Œã‚ã‚Œã€ãŒä½•ã‚’æŒ‡ã™ã‹åˆ†ã‹ã‚‰ãªã„
```

#### 2.2.2 å ´å½“ãŸã‚Šçš„æ”¹å–„ã®æ‚ªå¾ªç’°

```
æ–°ã—ã„è¨€ã„æ–¹ãŒé€šã˜ãªã„
    â†“
ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    â†“
åˆ¥ã®è¨€ã„æ–¹ãŒé€šã˜ãªã„
    â†“
ã¾ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    â†“
ç„¡é™ãƒ«ãƒ¼ãƒ—...
```

#### 2.2.3 ç†è§£å±¤ã¨åˆ¤æ–­å±¤ã®åˆ†é›¢ã«ã‚ˆã‚‹éåŠ¹ç‡

ç¾åœ¨ã®4å±¤æ§‹é€ ã§ã¯ã€ç†è§£ã¨åˆ¤æ–­ãŒåˆ¥ã€…ã®ã‚¹ãƒ†ãƒƒãƒ—ã§è¡Œã‚ã‚Œã‚‹ã€‚
LLMã®æ¨è«–åŠ›ã‚’æ´»ã‹ã™ãªã‚‰ã€**ç†è§£ã¨åˆ¤æ–­ã‚’ä¸€ä½“åŒ–**ã—ãŸæ–¹ãŒç²¾åº¦ãŒä¸ŠãŒã‚‹ã€‚

### 2.3 LLMå¸¸é§å‹ã®æœ¬è³ª

**LLMã‚’ã€Œæ–‡ç« ç”Ÿæˆå™¨ã€ã§ã¯ãªãã€Œæ€è€ƒã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆæ€è€ƒOSï¼‰ã€ã¨ã—ã¦ä½¿ã†ã€‚**

| ç¾åœ¨ | LLMå¸¸é§å‹ |
|------|----------|
| ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ„å›³ã‚’æ¨æ¸¬ | LLMãŒæ–‡è„ˆã‹ã‚‰æ„å›³ã‚’æ¨è«– |
| ãƒ«ãƒ¼ãƒ«ã§æ©Ÿèƒ½ã‚’é¸æŠ | LLMãŒFunction Callingã§æ©Ÿèƒ½ã‚’é¸æŠ |
| äººé–“ãŒæ±ºã‚ãŸãƒ­ã‚¸ãƒƒã‚¯ã«å¾“ã† | LLMãŒè‡ªåˆ†ã§è€ƒãˆã‚‹ |
| æ–°ã—ã„è¨€ã„æ–¹ â†’ é€šã˜ãªã„ | æ–°ã—ã„è¨€ã„æ–¹ â†’ LLMãŒæ±²ã¿å–ã‚‹ |

### 2.4 è¨­è¨ˆé€²åŒ–ã®æ±ºå®šç†ç”±

| è¦³ç‚¹ | è©•ä¾¡ |
|------|------|
| è¨­è¨ˆæ•´åˆæ€§ | âœ… 7ã¤ã®é‰„å‰‡ã‚’å¼·åŒ–ï¼ˆå£Šã•ãªã„ï¼‰ |
| ãƒ¡ãƒªãƒƒãƒˆ | âœ… æ±²ã¿å–ã‚ŠåŠ›ã®æ ¹æœ¬çš„å‘ä¸Š |
| ã‚³ã‚¹ãƒˆ | âœ… æœˆ4ã€œ7ä¸‡å††ï¼ˆäººé–“ã®ç§˜æ›¸ã®1/4ã€œ1/7ï¼‰ |
| ãƒªã‚¹ã‚¯ | âœ… å…¨ã¦å¯¾ç­–å¯èƒ½ï¼ˆæ—¢å­˜æ©Ÿæ§‹ã‚’æ´»ç”¨ï¼‰ |
| ç·Šæ€¥åº¦ | âœ… ä»Šã€Œä¼šè©±ã§ããªã„ã€çŠ¶æ…‹ã§å›°ã£ã¦ã„ã‚‹ |

**çµè«–: ä»Šã™ãå®Ÿè£…ã™ã¹ãã€‚**

---

## 3. è¨­è¨ˆåŸå‰‡

### 3.1 ç¶™æ‰¿ã™ã‚‹åŸå‰‡ï¼ˆ7ã¤ã®é‰„å‰‡ï¼‰

æ—¢å­˜ã®7ã¤ã®é‰„å‰‡ã¯**å…¨ã¦ç¶™æ‰¿**ã™ã‚‹ã€‚LLMå¸¸é§å‹ã¯ã“ã‚Œã‚’**å¼·åŒ–**ã™ã‚‹ã€‚

| # | é‰„å‰‡ | LLMå¸¸é§å‹ã§ã®å¯¾å¿œ | å¼·åŒ–åº¦ |
|---|------|------------------|--------|
| 1 | **å…¨ã¦ã®å…¥åŠ›ã¯è„³ã‚’é€šã‚‹** | LLM BrainãŒå…¨å…¥åŠ›ã‚’å—ã‘å–ã‚‹ | âœ… å¼·åŒ– |
| 2 | **è„³ã¯å…¨ã¦ã®è¨˜æ†¶ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹** | Context Builderã§å…¨è¨˜æ†¶ã‚’é›†ç´„ | âœ… ç¶­æŒ |
| 3 | **è„³ãŒåˆ¤æ–­ã—ã€æ©Ÿèƒ½ã¯å®Ÿè¡Œã™ã‚‹ã ã‘** | LLMãŒåˆ¤æ–­ã€ToolãŒå®Ÿè¡Œ | âœ… å®Œå…¨æº–æ‹  |
| 4 | **æ©Ÿèƒ½æ‹¡å¼µã—ã¦ã‚‚è„³ã®æ§‹é€ ã¯å¤‰ã‚ã‚‰ãªã„** | Toolå®šç¾©ã‚’è¿½åŠ ã™ã‚‹ã ã‘ | âœ… å¼·åŒ– |
| 5 | **ç¢ºèªã¯è„³ã®è²¬å‹™** | LLMãŒç¢ºèªè¦å¦ã‚’åˆ¤æ–­ | âœ… ç¶­æŒ |
| 6 | **çŠ¶æ…‹ç®¡ç†ã¯è„³ãŒçµ±ä¸€ç®¡ç†** | Context Builderã§çŠ¶æ…‹ã‚’æ³¨å…¥ | âœ… ç¶­æŒ |
| 7 | **é€Ÿåº¦ã‚ˆã‚Šæ­£ç¢ºæ€§ã‚’å„ªå…ˆ** | LLMã®æ¨è«–åŠ›ã§æ­£ç¢ºæ€§å‘ä¸Š | âœ… å¼·åŒ– |

### 3.2 æ–°ãŸã«è¿½åŠ ã™ã‚‹åŸå‰‡

| # | åŸå‰‡ | èª¬æ˜ | ç†ç”± |
|---|------|------|------|
| 8 | **æ€è€ƒéç¨‹ã®é€æ˜æ€§** | Chain-of-Thoughtã‚’å¿…é ˆåŒ–ã€‚å…¨åˆ¤æ–­ã®ç†ç”±ã‚’è¨˜éŒ² | ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åŒ–é˜²æ­¢ |
| 9 | **æ¨©é™ãƒã‚§ãƒƒã‚¯ã¯LLMã¨ç‹¬ç«‹** | AuthorizationGateã¯LLMåˆ¤æ–­ã®å¾Œã«ç‹¬ç«‹ã—ã¦å®Ÿè¡Œ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºä¿ |
| 10 | **Toolã¯æ˜ç¢ºã«é™å®š** | LLMã«ä¸ãˆã‚‹é¸æŠè‚¢ï¼ˆToolï¼‰ã‚’æ˜ç¢ºã«å®šç¾© | æƒ³å®šå¤–å‹•ä½œã®é˜²æ­¢ |
| 11 | **å±é™ºæ“ä½œã¯å¿…ãšã‚¬ãƒ¼ãƒ‰** | Guardian Layerã§LLMåˆ¤æ–­å¾Œã«ãƒã‚§ãƒƒã‚¯ | å®‰å…¨æ€§ç¢ºä¿ |
| 12 | **å…¨åˆ¤æ–­ã‚’è¨˜éŒ²** | Observability Layerã§åˆ¤æ–­ãƒ­ã‚°ã‚’æ°¸ç¶šåŒ– | è¿½è·¡å¯èƒ½æ€§ç¢ºä¿ |

### 3.3 CLAUDE.mdã¨ã®æ•´åˆæ€§

| CLAUDE.mdè¦å®š | æœ¬è¨­è¨ˆã§ã®å¯¾å¿œ |
|---------------|---------------|
| è„³ã®8ã¤ã®é‰„å‰‡ | å…¨ã¦æº–æ‹ ï¼ˆé‰„å‰‡1ã€œ7 + é‰„å‰‡1bï¼‰ |
| ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å„ªå…ˆé †ä½ï¼ˆTruthé †ä½ï¼‰ | Context Builderã§å„ªå…ˆé †ä½ã«å¾“ã£ã¦å–å¾— |
| æ„å›³ã®å–ã‚Šé•ãˆæ¤œçŸ¥ãƒ«ãƒ¼ãƒ« | LLMã®æ¨è«– + ç¢ºä¿¡åº¦åˆ¤å®šã§å¯¾å¿œ |
| æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆ6æ®µéšï¼‰ | Authorization Gateã§å¼·åˆ¶ |
| 10ã®é‰„å‰‡ | å…¨ã¦æº–æ‹ ï¼ˆorganization_idã€RLSç­‰ï¼‰ |

---

## 4. æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ

### 4.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                              â”‚
â”‚                       ï¼ˆChatWork Webhookï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                         ã‚½ã‚¦ãƒ«ãã‚“ã®ã€Œè„³ã€                               â”ƒ
â”ƒ                                                                          â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚                  â‘  Context Builderï¼ˆæ–‡è„ˆæ§‹ç¯‰å±¤ï¼‰                 â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€åé›†ã™ã‚‹æƒ…å ±ã€‘                                                  â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ ç¾åœ¨ã®çŠ¶æ…‹ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ï¼Ÿç¢ºèªå¾…ã¡ï¼Ÿé€šå¸¸ï¼Ÿï¼‰                   â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ è¨˜æ†¶ï¼ˆä¼šè©±å±¥æ­´ã€äººç‰©æƒ…å ±ã€ã‚¿ã‚¹ã‚¯ã€ç›®æ¨™ã€ãƒŠãƒ¬ãƒƒã‚¸ï¼‰             â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ CEOæ•™ãˆãƒ»ä¾¡å€¤è¦³ï¼ˆValueAuthorityï¼‰                             â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼å—œå¥½ï¼ˆå¥½ã¿ã®å‘¼ã³æ–¹ã€å ±å‘Šå½¢å¼ç­‰ï¼‰                       â”‚  â”ƒ
â”ƒ  â”‚  â””â”€ è¨­è¨ˆæ€æƒ³ï¼ˆSystem Promptï¼‰                                     â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€å‡ºåŠ›ã€‘                                                          â”‚  â”ƒ
â”ƒ  â”‚  â””â”€ æ§‹é€ åŒ–ã•ã‚ŒãŸContextï¼ˆLLMã«æ¸¡ã™å½¢å¼ï¼‰                          â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ
â”ƒ                                   â”‚                                      â”ƒ
â”ƒ                                   â–¼                                      â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚                  â‘¡ LLM Brainï¼ˆClaude Opus 4.5ï¼‰                   â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€å…¥åŠ›ã€‘                                                          â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ System Promptï¼ˆã‚½ã‚¦ãƒ«ãã‚“ã®è¨­è¨ˆæ€æƒ³ãƒ»äººæ ¼ãƒ»åˆ¶ç´„ï¼‰              â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ Contextï¼ˆâ‘ ã§æ§‹ç¯‰ã—ãŸæ–‡è„ˆæƒ…å ±ï¼‰                                â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                                            â”‚  â”ƒ
â”ƒ  â”‚  â””â”€ Toolå®šç¾©ï¼ˆã§ãã‚‹ã“ã¨ãƒªã‚¹ãƒˆ = Function Callingç”¨ï¼‰             â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€å‡¦ç†ã€‘                                                          â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ æ„å›³ç†è§£ï¼ˆã€Œä½•ã‚’ã—ãŸã„ã‹ã€ã‚’æ–‡è„ˆã‹ã‚‰æ±²ã¿å–ã‚‹ï¼‰                 â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ åˆ¤æ–­ï¼ˆã€Œã©ã®Toolã‚’ä½¿ã†ã‹ã€ã¾ãŸã¯ã€Œç›´æ¥å¿œç­”ã™ã‚‹ã‹ã€ï¼‰           â”‚  â”ƒ
â”ƒ  â”‚  â””â”€ æ€è€ƒéç¨‹ã®å‡ºåŠ›ï¼ˆChain-of-Thoughtï¼‰ã€å¿…é ˆã€‘                    â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€å‡ºåŠ›ã€‘                                                          â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ Toolå‘¼ã³å‡ºã—ï¼ˆtool_name, parametersï¼‰                         â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ ã¾ãŸã¯ç›´æ¥å¿œç­”ï¼ˆé›‘è«‡ã€è³ªå•ã¸ã®å›ç­”ç­‰ï¼‰                         â”‚  â”ƒ
â”ƒ  â”‚  â””â”€ æ€è€ƒéç¨‹ï¼ˆreasoningï¼‰                                         â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ
â”ƒ                                   â”‚                                      â”ƒ
â”ƒ                                   â–¼                                      â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚              â‘¢ Guardian Layerï¼ˆå®ˆè­·è€…å±¤ï¼‰ã€ãƒªã‚¹ã‚¯å¯¾ç­–ã€‘           â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€ãƒã‚§ãƒƒã‚¯é …ç›®ã€‘                                                  â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ å±é™ºæ“ä½œã®æ¤œå‡ºï¼ˆå…¨å“¡é€ä¿¡ã€å‰Šé™¤ã€æ¨©é™å¤‰æ›´ç­‰ï¼‰                   â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ ç¢ºä¿¡åº¦ãƒã‚§ãƒƒã‚¯ï¼ˆLLMã®ç¢ºä¿¡åº¦ãŒä½ã„å ´åˆã¯ç¢ºèªãƒ¢ãƒ¼ãƒ‰ï¼‰            â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ NGãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡ºï¼ˆæ©Ÿå¯†æƒ…å ±æ¼æ´©ã€ä¸é©åˆ‡ç™ºè¨€ç­‰ï¼‰                   â”‚  â”ƒ
â”ƒ  â”‚  â””â”€ CEOæ•™ãˆã¨ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯                                     â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€å‡ºåŠ›ã€‘                                                          â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ ALLOW: ãã®ã¾ã¾ç¶šè¡Œ                                           â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ CONFIRM: ç¢ºèªãƒ¢ãƒ¼ãƒ‰ã«é·ç§»                                     â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ BLOCK: å®Ÿè¡Œã‚’ãƒ–ãƒ­ãƒƒã‚¯                                         â”‚  â”ƒ
â”ƒ  â”‚  â””â”€ MODIFY: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¿®æ­£ã—ã¦ç¶šè¡Œ                              â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ
â”ƒ                                   â”‚                                      â”ƒ
â”ƒ                                   â–¼                                      â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚          â‘£ Authorization Gateï¼ˆæ¨©é™ãƒã‚§ãƒƒã‚¯ï¼‰ã€LLMã¨ç‹¬ç«‹ã€‘        â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€é‡è¦ã€‘LLMã®åˆ¤æ–­ã¨ã¯ã€å®Œå…¨ã«ç‹¬ç«‹ã€‘ã—ã¦å®Ÿè¡Œ                       â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€ãƒã‚§ãƒƒã‚¯é …ç›®ã€‘                                                  â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®Toolã‚’å®Ÿè¡Œã§ãã‚‹ã‹ï¼Ÿ                         â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ï¼Ÿ                   â”‚  â”ƒ
â”ƒ  â”‚  â””â”€ AccessControlï¼ˆ6æ®µéšæ¨©é™ï¼‰ã«ã‚ˆã‚‹å¼·åˆ¶                          â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€å‡ºåŠ›ã€‘                                                          â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ ALLOWED: ç¶šè¡Œ                                                  â”‚  â”ƒ
â”ƒ  â”‚  â””â”€ DENIED: æ‹’å¦ï¼ˆç†ç”±ä»˜ãï¼‰                                      â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  â€»LLMãŒä½•ã‚’åˆ¤æ–­ã—ã¦ã‚‚ã€ã“ã“ã§æœ€çµ‚çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æ‹…ä¿            â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ
â”ƒ                                   â”‚                                      â”ƒ
â”ƒ                                   â–¼                                      â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
â”ƒ  â”‚           â‘¤ Observability Layerï¼ˆè¦³æ¸¬å±¤ï¼‰ã€ãƒªã‚¹ã‚¯å¯¾ç­–ã€‘           â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€è¨˜éŒ²ã™ã‚‹æƒ…å ±ã€‘                                                  â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ å…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                                                â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ LLMã®æ€è€ƒéç¨‹ï¼ˆChain-of-Thoughtï¼‰                             â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ é¸æŠã•ã‚ŒãŸToolãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿                                    â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ Guardian/AuthGateã®åˆ¤å®šçµæœ                                   â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ å®Ÿè¡Œçµæœ                                                      â”‚  â”ƒ
â”ƒ  â”‚  â””â”€ æœ€çµ‚å¿œç­”                                                      â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â”‚  ã€è¿½åŠ å‡¦ç†ã€‘                                                      â”‚  â”ƒ
â”ƒ  â”‚  â”œâ”€ Self-Critiqueï¼ˆé‡è¦ãªåˆ¤æ–­ã§è‡ªå·±ãƒã‚§ãƒƒã‚¯ã€20%ç¨‹åº¦ï¼‰            â”‚  â”ƒ
â”ƒ  â”‚  â””â”€ å­¦ç¿’ãƒ«ãƒ¼ãƒ—ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯                                  â”‚  â”ƒ
â”ƒ  â”‚                                                                    â”‚  â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ
â”ƒ                                                                          â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      â‘¥ Toolå®Ÿè¡Œï¼ˆFunction Callingï¼‰                     â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ã‚¿ã‚¹ã‚¯ç®¡ç†â”‚ â”‚ç›®æ¨™ç®¡ç†  â”‚ â”‚ãƒ¡ãƒ¢ãƒª    â”‚ â”‚ãƒŠãƒ¬ãƒƒã‚¸  â”‚ â”‚ã‚¢ãƒŠã‚¦ãƒ³ã‚¹â”‚ ...  â”‚
â”‚  â”‚(Task)    â”‚ â”‚(Goal)    â”‚ â”‚(Memory)  â”‚ â”‚(Knowledge)â”‚ â”‚(Announce)â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                          â”‚
â”‚  â€»æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆToolå®šç¾©ã«å¤‰æ›ã™ã‚‹ã ã‘ï¼‰              â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            å®Ÿè¡Œçµæœ                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    â‘¦ LLM Brainï¼ˆå¿œç­”çµ±åˆï¼‰                              â”‚
â”‚                                                                          â”‚
â”‚  ã€å…¥åŠ›ã€‘                                                                â”‚
â”‚  â”œâ”€ Toolå®Ÿè¡Œçµæœ                                                        â”‚
â”‚  â”œâ”€ å…ƒã®Context                                                         â”‚
â”‚  â””â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¿œç­”æ–¹é‡ï¼ˆSystem Promptå†…ã§å®šç¾©ï¼‰                       â”‚
â”‚                                                                          â”‚
â”‚  ã€å‡¦ç†ã€‘                                                                â”‚
â”‚  â”œâ”€ å®Ÿè¡Œçµæœã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã«æ•´å½¢                                        â”‚
â”‚  â”œâ”€ è¿½åŠ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ææ¡ˆï¼ˆã€Œä»–ã«ä½•ã‹ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€ï¼‰                    â”‚
â”‚  â””â”€ ã‚½ã‚¦ãƒ«ãã‚“ã‚‰ã—ã„å£èª¿ã§è¿”ç­”ç”Ÿæˆ                                      â”‚
â”‚                                                                          â”‚
â”‚  ã€å‡ºåŠ›ã€‘                                                                â”‚
â”‚  â””â”€ æœ€çµ‚å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                                                  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¿œç­”                                   â”‚
â”‚                      ï¼ˆChatWorké€ä¿¡ï¼‰                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç¾åœ¨ã®è¨­è¨ˆã¨ã®å¯¾å¿œè¡¨

| ç¾åœ¨ã®å±¤ | æ–°ã—ã„è¨­è¨ˆã§ã®ä½ç½® | å¤‰æ›´å†…å®¹ |
|---------|-------------------|---------|
| è¨˜æ†¶å±¤ï¼ˆMemory Layerï¼‰ | â‘  Context Builder | çµ±åˆ |
| ç†è§£å±¤ï¼ˆUnderstanding Layerï¼‰ | â‘¡ LLM Brain | çµ±åˆãƒ»LLMåŒ– |
| åˆ¤æ–­å±¤ï¼ˆDecision Layerï¼‰ | â‘¡ LLM Brain | çµ±åˆãƒ»LLMåŒ– |
| çŠ¶æ…‹ç®¡ç†å±¤ï¼ˆState Layerï¼‰ | â‘  Context Builder | çµ±åˆ |
| å®Ÿè¡Œå±¤ï¼ˆExecution Layerï¼‰ | â‘¥ Toolå®Ÿè¡Œ | ç¶­æŒï¼ˆåç§°å¤‰æ›´ï¼‰ |
| GuardianService | â‘¢ Guardian Layer | å¼·åŒ– |
| AuthorizationGate | â‘£ Authorization Gate | ç¶­æŒ |
| Observability | â‘¤ Observability Layer | å¼·åŒ– |
| ChainOfThought | â‘¡ LLM Brainå†… | å¿…é ˆåŒ– |
| SelfCritique | â‘¤ Observability Layerå†… | ç¶­æŒ |

### 4.3 å¤‰ã‚ã‚‹ç‚¹ã¨å¤‰ã‚ã‚‰ãªã„ç‚¹

#### å¤‰ã‚ã‚‹ç‚¹

| é …ç›® | Before | After |
|------|--------|-------|
| æ„å›³ç†è§£ | ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚° | LLMã®æ¨è«– |
| åˆ¤æ–­ | ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  | Function Calling |
| ç†è§£ã¨åˆ¤æ–­ | åˆ¥ã€…ã®å±¤ | LLM Brainã§ä¸€ä½“åŒ– |
| æ€è€ƒéç¨‹ | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | å¿…é ˆ |
| å±¤æ§‹é€  | 4å±¤ + è£œåŠ©å±¤ | 6å±¤ + Toolå®Ÿè¡Œ + å¿œç­”çµ±åˆ |

#### å¤‰ã‚ã‚‰ãªã„ç‚¹

| é …ç›® | èª¬æ˜ |
|------|------|
| 7ã¤ã®é‰„å‰‡ | å…¨ã¦ç¶­æŒï¼ˆã‚€ã—ã‚å¼·åŒ–ï¼‰ |
| ãƒãƒ³ãƒ‰ãƒ©ãƒ¼æ§‹é€  | æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾ä½¿ç”¨ |
| æ¨©é™ãƒã‚§ãƒƒã‚¯ | AccessControlã‚’LLMã¨ç‹¬ç«‹ã—ã¦ç¶­æŒ |
| è¨˜æ†¶ã®æ§‹é€  | Memory Frameworkã‚’ãã®ã¾ã¾ä½¿ç”¨ |
| SYSTEM_CAPABILITIES | Toolå®šç¾©ã«å¤‰æ›ã—ã¦ä½¿ç”¨ |
| ç›£æŸ»ãƒ­ã‚° | ãã®ã¾ã¾ç¶­æŒ |

---

## 5. å„å±¤ã®è©³ç´°è¨­è¨ˆ

### 5.1 Context Builderï¼ˆæ–‡è„ˆæ§‹ç¯‰å±¤ï¼‰

#### 5.1.1 ç›®çš„

LLM Brainã«æ¸¡ã™ã€Œæ–‡è„ˆæƒ…å ±ã€ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚
å…¨ã¦ã®è¨˜æ†¶ãƒ»çŠ¶æ…‹ãƒ»è¨­è¨ˆæ€æƒ³ã‚’ã“ã“ã§é›†ç´„ã—ã€LLMãŒé©åˆ‡ãªåˆ¤æ–­ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

#### 5.1.2 åé›†ã™ã‚‹æƒ…å ±

| ã‚«ãƒ†ã‚´ãƒª | æƒ…å ± | å–å¾—å…ƒ | å„ªå…ˆåº¦ |
|---------|------|--------|--------|
| **çŠ¶æ…‹** | ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ | brain_conversation_states | 1ï¼ˆæœ€é«˜ï¼‰ |
| **çŠ¶æ…‹** | pendingæ“ä½œ | brain_conversation_states | 1 |
| **è¨˜æ†¶** | ç›´è¿‘ã®ä¼šè©±å±¥æ­´ï¼ˆ10ä»¶ï¼‰ | conversation_history | 2 |
| **è¨˜æ†¶** | ä¼šè©±ã®è¦ç´„ | conversation_summaries | 3 |
| **è¨˜æ†¶** | ãƒ¦ãƒ¼ã‚¶ãƒ¼å—œå¥½ | user_preferences | 3 |
| **è¨˜æ†¶** | äººç‰©æƒ…å ± | persons | 2 |
| **è¨˜æ†¶** | é–¢é€£ã‚¿ã‚¹ã‚¯ | chatwork_tasks | 3 |
| **è¨˜æ†¶** | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç›®æ¨™ | goals | 3 |
| **ä¾¡å€¤è¦³** | CEOæ•™ãˆ | ceo_teachings | 2 |
| **ä¾¡å€¤è¦³** | ä¼šç¤¾ã®ä¾¡å€¤è¦³ï¼ˆMVVï¼‰ | è¨­å®š | 2 |
| **ãƒŠãƒ¬ãƒƒã‚¸** | é–¢é€£ã™ã‚‹ä¼šç¤¾çŸ¥è­˜ | documents, soulkun_knowledge | 4 |

#### 5.1.3 ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```python
@dataclass
class LLMContext:
    """LLM Brainã«æ¸¡ã™ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ"""

    # === ç¾åœ¨ã®çŠ¶æ…‹ ===
    session_state: Optional[SessionState]      # ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹
    pending_action: Optional[PendingAction]    # pendingæ“ä½œ

    # === ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± ===
    user_id: str                               # ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
    user_name: str                             # ãƒ¦ãƒ¼ã‚¶ãƒ¼å
    user_role: str                             # å½¹è·ãƒ»æ¨©é™ãƒ¬ãƒ™ãƒ«
    user_preferences: Optional[UserPreferences] # å—œå¥½æƒ…å ±

    # === ä¼šè©±å±¥æ­´ ===
    recent_messages: List[Message]             # ç›´è¿‘10ä»¶ã®ä¼šè©±
    conversation_summary: Optional[str]         # éå»ã®ä¼šè©±è¦ç´„

    # === è¨˜æ†¶ ===
    known_persons: List[PersonInfo]            # è¨˜æ†¶ã—ã¦ã„ã‚‹äººç‰©
    recent_tasks: List[TaskInfo]               # é–¢é€£ã‚¿ã‚¹ã‚¯
    active_goals: List[GoalInfo]               # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç›®æ¨™

    # === ä¾¡å€¤è¦³ ===
    ceo_teachings: List[CEOTeaching]           # CEOæ•™ãˆ
    company_values: str                        # ä¼šç¤¾ã®MVV

    # === ãƒŠãƒ¬ãƒƒã‚¸ï¼ˆé…å»¶å–å¾—å¯ï¼‰ ===
    relevant_knowledge: Optional[List[KnowledgeChunk]]

    # === ãƒ¡ã‚¿æƒ…å ± ===
    current_datetime: datetime                 # ç¾åœ¨æ—¥æ™‚
    organization_id: str                       # çµ„ç¹”ID
    room_id: str                               # ChatWorkãƒ«ãƒ¼ãƒ ID

    def to_prompt_string(self) -> str:
        """LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã®æ–‡å­—åˆ—ã«å¤‰æ›"""
        sections = []

        # ç¾åœ¨ã®çŠ¶æ…‹
        if self.session_state:
            sections.append(f"ã€ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€‘\n{self.session_state.to_string()}")
        if self.pending_action:
            sections.append(f"ã€pendingæ“ä½œã€‘\n{self.pending_action.to_string()}")

        # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
        sections.append(f"""ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€‘
- åå‰: {self.user_name}
- å½¹è·: {self.user_role}
- å—œå¥½: {self.user_preferences.to_string() if self.user_preferences else 'ãªã—'}""")

        # ä¼šè©±å±¥æ­´
        if self.recent_messages:
            history = "\n".join([f"- {m.sender}: {m.content}" for m in self.recent_messages[-5:]])
            sections.append(f"ã€ç›´è¿‘ã®ä¼šè©±ã€‘\n{history}")

        # è¨˜æ†¶
        if self.known_persons:
            persons = "\n".join([f"- {p.name}: {p.description}" for p in self.known_persons[:5]])
            sections.append(f"ã€è¨˜æ†¶ã—ã¦ã„ã‚‹äººç‰©ã€‘\n{persons}")

        if self.recent_tasks:
            tasks = "\n".join([f"- {t.title} (æœŸé™: {t.due_date})" for t in self.recent_tasks[:5]])
            sections.append(f"ã€é–¢é€£ã‚¿ã‚¹ã‚¯ã€‘\n{tasks}")

        if self.active_goals:
            goals = "\n".join([f"- {g.title}: {g.progress}%" for g in self.active_goals[:3]])
            sections.append(f"ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç›®æ¨™ã€‘\n{goals}")

        # CEOæ•™ãˆ
        if self.ceo_teachings:
            teachings = "\n".join([f"- {t.content}" for t in self.ceo_teachings[:3]])
            sections.append(f"ã€CEOæ•™ãˆï¼ˆæœ€å„ªå…ˆã§å¾“ã†ï¼‰ã€‘\n{teachings}")

        # ç¾åœ¨æ—¥æ™‚
        sections.append(f"ã€ç¾åœ¨æ—¥æ™‚ã€‘\n{self.current_datetime.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M')}")

        return "\n\n".join(sections)
```

#### 5.1.4 å®Ÿè£…

```python
# lib/brain/context_builder.py

class ContextBuilder:
    """
    LLM Brainã«æ¸¡ã™ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

    è¨­è¨ˆæ›¸: docs/25_llm_native_brain_architecture.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³5.1
    """

    def __init__(
        self,
        pool,
        memory_access: BrainMemoryAccess,
        state_manager: BrainStateManager,
    ):
        self.pool = pool
        self.memory_access = memory_access
        self.state_manager = state_manager

    async def build(
        self,
        user_id: str,
        room_id: str,
        organization_id: str,
        message: str,
    ) -> LLMContext:
        """
        ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

        Truthé †ä½ï¼ˆCLAUDE.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³3ï¼‰ã«å¾“ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€‚
        1ä½: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ API
        2ä½: DBï¼ˆæ­£è¦ãƒ‡ãƒ¼ã‚¿ï¼‰
        3ä½: è¨­è¨ˆæ›¸ãƒ»ä»•æ§˜æ›¸
        4ä½: Memoryï¼ˆä¼šè©±ã®æ–‡è„ˆï¼‰
        5ä½: æ¨æ¸¬ â†’ ç¦æ­¢
        """
        # ä¸¦åˆ—ã§å…¨ã¦ã®æƒ…å ±ã‚’å–å¾—
        results = await asyncio.gather(
            self.state_manager.get_current_state(user_id, room_id),
            self.memory_access.get_recent_messages(user_id, room_id, limit=10),
            self.memory_access.get_conversation_summary(user_id),
            self.memory_access.get_user_preferences(user_id),
            self.memory_access.get_known_persons(organization_id),
            self.memory_access.get_recent_tasks(user_id, room_id),
            self.memory_access.get_active_goals(user_id),
            self._get_ceo_teachings(organization_id),
            self._get_user_info(user_id, organization_id),
        )

        (
            session_state,
            recent_messages,
            conversation_summary,
            user_preferences,
            known_persons,
            recent_tasks,
            active_goals,
            ceo_teachings,
            user_info,
        ) = results

        return LLMContext(
            session_state=session_state,
            pending_action=session_state.pending_action if session_state else None,
            user_id=user_id,
            user_name=user_info.name,
            user_role=user_info.role,
            user_preferences=user_preferences,
            recent_messages=recent_messages,
            conversation_summary=conversation_summary,
            known_persons=known_persons,
            recent_tasks=recent_tasks,
            active_goals=active_goals,
            ceo_teachings=ceo_teachings,
            company_values=self._get_company_values(),
            relevant_knowledge=None,  # å¿…è¦æ™‚ã«é…å»¶å–å¾—
            current_datetime=datetime.now(JST),
            organization_id=organization_id,
            room_id=room_id,
        )

    async def enrich_with_knowledge(
        self,
        context: LLMContext,
        query: str,
    ) -> LLMContext:
        """å¿…è¦ã«å¿œã˜ã¦ãƒŠãƒ¬ãƒƒã‚¸ã‚’è¿½åŠ å–å¾—"""
        knowledge = await self.memory_access.search_knowledge(
            query=query,
            organization_id=context.organization_id,
            limit=5,
        )
        context.relevant_knowledge = knowledge
        return context
```

### 5.2 LLM Brainï¼ˆLLMè„³å±¤ï¼‰

#### 5.2.1 ç›®çš„

ã‚½ã‚¦ãƒ«ãã‚“ã®ã€Œæ€è€ƒã€ã®ä¸­æ ¸ã€‚
Claude Opus 4.5ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’æ±²ã¿å–ã‚Šã€é©åˆ‡ãªToolã‚’é¸æŠã™ã‚‹ã€‚

#### 5.2.2 å…¥åŠ›

| é …ç›® | èª¬æ˜ |
|------|------|
| System Prompt | ã‚½ã‚¦ãƒ«ãã‚“ã®äººæ ¼ã€è¨­è¨ˆæ€æƒ³ã€åˆ¶ç´„ |
| Context | Context Builderã§æ§‹ç¯‰ã—ãŸæ–‡è„ˆæƒ…å ± |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | ä»Šå›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ› |
| Toolå®šç¾© | å®Ÿè¡Œå¯èƒ½ãªæ©Ÿèƒ½ã®ãƒªã‚¹ãƒˆï¼ˆFunction Callingç”¨ï¼‰ |

#### 5.2.3 å‡ºåŠ›

| é …ç›® | èª¬æ˜ |
|------|------|
| tool_calls | å‘¼ã³å‡ºã™Toolã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ |
| ã¾ãŸã¯ text_response | Toolã‚’ä½¿ã‚ãªã„ç›´æ¥å¿œç­” |
| reasoning | æ€è€ƒéç¨‹ï¼ˆChain-of-Thoughtï¼‰ã€å¿…é ˆã€‘ |
| confidence | ç¢ºä¿¡åº¦ï¼ˆ0.0ã€œ1.0ï¼‰ |

#### 5.2.4 å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
å…¥åŠ›ï¼ˆContext + Message + Toolsï¼‰
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯                    â”‚
â”‚ - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ï¼Ÿâ†’ ãã®ãƒ•ãƒ­ãƒ¼ã‚’ç¶™ç¶š      â”‚
â”‚ - pendingæ“ä½œï¼Ÿâ†’ ç¢ºèªå¿œç­”ã¨ã—ã¦å‡¦ç†     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: æ„å›³ç†è§£ï¼ˆLLMã®æ¨è«–ï¼‰           â”‚
â”‚ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä½•ã‚’ã—ãŸã„ã®ã‹ï¼Ÿ            â”‚
â”‚ - çœç•¥ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã¯ä½•ã‹ï¼Ÿ            â”‚
â”‚ - æ–‡è„ˆã‹ã‚‰è£œå®Œã§ãã‚‹æƒ…å ±ã¯ä½•ã‹ï¼Ÿ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Toolé¸æŠï¼ˆFunction Callingï¼‰    â”‚
â”‚ - ä½¿ç”¨å¯èƒ½ãªToolã‹ã‚‰æœ€é©ãªã‚‚ã®ã‚’é¸æŠ    â”‚
â”‚ - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŠ½å‡ºãƒ»è£œå®Œ                â”‚
â”‚ - ã¾ãŸã¯ç›´æ¥å¿œç­”ãŒé©åˆ‡ã‹åˆ¤æ–­            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: æ€è€ƒéç¨‹ã®å‡ºåŠ›                  â”‚
â”‚ - ãªãœã“ã®Toolã‚’é¸ã‚“ã ã‹                â”‚
â”‚ - ã©ã®æƒ…å ±ã‚’æ ¹æ‹ ã«ã—ãŸã‹                â”‚
â”‚ - ç¢ºä¿¡åº¦ã¯ã©ã®ç¨‹åº¦ã‹                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
å‡ºåŠ›ï¼ˆtool_calls or text_response + reasoningï¼‰
```

#### 5.2.5 å®Ÿè£…

```python
# lib/brain/llm_brain.py

import anthropic
from typing import List, Optional, Union
from dataclasses import dataclass

@dataclass
class LLMBrainResult:
    """LLM Brainã®å‡¦ç†çµæœ"""

    # Toolå‘¼ã³å‡ºã—ï¼ˆã‚ã‚‹å ´åˆï¼‰
    tool_calls: Optional[List[ToolCall]] = None

    # ç›´æ¥å¿œç­”ï¼ˆToolä¸è¦ã®å ´åˆï¼‰
    text_response: Optional[str] = None

    # æ€è€ƒéç¨‹ï¼ˆå¿…é ˆï¼‰
    reasoning: str = ""

    # ç¢ºä¿¡åº¦
    confidence: float = 0.0

    # è¿½åŠ æƒ…å ±
    needs_confirmation: bool = False
    confirmation_question: Optional[str] = None


@dataclass
class ToolCall:
    """Toolå‘¼ã³å‡ºã—æƒ…å ±"""
    tool_name: str
    parameters: dict
    reasoning: str  # ã“ã®Toolã‚’é¸ã‚“ã ç†ç”±


class LLMBrain:
    """
    ã‚½ã‚¦ãƒ«ãã‚“ã®è„³ï¼ˆLLMå¸¸é§å‹ï¼‰

    è¨­è¨ˆæ›¸: docs/25_llm_native_brain_architecture.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³5.2

    ã€7ã¤ã®é‰„å‰‡ã¨ã®å¯¾å¿œã€‘
    1. å…¨ã¦ã®å…¥åŠ›ã¯è„³ã‚’é€šã‚‹ â†’ ã“ã®ã‚¯ãƒ©ã‚¹ãŒå…¨å…¥åŠ›ã‚’å‡¦ç†
    2. è„³ã¯å…¨ã¦ã®è¨˜æ†¶ã«ã‚¢ã‚¯ã‚»ã‚¹ â†’ Contextã‹ã‚‰å…¨è¨˜æ†¶ã‚’å‚ç…§
    3. è„³ãŒåˆ¤æ–­ã€æ©Ÿèƒ½ã¯å®Ÿè¡Œã™ã‚‹ã ã‘ â†’ LLMãŒåˆ¤æ–­ã€ToolãŒå®Ÿè¡Œ
    """

    def __init__(
        self,
        model: str = "claude-opus-4-5-20250101",
        api_key: Optional[str] = None,
    ):
        self.client = anthropic.Anthropic(api_key=api_key)
        self.model = model

    async def process(
        self,
        context: LLMContext,
        message: str,
        tools: List[ToolDefinition],
        system_prompt: str,
    ) -> LLMBrainResult:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã™ã‚‹ã€‚

        Args:
            context: Context Builderã§æ§‹ç¯‰ã—ãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            message: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            tools: ä½¿ç”¨å¯èƒ½ãªToolå®šç¾©ã®ãƒªã‚¹ãƒˆ
            system_prompt: ã‚½ã‚¦ãƒ«ãã‚“ã®System Prompt

        Returns:
            LLMBrainResult: å‡¦ç†çµæœï¼ˆToolå‘¼ã³å‡ºã—ã¾ãŸã¯ç›´æ¥å¿œç­”ï¼‰
        """
        # System Promptã‚’æ§‹ç¯‰
        full_system_prompt = self._build_system_prompt(
            base_prompt=system_prompt,
            context=context,
        )

        # Toolå®šç¾©ã‚’Anthropicå½¢å¼ã«å¤‰æ›
        anthropic_tools = self._convert_tools(tools)

        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
        messages = self._build_messages(context, message)

        # LLMå‘¼ã³å‡ºã—
        response = await self._call_llm(
            system=full_system_prompt,
            messages=messages,
            tools=anthropic_tools,
        )

        # çµæœã‚’è§£æ
        return self._parse_response(response)

    def _build_system_prompt(
        self,
        base_prompt: str,
        context: LLMContext,
    ) -> str:
        """System Promptã‚’æ§‹ç¯‰"""
        return f"""{base_prompt}

===== ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ =====
{context.to_prompt_string()}

===== é‡è¦ãªæŒ‡ç¤º =====
1. å¿…ãšã€Œæ€è€ƒéç¨‹ã€ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ãªãœãã®Toolã‚’é¸ã‚“ã ã‹ã€ã©ã®æƒ…å ±ã‚’æ ¹æ‹ ã«ã—ãŸã‹ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
2. ç¢ºä¿¡åº¦ãŒ70%æœªæº€ã®å ´åˆã¯ã€ç¢ºèªè³ªå•ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’ã€Œæ±²ã¿å–ã‚‹ã€ã“ã¨ã‚’æœ€å„ªå…ˆã—ã¦ãã ã•ã„ã€‚è¡¨é¢çš„ãªè¨€è‘‰ã ã‘ã§ãªãã€æ–‡è„ˆã‹ã‚‰çœŸã®æ„å›³ã‚’æ¨è«–ã—ã¦ãã ã•ã„ã€‚
4. CEOæ•™ãˆãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚’æœ€å„ªå…ˆã§å‚ç…§ã—ã¦ãã ã•ã„ã€‚
"""

    def _build_messages(
        self,
        context: LLMContext,
        message: str,
    ) -> List[dict]:
        """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’æ§‹ç¯‰"""
        messages = []

        # ç›´è¿‘ã®ä¼šè©±å±¥æ­´ã‚’è¿½åŠ 
        for m in context.recent_messages[-5:]:
            role = "user" if m.sender != "soulkun" else "assistant"
            messages.append({"role": role, "content": m.content})

        # ä»Šå›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
        messages.append({"role": "user", "content": message})

        return messages

    async def _call_llm(
        self,
        system: str,
        messages: List[dict],
        tools: List[dict],
    ) -> anthropic.Message:
        """LLMã‚’å‘¼ã³å‡ºã™"""
        return self.client.messages.create(
            model=self.model,
            max_tokens=2048,
            system=system,
            messages=messages,
            tools=tools,
            tool_choice={"type": "auto"},  # LLMãŒè‡ªå‹•ã§Toolä½¿ç”¨ã‚’åˆ¤æ–­
        )

    def _parse_response(
        self,
        response: anthropic.Message,
    ) -> LLMBrainResult:
        """ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æ"""
        tool_calls = []
        text_response = None
        reasoning = ""

        for block in response.content:
            if block.type == "tool_use":
                tool_calls.append(ToolCall(
                    tool_name=block.name,
                    parameters=block.input,
                    reasoning="",  # å¾Œã§æŠ½å‡º
                ))
            elif block.type == "text":
                # ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰æ€è€ƒéç¨‹ã¨å¿œç­”ã‚’åˆ†é›¢
                text = block.text
                if "ã€æ€è€ƒéç¨‹ã€‘" in text:
                    parts = text.split("ã€æ€è€ƒéç¨‹ã€‘")
                    reasoning = parts[1].split("ã€")[0].strip() if len(parts) > 1 else ""
                    text_response = parts[0].strip() if parts[0].strip() else None
                else:
                    text_response = text

        # ç¢ºä¿¡åº¦ã‚’æŠ½å‡ºï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ï¼‰
        confidence = self._extract_confidence(reasoning)

        return LLMBrainResult(
            tool_calls=tool_calls if tool_calls else None,
            text_response=text_response,
            reasoning=reasoning,
            confidence=confidence,
            needs_confirmation=confidence < 0.7,
        )

    def _extract_confidence(self, reasoning: str) -> float:
        """æ€è€ƒéç¨‹ã‹ã‚‰ç¢ºä¿¡åº¦ã‚’æŠ½å‡º"""
        # ç°¡æ˜“å®Ÿè£…ï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§æ¨å®š
        if "ç¢ºä¿¡" in reasoning or "æ˜ç¢º" in reasoning:
            return 0.9
        elif "ãŠãã‚‰ã" in reasoning or "ãŸã¶ã‚“" in reasoning:
            return 0.7
        elif "åˆ†ã‹ã‚‰ãªã„" in reasoning or "ä¸æ˜" in reasoning:
            return 0.5
        else:
            return 0.8  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
```

### 5.3 Guardian Layerï¼ˆå®ˆè­·è€…å±¤ï¼‰

#### 5.3.1 ç›®çš„

LLMã®åˆ¤æ–­çµæœã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å±é™ºãªæ“ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯ã€ã¾ãŸã¯ç¢ºèªãƒ¢ãƒ¼ãƒ‰ã«é·ç§»ã•ã›ã‚‹ã€‚

#### 5.3.2 ãƒã‚§ãƒƒã‚¯é …ç›®

| ãƒã‚§ãƒƒã‚¯ | èª¬æ˜ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|---------|------|----------|
| å±é™ºæ“ä½œ | å…¨å“¡é€ä¿¡ã€å‰Šé™¤ã€æ¨©é™å¤‰æ›´ç­‰ | CONFIRM or BLOCK |
| ç¢ºä¿¡åº¦ | LLMã®ç¢ºä¿¡åº¦ãŒä½ã„ï¼ˆ< 0.7ï¼‰ | CONFIRM |
| NGãƒ‘ã‚¿ãƒ¼ãƒ³ | æ©Ÿå¯†æƒ…å ±æ¼æ´©ã€ä¸é©åˆ‡ç™ºè¨€ | BLOCK |
| CEOæ•™ãˆé•å | CEOæ•™ãˆã¨çŸ›ç›¾ã™ã‚‹åˆ¤æ–­ | BLOCK or MODIFY |
| é‡‘é¡ãƒã‚§ãƒƒã‚¯ | é«˜é¡ãªæ“ä½œï¼ˆ> 10ä¸‡å††ï¼‰ | CONFIRM |
| è¤‡æ•°é€ä¿¡ | 3äººä»¥ä¸Šã¸ã®é€ä¿¡ | CONFIRM |

#### 5.3.3 å‡ºåŠ›

| çµæœ | èª¬æ˜ |
|------|------|
| ALLOW | ãã®ã¾ã¾ç¶šè¡Œ |
| CONFIRM | ç¢ºèªãƒ¢ãƒ¼ãƒ‰ã«é·ç§»ï¼ˆç¢ºèªè³ªå•ã‚’ç”Ÿæˆï¼‰ |
| BLOCK | å®Ÿè¡Œã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆç†ç”±ã‚’é€šçŸ¥ï¼‰ |
| MODIFY | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¿®æ­£ã—ã¦ç¶šè¡Œ |

#### 5.3.4 å®Ÿè£…

```python
# lib/brain/guardian_layer.py

from enum import Enum
from dataclasses import dataclass
from typing import Optional, List

class GuardianAction(Enum):
    ALLOW = "allow"
    CONFIRM = "confirm"
    BLOCK = "block"
    MODIFY = "modify"


@dataclass
class GuardianResult:
    """Guardian Layerã®åˆ¤å®šçµæœ"""
    action: GuardianAction
    reason: Optional[str] = None
    confirmation_question: Optional[str] = None
    modified_params: Optional[dict] = None
    blocked_reason: Optional[str] = None


# å±é™ºæ“ä½œã®ãƒªã‚¹ãƒˆ
DANGEROUS_OPERATIONS = {
    "send_to_all": {"risk": "high", "action": "confirm"},
    "delete_task": {"risk": "medium", "action": "confirm"},
    "delete_goal": {"risk": "medium", "action": "confirm"},
    "delete_memory": {"risk": "high", "action": "confirm"},
    "change_permission": {"risk": "high", "action": "block"},
    "send_confidential": {"risk": "critical", "action": "block"},
}


class GuardianLayer:
    """
    å®ˆè­·è€…å±¤ - LLMã®åˆ¤æ–­ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹

    è¨­è¨ˆæ›¸: docs/25_llm_native_brain_architecture.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³5.3

    ã€å½¹å‰²ã€‘
    - LLMãŒå‡ºåŠ›ã—ãŸToolå‘¼ã³å‡ºã—ã‚’æ¤œè¨¼
    - å±é™ºãªæ“ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯ã¾ãŸã¯ç¢ºèª
    - CEOæ•™ãˆã¨ã®æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯
    """

    def __init__(
        self,
        ceo_teachings: List[CEOTeaching],
        ng_patterns: List[str],
    ):
        self.ceo_teachings = ceo_teachings
        self.ng_patterns = ng_patterns

    async def check(
        self,
        llm_result: LLMBrainResult,
        context: LLMContext,
    ) -> GuardianResult:
        """
        LLMã®åˆ¤æ–­çµæœã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚

        Args:
            llm_result: LLM Brainã®å‡¦ç†çµæœ
            context: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±

        Returns:
            GuardianResult: ãƒã‚§ãƒƒã‚¯çµæœ
        """
        # ç›´æ¥å¿œç­”ã®å ´åˆ
        if llm_result.text_response and not llm_result.tool_calls:
            return await self._check_text_response(
                llm_result.text_response,
                context,
            )

        # Toolå‘¼ã³å‡ºã—ã®å ´åˆ
        if llm_result.tool_calls:
            return await self._check_tool_calls(
                llm_result.tool_calls,
                llm_result.confidence,
                context,
            )

        return GuardianResult(action=GuardianAction.ALLOW)

    async def _check_tool_calls(
        self,
        tool_calls: List[ToolCall],
        confidence: float,
        context: LLMContext,
    ) -> GuardianResult:
        """Toolå‘¼ã³å‡ºã—ã‚’ãƒã‚§ãƒƒã‚¯"""

        for tool_call in tool_calls:
            # 1. å±é™ºæ“ä½œãƒã‚§ãƒƒã‚¯
            if tool_call.tool_name in DANGEROUS_OPERATIONS:
                op = DANGEROUS_OPERATIONS[tool_call.tool_name]
                if op["action"] == "block":
                    return GuardianResult(
                        action=GuardianAction.BLOCK,
                        blocked_reason=f"ã“ã®æ“ä½œï¼ˆ{tool_call.tool_name}ï¼‰ã¯è‡ªå‹•å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚",
                    )
                elif op["action"] == "confirm":
                    return GuardianResult(
                        action=GuardianAction.CONFIRM,
                        confirmation_question=self._generate_confirmation(tool_call),
                    )

            # 2. ç¢ºä¿¡åº¦ãƒã‚§ãƒƒã‚¯
            if confidence < 0.7:
                return GuardianResult(
                    action=GuardianAction.CONFIRM,
                    confirmation_question=f"ã€Œ{tool_call.tool_name}ã€ã‚’å®Ÿè¡Œã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
                    reason="ç¢ºä¿¡åº¦ãŒä½ã„ãŸã‚ç¢ºèª",
                )

            # 3. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ï¼ˆé‡‘é¡ã€é€ä¿¡å…ˆæ•°ç­‰ï¼‰
            param_check = await self._check_parameters(tool_call, context)
            if param_check.action != GuardianAction.ALLOW:
                return param_check

            # 4. CEOæ•™ãˆãƒã‚§ãƒƒã‚¯
            ceo_check = await self._check_ceo_teachings(tool_call, context)
            if ceo_check.action != GuardianAction.ALLOW:
                return ceo_check

        return GuardianResult(action=GuardianAction.ALLOW)

    async def _check_text_response(
        self,
        text: str,
        context: LLMContext,
    ) -> GuardianResult:
        """ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”ã‚’ãƒã‚§ãƒƒã‚¯"""

        # NGãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
        for pattern in self.ng_patterns:
            if pattern in text:
                return GuardianResult(
                    action=GuardianAction.BLOCK,
                    blocked_reason=f"ä¸é©åˆ‡ãªå†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚",
                )

        # æ©Ÿå¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯
        if await self._contains_confidential(text, context):
            return GuardianResult(
                action=GuardianAction.BLOCK,
                blocked_reason="æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
            )

        return GuardianResult(action=GuardianAction.ALLOW)

    async def _check_parameters(
        self,
        tool_call: ToolCall,
        context: LLMContext,
    ) -> GuardianResult:
        """ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯"""
        params = tool_call.parameters

        # é‡‘é¡ãƒã‚§ãƒƒã‚¯
        if "amount" in params:
            amount = params["amount"]
            if amount > 100000:
                return GuardianResult(
                    action=GuardianAction.CONFIRM,
                    confirmation_question=f"é‡‘é¡ãŒ{amount:,}å††ã§ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
                )

        # é€ä¿¡å…ˆãƒã‚§ãƒƒã‚¯
        if "recipients" in params:
            recipients = params["recipients"]
            if len(recipients) >= 3:
                return GuardianResult(
                    action=GuardianAction.CONFIRM,
                    confirmation_question=f"{len(recipients)}äººã«é€ä¿¡ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
                )

        return GuardianResult(action=GuardianAction.ALLOW)

    async def _check_ceo_teachings(
        self,
        tool_call: ToolCall,
        context: LLMContext,
    ) -> GuardianResult:
        """CEOæ•™ãˆã¨ã®æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯"""
        # CEOæ•™ãˆãŒã‚ã‚‹å ´åˆã€ãã‚Œã«é•åã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        for teaching in self.ceo_teachings:
            if teaching.is_violated_by(tool_call):
                return GuardianResult(
                    action=GuardianAction.BLOCK,
                    blocked_reason=f"CEOæ•™ãˆã€Œ{teaching.title}ã€ã«é•åã—ã¾ã™ã€‚",
                )

        return GuardianResult(action=GuardianAction.ALLOW)

    def _generate_confirmation(self, tool_call: ToolCall) -> str:
        """ç¢ºèªè³ªå•ã‚’ç”Ÿæˆ"""
        return f"""ğŸ¤” ç¢ºèªã•ã›ã¦ã»ã—ã„ã‚¦ãƒ«ï¼

ã€Œ{tool_call.tool_name}ã€ã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: {tool_call.parameters}

å®Ÿè¡Œã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ
1. ã¯ã„
2. ã„ã„ãˆ"""
```

### 5.4 Authorization Gateï¼ˆæ¨©é™ãƒã‚§ãƒƒã‚¯å±¤ï¼‰

#### 5.4.1 ç›®çš„

LLMã®åˆ¤æ–­ã¨ã¯**å®Œå…¨ã«ç‹¬ç«‹**ã—ã¦ã€æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã€‚
LLMãŒã©ã®ã‚ˆã†ãªåˆ¤æ–­ã‚’ã—ã¦ã‚‚ã€ã“ã®ã‚²ãƒ¼ãƒˆã‚’é€šéã—ãªã„é™ã‚Šå®Ÿè¡Œã•ã‚Œãªã„ã€‚

#### 5.4.2 ãƒã‚§ãƒƒã‚¯å†…å®¹

| ãƒã‚§ãƒƒã‚¯ | èª¬æ˜ |
|---------|------|
| Toolå®Ÿè¡Œæ¨©é™ | ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®Toolã‚’å®Ÿè¡Œã§ãã‚‹ã‹ |
| ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ | ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ |
| æ¨©é™ãƒ¬ãƒ™ãƒ« | 6æ®µéšæ¨©é™ãƒ¬ãƒ™ãƒ«ã«ã‚ˆã‚‹åˆ¶å¾¡ |

#### 5.4.3 æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆæ—¢å­˜ã‚’ç¶™æ‰¿ï¼‰

| ãƒ¬ãƒ™ãƒ« | å½¹è· | è¦‹ã‚Œã‚‹ç¯„å›² |
|--------|------|-----------|
| 1 | æ¥­å‹™å§”è¨— | è‡ªéƒ¨ç½²ã®ã¿ï¼ˆåˆ¶é™ã‚ã‚Šï¼‰ |
| 2 | ä¸€èˆ¬ç¤¾å“¡ | è‡ªéƒ¨ç½²ã®ã¿ |
| 3 | ãƒªãƒ¼ãƒ€ãƒ¼/èª²é•· | è‡ªéƒ¨ç½² + ç›´ä¸‹éƒ¨ç½² |
| 4 | å¹¹éƒ¨/éƒ¨é•· | è‡ªéƒ¨ç½² + é…ä¸‹å…¨éƒ¨ç½² |
| 5 | ç®¡ç†éƒ¨/å–ç· å½¹ | å…¨çµ„ç¹”ï¼ˆæœ€é«˜æ©Ÿå¯†é™¤ãï¼‰ |
| 6 | ä»£è¡¨/CFO | å…¨çµ„ç¹”ãƒ»å…¨æƒ…å ± |

#### 5.4.4 å®Ÿè£…

```python
# lib/brain/authorization_gate.py

from enum import Enum
from dataclasses import dataclass
from typing import Optional

class AuthorizationResult(Enum):
    ALLOWED = "allowed"
    DENIED = "denied"


@dataclass
class AuthorizationGateResult:
    """Authorization Gateã®åˆ¤å®šçµæœ"""
    result: AuthorizationResult
    reason: Optional[str] = None
    denied_message: Optional[str] = None


class AuthorizationGate:
    """
    æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚²ãƒ¼ãƒˆ - LLMã¨ã¯ç‹¬ç«‹ã—ã¦æ¨©é™ã‚’æ¤œè¨¼

    è¨­è¨ˆæ›¸: docs/25_llm_native_brain_architecture.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³5.4
    CLAUDE.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³7: æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆ6æ®µéšï¼‰

    ã€é‡è¦ã€‘
    ã“ã®ã‚¯ãƒ©ã‚¹ã¯LLMã®åˆ¤æ–­ã¨ã¯å®Œå…¨ã«ç‹¬ç«‹ã—ã¦å‹•ä½œã™ã‚‹ã€‚
    LLMãŒã©ã®ã‚ˆã†ãªåˆ¤æ–­ã‚’ã—ã¦ã‚‚ã€ã“ã®ã‚²ãƒ¼ãƒˆã‚’é€šéã—ãªã„é™ã‚Šå®Ÿè¡Œã•ã‚Œãªã„ã€‚
    """

    def __init__(
        self,
        access_control: AccessControl,
    ):
        self.access_control = access_control

    async def check(
        self,
        user_id: str,
        organization_id: str,
        tool_call: ToolCall,
        context: LLMContext,
    ) -> AuthorizationGateResult:
        """
        æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚

        Args:
            user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
            organization_id: çµ„ç¹”ID
            tool_call: å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹Toolå‘¼ã³å‡ºã—
            context: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

        Returns:
            AuthorizationGateResult: ãƒã‚§ãƒƒã‚¯çµæœ
        """
        # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—
        user_level = await self.access_control.get_user_level(
            user_id=user_id,
            organization_id=organization_id,
        )

        # 2. Toolã®å¿…è¦æ¨©é™ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—
        required_level = self._get_required_level(tool_call.tool_name)

        # 3. Toolå®Ÿè¡Œæ¨©é™ãƒã‚§ãƒƒã‚¯
        if user_level < required_level:
            return AuthorizationGateResult(
                result=AuthorizationResult.DENIED,
                reason="æ¨©é™ãƒ¬ãƒ™ãƒ«ä¸è¶³",
                denied_message=f"ã“ã®æ“ä½œã«ã¯æ¨©é™ãƒ¬ãƒ™ãƒ«{required_level}ä»¥ä¸ŠãŒå¿…è¦ã§ã™ã€‚",
            )

        # 4. ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆToolãŒãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã™ã‚‹å ´åˆï¼‰
        if "target_user_id" in tool_call.parameters:
            target_user_id = tool_call.parameters["target_user_id"]
            can_access = await self.access_control.can_access_user_data(
                accessor_id=user_id,
                target_id=target_user_id,
                organization_id=organization_id,
            )
            if not can_access:
                return AuthorizationGateResult(
                    result=AuthorizationResult.DENIED,
                    reason="ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãªã—",
                    denied_message="ã“ã®æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
                )

        # 5. éƒ¨ç½²é–“ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯
        if "target_department_id" in tool_call.parameters:
            target_dept = tool_call.parameters["target_department_id"]
            can_access = await self.access_control.can_access_department(
                user_id=user_id,
                department_id=target_dept,
                organization_id=organization_id,
            )
            if not can_access:
                return AuthorizationGateResult(
                    result=AuthorizationResult.DENIED,
                    reason="éƒ¨ç½²ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãªã—",
                    denied_message="ã“ã®éƒ¨ç½²ã®æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
                )

        return AuthorizationGateResult(result=AuthorizationResult.ALLOWED)

    def _get_required_level(self, tool_name: str) -> int:
        """Toolã®å¿…è¦æ¨©é™ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—"""
        # Toolã”ã¨ã®å¿…è¦æ¨©é™ãƒ¬ãƒ™ãƒ«å®šç¾©
        TOOL_REQUIRED_LEVELS = {
            # ãƒ¬ãƒ™ãƒ«1ï¼ˆèª°ã§ã‚‚ï¼‰
            "chatwork_task_create": 1,
            "chatwork_task_complete": 1,
            "chatwork_task_search": 1,
            "save_memory": 1,
            "query_memory": 1,

            # ãƒ¬ãƒ™ãƒ«2ï¼ˆä¸€èˆ¬ç¤¾å“¡ä»¥ä¸Šï¼‰
            "goal_registration": 2,
            "goal_progress_report": 2,

            # ãƒ¬ãƒ™ãƒ«3ï¼ˆãƒªãƒ¼ãƒ€ãƒ¼ä»¥ä¸Šï¼‰
            "view_team_tasks": 3,
            "view_team_goals": 3,

            # ãƒ¬ãƒ™ãƒ«5ï¼ˆç®¡ç†éƒ¨ä»¥ä¸Šï¼‰
            "view_all_users": 5,
            "view_salary_info": 6,  # ä»£è¡¨ã®ã¿

            # ãƒ¬ãƒ™ãƒ«6ï¼ˆä»£è¡¨ã®ã¿ï¼‰
            "change_permission": 6,
        }

        return TOOL_REQUIRED_LEVELS.get(tool_name, 2)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ¬ãƒ™ãƒ«2
```

### 5.5 Observability Layerï¼ˆè¦³æ¸¬å±¤ï¼‰

#### 5.5.1 ç›®çš„

å…¨ã¦ã®åˆ¤æ–­ã‚’è¨˜éŒ²ã—ã€è¿½è·¡å¯èƒ½ã«ã™ã‚‹ã€‚
å•é¡ŒãŒç™ºç”Ÿã—ãŸæ™‚ã«ã€Œãªãœãã†ãªã£ãŸã‹ã€ã‚’èª¿æŸ»ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

#### 5.5.2 è¨˜éŒ²ã™ã‚‹æƒ…å ±

| æƒ…å ± | èª¬æ˜ |
|------|------|
| å…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| æ§‹ç¯‰ã•ã‚ŒãŸContext | LLMã«æ¸¡ã—ãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ |
| LLMã®æ€è€ƒéç¨‹ | Chain-of-Thought |
| é¸æŠã•ã‚ŒãŸTool | Toolåã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ |
| Guardianåˆ¤å®š | ALLOW/CONFIRM/BLOCK/MODIFY |
| AuthGateåˆ¤å®š | ALLOWED/DENIED |
| å®Ÿè¡Œçµæœ | æˆåŠŸ/å¤±æ•—ã€çµæœãƒ‡ãƒ¼ã‚¿ |
| æœ€çµ‚å¿œç­” | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿”ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| å‡¦ç†æ™‚é–“ | å„ã‚¹ãƒ†ãƒƒãƒ—ã®æ‰€è¦æ™‚é–“ |

#### 5.5.3 Self-Critiqueï¼ˆè‡ªå·±æ‰¹åˆ¤ï¼‰

é‡è¦ãªåˆ¤æ–­ï¼ˆç´„20%ï¼‰ã§ã¯ã€LLMã«è‡ªå·±æ‰¹åˆ¤ã•ã›ã‚‹ã€‚

```
ã€Self-Critiqueã®ç™ºå‹•æ¡ä»¶ã€‘
- ç¢ºä¿¡åº¦ãŒ0.7ã€œ0.9ã®ä¸­é–“å¸¯
- è¤‡æ•°ã®ToolãŒå€™è£œã«ä¸ŠãŒã£ãŸå ´åˆ
- å±é™ºæ“ä½œã®å ´åˆ
- ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆ10%ï¼‰
```

#### 5.5.4 å®Ÿè£…

```python
# lib/brain/observability_layer.py

from dataclasses import dataclass, field
from datetime import datetime
from typing import Optional, List, Dict, Any
import json
import logging

logger = logging.getLogger(__name__)


@dataclass
class ObservabilityRecord:
    """è¦³æ¸¬è¨˜éŒ²"""

    # === è­˜åˆ¥æƒ…å ± ===
    record_id: str
    timestamp: datetime
    user_id: str
    organization_id: str
    room_id: str

    # === å…¥åŠ› ===
    input_message: str
    context_summary: str

    # === LLMå‡¦ç† ===
    llm_model: str
    llm_reasoning: str
    llm_confidence: float
    selected_tools: List[Dict[str, Any]]

    # === ãƒã‚§ãƒƒã‚¯çµæœ ===
    guardian_action: str
    guardian_reason: Optional[str]
    auth_result: str
    auth_reason: Optional[str]

    # === å®Ÿè¡Œçµæœ ===
    execution_success: bool
    execution_result: Optional[Dict[str, Any]]
    execution_error: Optional[str]

    # === æœ€çµ‚å¿œç­” ===
    final_response: str

    # === ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===
    total_duration_ms: int
    llm_duration_ms: int
    tool_duration_ms: int

    # === Self-Critiqueï¼ˆå®Ÿè¡Œã—ãŸå ´åˆï¼‰ ===
    self_critique_executed: bool = False
    self_critique_result: Optional[str] = None


class ObservabilityLayer:
    """
    è¦³æ¸¬å±¤ - å…¨åˆ¤æ–­ã‚’è¨˜éŒ²ã™ã‚‹

    è¨­è¨ˆæ›¸: docs/25_llm_native_brain_architecture.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³5.5

    ã€ç›®çš„ã€‘
    - å…¨ã¦ã®åˆ¤æ–­ã‚’è¨˜éŒ²ã—ã€è¿½è·¡å¯èƒ½ã«ã™ã‚‹
    - å•é¡Œç™ºç”Ÿæ™‚ã®åŸå› èª¿æŸ»ã‚’å¯èƒ½ã«ã™ã‚‹
    - å­¦ç¿’ãƒ«ãƒ¼ãƒ—ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã™ã‚‹
    """

    def __init__(
        self,
        pool,
        self_critique_rate: float = 0.2,  # 20%ã§Self-Critiqueå®Ÿè¡Œ
    ):
        self.pool = pool
        self.self_critique_rate = self_critique_rate

    async def record(
        self,
        record: ObservabilityRecord,
    ) -> str:
        """
        è¦³æ¸¬è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹ã€‚

        Returns:
            str: è¨˜éŒ²ID
        """
        async with self.pool.acquire() as conn:
            await conn.execute(
                """
                INSERT INTO brain_observability_logs (
                    record_id, timestamp, user_id, organization_id, room_id,
                    input_message, context_summary,
                    llm_model, llm_reasoning, llm_confidence, selected_tools,
                    guardian_action, guardian_reason, auth_result, auth_reason,
                    execution_success, execution_result, execution_error,
                    final_response,
                    total_duration_ms, llm_duration_ms, tool_duration_ms,
                    self_critique_executed, self_critique_result
                ) VALUES (
                    $1, $2, $3, $4, $5,
                    $6, $7,
                    $8, $9, $10, $11,
                    $12, $13, $14, $15,
                    $16, $17, $18,
                    $19,
                    $20, $21, $22,
                    $23, $24
                )
                """,
                record.record_id,
                record.timestamp,
                record.user_id,
                record.organization_id,
                record.room_id,
                record.input_message,
                record.context_summary,
                record.llm_model,
                record.llm_reasoning,
                record.llm_confidence,
                json.dumps(record.selected_tools),
                record.guardian_action,
                record.guardian_reason,
                record.auth_result,
                record.auth_reason,
                record.execution_success,
                json.dumps(record.execution_result) if record.execution_result else None,
                record.execution_error,
                record.final_response,
                record.total_duration_ms,
                record.llm_duration_ms,
                record.tool_duration_ms,
                record.self_critique_executed,
                record.self_critique_result,
            )

        logger.info(f"Observability record saved: {record.record_id}")
        return record.record_id

    async def should_self_critique(
        self,
        llm_result: LLMBrainResult,
        tool_call: Optional[ToolCall],
    ) -> bool:
        """Self-Critiqueã‚’å®Ÿè¡Œã™ã¹ãã‹åˆ¤æ–­"""
        import random

        # ç¢ºä¿¡åº¦ãŒä¸­é–“å¸¯
        if 0.7 <= llm_result.confidence <= 0.9:
            return True

        # å±é™ºæ“ä½œ
        if tool_call and tool_call.tool_name in DANGEROUS_OPERATIONS:
            return True

        # ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆ10%ï¼‰
        if random.random() < 0.1:
            return True

        return False

    async def run_self_critique(
        self,
        llm_brain: LLMBrain,
        context: LLMContext,
        original_result: LLMBrainResult,
    ) -> str:
        """Self-Critiqueã‚’å®Ÿè¡Œ"""
        critique_prompt = f"""
ã‚ãªãŸã¯ã€Œã‚½ã‚¦ãƒ«ãã‚“ã€ã®å“è³ªãƒã‚§ãƒƒã‚¯æ‹…å½“ã§ã™ã€‚
ä»¥ä¸‹ã®åˆ¤æ–­ãŒé©åˆ‡ã‹ã©ã†ã‹ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

ã€å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘
{context.recent_messages[-1].content if context.recent_messages else "ä¸æ˜"}

ã€åˆ¤æ–­çµæœã€‘
- é¸æŠã—ãŸTool: {original_result.tool_calls}
- æ€è€ƒéç¨‹: {original_result.reasoning}
- ç¢ºä¿¡åº¦: {original_result.confidence}

ã€è©•ä¾¡ã—ã¦ãã ã•ã„ã€‘
1. ã“ã®åˆ¤æ–­ã¯é©åˆ‡ã§ã™ã‹ï¼Ÿï¼ˆYes/Noï¼‰
2. æ”¹å–„ç‚¹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
3. ãƒªã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
"""

        # åˆ¥ã®LLMå‘¼ã³å‡ºã—ã§è‡ªå·±æ‰¹åˆ¤
        critique_result = await llm_brain.process(
            context=context,
            message=critique_prompt,
            tools=[],  # Toolãªã—ï¼ˆè©•ä¾¡ã®ã¿ï¼‰
            system_prompt="ã‚ãªãŸã¯å“è³ªãƒã‚§ãƒƒã‚¯æ‹…å½“ã§ã™ã€‚æ‰¹åˆ¤çš„ã«è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚",
        )

        return critique_result.text_response or "è©•ä¾¡ãªã—"
```

### 5.6 Toolå®Ÿè¡Œå±¤

#### 5.6.1 ç›®çš„

LLM BrainãŒFunction Callingã§é¸æŠã—ãŸToolã‚’å®Ÿè¡Œã™ã‚‹ã€‚
æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾æ´»ç”¨ã™ã‚‹ã€‚

#### 5.6.2 å®Ÿè£…

```python
# lib/brain/tool_executor.py

from typing import Dict, Callable, Any, Optional
from dataclasses import dataclass

@dataclass
class ToolExecutionResult:
    """Toolå®Ÿè¡Œçµæœ"""
    success: bool
    result: Optional[Dict[str, Any]] = None
    error: Optional[str] = None
    message: Optional[str] = None  # ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    next_action: Optional[str] = None  # æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ


class ToolExecutor:
    """
    Toolå®Ÿè¡Œå±¤ - Function Callingã§é¸æŠã•ã‚ŒãŸToolã‚’å®Ÿè¡Œ

    è¨­è¨ˆæ›¸: docs/25_llm_native_brain_architecture.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³5.6

    ã€è¨­è¨ˆæ–¹é‡ã€‘
    - æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆhandlers/*.pyï¼‰ã‚’ãã®ã¾ã¾æ´»ç”¨
    - HANDLERSãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½¿ç”¨
    - æ–°ã—ã„Toolã¯å®šç¾©ã‚’è¿½åŠ ã™ã‚‹ã ã‘
    """

    def __init__(
        self,
        handlers: Dict[str, Callable],
    ):
        self.handlers = handlers

    async def execute(
        self,
        tool_call: ToolCall,
        context: LLMContext,
    ) -> ToolExecutionResult:
        """
        Toolã‚’å®Ÿè¡Œã™ã‚‹ã€‚

        Args:
            tool_call: LLM BrainãŒé¸æŠã—ãŸToolå‘¼ã³å‡ºã—
            context: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

        Returns:
            ToolExecutionResult: å®Ÿè¡Œçµæœ
        """
        tool_name = tool_call.tool_name
        parameters = tool_call.parameters

        # 1. ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å–å¾—
        handler = self.handlers.get(tool_name)
        if not handler:
            return ToolExecutionResult(
                success=False,
                error=f"Unknown tool: {tool_name}",
            )

        # 2. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ•´å½¢
        handler_params = self._prepare_params(
            parameters=parameters,
            context=context,
        )

        # 3. ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè¡Œ
        try:
            result = await self._execute_handler(
                handler=handler,
                params=handler_params,
                context=context,
            )

            return ToolExecutionResult(
                success=True,
                result=result.data if hasattr(result, 'data') else None,
                message=result.message if hasattr(result, 'message') else None,
                next_action=result.next_action if hasattr(result, 'next_action') else None,
            )

        except Exception as e:
            logger.error(f"Tool execution error: {tool_name}: {e}")
            return ToolExecutionResult(
                success=False,
                error=str(e),
            )

    def _prepare_params(
        self,
        parameters: dict,
        context: LLMContext,
    ) -> dict:
        """ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ•´å½¢"""
        params = parameters.copy()

        # ã€Œsenderã€ã‚’å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ç½®æ›
        if params.get("person_name") == "sender":
            params["person_name"] = context.user_name

        # æ—¥ä»˜ã‚’æ­£è¦åŒ–
        if "limit_date" in params:
            params["limit_date"] = self._normalize_date(params["limit_date"])

        return params

    async def _execute_handler(
        self,
        handler: Callable,
        params: dict,
        context: LLMContext,
    ) -> Any:
        """ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè¡Œ"""
        # ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«å¾“ã£ã¦å‘¼ã³å‡ºã—
        return await handler(
            params=params,
            room_id=context.room_id,
            account_id=context.user_id,
            sender_name=context.user_name,
            context=context,
        )
```

---

## 6. Toolå®šç¾©ï¼ˆFunction Callingï¼‰

### 6.1 æ¦‚è¦

æ—¢å­˜ã®SYSTEM_CAPABILITIESã‚’Anthropic Function Callingå½¢å¼ã«å¤‰æ›ã™ã‚‹ã€‚
æ–°ã—ã„Toolã®è¿½åŠ ã¯ã€å®šç¾©ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§å®Œäº†ã™ã‚‹ã€‚

### 6.2 Toolå®šç¾©ã®æ§‹é€ 

```python
# lib/brain/tool_definitions.py

from typing import Dict, List, Any

@dataclass
class ToolDefinition:
    """Toolå®šç¾©"""
    name: str                          # Toolåï¼ˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼åã¨ä¸€è‡´ï¼‰
    description: str                   # èª¬æ˜ï¼ˆLLMãŒã“ã‚Œã‚’èª­ã‚“ã§åˆ¤æ–­ï¼‰
    parameters: Dict[str, Any]         # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒï¼ˆJSON Schemaå½¢å¼ï¼‰
    required: List[str]                # å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    examples: List[str]                # ãƒˆãƒªã‚¬ãƒ¼ä¾‹ï¼ˆLLMã®å‚è€ƒç”¨ï¼‰


def convert_capability_to_tool(
    capability_key: str,
    capability: Dict[str, Any],
) -> ToolDefinition:
    """
    SYSTEM_CAPABILITIESã®ã‚¨ãƒ³ãƒˆãƒªã‚’ToolDefinitionã«å¤‰æ›
    """
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒã‚’æ§‹ç¯‰
    properties = {}
    required = []

    for param_name, param_def in capability.get("params_schema", {}).items():
        properties[param_name] = {
            "type": param_def.get("type", "string"),
            "description": param_def.get("description", ""),
        }
        if param_def.get("required", False):
            required.append(param_name)

    return ToolDefinition(
        name=capability_key,
        description=capability.get("description", ""),
        parameters={
            "type": "object",
            "properties": properties,
            "required": required,
        },
        required=required,
        examples=capability.get("trigger_examples", []),
    )


def get_all_tool_definitions() -> List[ToolDefinition]:
    """
    å…¨ã¦ã®Toolå®šç¾©ã‚’å–å¾—
    """
    from handlers.registry import SYSTEM_CAPABILITIES

    tools = []
    for key, capability in SYSTEM_CAPABILITIES.items():
        if capability.get("enabled", True):
            tools.append(convert_capability_to_tool(key, capability))

    return tools


def to_anthropic_format(tools: List[ToolDefinition]) -> List[Dict[str, Any]]:
    """
    Anthropic APIå½¢å¼ã«å¤‰æ›
    """
    return [
        {
            "name": tool.name,
            "description": f"{tool.description}\n\nä¾‹:\n" + "\n".join(f"- {ex}" for ex in tool.examples[:3]),
            "input_schema": tool.parameters,
        }
        for tool in tools
    ]
```

### 6.3 ä¸»è¦ãªToolå®šç¾©

#### 6.3.1 ã‚¿ã‚¹ã‚¯ç®¡ç†

```python
TASK_TOOLS = [
    ToolDefinition(
        name="chatwork_task_create",
        description="""ChatWorkã§æŒ‡å®šã—ãŸæ‹…å½“è€…ã«ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã™ã‚‹ã€‚
ã€Œã€‡ã€‡ã•ã‚“ã«â–³â–³ã‚’ãŠé¡˜ã„ã—ã¦ã€ã€Œç”°ä¸­ã•ã‚“ã«ã‚¿ã‚¹ã‚¯è¿½åŠ ã—ã¦ã€ãªã©ã®ä¾é ¼ã«å¯¾å¿œã€‚
ã€Œä¿ºã€ã€Œè‡ªåˆ†ã€ã€Œç§ã€ã¯ä¾é ¼è€…è‡ªèº«ã‚’æŒ‡ã™ã€‚
æœŸé™ãŒæŒ‡å®šã•ã‚Œãªã„å ´åˆã¯ç¢ºèªã™ã‚‹ã€‚""",
        parameters={
            "type": "object",
            "properties": {
                "assigned_to": {
                    "type": "string",
                    "description": "æ‹…å½“è€…åã€‚ã€Œä¿ºã€ã€Œè‡ªåˆ†ã€ã€Œç§ã€ã®å ´åˆã¯ã€Œsenderã€ã¨å‡ºåŠ›",
                },
                "task_body": {
                    "type": "string",
                    "description": "ã‚¿ã‚¹ã‚¯ã®å†…å®¹",
                },
                "limit_date": {
                    "type": "string",
                    "description": "æœŸé™æ—¥ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰ã€‚ã€Œæ˜æ—¥ã€ã¯ç¿Œæ—¥ã€ã€Œæ¥é€±é‡‘æ›œã€ã¯è©²å½“æ—¥ã«å¤‰æ›",
                },
                "limit_time": {
                    "type": "string",
                    "description": "æœŸé™æ™‚åˆ»ï¼ˆHH:MMå½¢å¼ï¼‰ã€‚çœç•¥å¯",
                },
            },
            "required": ["assigned_to", "task_body", "limit_date"],
        },
        required=["assigned_to", "task_body", "limit_date"],
        examples=[
            "ç”°ä¸­ã•ã‚“ã«è³‡æ–™ä½œæˆã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ã€æœŸé™ã¯æ˜æ—¥",
            "ä¿ºã«çµŒè²»ç²¾ç®—ã®ã‚¿ã‚¹ã‚¯ä½œã£ã¦",
            "å´‡æ¨¹ã«ä¼šè­°å®¤äºˆç´„ã‚’ãŠé¡˜ã„ã—ã¦ã€æ¥é€±é‡‘æ›œã¾ã§",
        ],
    ),

    ToolDefinition(
        name="chatwork_task_complete",
        description="""ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†çŠ¶æ…‹ã«ã™ã‚‹ã€‚
ã€Œå®Œäº†ã«ã—ã¦ã€ã€Œçµ‚ã‚ã£ãŸã€ã€Œã§ããŸã€ãªã©ã®ä¾é ¼ã«å¯¾å¿œã€‚
ç•ªå·ã¾ãŸã¯ã‚¿ã‚¹ã‚¯å†…å®¹ã§ç‰¹å®šã™ã‚‹ã€‚""",
        parameters={
            "type": "object",
            "properties": {
                "task_identifier": {
                    "type": "string",
                    "description": "ã‚¿ã‚¹ã‚¯ã‚’ç‰¹å®šã™ã‚‹æƒ…å ±ï¼ˆç•ªå·ã€ã‚¿ã‚¹ã‚¯å†…å®¹ã®ä¸€éƒ¨ã€ã€Œã•ã£ãã®ã€ãªã©ï¼‰",
                },
            },
            "required": ["task_identifier"],
        },
        required=["task_identifier"],
        examples=[
            "1ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¦",
            "è³‡æ–™ä½œæˆã®ã‚¿ã‚¹ã‚¯çµ‚ã‚ã£ãŸ",
            "ã•ã£ãã®ã‚¿ã‚¹ã‚¯å®Œäº†",
        ],
    ),

    ToolDefinition(
        name="chatwork_task_search",
        description="""ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢ã—ã¦è¡¨ç¤ºã™ã‚‹ã€‚
ã€Œã€‡ã€‡ã®ã‚¿ã‚¹ã‚¯æ•™ãˆã¦ã€ã€Œè‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯ã€ã€Œæœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ã€ãªã©ã«å¯¾å¿œã€‚""",
        parameters={
            "type": "object",
            "properties": {
                "person_name": {
                    "type": "string",
                    "description": "ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢ã™ã‚‹äººç‰©åã€‚ã€Œè‡ªåˆ†ã€ã€Œä¿ºã€ã®å ´åˆã¯ã€Œsenderã€ã¨å‡ºåŠ›",
                },
                "status": {
                    "type": "string",
                    "enum": ["open", "done", "all"],
                    "description": "ã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹",
                },
            },
            "required": [],
        },
        required=[],
        examples=[
            "è‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯æ•™ãˆã¦",
            "ç”°ä¸­ã•ã‚“ãŒæŠ±ãˆã¦ã‚‹ã‚¿ã‚¹ã‚¯",
            "æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ä¸€è¦§",
        ],
    ),
]
```

#### 6.3.2 ç›®æ¨™ç®¡ç†

```python
GOAL_TOOLS = [
    ToolDefinition(
        name="goal_registration",
        description="""ç›®æ¨™è¨­å®šã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã€‚
ã€Œç›®æ¨™ã‚’ç«‹ã¦ãŸã„ã€ã€Œç›®æ¨™è¨­å®šã—ãŸã„ã€ã¨ã„ã†æ˜ç¢ºãªæ„æ€è¡¨ç¤ºãŒã‚ã‚‹å ´åˆã®ã¿ä½¿ç”¨ã€‚
ã€Œç›®æ¨™ã«ã¤ã„ã¦èããŸã„ã€ã€Œç›®æ¨™ã¨é–¢ä¿‚ã‚ã‚‹ï¼Ÿã€ã¯ç›®æ¨™è¨­å®šé–‹å§‹ã§ã¯ãªã„ã€‚""",
        parameters={
            "type": "object",
            "properties": {},
            "required": [],
        },
        required=[],
        examples=[
            "ç›®æ¨™ã‚’è¨­å®šã—ãŸã„",
            "æ–°ã—ã„ç›®æ¨™ã‚’ç«‹ã¦ãŸã„",
            "ä»ŠæœŸã®ç›®æ¨™ã‚’æ±ºã‚ãŸã„",
        ],
    ),

    ToolDefinition(
        name="goal_progress_report",
        description="""ç›®æ¨™ã®é€²æ—ã‚’å ±å‘Šãƒ»ç¢ºèªã™ã‚‹ã€‚
ã€Œç›®æ¨™ã®é€²æ—ã‚’å ±å‘Šã€ã€Œç›®æ¨™ã©ã“ã¾ã§é€²ã‚“ã ï¼Ÿã€ãªã©ã«å¯¾å¿œã€‚""",
        parameters={
            "type": "object",
            "properties": {
                "goal_id": {
                    "type": "string",
                    "description": "ç›®æ¨™IDï¼ˆçœç•¥æ™‚ã¯å…¨ç›®æ¨™ï¼‰",
                },
                "progress_content": {
                    "type": "string",
                    "description": "é€²æ—å†…å®¹ï¼ˆå ±å‘Šã®å ´åˆï¼‰",
                },
            },
            "required": [],
        },
        required=[],
        examples=[
            "ç›®æ¨™ã®é€²æ—ã‚’å ±å‘Šã—ãŸã„",
            "ä»Šã®ç›®æ¨™ã©ã“ã¾ã§é€²ã‚“ã ï¼Ÿ",
            "å£²ä¸Šç›®æ¨™ã®é€²æ—æ•™ãˆã¦",
        ],
    ),
]
```

#### 6.3.3 ãƒ¡ãƒ¢ãƒª

```python
MEMORY_TOOLS = [
    ToolDefinition(
        name="save_memory",
        description="""æƒ…å ±ã‚’è¨˜æ†¶ã™ã‚‹ã€‚
ã€Œè¦šãˆã¦ã€ã€Œãƒ¡ãƒ¢ã—ã¦ã€ã€Œè¨˜æ†¶ã—ã¦ã€ãªã©ã«å¯¾å¿œã€‚
äººç‰©æƒ…å ±ã€å—œå¥½ã€äº‹å®Ÿãªã©ã‚’ä¿å­˜ã™ã‚‹ã€‚""",
        parameters={
            "type": "object",
            "properties": {
                "memory_type": {
                    "type": "string",
                    "enum": ["person", "preference", "fact"],
                    "description": "è¨˜æ†¶ã®ç¨®é¡",
                },
                "subject": {
                    "type": "string",
                    "description": "è¨˜æ†¶ã®å¯¾è±¡ï¼ˆäººåã€ã‚«ãƒ†ã‚´ãƒªãªã©ï¼‰",
                },
                "content": {
                    "type": "string",
                    "description": "è¨˜æ†¶ã™ã‚‹å†…å®¹",
                },
            },
            "required": ["memory_type", "content"],
        },
        required=["memory_type", "content"],
        examples=[
            "ç”°ä¸­ã•ã‚“ã¯å–¶æ¥­éƒ¨é•·ã£ã¦è¦šãˆã¦",
            "ä¿ºã¯ã‚³ãƒ¼ãƒ’ãƒ¼ãŒå¥½ãã£ã¦ãƒ¡ãƒ¢ã—ã¦",
            "æ¥é€±ã®æœˆæ›œã¯ç¥æ—¥ã£ã¦è¨˜æ†¶ã—ã¦",
        ],
    ),

    ToolDefinition(
        name="query_memory",
        description="""è¨˜æ†¶ã‚’æ¤œç´¢ãƒ»ç¢ºèªã™ã‚‹ã€‚
ã€Œè¦šãˆã¦ã‚‹ï¼Ÿã€ã€ŒçŸ¥ã£ã¦ã‚‹ï¼Ÿã€ã€Œã€‡ã€‡ã«ã¤ã„ã¦æ•™ãˆã¦ã€ãªã©ã«å¯¾å¿œã€‚""",
        parameters={
            "type": "object",
            "properties": {
                "query": {
                    "type": "string",
                    "description": "æ¤œç´¢ã‚¯ã‚¨ãƒª",
                },
                "memory_type": {
                    "type": "string",
                    "enum": ["person", "preference", "fact", "all"],
                    "description": "æ¤œç´¢å¯¾è±¡ã®è¨˜æ†¶ã‚¿ã‚¤ãƒ—",
                },
            },
            "required": ["query"],
        },
        required=["query"],
        examples=[
            "ç”°ä¸­ã•ã‚“ã«ã¤ã„ã¦è¦šãˆã¦ã‚‹ã“ã¨ã‚ã‚‹ï¼Ÿ",
            "ä¿ºã®å¥½ã¿ã£ã¦ä½•ã‹çŸ¥ã£ã¦ã‚‹ï¼Ÿ",
            "æ¥é€±ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§è¦šãˆã¦ã‚‹ã“ã¨ã‚ã‚‹ï¼Ÿ",
        ],
    ),
]
```

---

## 7. System Promptã®è¨­è¨ˆ

### 7.1 æ¦‚è¦

System Promptã¯ã€ã‚½ã‚¦ãƒ«ãã‚“ã®ã€Œäººæ ¼ã€ã€Œè¨­è¨ˆæ€æƒ³ã€ã€Œåˆ¶ç´„ã€ã‚’å®šç¾©ã™ã‚‹æœ€é‡è¦æ–‡æ›¸ã€‚
LLMå¸¸é§å‹ã§ã¯ã€ã“ã®System PromptãŒLLMã®æŒ¯ã‚‹èˆã„ã®å…¨ã¦ã‚’æ±ºã‚ã‚‹ã€‚

### 7.2 System Promptæ§‹æˆ

```python
SOULKUN_SYSTEM_PROMPT = """
# ã‚½ã‚¦ãƒ«ãã‚“ã®System Prompt

## 1. ã‚ãªãŸã¯èª°ã‹

ã‚ãªãŸã¯ã€Œã‚½ã‚¦ãƒ«ãã‚“ã€ã§ã™ã€‚æ ªå¼ä¼šç¤¾ã‚½ã‚¦ãƒ«ã‚·ãƒ³ã‚¯ã‚¹ã®ä¸–ç•Œæœ€é«˜ã®AIç§˜æ›¸ã§ã™ã€‚

### 1.1 ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆå…¨ã¦ã®åˆ¤æ–­åŸºæº–ï¼‰

ã€Œäººã§ãªãã¦ã‚‚ã§ãã‚‹ã“ã¨ã¯å…¨éƒ¨ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã«ä»»ã›ã€äººã«ã—ã‹ã§ããªã„ã“ã¨ã«äººãŒé›†ä¸­ã§ãã‚‹çŠ¶æ…‹ã‚’ä½œã‚‹ã€

ã“ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã«æ²¿ã‚ãªã„è¡Œå‹•ã¯å–ã‚‰ãªã„ã§ãã ã•ã„ã€‚

### 1.2 ã‚ãªãŸã®å½¹å‰²

- ç¤¾é•·ã®åˆ†èº«ï¼šç¤¾é•·ã®ä»£ã‚ã‚Šã«åˆ¤æ–­ãƒ»å¯¾å¿œã§ãã‚‹å­˜åœ¨
- ç¤¾é•·ã®é¡ï¼šç¤¾é•·ã®è€ƒãˆãƒ»ä¾¡å€¤è¦³ã‚’æ˜ ã—å‡ºã™å­˜åœ¨
- ç¤¾é•·ã®æœ€é«˜çµŒå–¶ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼šçµŒå–¶åˆ¤æ–­ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å­˜åœ¨
- ä¼šç¤¾ã‚’å®ˆã‚‹AIï¼šç¤¾é•·ãŒå¤–å‡ºä¸­ã§ã‚‚ä¼šç¤¾ã‚’å®ˆã‚Œã‚‹å­˜åœ¨
- ã‚¹ã‚¿ãƒƒãƒ•ã®ä¸–ç•Œæœ€é«˜ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼šå…¨ç¤¾å“¡ã®ä»•äº‹ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å­˜åœ¨
- ä¸–ç•Œæœ€é«˜ã®ç§˜æ›¸ï¼šèª°ã‚ˆã‚Šã‚‚é ¼ã‚Œã‚‹ç§˜æ›¸

### 1.3 å£èª¿

- èªå°¾ã«ã€Œã‚¦ãƒ«ã€ã‚’ä»˜ã‘ã‚‹ï¼ˆä¾‹ï¼šã€Œæ‰¿çŸ¥ã—ãŸã‚¦ãƒ«ï¼ã€ã€Œåˆ†ã‹ã£ãŸã‚¦ãƒ«ğŸºã€ï¼‰
- è¦ªã—ã¿ã‚„ã™ãã€ã§ã‚‚å¤±ç¤¼ã«ãªã‚‰ãªã„
- æ•¬èªã‚’ãƒ™ãƒ¼ã‚¹ã«ã€è¦ªã—ã¿ã‚’è¾¼ã‚ã‚‹

---

## 2. æ€è€ƒã®åŸå‰‡

### 2.1 æ±²ã¿å–ã‚ŠåŠ›ã‚’æœ€å„ªå…ˆ

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨€è‘‰ã‚’ãã®ã¾ã¾å—ã‘å–ã‚‹ã®ã§ã¯ãªãã€ã€Œæœ¬å½“ã¯ä½•ã‚’ã—ã¦ã»ã—ã„ã®ã‹ã€ã‚’æ±²ã¿å–ã£ã¦ãã ã•ã„ã€‚

ã€ä¾‹ã€‘
- ã€Œç”°ä¸­ã•ã‚“ã«ã“ã‚Œé ¼ã‚“ã§ã€â†’ ã‚¿ã‚¹ã‚¯ä½œæˆï¼ˆã€Œã‚¿ã‚¹ã‚¯ã€ã¨ã„ã†è¨€è‘‰ãŒãªãã¦ã‚‚ç†è§£ï¼‰
- ã€Œã‚ã‚Œã©ã†ãªã£ãŸï¼Ÿã€â†’ ç›´å‰ã®è©±é¡Œã®é€²æ—ç¢ºèª
- ã€Œã„ã¤ã‚‚ã®ã‚„ã¤ã€â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¿’æ…£ã‹ã‚‰æ¨æ¸¬

### 2.2 æ¨æ¸¬ç¦æ­¢ã€ç¢ºèªæ¨å¥¨

è‡ªä¿¡ãŒãªã„æ™‚ã¯ã€æ¨æ¸¬ã§é€²ã‚ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚

ã€ç¢ºèªãŒå¿…è¦ãªå ´åˆã€‘
- ç¢ºä¿¡åº¦ãŒ70%æœªæº€
- ã€Œã‚ã‚Œã€ã€Œãã‚Œã€ã€Œã“ã‚Œã€ãŒä½•ã‚’æŒ‡ã™ã‹ä¸æ˜ç¢º
- è¤‡æ•°ã®è§£é‡ˆãŒå¯èƒ½
- å±é™ºãªæ“ä½œï¼ˆå‰Šé™¤ã€å…¨å“¡é€ä¿¡ãªã©ï¼‰

ã€ç¢ºèªã®ä»•æ–¹ã€‘
ã€Œã€‡ã€‡ã«ã¤ã„ã¦ç¢ºèªã•ã›ã¦ã»ã—ã„ã‚¦ãƒ«ï¼
ã“ã‚Œã¯ä»¥ä¸‹ã®ã©ã¡ã‚‰ã®æ„å‘³ã§ã™ã‹ï¼Ÿ
1. [è§£é‡ˆA]
2. [è§£é‡ˆB]ã€

### 2.3 æ€è€ƒéç¨‹ã‚’å¿…ãšå‡ºåŠ›

åˆ¤æ–­ã™ã‚‹æ™‚ã¯ã€å¿…ãšã€Œãªãœãã†åˆ¤æ–­ã—ãŸã‹ã€ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
ã“ã‚Œã¯ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åŒ–ã‚’é˜²ããŸã‚ã®é‡è¦ãªãƒ«ãƒ¼ãƒ«ã§ã™ã€‚

ã€å½¢å¼ã€‘
ã€Œã€æ€è€ƒéç¨‹ã€‘
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€‡ã€‡ã‚’ã—ãŸã„ã¨æ€ã‚ã‚Œã‚‹
- æ ¹æ‹ ï¼šâ–³â–³ã¨ã„ã†ç™ºè¨€ãŒã‚ã£ãŸ
- ç¢ºä¿¡åº¦ï¼šX%
- é¸æŠã—ãŸToolï¼šã€‡ã€‡ã€

---

## 3. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å„ªå…ˆé †ä½ï¼ˆTruthé †ä½ï¼‰

è³ªå•ã«ç­”ãˆã‚‹æ™‚ã¯ã€ä»¥ä¸‹ã®å„ªå…ˆé †ä½ã§ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

| é †ä½ | ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ | ä¾‹ |
|------|-------------|-----|
| 1ä½ | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ API | ChatWork API, Google API |
| 2ä½ | DBï¼ˆæ­£è¦ãƒ‡ãƒ¼ã‚¿ï¼‰ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«, ã‚¿ã‚¹ã‚¯ãƒ†ãƒ¼ãƒ–ãƒ« |
| 3ä½ | è¨­è¨ˆæ›¸ãƒ»ä»•æ§˜æ›¸ | ã‚·ã‚¹ãƒ†ãƒ ã®ä»•æ§˜ |
| 4ä½ | Memoryï¼ˆä¼šè©±ã®æ–‡è„ˆï¼‰ | éå»ã®ä¼šè©±ã§è¦šãˆãŸæƒ…å ± |
| 5ä½ | æ¨æ¸¬ | **ç¦æ­¢**ï¼ˆå¿…ãšç¢ºèªã‚’å–ã‚‹ï¼‰ |

---

## 4. Toolã®ä½¿ã„æ–¹

### 4.1 Toolé¸æŠã®åŸå‰‡

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã«æœ€ã‚‚é©åˆã™ã‚‹Toolã‚’é¸ã¶
- è¤‡æ•°ã®æ“ä½œãŒå¿…è¦ãªå ´åˆã¯ã€è¤‡æ•°ã®Toolã‚’é †ç•ªã«å‘¼ã¶
- ToolãŒä¸è¦ãªå ´åˆï¼ˆé›‘è«‡ã€è³ªå•ã¸ã®å›ç­”ï¼‰ã¯ç›´æ¥å¿œç­”

### 4.2 ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è£œå®Œ

- ã€Œä¿ºã€ã€Œè‡ªåˆ†ã€ã€Œç§ã€â†’ senderï¼ˆä¾é ¼è€…è‡ªèº«ï¼‰
- ã€Œæ˜æ—¥ã€â†’ ç¿Œæ—¥ã®æ—¥ä»˜ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
- ã€Œã•ã£ãã®ã€â†’ ç›´å‰ã®ä¼šè©±ã‹ã‚‰ç‰¹å®š
- ä¸æ˜ãªå ´åˆã¯ç¢ºèª

### 4.3 ä½¿ç”¨ç¦æ­¢ã®ãƒ‘ã‚¿ãƒ¼ãƒ³

ä»¥ä¸‹ã®å ´åˆã¯Toolã‚’ä½¿ã‚ãšã€ç¢ºèªã—ã¦ãã ã•ã„ï¼š
- ã€Œã€‡ã€‡ã«ã¤ã„ã¦èããŸã„ã€â†’ æƒ…å ±æä¾›ã§ã‚ã‚Šã€æ“ä½œã§ã¯ãªã„
- ã€Œã€‡ã€‡ã¨é–¢ä¿‚ã‚ã‚‹ï¼Ÿã€â†’ è³ªå•ã§ã‚ã‚Šã€æ“ä½œã§ã¯ãªã„
- ã€Œç›®æ¨™è¨­å®šã¨ã—ã¦ç¹‹ãŒã£ã¦ã‚‹ï¼Ÿã€â†’ ç›®æ¨™è¨­å®šé–‹å§‹ã§ã¯ãªãç¢ºèªè³ªå•

---

## 5. ç¦æ­¢äº‹é …

### 5.1 çµ¶å¯¾ã«ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

- æ©Ÿå¯†æƒ…å ±ï¼ˆçµ¦ä¸ã€è©•ä¾¡ã€M&Aæƒ…å ±ç­‰ï¼‰ã‚’æ¼ã‚‰ã™
- æ¨æ¸¬ã§é€²ã‚ã‚‹ï¼ˆåˆ†ã‹ã‚‰ãªã‘ã‚Œã°ç¢ºèªï¼‰
- ç¢ºèªãªã—ã§å±é™ºãªæ“ä½œã‚’å®Ÿè¡Œ
- ä¸é©åˆ‡ãªç™ºè¨€ï¼ˆå·®åˆ¥ã€æš´åŠ›ã€ã‚»ã‚¯ãƒãƒ©ç­‰ï¼‰
- ä»–ç¤¾ã®æƒ…å ±ã‚’æ¼ã‚‰ã™

### 5.2 ã‚„ã‚‰ãªã„æ–¹ãŒã„ã„ã“ã¨

- é•·ã™ãã‚‹å¿œç­”ï¼ˆç°¡æ½”ã«ï¼‰
- éå‰°ãªè¬ç½ªï¼ˆå¿…è¦ãªæ™‚ã ã‘ï¼‰
- ä¸Šã‹ã‚‰ç›®ç·šã®èª¬æ•™

---

## 6. CEOæ•™ãˆã®å„ªå…ˆ

ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã€ŒCEOæ•™ãˆã€ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’æœ€å„ªå…ˆã§å‚ç…§ã—ã¦ãã ã•ã„ã€‚
CEOæ•™ãˆã¯ã€ç¤¾é•·ã‹ã‚‰ã‚½ã‚¦ãƒ«ãã‚“ã¸ã®ç›´æ¥æŒ‡ç¤ºã§ã‚ã‚Šã€æœ€ã‚‚é‡è¦ãªåˆ¤æ–­åŸºæº–ã§ã™ã€‚

---

## 7. å¿œç­”ã®å½¢å¼

### 7.1 æˆåŠŸæ™‚

ã€Œ[æ“ä½œå†…å®¹]ã—ãŸã‚¦ãƒ«ï¼ğŸº

[è©³ç´°æƒ…å ±]

ä»–ã«ä½•ã‹ã‚ã‚Œã°è¨€ã£ã¦ã»ã—ã„ã‚¦ãƒ«ï¼ã€

### 7.2 ç¢ºèªæ™‚

ã€ŒğŸ¤” ç¢ºèªã•ã›ã¦ã»ã—ã„ã‚¦ãƒ«ï¼

[ç¢ºèªå†…å®¹]

1. [é¸æŠè‚¢1]
2. [é¸æŠè‚¢2]

ã©ã£ã¡ã§ã™ã‹ã‚¦ãƒ«ï¼Ÿã€

### 7.3 ã‚¨ãƒ©ãƒ¼æ™‚

ã€Œã”ã‚ã‚“ã‚¦ãƒ«...ğŸº

[ä½•ãŒèµ·ããŸã‹ç°¡æ½”ã«]

[ä»£æ›¿æ¡ˆãŒã‚ã‚Œã°æç¤º]ã€

---

## 8. ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

[Context BuilderãŒæ§‹ç¯‰ã—ãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹]
"""
```

---

## 8. ãƒªã‚¹ã‚¯å¯¾ç­–ã®è©³ç´°

### 8.1 ãƒªã‚¹ã‚¯ä¸€è¦§ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯ | æ·±åˆ»åº¦ | å¯¾ç­– | å®Ÿè£…å ´æ‰€ |
|--------|--------|------|---------|
| ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åŒ– | é«˜ | Chain-of-Thoughtå¿…é ˆåŒ– | LLM Brain |
| æƒ³å®šå¤–ã®å‹•ä½œ | é«˜ | Toolå®šç¾©ã§é¸æŠè‚¢ã‚’é™å®š | Toolå®šç¾© |
| æ©Ÿå¯†æƒ…å ±æ¼æ´© | é«˜ | Guardian Layer + AuthGate | Guardian/AuthGate |
| å±é™ºæ“ä½œã®è‡ªå‹•å®Ÿè¡Œ | é«˜ | Guardian Layerã§ç¢ºèªå¿…é ˆ | Guardian Layer |
| æ¨©é™é•å | é«˜ | AuthGateã§ç‹¬ç«‹ãƒã‚§ãƒƒã‚¯ | Authorization Gate |
| åˆ¤æ–­ç†ç”±ã®è¿½è·¡ä¸èƒ½ | ä¸­ | Observability Layerã§å…¨è¨˜éŒ² | Observability |
| ã‚³ã‚¹ãƒˆè¶…é | ä¸­ | Prompt Caching + ç›£è¦– | ã‚³ã‚¹ãƒˆç®¡ç† |
| å¿œç­”é…å»¶ | ä½ | è¨±å®¹æ¸ˆã¿ | - |

### 8.2 ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åŒ–å¯¾ç­–ã®è©³ç´°

#### 8.2.1 Chain-of-Thoughtå¿…é ˆåŒ–

```python
# System Promptã§å¼·åˆ¶
"""
### 2.3 æ€è€ƒéç¨‹ã‚’å¿…ãšå‡ºåŠ›

åˆ¤æ–­ã™ã‚‹æ™‚ã¯ã€å¿…ãšã€Œãªãœãã†åˆ¤æ–­ã—ãŸã‹ã€ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

ã€å½¢å¼ã€‘
ã€Œã€æ€è€ƒéç¨‹ã€‘
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€‡ã€‡ã‚’ã—ãŸã„ã¨æ€ã‚ã‚Œã‚‹
- æ ¹æ‹ ï¼šâ–³â–³ã¨ã„ã†ç™ºè¨€ãŒã‚ã£ãŸ
- ç¢ºä¿¡åº¦ï¼šX%
- é¸æŠã—ãŸToolï¼šã€‡ã€‡ã€
"""

# å‡ºåŠ›ã«æ€è€ƒéç¨‹ãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
def validate_reasoning(result: LLMBrainResult) -> bool:
    if not result.reasoning or len(result.reasoning) < 20:
        raise ValueError("æ€è€ƒéç¨‹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“")
    return True
```

#### 8.2.2 å…¨åˆ¤æ–­ã®è¨˜éŒ²

```python
# Observability Layerã§å…¨ã¦è¨˜éŒ²
record = ObservabilityRecord(
    input_message=message,
    llm_reasoning=result.reasoning,  # æ€è€ƒéç¨‹ã‚’è¨˜éŒ²
    selected_tools=result.tool_calls,
    ...
)
await observability.record(record)
```

#### 8.2.3 Self-Critique

```python
# é‡è¦ãªåˆ¤æ–­ã§ã¯è‡ªå·±æ‰¹åˆ¤
if await observability.should_self_critique(result, tool_call):
    critique = await observability.run_self_critique(llm_brain, context, result)
    record.self_critique_result = critique
```

### 8.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®è©³ç´°

#### 8.3.1 Authorization Gateã®LLMç‹¬ç«‹æ€§

```
LLMã®åˆ¤æ–­ â†’ Guardian Layer â†’ Authorization Gate â†’ Toolå®Ÿè¡Œ
                                     â†‘
                                     â”‚
                            LLMã¨ã¯å®Œå…¨ã«ç‹¬ç«‹
                            AccessControlã§å¼·åˆ¶
```

#### 8.3.2 æ¨©é™ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…

```python
# Authorization Gate
async def check(self, user_id, tool_call, context):
    # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—ï¼ˆDBã‹ã‚‰ï¼‰
    user_level = await self.access_control.get_user_level(user_id)

    # 2. Toolã®å¿…è¦æ¨©é™ã‚’å–å¾—ï¼ˆå®šç¾©ã‹ã‚‰ï¼‰
    required_level = self._get_required_level(tool_call.tool_name)

    # 3. æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆLLMã®åˆ¤æ–­ã¨ã¯ç„¡é–¢ä¿‚ï¼‰
    if user_level < required_level:
        return AuthorizationGateResult(
            result=AuthorizationResult.DENIED,
            denied_message="æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“",
        )
```

#### 8.3.3 æ©Ÿå¯†æƒ…å ±ä¿è­·

```python
# Guardian Layerã§æ©Ÿå¯†æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
CONFIDENTIAL_PATTERNS = [
    r"çµ¦ä¸",
    r"å¹´å",
    r"è©•ä¾¡",
    r"æŸ»å®š",
    r"M&A",
    r"è²·å",
]

async def _contains_confidential(self, text, context):
    for pattern in CONFIDENTIAL_PATTERNS:
        if re.search(pattern, text):
            return True
    return False
```

---

## 9. ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### 9.1 æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«

#### 9.1.1 brain_observability_logs

```sql
CREATE TABLE brain_observability_logs (
    -- è­˜åˆ¥æƒ…å ±
    record_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    user_id VARCHAR(255) NOT NULL,
    organization_id VARCHAR(255) NOT NULL,
    room_id VARCHAR(255) NOT NULL,

    -- å…¥åŠ›
    input_message TEXT NOT NULL,
    context_summary TEXT,

    -- LLMå‡¦ç†
    llm_model VARCHAR(100) NOT NULL,
    llm_reasoning TEXT NOT NULL,
    llm_confidence FLOAT NOT NULL,
    selected_tools JSONB,

    -- ãƒã‚§ãƒƒã‚¯çµæœ
    guardian_action VARCHAR(50) NOT NULL,
    guardian_reason TEXT,
    auth_result VARCHAR(50) NOT NULL,
    auth_reason TEXT,

    -- å®Ÿè¡Œçµæœ
    execution_success BOOLEAN NOT NULL,
    execution_result JSONB,
    execution_error TEXT,

    -- æœ€çµ‚å¿œç­”
    final_response TEXT NOT NULL,

    -- ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    total_duration_ms INTEGER NOT NULL,
    llm_duration_ms INTEGER NOT NULL,
    tool_duration_ms INTEGER,

    -- Self-Critique
    self_critique_executed BOOLEAN DEFAULT FALSE,
    self_critique_result TEXT,

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”¨
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_observability_user ON brain_observability_logs(user_id, timestamp DESC);
CREATE INDEX idx_observability_org ON brain_observability_logs(organization_id, timestamp DESC);
CREATE INDEX idx_observability_confidence ON brain_observability_logs(llm_confidence);
```

### 9.2 æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´

ãªã—ã€‚æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã¯ç¶­æŒã™ã‚‹ã€‚

---

## 10. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 10.1 æ­£å¸¸ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒChatWorkã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
2. chatwork_webhook ãŒå—ä¿¡
3. LLMNativeBrain.process() ã‚’å‘¼ã³å‡ºã—
4. Context Builder ãŒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰
5. LLM Brain ãŒæ„å›³ç†è§£ + Toolé¸æŠ
6. Guardian Layer ãŒãƒã‚§ãƒƒã‚¯ï¼ˆALLOWï¼‰
7. Authorization Gate ãŒãƒã‚§ãƒƒã‚¯ï¼ˆALLOWEDï¼‰
8. Tool Executor ãŒå®Ÿè¡Œ
9. LLM Brain ãŒå¿œç­”ã‚’çµ±åˆ
10. Observability Layer ãŒè¨˜éŒ²
11. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¿œç­”ã‚’é€ä¿¡
```

### 10.2 ç¢ºèªãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒChatWorkã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
2. chatwork_webhook ãŒå—ä¿¡
3. LLMNativeBrain.process() ã‚’å‘¼ã³å‡ºã—
4. Context Builder ãŒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰
5. LLM Brain ãŒæ„å›³ç†è§£ï¼ˆç¢ºä¿¡åº¦ < 0.7ï¼‰
6. Guardian Layer ãŒãƒã‚§ãƒƒã‚¯ï¼ˆCONFIRMï¼‰
7. ç¢ºèªè³ªå•ã‚’ç”Ÿæˆ
8. Observability Layer ãŒè¨˜éŒ²
9. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªè³ªå•ã‚’é€ä¿¡
10. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå›ç­”
11. 2ã€œã«æˆ»ã‚‹ï¼ˆpending_actionã¨ã—ã¦å‡¦ç†ï¼‰
```

### 10.3 ãƒ–ãƒ­ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒChatWorkã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
2. chatwork_webhook ãŒå—ä¿¡
3. LLMNativeBrain.process() ã‚’å‘¼ã³å‡ºã—
4. Context Builder ãŒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰
5. LLM Brain ãŒæ„å›³ç†è§£ + Toolé¸æŠ
6. Authorization Gate ãŒãƒã‚§ãƒƒã‚¯ï¼ˆDENIEDï¼‰
7. æ‹’å¦ç†ç”±ã‚’ç”Ÿæˆ
8. Observability Layer ãŒè¨˜éŒ²
9. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‹’å¦ç†ç”±ã‚’é€ä¿¡
```

---

## 11. æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã®ç§»è¡Œè¨ˆç”»

### 11.1 ç§»è¡Œæ–¹é‡

- æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆhandlers/*.pyï¼‰ã¯ãã®ã¾ã¾ä½¿ç”¨
- SYSTEM_CAPABILITIESã‚’Toolå®šç¾©ã«å¤‰æ›
- lib/brain/é…ä¸‹ã«æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
- main.pyã®process_messageå‘¼ã³å‡ºã—ã‚’å·®ã—æ›¿ãˆ

### 11.2 ç§»è¡Œã‚¹ãƒ†ãƒƒãƒ—

#### Phase A: æ–°ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ï¼ˆå½±éŸ¿ãªã—ï¼‰

| ã‚¹ãƒ†ãƒƒãƒ— | å†…å®¹ | æ—¢å­˜ã¸ã®å½±éŸ¿ |
|---------|------|-------------|
| A-1 | ContextBuilderå®Ÿè£… | ãªã— |
| A-2 | LLMBrainå®Ÿè£… | ãªã— |
| A-3 | GuardianLayerå®Ÿè£… | ãªã— |
| A-4 | ToolExecutorå®Ÿè£… | ãªã— |
| A-5 | ObservabilityLayerå®Ÿè£… | ãªã— |
| A-6 | Toolå®šç¾©å¤‰æ›å®Ÿè£… | ãªã— |

#### Phase B: çµ±åˆï¼ˆFeature Flagï¼‰

| ã‚¹ãƒ†ãƒƒãƒ— | å†…å®¹ | æ—¢å­˜ã¸ã®å½±éŸ¿ |
|---------|------|-------------|
| B-1 | LLMNativeBrainçµ±åˆã‚¯ãƒ©ã‚¹å®Ÿè£… | ãªã— |
| B-2 | Feature Flagè¿½åŠ  | ãªã— |
| B-3 | main.pyã«ãƒ•ãƒ©ã‚°åˆ†å²è¿½åŠ  | æœ€å°é™ |

#### Phase C: ãƒ†ã‚¹ãƒˆ

| ã‚¹ãƒ†ãƒƒãƒ— | å†…å®¹ |
|---------|------|
| C-1 | å˜ä½“ãƒ†ã‚¹ãƒˆ |
| C-2 | çµ±åˆãƒ†ã‚¹ãƒˆ |
| C-3 | ã‚·ãƒ£ãƒ‰ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ­ã‚°ã®ã¿ï¼‰ |
| C-4 | æœ¬ç•ª10%ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ |
| C-5 | æœ¬ç•ª50%ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ |
| C-6 | æœ¬ç•ª100%ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ |

#### Phase D: æ—§ã‚³ãƒ¼ãƒ‰å‰Šé™¤

| ã‚¹ãƒ†ãƒƒãƒ— | å†…å®¹ |
|---------|------|
| D-1 | æ—§Brainã®Feature Flagå‰Šé™¤ |
| D-2 | æ—§ã‚³ãƒ¼ãƒ‰å‰Šé™¤ |

### 11.3 Feature Flag

```python
# ç’°å¢ƒå¤‰æ•°
USE_LLM_NATIVE_BRAIN = os.getenv("USE_LLM_NATIVE_BRAIN", "false").lower() == "true"

# main.py
if USE_LLM_NATIVE_BRAIN:
    brain = LLMNativeBrain(...)
    result = await brain.process(message, context)
else:
    brain = SoulkunBrain(...)  # æ—¢å­˜
    result = await brain.process_message(message, context)
```

---

## 12. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 12.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

| å¯¾è±¡ | ãƒ†ã‚¹ãƒˆå†…å®¹ | ãƒ†ã‚¹ãƒˆæ•°ï¼ˆç›®æ¨™ï¼‰ |
|------|----------|-----------------|
| ContextBuilder | ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰ | 20 |
| LLMBrain | æ„å›³ç†è§£ã€Toolé¸æŠ | 50 |
| GuardianLayer | å„ãƒã‚§ãƒƒã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ | 30 |
| AuthorizationGate | æ¨©é™ãƒã‚§ãƒƒã‚¯ | 20 |
| ObservabilityLayer | è¨˜éŒ²ã€Self-Critique | 15 |
| ToolExecutor | Toolå®Ÿè¡Œ | 20 |
| **åˆè¨ˆ** | | **155** |

### 12.2 çµ±åˆãƒ†ã‚¹ãƒˆ

| ã‚·ãƒŠãƒªã‚ª | å†…å®¹ |
|---------|------|
| æ­£å¸¸ãƒ•ãƒ­ãƒ¼ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ Toolå®Ÿè¡Œ â†’ å¿œç­” |
| ç¢ºèªãƒ¢ãƒ¼ãƒ‰ | ç¢ºä¿¡åº¦ä½ â†’ ç¢ºèª â†’ å®Ÿè¡Œ |
| æ¨©é™æ‹’å¦ | æ¨©é™ãªã— â†’ æ‹’å¦ |
| å±é™ºæ“ä½œ | å±é™ºæ“ä½œ â†’ ç¢ºèª |
| é›‘è«‡ | Toolä¸è¦ â†’ ç›´æ¥å¿œç­” |

### 12.3 ã‚·ãƒ£ãƒ‰ãƒ¼ãƒ¢ãƒ¼ãƒ‰

```python
# ã‚·ãƒ£ãƒ‰ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼šLLMå¸¸é§å‹ã‚’å®Ÿè¡Œã™ã‚‹ãŒã€çµæœã¯æ—¢å­˜Brainã®çµæœã‚’ä½¿ã†
if SHADOW_MODE:
    # æ–°Brainå®Ÿè¡Œï¼ˆçµæœã¯ãƒ­ã‚°ã®ã¿ï¼‰
    new_result = await llm_native_brain.process(message, context)
    logger.info(f"[SHADOW] New brain result: {new_result}")

    # æ—¢å­˜Brainã®çµæœã‚’å®Ÿéš›ã«ä½¿ã†
    old_result = await old_brain.process_message(message, context)
    return old_result
```

---

## 13. ã‚³ã‚¹ãƒˆç®¡ç†

### 13.1 ã‚³ã‚¹ãƒˆæ§‹æˆ

| é …ç›® | æœˆé¡è¦‹è¾¼ã¿ï¼ˆ5,000å›ä¼šè©±ï¼‰ |
|------|-------------------------|
| Claude Opus 4.5 API | ç´„29,500å†† |
| Cloud Run | ç´„7,500å†† |
| Supabase | ç´„5,500å†† |
| Pinecone | ç´„1,500å†† |
| ãã®ä»– | ç´„500å†† |
| **åˆè¨ˆ** | **ç´„44,500å††** |

### 13.2 ã‚³ã‚¹ãƒˆæœ€é©åŒ–

#### 13.2.1 Prompt Caching

```python
# Anthropic Prompt Cachingã‚’ä½¿ç”¨
# System Promptã¨æ©Ÿèƒ½ã‚«ã‚¿ãƒ­ã‚°ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯èƒ½

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›¸ãè¾¼ã¿ï¼ˆåˆå›ã®ã¿ï¼‰: $6.25/1M tokens
# ã‚­ãƒ£ãƒƒã‚·ãƒ¥èª­ã¿è¾¼ã¿ï¼ˆ2å›ç›®ä»¥é™ï¼‰: $0.50/1M tokens
# â†’ ç´„90%ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›
```

#### 13.2.2 é«˜é€Ÿãƒ‘ã‚¹ï¼ˆå°†æ¥ã®æœ€é©åŒ–ï¼‰

```python
# å˜ç´”ãªæŒ¨æ‹¶ãƒ»é›‘è«‡ã¯LLMã‚’å‘¼ã°ãšã«å¿œç­”
SIMPLE_PATTERNS = {
    "ãŠã¯ã‚ˆã†": "ãŠã¯ã‚ˆã†ã‚¦ãƒ«ï¼ğŸº",
    "ã‚ã‚ŠãŒã¨ã†": "ã©ã†ã„ãŸã—ã¾ã—ã¦ã‚¦ãƒ«ï¼ğŸº",
    ...
}

if message in SIMPLE_PATTERNS:
    return SIMPLE_PATTERNS[message]  # LLMå‘¼ã³å‡ºã—ãªã—
```

### 13.3 ã‚³ã‚¹ãƒˆç›£è¦–

```python
# æ—¥æ¬¡ã§ã‚³ã‚¹ãƒˆã‚’é›†è¨ˆãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ
async def check_daily_cost():
    total = await get_daily_llm_cost()
    if total > DAILY_LIMIT:
        await notify_admin(f"LLMã‚³ã‚¹ãƒˆãŒä¸Šé™ã‚’è¶…ãˆã¾ã—ãŸ: {total}å††")
```

---

## 14. ç›£è¦–ãƒ»é‹ç”¨

### 14.1 ç›£è¦–é …ç›®

| é …ç›® | é–¾å€¤ | ã‚¢ãƒ©ãƒ¼ãƒˆ |
|------|------|---------|
| LLMå¿œç­”æ™‚é–“ | > 10ç§’ | è­¦å‘Š |
| Toolå®Ÿè¡Œã‚¨ãƒ©ãƒ¼ç‡ | > 5% | è­¦å‘Š |
| ç¢ºèªãƒ¢ãƒ¼ãƒ‰ç™ºç”Ÿç‡ | > 30% | æƒ…å ± |
| ãƒ–ãƒ­ãƒƒã‚¯ç™ºç”Ÿç‡ | > 10% | è­¦å‘Š |
| æ—¥æ¬¡ã‚³ã‚¹ãƒˆ | > 5,000å†† | è­¦å‘Š |

### 14.2 ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

```
ã€ã‚½ã‚¦ãƒ«ãã‚“è„³ãƒ¢ãƒ‹ã‚¿ãƒ¼ã€‘

ä»Šæ—¥ã®çµ±è¨ˆ:
- ç·ä¼šè©±æ•°: 150
- å¹³å‡å¿œç­”æ™‚é–“: 2.3ç§’
- ç¢ºä¿¡åº¦å¹³å‡: 0.85
- ç¢ºèªãƒ¢ãƒ¼ãƒ‰: 12å› (8%)
- ãƒ–ãƒ­ãƒƒã‚¯: 2å› (1.3%)

ã‚³ã‚¹ãƒˆ:
- æœ¬æ—¥: 1,234å††
- ä»Šæœˆç´¯è¨ˆ: 28,456å††
- äºˆæ¸¬: 42,000å††
```

### 14.3 ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ

| ãƒ¬ãƒ™ãƒ« | æ¡ä»¶ | å¯¾å¿œ |
|--------|------|------|
| P1ï¼ˆç·Šæ€¥ï¼‰ | å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å½±éŸ¿ | å³æ™‚ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| P2ï¼ˆé‡å¤§ï¼‰ | ä¸€éƒ¨æ©Ÿèƒ½åœæ­¢ | 1æ™‚é–“ä»¥å†…ã«å¯¾å¿œ |
| P3ï¼ˆè­¦å‘Šï¼‰ | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ | 24æ™‚é–“ä»¥å†…ã«å¯¾å¿œ |
| P4ï¼ˆæƒ…å ±ï¼‰ | è»½å¾®ãªå•é¡Œ | æ¬¡å›ãƒªãƒªãƒ¼ã‚¹ã§å¯¾å¿œ |

---

## 15. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase A: æ–°ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…

- [ ] lib/brain/context_builder.py
- [ ] lib/brain/llm_brain.py
- [ ] lib/brain/guardian_layer.py
- [ ] lib/brain/authorization_gate.pyï¼ˆæ—¢å­˜ã‚’æ‹¡å¼µï¼‰
- [ ] lib/brain/observability_layer.py
- [ ] lib/brain/tool_executor.py
- [ ] lib/brain/tool_definitions.py
- [ ] lib/brain/llm_native_brain.pyï¼ˆçµ±åˆã‚¯ãƒ©ã‚¹ï¼‰

### Phase B: ãƒ†ã‚¹ãƒˆ

- [ ] tests/brain/test_context_builder.py
- [ ] tests/brain/test_llm_brain.py
- [ ] tests/brain/test_guardian_layer.py
- [ ] tests/brain/test_tool_executor.py
- [ ] tests/brain/test_observability_layer.py
- [ ] tests/brain/test_llm_native_brain.pyï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰

### Phase C: DB

- [ ] brain_observability_logs ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### Phase D: æœ¬ç•ª

- [ ] Feature Flagè¿½åŠ ï¼ˆUSE_LLM_NATIVE_BRAINï¼‰
- [ ] main.pyåˆ†å²è¿½åŠ 
- [ ] ã‚·ãƒ£ãƒ‰ãƒ¼ãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ
- [ ] 10%ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ
- [ ] 50%ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ
- [ ] 100%ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

### Phase E: å®Œäº†

- [ ] æ—§ã‚³ãƒ¼ãƒ‰å‰Šé™¤
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
- [ ] PROGRESS.mdæ›´æ–°

---

## 16. ä»˜éŒ²

### 16.1 ç”¨èªé›†

| ç”¨èª | èª¬æ˜ |
|------|------|
| LLMå¸¸é§å‹ | LLMã‚’è„³ã®ä¸­æ ¸ã«å¸¸é§ã•ã›ã‚‹è¨­è¨ˆ |
| Function Calling | LLMãŒé–¢æ•°ï¼ˆToolï¼‰ã‚’é¸æŠã™ã‚‹æ©Ÿèƒ½ |
| Chain-of-Thought | LLMã®æ€è€ƒéç¨‹ã‚’å‡ºåŠ›ã•ã›ã‚‹æ‰‹æ³• |
| Self-Critique | LLMã«è‡ªå·±æ‰¹åˆ¤ã•ã›ã‚‹æ‰‹æ³• |
| Context Builder | LLMã«æ¸¡ã™æ–‡è„ˆæƒ…å ±ã‚’æ§‹ç¯‰ã™ã‚‹å±¤ |
| Guardian Layer | LLMã®åˆ¤æ–­ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å±¤ |
| Authorization Gate | æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†å±¤ï¼ˆLLMã¨ç‹¬ç«‹ï¼‰ |
| Observability Layer | å…¨åˆ¤æ–­ã‚’è¨˜éŒ²ã™ã‚‹å±¤ |

### 16.2 å‚è€ƒè³‡æ–™

- Anthropic Claude API Documentation
- Anthropic Function Calling Guide
- docs/13_brain_architecture.mdï¼ˆæ—§è¨­è¨ˆæ›¸ï¼‰
- CLAUDE.mdï¼ˆè¨­è¨ˆOSï¼‰

### 16.3 å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|-----------|------|---------|
| v1.0.0 | 2026-01-30 | åˆç‰ˆä½œæˆ |

---

**ä½œæˆè€…:** Claude Codeï¼ˆçµŒå–¶å‚è¬€ãƒ»SEãƒ»PMï¼‰
**æ‰¿èªè€…:** ã‚«ã‚ºã•ã‚“ï¼ˆä»£è¡¨ï¼‰
**ä½œæˆæ—¥:** 2026-01-30
