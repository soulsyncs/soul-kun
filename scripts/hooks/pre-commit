#!/bin/bash
# =============================================================================
# pre-commit hook: lib/ 同期チェック
# =============================================================================
#
# コミット前にlib/が同期されているかチェック
# 同期されていない場合はコミットをブロック
#
# v10.53.0: 初版作成（大規模修繕対応）
# =============================================================================

# カラー出力
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "${YELLOW}🔍 pre-commit: lib/ 同期チェック${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# lib/ が変更されているかチェック
LIB_CHANGED=$(git diff --cached --name-only | grep "^lib/" | head -1)

if [ -z "$LIB_CHANGED" ]; then
    echo -e "${GREEN}✅ lib/ に変更なし（チェックスキップ）${NC}"
    echo ""
    exit 0
fi

echo "lib/ に変更が検出されました。同期状態をチェック中..."
echo ""

# 同期スクリプトが存在するか確認
if [ ! -f "scripts/sync_lib.sh" ]; then
    echo -e "${YELLOW}⚠️ scripts/sync_lib.sh が見つかりません（チェックスキップ）${NC}"
    exit 0
fi

# 同期チェック実行
if ./scripts/sync_lib.sh --check > /dev/null 2>&1; then
    echo -e "${GREEN}✅ lib/ は同期されています${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}❌ lib/ が同期されていません！${NC}"
    echo ""
    echo "コミット前に以下を実行してください:"
    echo ""
    echo "  make sync"
    echo ""
    echo "または:"
    echo ""
    echo "  ./scripts/sync_lib.sh"
    echo ""
    echo "同期後、変更をステージに追加:"
    echo ""
    echo "  git add chatwork-webhook/lib proactive-monitor/lib ..."
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo -e "${YELLOW}⚠️ このチェックをスキップするには:${NC}"
    echo "  git commit --no-verify"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    exit 1
fi
