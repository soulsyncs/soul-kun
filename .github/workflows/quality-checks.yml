name: Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  # =====================================================
  # 1. lib/ã‚³ãƒ”ãƒ¼ã®åŒæœŸãƒã‚§ãƒƒã‚¯
  # =====================================================
  lib-sync-check:
    name: Check lib/ copies are in sync
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Check text_utils.py sync
        run: |
          echo "ğŸ” Checking lib/text_utils.py copies are in sync..."

          # ãƒ¡ã‚¤ãƒ³ã®lib/text_utils.pyãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if [ ! -f "lib/text_utils.py" ]; then
            echo "âŒ lib/text_utils.py not found"
            exit 1
          fi

          # remind-tasks/lib/text_utils.pyã¨ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯
          if [ -f "remind-tasks/lib/text_utils.py" ]; then
            if ! diff -q "lib/text_utils.py" "remind-tasks/lib/text_utils.py" > /dev/null 2>&1; then
              echo "âŒ lib/text_utils.py and remind-tasks/lib/text_utils.py are OUT OF SYNC!"
              echo ""
              echo "Differences:"
              diff "lib/text_utils.py" "remind-tasks/lib/text_utils.py" | head -50
              exit 1
            else
              echo "âœ… remind-tasks/lib/text_utils.py is in sync"
            fi
          else
            echo "âš ï¸ remind-tasks/lib/text_utils.py not found (may be intentional)"
          fi

          # sync-chatwork-tasks/lib/text_utils.pyã¨ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯
          if [ -f "sync-chatwork-tasks/lib/text_utils.py" ]; then
            if ! diff -q "lib/text_utils.py" "sync-chatwork-tasks/lib/text_utils.py" > /dev/null 2>&1; then
              echo "âŒ lib/text_utils.py and sync-chatwork-tasks/lib/text_utils.py are OUT OF SYNC!"
              echo ""
              echo "Differences:"
              diff "lib/text_utils.py" "sync-chatwork-tasks/lib/text_utils.py" | head -50
              exit 1
            else
              echo "âœ… sync-chatwork-tasks/lib/text_utils.py is in sync"
            fi
          else
            echo "âš ï¸ sync-chatwork-tasks/lib/text_utils.py not found (may be intentional)"
          fi

          echo ""
          echo "âœ… All lib/text_utils.py copies are in sync!"

  # =====================================================
  # 2. ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡ºï¼ˆç›´æ¥åˆ‡ã‚Šè©°ã‚é˜²æ­¢ï¼‰
  # =====================================================
  #
  # æ¤œå‡ºå¯¾è±¡: ã‚¿ã‚¹ã‚¯è¡¨ç¤ºç”¨ã®ç›´æ¥åˆ‡ã‚Šè©°ã‚ï¼ˆ[:30], [:40]å½¢å¼ï¼‰
  # æ¤œå‡ºå¯¾è±¡å¤–:
  #   - ãƒ­ã‚°å‡ºåŠ›ç”¨ï¼ˆ[:500]ãªã©å¤§ããªæ•°å­—ï¼‰
  #   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆstr(e)[:50]ï¼‰
  #   - summary_previewï¼ˆãƒ­ã‚°å‡ºåŠ›ç”¨ï¼‰
  #   - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°å†…ã®å®šç¾©
  #
  forbidden-patterns-check:
    name: Check for forbidden patterns
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Check for direct truncation patterns
        run: |
          echo "ğŸ” Checking for forbidden truncation patterns..."
          echo "   (Checking for task display truncation, not log output)"

          # æ¤œå‡ºå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
          TARGET_FILES=(
            "remind-tasks/main.py"
            "sync-chatwork-tasks/main.py"
          )

          # =====================================================
          # ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆv10.17.1å¼·åŒ–ï¼‰
          # =====================================================
          # æ¤œå‡ºå¯¾è±¡:
          #   - body[:30], body[:40] + "..." å½¢å¼
          #   - task["body"][:30] + "..." å½¢å¼
          #   - task_body[:30] + "..." å½¢å¼
          #   - clean_task_name[:30] + "..." å½¢å¼
          #   - clean_body[:40] + "..." å½¢å¼
          #
          # é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³:
          #   - summary[:30]ï¼ˆãƒ­ã‚°å‡ºåŠ›ç”¨ãªã®ã§OKï¼‰
          #   - summary_previewï¼ˆãƒ­ã‚°å‡ºåŠ›ç”¨ãªã®ã§OKï¼‰
          #   - current_summary[:50]ï¼ˆãƒ­ã‚°/ç›£æŸ»ç”¨ãªã®ã§OKï¼‰
          #   - text[:max_length]ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°å†…ãªã®ã§OKï¼‰
          # =====================================================

          ERRORS_FOUND=0

          for file in "${TARGET_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Checking $file..."

              # ãƒ‘ã‚¿ãƒ¼ãƒ³1: body[:30] + "..." å½¢å¼ï¼ˆå¤‰æ•°åãŒbodyã§å§‹ã¾ã‚‹ï¼‰
              # ãŸã ã—ã€"summary" ã‚’å«ã‚€è¡Œã¯é™¤å¤–
              if grep -n 'body\[:3[0-9]\].*\.\.\.' "$file" | grep -v "summary" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous body truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³2: task["body"][:30] + "..." å½¢å¼
              if grep -n 'task\["body"\]\[:3[0-9]\].*\.\.\.' "$file" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous task[\"body\"] truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³3: task_info["body"][:30] + "..." å½¢å¼
              if grep -n 'task_info\["body"\]\[:3[0-9]\].*\.\.\.' "$file" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous task_info[\"body\"] truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³4: task_body[:30] ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆf-stringå†…ï¼‰
              if grep -n 'task_body\[:3[0-9]\]' "$file" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous task_body truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³5: clean_task_name[:30] + "..." å½¢å¼
              if grep -n 'clean_task_name\[:3[0-9]\].*\.\.\.' "$file" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous clean_task_name truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³6: clean_body[:4x] + "..." å½¢å¼ï¼ˆå…ƒã€…ã®ãƒã‚§ãƒƒã‚¯ï¼‰
              if grep -n 'clean_body\[:4[0-9]\].*\.\.\.' "$file" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous clean_body truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi
            fi
          done

          if [ $ERRORS_FOUND -eq 1 ]; then
            echo ""
            echo "âŒ Forbidden patterns found!"
            echo "   Use prepare_task_display_text() instead of direct truncation."
            exit 1
          fi

          echo "âœ… No forbidden truncation patterns found!"

  # =====================================================
  # 3. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # =====================================================
  unit-tests:
    name: Run unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run text_utils tests
        run: |
          echo "ğŸ§ª Running lib/text_utils.py unit tests..."
          # ãƒ†ã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰å®Ÿè¡Œï¼ˆlib/ã¸ã®ãƒ‘ã‚¹ã‚’è§£æ±ºï¼‰
          cd $GITHUB_WORKSPACE
          PYTHONPATH=$GITHUB_WORKSPACE python -m pytest tests/test_text_utils_lib.py -v --tb=short --ignore-glob='**/embedding.py'
          echo "âœ… All tests passed!"

  # =====================================================
  # æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  # =====================================================
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lib-sync-check, forbidden-patterns-check, unit-tests]
    steps:
      - name: All checks passed
        run: |
          echo "âœ… All quality checks passed!"
          echo ""
          echo "Checks completed:"
          echo "  - lib/ copies sync check"
          echo "  - Forbidden patterns check"
          echo "  - Unit tests"
