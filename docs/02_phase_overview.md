# 第2章：Phase構成

## 2.1 Phase構成全体図【更新】

### 【社内優先フェーズ】2026年 Q1〜Q3

- Phase 1: タスク管理基盤 ✅完了
- Phase 1-B: タスク検知・監視 ✅完了（v10.1.4）
- Phase 2: AI応答・評価機能 ✅完了
- Phase 2.5: 目標達成支援 🔄Q1（実装中）
- Phase 3: ナレッジ系（ソウルくんの脳みそ）✅完了（v10.13.3）
- **★ Phase 3.5: 組織階層連携（ソウルくんの目）✅完了（2026-01-19）【v10.0追加】**
- **★ Phase 3.6: 組織図システム製品化 📋Q2〜Q3 【v10.0追加】**
- **★ Phase C: 会議系（議事録自動化）📋Q3 Week 1-2, 5-6 【v10.1追加】**
- Phase B7: 採用・教育支援 📋Q3 Week 9-12
- Phase B3-部分: シフト管理 📋Q4以降

### 【BPaaS向けフェーズ】2026年 Q4〜2027年

- Phase 4A: テナント分離（BPaaS新規テーブル）📋Q4
  ※Phase 3.5の組織階層モデルを前提とする
- Phase 4B: テナント分離（既存テーブル移行）📋2027年Q1
- Phase B1-Core: 経理・財務基盤【手入力版】📋Q4
- Phase B1-Auto: 経理・財務自動化【API連携版】📋2027年Q1
- Phase B2: 会計ソフト連携 📋2027年Q1
- Phase B3-残り: 勤怠集計 + SmartHR連携 📋2027年Q2
- Phase 1-C: レポート自動生成 📋2027年Q2

### 【将来構想】2027年以降

- Phase B5: 業界特化機能
- Phase B6: ANDPAD連携
- Phase 8-A: IT導入補助金対応
- Phase 8: SaaS化・外販
- Phase 9: M&A連携機能
- Phase 10: パートナー連携基盤

---

## 2.2 各Phaseの概要

### ■ Phase 1-B: タスク検知・監視【v10.1.4更新】✅完了

**目的:** タスクの期限超過を自動検知し、担当者に毎日リマインド通知を送る

**スコープ（v10.1.4）:**

| # | 機能 | 詳細 | 実装状況 |
|---|------|------|---------|
| 1 | 期限超過タスク検知 | 毎日朝9時に期限切れタスクを検出 | ✅実装 |
| 2 | ChatWork自動通知 | 担当者のDMに期限超過タスクを通知 | ✅実装 |
| 3 | 二重送信防止 | notification_logsで冪等性確保（UPSERT仕様） | ✅実装（v10.1.4） |
| 4 | エスカレーション | 3日超過で依頼者+管理部に報告 | ✅実装 |
| 5 | 汎用通知ログ | Phase 2.5/Cでも利用可能なnotification_logs | ✅実装（v10.1.4） |

**技術仕様（v10.1.4）:**

```yaml
Scheduler: Cloud Scheduler（毎日朝8:30 JST）
実装: remind-tasks/main.py（Cloud Functions）
DB: notification_logsテーブル（汎用通知ログ、v10.1.4）
通知タイプ:
  - task_reminder: タスク期限超過リマインド
  - task_escalation: 3日超過エスカレーション
冪等性: UNIQUE(org_id, target_type, target_id, date, type) + UPSERT
```

**notification_logsテーブル（v10.1.4）:**

| カラム | 型 | 説明 |
|--------|---|------|
| notification_type | VARCHAR(50) | task_reminder, task_escalation, goal_reminder, meeting_reminder |
| target_type | VARCHAR(50) | task, goal, meeting, system |
| target_id | BIGINT | 対象ID（task_id等） |
| status | VARCHAR(20) | success, failed, skipped |
| metadata | JSONB | overdue_days等の追加情報 |

**リマインド通知例:**

```
山田さん

📌 期限超過のタスクがありますウル！

1. 「Re:nk新規案件ヒアリング資料作成」（依頼者: 吉澤 / 期限: 01/15 / 2日超過）

遅れている理由と、いつ頃完了できそうか教えてほしいウル🐺
```

**Phase 1-B完了定義（5項目）:**

| # | 要件 | 詳細 | 確認方法 |
|---|------|------|---------|
| 1 | 期限超過検知 | 毎日朝8:30に期限超過タスクを検出 | ✅Cloud Schedulerログ確認 |
| 2 | ChatWork通知 | 検出したタスクを担当者のDMに通知 | ✅ChatWork受信確認 |
| 3 | 冪等性保証 | 同じタスクに同じ日に2回送信しない | ✅notification_logs確認 |
| 4 | エラーハンドリング | ChatWork API失敗時にログ記録＋リトライ | ✅エラーログ確認 |
| 5 | エスカレーション | 3日超過で依頼者+管理部に報告 | ✅process_escalations() |

**v10.1.4での改善:**

| # | 改善 | 変更内容 | 効果 |
|---|------|---------|------|
| 1 | 汎用通知ログ | task_overdue_reminders → notification_logs | Phase 2.5/C対応 |
| 2 | UPSERT仕様 | ON CONFLICT DO UPDATE | 失敗→成功のリトライ対応 |
| 3 | メタデータ対応 | JSONB metadata カラム | 拡張性向上 |
| 4 | データ移行 | 既存データを自動移行 | 後方互換性 |
| 5 | 統合ログ | task_reminder + task_escalation | 一元管理 |

---

### ■ Phase 3: ナレッジ系（ソウルくんの脳みそ）📋Q2 Week 1-6

（v9.2と同じ内容のため省略）

**Phase 3 MVPの完了定義（9項目）：**

| # | 要件 | 詳細 |
|---|------|------|
| 1 | ドキュメント取り込み | A（理念）、B（マニュアル）、F（サービス情報）をPineconeに登録 |
| 2 | 参照検索 | 質問に対して関連箇所を返す |
| 3 | 根拠提示 | 回答に引用/出典を付ける |
| 4 | 注意書き | 「最終更新日」「最新版は管理部に確認」を付ける |
| 5 | フィードバック | 「役に立った/違う」を記録する |
| 6 | アクセス制御 | 最低でも「全員OK/管理部のみ」の2段階 |
| 7 | 引用粒度 | ページ/見出し/段落（chunk_id）まで特定できる |
| 8 | 回答拒否条件 | 根拠が取れない場合は「回答できません」を返す |
| 9 | 検索品質評価 | 週次で「ヒットしない質問」「誤ヒット」を可視化 |

**入れるナレッジのカテゴリと優先順位：**

| 優先度 | カテゴリ | 内容例 | 実装時期 | 理由 |
|--------|---------|--------|---------|------|
| **1** | A: 理念・哲学 | MVV、3軸、行動指針 | Q2（MVP） | 誤答リスク低い |
| **2** | B: 業務マニュアル | 各業務の手順書 | Q2（MVP） | 問い合わせ削減に直結 |
| **3** | F: サービス情報 | 自社サービスの説明、料金 | Q2（MVP） | 営業で即効性 |
| **4** | C: 就業規則 | 勤怠、経費、休暇等 | Q3以降 | 誤答が労務事故に |
| **5** | D: テンプレート | 返信文、議事録のひな形 | Q3以降 | 参照なので後でOK |
| **6** | E: 顧客情報 | 顧客ごとの対応ルール | Q3以降 | セキュリティ設計必要 |

---

## 2.2.5 Phase 3.5: 組織階層連携【新設】

### ■ Phase 3.5の目的

**「ソウルくんが組織構造を理解し、階層ベースのアクセス制御を実現する」**

### ■ Phase 3.5の位置づけ

```
Phase 3: ナレッジ系（脳みそ）
   ↓
   【この脳みそが「組織構造」を理解する】
   ↓
Phase 3.5: 組織階層連携（目）← ★ここ
   ↓
   【組織構造を理解した上で、テナント分離する】
   ↓
Phase 4A: テナント分離
```

### ■ Phase 3.5で実現すること

| # | 機能 | 説明 | 効果 |
|---|------|------|------|
| 1 | 組織階層モデルの構築 | 部署の親子関係を定義 | 「営業部 > 東京営業課」を理解 |
| 2 | ユーザーの所属管理 | ユーザーがどの部署に所属しているか | 「山田さんは東京営業課」 |
| 3 | 動的アクセス権限計算 | 組織階層から権限を自動計算 | 「課長は課内の機密情報を見れる」 |
| 4 | RAG検索への統合 | Pinecone検索に組織フィルタを追加 | 「自部署の情報のみヒット」 |
| 5 | 組織図システムとの同期 | 組織図Webアプリからデータを受信 | 「組織変更が自動反映」 |

### ■ Phase 3.5の完了定義（10項目）

| # | 要件 | 詳細 | テスト方法 |
|---|------|------|-----------|
| 1 | 組織階層テーブル作成 | departments, user_departments, department_access_scopes | マイグレーション実行 |
| 2 | 組織図同期API | POST /api/v1/organizations/{org_id}/sync-org-chart | Postmanで動作確認 |
| 3 | 階層パスの自動生成 | LTREEパスの自動計算 | 「本社.営業部.東京課」が生成される |
| 4 | アクセス可能部署の計算 | compute_accessible_departments() | 「部長は配下3部署アクセス可」を確認 |
| 5 | RAG検索への組織フィルタ | Pinecone Metadataに department_id 追加 | 「課長は課外の機密情報を見れない」を確認 |
| 6 | 権限判定ロジック | can_access_document(user, document) | 各役職ごとにテスト |
| 7 | 監査ログ記録 | 「誰がどの部署の情報を見たか」を記録 | audit_logsに記録されることを確認 |
| 8 | 管理画面 | 組織図の同期状態を表示 | UIで確認 |
| 9 | エラーハンドリング | 循環参照、孤立部署の検出 | 異常データでテスト |
| 10 | パフォーマンステスト | 1000部署、10000ユーザーでの動作 | 応答時間 < 200ms |

### ■ Phase 3.5の技術スタック

| 要素 | 技術 | 理由 |
|------|------|------|
| 階層クエリ | PostgreSQL LTREE | 階層検索が高速（O(log n)） |
| API | FastAPI (Cloud Run) | 新規APIはFastAPIで実装 |
| 既存API | Flask (Cloud Functions) | 段階的にFastAPIへ移行 |
| 共通ライブラリ | lib/ | Flask/FastAPI両対応の共通コード |
| 同期方式 | REST API（Push型） | 組織図システムから変更を通知 |
| キャッシュ | Redis | アクセス可能部署リストをキャッシュ |

### ■ ハイブリッドアーキテクチャ【v10.1.5追加】

**現状（Phase 3.5開始時点）:**
- 既存: Flask + Cloud Functions（main.py 2,615行）
- 新規: FastAPI + Cloud Run（api/ディレクトリ）

**共通ライブラリ（lib/）:**
```
lib/
├── config.py      # 環境変数・設定管理
├── secrets.py     # GCP Secret Manager
├── db.py          # DB接続（sync/async両対応）
├── chatwork.py    # Chatwork APIクライアント
├── tenant.py      # テナントコンテキスト管理
└── logging.py     # 構造化ログ
```

**Phase 4開始前（2026年Q4）までの移行計画:**

| 時期 | マイルストーン | 内容 |
|------|--------------|------|
| Phase 3.5 | lib/共通化 | DB接続、Chatwork API、シークレット管理を共通化 |
| Phase 3.5 | FastAPI基盤 | api/ディレクトリにFastAPIアプリ構築 |
| Phase 3.6 | 組織図API | FastAPIで組織図同期APIを実装 |
| Phase C | 会議系API | FastAPIで議事録APIを実装 |
| **Q3末** | **Flask移行完了** | **既存Cloud FunctionsをFastAPIに完全移行** |
| Phase 4A | マルチテナント | FastAPIベースでBPaaS対応 |

**重要: Phase 4A開始前にFlask→FastAPI移行を完了すること**

### ■ Phase 3.5の実装時期

| Week | タスク | 工数 | 担当 |
|------|--------|------|------|
| **Q2 Week 7** | データモデル構築 | 20h | エンジニア |
| | - departments テーブル作成 | 5h | |
| | - user_departments テーブル作成 | 5h | |
| | - department_access_scopes テーブル作成 | 5h | |
| | - マイグレーション実行 | 5h | |
| **Q2 Week 8** | API実装 | 30h | エンジニア |
| | - 組織図同期API | 10h | |
| | - 階層計算ロジック | 10h | |
| | - RAG検索統合 | 10h | |
| **合計** | | **50h** | |

### ■ Phase 3.5の依存関係

**前提条件:**
- Phase 3（ナレッジ系）の基盤が完成していること
- organizations, users テーブルが存在すること
- Pinecone接続が確立していること

**Phase 3.5が前提となるPhase:**
- Phase 3.6（組織図システム製品化）
- Phase 4A（テナント分離）
- Phase B7（採用・教育）


### ■ Phase Cの依存関係【v10.1追加】

**前提条件:**
- Phase 1（タスク管理基盤）が完成していること ✅
- Phase 1-B（タスク検知・監視）が完成していること
- ChatWork API連携が確立していること ✅
- OpenAI API連携が確立していること ✅

**Phase Cが前提となるPhase:**
- Phase C2（ナレッジ化）→ Phase 3（ナレッジ系）完成後に実装

**Phase 3.5/3.6との関係:**
- Phase Cは Phase 3.5（組織階層）に**準拠**（department_id, confidentiality_level）
- Phase Cは Phase 3.6（組織図製品化）とは**独立**（並行開発可能）
---

## 2.2.6 Phase 3.6: 組織図システム製品化【新設】

### ■ Phase 3.6の目的

**「組織図システムを単体製品として外販可能にし、ソウル君とのセット販売を実現する」**

### ■ Phase 3.6の戦略的意義

**現状の課題:**
- 組織図システムは社内用（LocalStorage）
- セキュリティが弱い（ブラウザ内のみ）
- 外販できない

**Phase 3.6で実現すること:**
- **組織図システムをクラウドベースに改修**
- **ソウル君と連携した製品として外販**
- **BPaaS顧客に「組織図 + AI」のセット販売**

**売上への影響:**

| 項目 | 金額（月額） | 備考 |
|------|------------|------|
| 組織図システム単体 | 1〜2万円 | 50名まで1万円、51〜100名2万円 |
| ソウル君単体 | 3〜5万円 | 既存料金 |
| **セット販売** | **4〜7万円** | 10%割引 |

**ARPUの向上:**
- 従来: 3〜5万円/顧客
- Phase 3.6後: **4〜7万円/顧客**
- **増加率: +20〜40%**

### ■ Phase 3.6で実装する機能

| # | 機能 | 説明 | 優先度 |
|---|------|------|--------|
| 1 | マルチテナント対応 | 顧客ごとに組織図データを分離 | 必須 |
| 2 | クラウドストレージ | LocalStorageからCloud SQLへ移行 | 必須 |
| 3 | 権限管理 | 誰が組織図を編集できるか | 必須 |
| 4 | API認証 | 組織図APIへのアクセス制御 | 必須 |
| 5 | データエクスポート | PDF/Excel出力 | 必須 |
| 6 | 履歴管理 | 組織変更履歴の記録 | 必須 |
| 7 | テンプレート機能 | 業種別の組織図テンプレート | 推奨 |
| 8 | 承認フロー | 組織変更の承認ワークフロー | オプション |
| 9 | SmartHR連携 | 従業員データの自動同期 | オプション |
| 10 | Slack通知 | 組織変更をSlack通知 | オプション |

### ■ Phase 3.6の完了定義（8項目）

| # | 要件 | 詳細 |
|---|------|------|
| 1 | マルチテナント化 | 顧客ごとにデータ分離 |
| 2 | 認証・認可 | ログイン、権限管理 |
| 3 | データ移行ツール | LocalStorage → Cloud SQL |
| 4 | UI改修 | クラウドベースに対応 |
| 5 | API整備 | 全機能をAPIで提供 |
| 6 | ドキュメント作成 | API仕様書、マニュアル |
| 7 | セキュリティ監査 | 脆弱性テスト |
| 8 | 外販準備 | 料金ページ、契約書 |

### ■ Phase 3.6の実装時期

| 期間 | タスク | 工数 | 担当 |
|------|--------|------|------|
| **Q2 Week 9-12** | 基盤構築 | 80h | エンジニア |
| | - マルチテナント化 | 30h | |
| | - 認証・認可 | 20h | |
| | - データ移行ツール | 30h | |
| **Q3 Week 1-4** | UI改修 | 60h | デザイナー + エンジニア |
| | - クラウドベースUI | 40h | |
| | - 管理画面 | 20h | |
| **Q3 Week 5-8** | 外販準備 | 40h | 営業 + マーケ |
| | - API仕様書 | 10h | |
| | - マニュアル | 10h | |
| | - 料金ページ | 10h | |
| | - 契約書 | 10h | |
| **合計** | | **180h** | |

### ■ Phase 3.6の料金モデル【新設】

**組織図システム単体:**

| プラン | 人数 | 月額 | 年額（割引） |
|--------|------|------|------------|
| スターター | 〜50名 | 10,000円 | 100,000円（17%OFF） |
| スタンダード | 51〜100名 | 20,000円 | 200,000円（17%OFF） |
| プロフェッショナル | 101〜300名 | 30,000円 | 300,000円（17%OFF） |
| エンタープライズ | 301名〜 | 個別見積 | 個別見積 |

**ソウル君 + 組織図システム セット:**

| プラン | 人数 | 月額 | セット割引 |
|--------|------|------|-----------|
| スターター | 〜50名 | 40,000円 | 10% OFF |
| スタンダード | 51〜100名 | 60,000円 | 10% OFF |
| プロフェッショナル | 101〜300名 | 80,000円 | 10% OFF |


---

## 2.2.7 Phase C: 会議系（議事録自動化）【v10.1追加】

### ■ Phase Cの位置づけ

**Phase Cの配置と運用詳細は、別紙「v10.1 Addendum - Phase C配置最終決定 v1.1（2026-01-15）」を参照してください。**

### ■ Phase Cの概要

**実装スケジュール:**

| フェーズ | 時期 | 内容 | 工数（実質） |
|---------|------|------|-------------|
| **MVP0** | Q3 Week 1-2 | Zoom/Meet連携、文字起こし、社内実証開始 | 40h（AI活用） |
| **MVP1** | Q3 Week 5-6 | 議事録自動生成、タスク統合、完全自動化 | 50h（AI活用） |
| **Phase C2** | Q4以降 | ナレッジ化、決定事項追跡 | 2026年内見送り |

**Phase Cの価値:**

| 指標 | 数値 | 備考 |
|------|------|------|
| 社内削減効果 | 年間117万円 | 実測ベースで更新 |
| 社内開発コスト | 55万円 | 110h × 5,000円/h |
| ROI | 113% | 投資回収期間6ヶ月 |
| BPaaS外販 | Phase 3.6とセット販売可能 | 組織図+AI+議事録 |

### ■ Phase Cで実現すること

| # | 機能 | 説明 | MVP |
|---|------|------|-----|
| 1 | Zoom/Meet連携 | 会議録画の自動取得 | MVP0 |
| 2 | 文字起こし | Whisper APIで自動文字起こし | MVP0 |
| 3 | ChatWork投稿 | 文字起こし結果を自動投稿 | MVP0 |
| 4 | 議事録生成 | GPT-4で議事録を自動作成 | MVP1 |
| 5 | タスク統合 | アクションアイテムをタスク化 | MVP1 |
| 6 | ナレッジ化 | 議事録をナレッジDBに登録 | Phase C2 |
| 7 | 決定事項追跡 | 決定事項の進捗管理 | Phase C2 |

### ■ Phase Cの技術スタック

| 要素 | 技術 | 理由 |
|------|------|------|
| 会議録画 | Zoom API, Google Meet API | 既存ツールと連携 |
| 文字起こし | OpenAI Whisper API | 精度が高い |
| 議事録生成 | GPT-4 | 議事録の品質が高い |
| ストレージ | Google Cloud Storage | 録画保存用 |
| データベース | Cloud SQL (PostgreSQL) | 既存システムと統一 |

### ■ Phase Cの依存関係

**前提条件:**
- Phase 1（タスク管理基盤）が完成していること
- ChatWork API連携が確立していること
- OpenAI API連携が確立していること

**Phase Cが前提となるPhase:**
- Phase C2（ナレッジ化）にはPhase 3（ナレッジ系）が必要

### ■ Phase Cの詳細

**詳細設計、実装ガイド、リスク対策、効果測定等の完全な情報は、以下の別紙を参照してください:**

**📄 v10.1 Addendum - Phase C配置最終決定 v1.1（2026-01-15）**

**Addendum v1.1の内容:**
- エグゼクティブサマリー
- 背景と哲学の転換
- 実装スケジュール詳細
- **9つの鉄壁保証**（v1.0の6つ + v1.1で3つ追加）
- データベース設計（v1.1改善版）
  - **tenant_id/organization_id 同義宣言**
  - **department_id/confidentiality_level 追加**（Phase 3.5準拠）
  - **created_by/updated_by 追加**（v10.1準拠）
- **状態遷移責務表 + 楽観ロック実装**（二重起動防止）
- **監査ログ統合設計**（v10.1第7.3章準拠）
- **Phase C2準備設計**（ナレッジ化：embedding/chunks）
- **Phase 1-B統合詳細**（タスク統合）
- 実装ガイド
- リスク管理
- 効果測定
- 次のアクション

**技術的負債の解消:**
- v1.0時点: 69.5h（約1.7週間分）
- v1.1時点: **0h**（完全解消）
---

（続く...）


---

**[📁 目次に戻る](00_README.md)**
