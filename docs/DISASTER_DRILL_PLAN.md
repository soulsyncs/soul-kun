# 障害訓練計画書

**作成日:** 2026-01-30
**目的:** OPERATIONS_RUNBOOKの有効性を検証し、障害対応能力を維持・向上させる

---

## Document Contract（SoT宣言）

| 項目 | 内容 |
|------|------|
| **この文書の役割** | 障害訓練の計画・実施・評価の基準 |
| **書くこと** | 訓練シナリオ、実施手順、評価基準、スケジュール |
| **書かないこと** | 障害対応手順の詳細（→OPERATIONS_RUNBOOK.md） |
| **SoT（この文書が正）** | 障害訓練の全仕様 |
| **Owner** | SRE / インフラ担当（連絡先: #ops チャンネル） |
| **更新トリガー** | 訓練実施後、新たなリスク発見時 |

---

## 1. 訓練の目的

### 1.1 なぜ障害訓練が必要か

```
【訓練なしの場合】
設計書 → 本番障害発生 → 「手順書どこ？」「これで合ってる？」→ 復旧遅延

【訓練ありの場合】
設計書 → 訓練で検証 → 本番障害発生 → 「訓練通りにやろう」→ 迅速復旧
```

### 1.2 訓練の目標

| 目標 | 指標 |
|------|------|
| **MTTR短縮** | 復旧時間を30分以内に |
| **手順書の検証** | OPERATIONS_RUNBOOKが実際に機能することを確認 |
| **チーム練度向上** | 誰でも対応できる状態に |
| **改善点の発見** | 手順書の不備・曖昧な点を特定 |

---

## 2. 訓練シナリオ

### 2.1 シナリオ一覧

| ID | シナリオ | 難易度 | 頻度 | 対象チーム |
|----|---------|--------|------|-----------|
| **DR-001** | API応答遅延 | 低 | 月次 | 開発 |
| **DR-002** | DB接続障害 | 中 | 四半期 | 開発+インフラ |
| **DR-003** | LLM APIエラー | 中 | 四半期 | 開発 |
| **DR-004** | ChatWork連携障害 | 中 | 四半期 | 開発 |
| **DR-005** | 全サービス停止 | 高 | 半期 | 全員 |
| **DR-006** | データ漏洩インシデント | 高 | 半期 | 全員+経営 |

### 2.2 シナリオ詳細

---

#### DR-001: API応答遅延

**状況設定:**
> 09:00 ユーザーから「ソウルくんの応答が遅い」と報告
> Cloud Runのレイテンシが通常の5倍（2秒→10秒）

**訓練の流れ:**

| ステップ | アクション | 担当 | 時間目標 |
|---------|-----------|------|---------|
| 1 | 障害検知・アラート確認 | オンコール | 5分 |
| 2 | 影響範囲の特定 | オンコール | 10分 |
| 3 | 原因調査（Cloud Runメトリクス確認） | 開発 | 15分 |
| 4 | 対処実行（インスタンス数増加/再デプロイ） | 開発 | 20分 |
| 5 | 復旧確認・報告 | オンコール | 25分 |

**参照手順:** OPERATIONS_RUNBOOK.md セクション2

**評価基準:**
- [ ] 30分以内に復旧
- [ ] ユーザーへの一次報告が10分以内
- [ ] 根本原因が特定された

---

#### DR-002: DB接続障害

**状況設定:**
> 14:00 アラート「PostgreSQL接続エラー率100%」
> Cloud SQL Proxyがダウン

**訓練の流れ:**

| ステップ | アクション | 担当 | 時間目標 |
|---------|-----------|------|---------|
| 1 | 障害検知・アラート確認 | オンコール | 5分 |
| 2 | 読み取り専用モードへ切り替え | インフラ | 10分 |
| 3 | Cloud SQL Proxy再起動 | インフラ | 15分 |
| 4 | 接続確認 | 開発 | 20分 |
| 5 | 読み取り専用モード解除 | インフラ | 25分 |
| 6 | 復旧確認・報告 | オンコール | 30分 |

**参照手順:** OPERATIONS_RUNBOOK.md セクション2.2

**評価基準:**
- [ ] 30分以内に復旧
- [ ] データ損失なし
- [ ] 読み取り専用モードが正常に機能

---

#### DR-003: LLM APIエラー

**状況設定:**
> 10:30 アラート「Anthropic API エラー率50%」
> Claude APIが断続的にタイムアウト

**訓練の流れ:**

| ステップ | アクション | 担当 | 時間目標 |
|---------|-----------|------|---------|
| 1 | 障害検知・アラート確認 | オンコール | 5分 |
| 2 | Anthropicステータスページ確認 | 開発 | 8分 |
| 3 | フォールバック応答の有効化 | 開発 | 15分 |
| 4 | ユーザーへの状況説明メッセージ設定 | 開発 | 20分 |
| 5 | 定期的なAPI疎通確認 | 開発 | 継続 |
| 6 | 復旧確認・フォールバック解除 | 開発 | - |

**参照手順:** OPERATIONS_RUNBOOK.md セクション2.3

**評価基準:**
- [ ] 15分以内にフォールバック有効化
- [ ] ユーザーへの説明メッセージが適切
- [ ] API復旧後の正常化が確認された

---

#### DR-004: ChatWork連携障害

**状況設定:**
> 16:00 「ChatWorkへの通知が届かない」と報告
> ChatWork APIがメンテナンス中

**訓練の流れ:**

| ステップ | アクション | 担当 | 時間目標 |
|---------|-----------|------|---------|
| 1 | 障害検知 | オンコール | 5分 |
| 2 | ChatWorkステータス確認 | 開発 | 8分 |
| 3 | 通知キューの滞留確認 | 開発 | 12分 |
| 4 | リトライ設定の確認 | 開発 | 15分 |
| 5 | 復旧後の滞留メッセージ再送確認 | 開発 | - |

**参照手順:** OPERATIONS_RUNBOOK.md セクション2.4

**評価基準:**
- [ ] メッセージが重複送信されない
- [ ] 滞留メッセージが復旧後に正常送信される

---

#### DR-005: 全サービス停止

**状況設定:**
> 11:00 全てのサービスが応答しない
> GCPリージョン障害

**訓練の流れ:**

| ステップ | アクション | 担当 | 時間目標 |
|---------|-----------|------|---------|
| 1 | 障害検知・アラート確認 | オンコール | 5分 |
| 2 | GCPステータス確認 | インフラ | 8分 |
| 3 | 経営層への報告 | マネージャー | 10分 |
| 4 | ユーザーへの障害告知 | マネージャー | 15分 |
| 5 | DRサイトへの切り替え判断 | 経営 | 30分 |
| 6 | 復旧作業 | 全員 | - |
| 7 | ポストモーテム実施 | 全員 | 復旧後24時間 |

**参照手順:** OPERATIONS_RUNBOOK.md セクション1

**評価基準:**
- [ ] 15分以内に経営層へ報告
- [ ] ユーザーへの告知が30分以内
- [ ] ポストモーテムが実施された

---

#### DR-006: データ漏洩インシデント

**状況設定:**
> 「他の会社のデータが見えた」とユーザーから報告
> organization_idフィルタ漏れによるデータ漏洩の疑い

**訓練の流れ:**

| ステップ | アクション | 担当 | 時間目標 |
|---------|-----------|------|---------|
| 1 | インシデント受付・エスカレーション | オンコール | 即座 |
| 2 | **サービス即時停止の判断** | 経営 | 5分 |
| 3 | 影響範囲の調査 | 開発 | 30分 |
| 4 | 漏洩したデータの特定 | 開発 | 1時間 |
| 5 | 影響を受けたユーザーの特定 | 開発 | 2時間 |
| 6 | 法務・コンプライアンス報告 | 経営 | 24時間以内 |
| 7 | ユーザーへの通知 | 経営 | 72時間以内 |
| 8 | 再発防止策の実施 | 開発 | 1週間 |

**参照手順:** OPERATIONS_RUNBOOK.md セクション3

**評価基準:**
- [ ] 5分以内にサービス停止判断がされた
- [ ] 影響範囲が正確に特定された
- [ ] 法的要件（72時間以内の通知等）が満たされた

---

#### DR-007: バックアップ復旧テスト【2026-01-30追加】

**状況設定:**
> データベースの破損が発生
> バックアップからの復旧が必要

**訓練の流れ:**

| ステップ | アクション | 担当 | 時間目標 |
|---------|-----------|------|---------|
| 1 | 復旧対象の特定（日付・範囲） | インフラ | 5分 |
| 2 | バックアップ一覧の確認 | インフラ | 10分 |
| 3 | テスト環境へのバックアップ復元 | インフラ | 30分 |
| 4 | データ整合性検証 | 開発 | 45分 |
| 5 | 本番復旧判断 | 経営 | 50分 |
| 6 | 本番環境への復元（必要な場合） | インフラ | 1時間 |
| 7 | アプリケーション動作確認 | 開発 | 1時間15分 |
| 8 | ユーザーへの復旧報告 | マネージャー | 1時間30分 |

**参照手順:** OPERATIONS_RUNBOOK.md セクション14

**評価基準:**
- [ ] バックアップが正常に取得されていた
- [ ] テスト環境への復元が成功
- [ ] データ損失が許容範囲内（RPO目標）
- [ ] 復旧時間が目標内（RTO目標: 4時間以内）

**RTO/RPO目標:**
| 指標 | 目標値 | 説明 |
|------|--------|------|
| **RTO** | 4時間 | 復旧完了までの最大許容時間 |
| **RPO** | 24時間 | 最大許容データ損失期間 |

---

#### DR-008: 外部サービス障害訓練【2026-01-30追加】

**状況設定:**
> Pineconeが完全停止
> ナレッジ検索機能が利用不可

**訓練の流れ:**

| ステップ | アクション | 担当 | 時間目標 |
|---------|-----------|------|---------|
| 1 | 障害検知・ステータス確認 | オンコール | 5分 |
| 2 | フォールバックモード有効化 | 開発 | 10分 |
| 3 | ユーザーへの機能制限告知 | マネージャー | 15分 |
| 4 | 代替応答モードの動作確認 | 開発 | 20分 |
| 5 | 復旧監視（定期的にステータス確認） | オンコール | 継続 |
| 6 | フォールバック解除・正常化 | 開発 | 復旧後 |

**参照手順:** OPERATIONS_RUNBOOK.md セクション12.2

**評価基準:**
- [ ] 10分以内にフォールバックモードが有効化
- [ ] ユーザーへの告知が適切
- [ ] 機能制限状態でも基本応答が可能
- [ ] 復旧後の正常化がスムーズ

---

## 3. 訓練の実施手順

### 3.1 訓練前準備（1週間前）

| # | 項目 | 担当 |
|---|------|------|
| 1 | 訓練日時・シナリオの決定 | SRE |
| 2 | 参加者への通知 | SRE |
| 3 | テスト環境の準備（本番影響なし） | 開発 |
| 4 | 観察者の任命 | SRE |
| 5 | 評価シートの準備 | SRE |

### 3.2 訓練当日

```
【タイムライン例】

09:00 訓練開始宣言
09:05 シナリオ発動（障害注入）
09:05〜 対応開始（参加者は手順書を参照して対応）
      ↓
      観察者は以下を記録：
      - 各ステップの所要時間
      - 手順書との乖離
      - 判断に迷った点
      - 改善提案
      ↓
XX:XX 復旧完了宣言
XX:XX 訓練終了宣言
XX:XX+15 振り返りミーティング（30分）
```

### 3.3 訓練後（1週間以内）

| # | 項目 | 担当 |
|---|------|------|
| 1 | 評価レポート作成 | SRE |
| 2 | 手順書の改善点を反映 | 開発 |
| 3 | 次回訓練計画の更新 | SRE |

---

## 4. 評価基準

### 4.1 共通評価項目

| 項目 | 評価基準 | 配点 |
|------|---------|------|
| **検知速度** | アラートから認識まで5分以内 | 20点 |
| **初動速度** | 最初のアクションまで10分以内 | 20点 |
| **手順書遵守** | OPERATIONS_RUNBOOKに従って対応 | 20点 |
| **復旧時間** | 目標時間内に復旧 | 20点 |
| **報告品質** | 正確で簡潔な報告 | 20点 |

### 4.2 評価レベル

| スコア | レベル | 判定 |
|--------|--------|------|
| 90-100 | A | 優秀 - 現状維持 |
| 70-89 | B | 良好 - 軽微な改善 |
| 50-69 | C | 要改善 - 手順書見直し |
| 0-49 | D | 不合格 - 再訓練必須 |

---

## 5. 訓練スケジュール

### 5.1 年間スケジュール

| 月 | 訓練 | シナリオ |
|----|------|---------|
| 1月 | 定期訓練 | DR-001（API応答遅延） |
| 2月 | - | - |
| 3月 | 四半期訓練 | DR-002（DB接続障害） |
| 4月 | 定期訓練 | DR-001 |
| 5月 | - | - |
| 6月 | 半期訓練 | DR-005（全サービス停止） |
| 7月 | 定期訓練 | DR-003（LLM APIエラー） |
| 8月 | - | - |
| 9月 | 四半期訓練 | DR-004（ChatWork連携障害） |
| 10月 | 定期訓練 | DR-001 |
| 11月 | - | - |
| 12月 | 半期訓練 | DR-006（データ漏洩） |

### 5.2 訓練頻度まとめ

| シナリオ | 頻度 | 次回予定 |
|---------|------|---------|
| DR-001（API応答遅延） | 月次 | - |
| DR-002（DB接続障害） | 四半期 | - |
| DR-003（LLM APIエラー） | 四半期 | - |
| DR-004（ChatWork連携） | 四半期 | - |
| DR-005（全サービス停止） | 半期 | - |
| DR-006（データ漏洩） | 半期 | - |
| DR-007（バックアップ復旧） | 四半期 | - |
| DR-008（外部サービス障害） | 四半期 | - |

---

## 6. 訓練記録テンプレート

```markdown
# 障害訓練記録

## 基本情報

- **訓練日時:** YYYY-MM-DD HH:MM - HH:MM
- **シナリオ:** DR-XXX
- **参加者:**
- **観察者:**

## タイムライン

| 時刻 | イベント | 担当 | 備考 |
|------|---------|------|------|
| HH:MM | 訓練開始 | - | |
| HH:MM | 障害検知 | - | |
| ... | ... | ... | ... |
| HH:MM | 復旧完了 | - | |
| HH:MM | 訓練終了 | - | |

## 評価

| 項目 | スコア | コメント |
|------|--------|---------|
| 検知速度 | /20 | |
| 初動速度 | /20 | |
| 手順書遵守 | /20 | |
| 復旧時間 | /20 | |
| 報告品質 | /20 | |
| **合計** | **/100** | |

## 改善点

1.
2.
3.

## 手順書への反映事項

- [ ]
- [ ]

## 次回訓練への申し送り

-
```

---

## 7. 関連ドキュメント

| ドキュメント | 参照内容 |
|-------------|---------|
| OPERATIONS_RUNBOOK.md | 障害対応手順 |
| SECURITY_AUDIT_ORGANIZATION_ID.md | データ漏洩リスク |
| CLAUDE.md | 緊急時の優先度判断 |

---

## 更新履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-30 | 初版作成 |

---

**このファイルについての質問は、SRE / インフラ担当に連絡してください。**
