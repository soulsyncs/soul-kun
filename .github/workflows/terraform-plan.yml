name: Terraform Plan

# =============================================================================
# P18 Phase D: Terraformå¤‰æ›´å·®åˆ†ã®è‡ªå‹•è¡¨ç¤º
#
# ç›®çš„:
#   PRã§terraform/é…ä¸‹ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã€ã€Œä½•ãŒå¤‰ã‚ã‚‹ã‹ã€ã‚’è‡ªå‹•ã§PRã‚³ãƒ¡ãƒ³ãƒˆã«è¡¨ç¤ºã™ã‚‹ã€‚
#   ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´ã®å†…å®¹ã‚’å…¨å“¡ãŒãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
#
# å‹•ä½œ:
#   1. terraform/é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸPRã‚’æ¤œçŸ¥
#   2. terraform fmtï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèªï¼‰
#   3. terraform validateï¼ˆè¨­å®šã®æ–‡æ³•ãƒã‚§ãƒƒã‚¯ï¼‰
#   4. terraform planï¼ˆå¤‰æ›´å·®åˆ†ã‚’è¨ˆç®—ï¼‰
#   5. PRã®ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦å·®åˆ†ã‚’æŠ•ç¨¿
#
# v11.2.3: åˆç‰ˆä½œæˆï¼ˆP18 Phase Dï¼‰
# =============================================================================

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'terraform/**'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: terraform-plan-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  terraform-plan:
    name: Terraform Planï¼ˆå¤‰æ›´å·®åˆ†ç¢ºèªï¼‰
    runs-on: ubuntu-latest

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Terraform ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"

      # -------------------------------------------------------------------------
      # GCPèªè¨¼ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼æ–¹å¼ï¼‰
      # â€» GitHub Secrets ã« GCP_CREDENTIALS_JSON ã‚’ç™»éŒ²ã™ã‚‹ã¨æœ‰åŠ¹ã«ãªã‚Šã¾ã™
      # â€» æœªç™»éŒ²ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆterraform planã¯backend=falseã§å®Ÿè¡Œï¼‰
      # å°†æ¥çš„ã«ã¯ Workload Identity Federationï¼ˆé•·æœŸéµä¸è¦ã®æ–¹å¼ï¼‰ã¸ã®ç§»è¡Œã‚’æ¨å¥¨
      # -------------------------------------------------------------------------
      - name: GCPèªè¨¼
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}
        continue-on-error: true

      # -------------------------------------------------------------------------
      # terraform fmt: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      # ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚„ã‚¹ãƒšãƒ¼ã‚¹ãŒæ­£ã—ã„ã‹ç¢ºèªï¼‰
      # -------------------------------------------------------------------------
      - name: terraform fmtï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèªï¼‰
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: terraform
        continue-on-error: true

      # -------------------------------------------------------------------------
      # terraform init: åˆæœŸåŒ–
      # GCP_CREDENTIALS_JSON ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯GCSãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã€
      # æœªç™»éŒ²ã®å ´åˆã¯ -backend=false ã§ãƒ­ãƒ¼ã‚«ãƒ«åˆæœŸåŒ–
      # -------------------------------------------------------------------------
      - name: terraform init
        id: init
        run: |
          if [ -n "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
            terraform init
          else
            terraform init -backend=false
          fi
        working-directory: terraform

      # -------------------------------------------------------------------------
      # terraform validate: æ–‡æ³•ãƒã‚§ãƒƒã‚¯
      # ï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«é–“é•ã„ãŒãªã„ã‹ç¢ºèªï¼‰
      # -------------------------------------------------------------------------
      - name: terraform validate
        id: validate
        run: terraform validate
        working-directory: terraform

      # -------------------------------------------------------------------------
      # terraform plan: å¤‰æ›´å·®åˆ†è¨ˆç®—
      # ï¼ˆå®Ÿéš›ã«ã¯å¤‰æ›´ã›ãšã€ã€Œä½•ãŒå¤‰ã‚ã‚‹ã‹ã€ã ã‘ã‚’è¡¨ç¤ºï¼‰
      # â€» -backend=false ã®ãŸã‚æ—¢å­˜ state æœªå‚ç…§ã€‚å·®åˆ†ã¯å‚è€ƒå€¤ã¨ã—ã¦æ‰±ã£ã¦ãã ã•ã„
      # -------------------------------------------------------------------------
      - name: terraform planï¼ˆå¤‰æ›´å·®åˆ†è¨ˆç®—ï¼‰
        id: plan
        run: |
          terraform plan -no-color -lock=false 2>&1 | head -500
        working-directory: terraform
        continue-on-error: true

      # -------------------------------------------------------------------------
      # PRã‚³ãƒ¡ãƒ³ãƒˆã«çµæœã‚’æŠ•ç¨¿
      # -------------------------------------------------------------------------
      - name: PRã«Terraformçµæœã‚’æŠ•ç¨¿
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN_OUTPUT: ${{ steps.plan.outputs.stdout }}
          FMT_RESULT: ${{ steps.fmt.outcome }}
          VALIDATE_RESULT: ${{ steps.validate.outcome }}
          PLAN_RESULT: ${{ steps.plan.outcome }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fmt = process.env.FMT_RESULT === 'success' ? 'âœ…' : 'âŒ';
            const validate = process.env.VALIDATE_RESULT === 'success' ? 'âœ…' : 'âŒ';
            const plan = process.env.PLAN_RESULT === 'success' ? 'âœ…' : 'âš ï¸';

            const output = `## ğŸ—ï¸ Terraformå¤‰æ›´å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆ

            | ãƒã‚§ãƒƒã‚¯é …ç›® | çµæœ |
            |------------|------|
            | ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèª | ${fmt} |
            | æ–‡æ³•ãƒã‚§ãƒƒã‚¯ | ${validate} |
            | å¤‰æ›´å·®åˆ†è¨ˆç®— | ${plan} |

            <details>
            <summary>ğŸ“‹ å¤‰æ›´å·®åˆ†ã®è©³ç´°ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>

            \`\`\`hcl
            ${process.env.PLAN_OUTPUT || 'ï¼ˆå·®åˆ†ãªã—ï¼‰'}
            \`\`\`

            </details>

            > **æ³¨æ„**: ã“ã®Planã¯èª­ã¿å–ã‚Šå°‚ç”¨ã§ã™ã€‚å®Ÿéš›ã®ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´ã¯æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ã¿è¡Œã‚ã‚Œã¾ã™ã€‚
            > å¤‰æ›´ã‚’æœ¬ç•ªã«é©ç”¨ã™ã‚‹ã«ã¯ã€ãƒãƒ¼ã‚¸å¾Œã«æ‰‹å‹•ã§ \`terraform apply\` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            > âš ï¸ ã“ã®Planã¯æ—¢å­˜stateæœªå‚ç…§ï¼ˆ-backend=falseï¼‰ã®ãŸã‚ã€å®Ÿéš›ã®å·®åˆ†ã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

            *æœ€çµ‚æ›´æ–°: ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}*`;

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã—ã¦æ›´æ–°ï¼ˆåŒã˜PRã«è¤‡æ•°ã‚³ãƒ¡ãƒ³ãƒˆã—ãªã„ï¼‰
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Terraformå¤‰æ›´å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆ')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: output
              });
            }

      # -------------------------------------------------------------------------
      # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°å¤±æ•—ã«ã™ã‚‹
      # -------------------------------------------------------------------------
      - name: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ç¢ºèª
        if: steps.fmt.outcome == 'failure'
        run: |
          echo "âŒ Terraformã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒå´©ã‚Œã¦ã„ã¾ã™"
          echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š"
          echo "  cd terraform && terraform fmt"
          exit 1
