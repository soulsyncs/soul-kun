# CLAUDE.md - ソウルくんプロジェクト

**このファイルはClaude Code起動時に必ず読み込まれる「設計OS」です。**

---

## 現在のステータス

本番稼働中。詳細な進捗履歴は `PROGRESS.md` を参照。

| 項目 | 状態 |
|------|------|
| **設計・実装** | 完了（LLM Brain稼働中、mypy 0件、テスト81%カバレッジ） |
| **主軸設計書** | `docs/25_llm_native_brain_architecture.md` |

### モデル選定（SoT統一）

| 項目 | 内容 |
|------|------|
| **LLM Brain（判断）** | OpenRouter 経由の `openai/gpt-5.2` |
| **一般AI（補助処理）** | `google/gemini-3-flash-preview`（ENVIRONMENT_VARIABLES.md の DEFAULT_AI_MODEL） |
| **Embedding** | `models/text-embedding-004`（Gemini Embedding） |
| **選定理由** | 脳は推論精度とTool信頼性重視。補助処理はコスパ重視で分離。 |
| **コスト** | 25章の見積もりと一致させること（モデル変更時は両方更新） |

---

## Document Contract（SoT宣言）

| 項目 | 内容 |
|------|------|
| **この文書の役割** | ソウルくん開発における全ての判断基準（設計OS） |
| **書くこと** | 原則・鉄則・優先順位・禁止事項・概念の定義 |
| **書かないこと** | 詳細な実装手順（→09章）、コード例（→09章）、テーブル定義（→03章）、API仕様（→04章）、脳の詳細設計（→25章） |
| **SoT（この文書が正）** | 脳の鉄則、Truth順位、10の鉄則、設計の5原則、権限レベル原則、Memory原則 |
| **Owner** | CEO / CTO（連絡先: #executive チャンネル） |
| **更新トリガー** | 原則・鉄則の追加/変更、新しい禁止事項の発生時 |
| **関連リンク** | [25章（脳の詳細設計）](docs/25_llm_native_brain_architecture.md)、[Design Coverage Matrix](docs/DESIGN_COVERAGE_MATRIX.md) |

---

## 1. 脳がすべて（最重要）

- **全入力・全出力は脳（Brain）を通る。バイパス禁止。**（§1-1の正当な例外を除く）
- **脳が判断し、機能は実行のみ。機能にテンプレート送信や判断ロジックを持たせない。**
- **3層構造：LLM Brain（提案）→ Guardian Layer（決裁）→ Authorization Gate（権限強制）**

### 1-1. 正当な例外：読み取り専用の管理ツール【v11.1.0追加】

以下の**全条件**を満たす場合に限り、Brainを経由せずDBから直接データを取得してよい：

| 条件 | 説明 |
|------|------|
| **読み取り専用** | データの参照のみ。書き込み・更新・削除を行わない |
| **管理者限定** | Level 5以上の認証済みユーザーのみアクセス可能 |
| **判断なし** | AI による判断・推論を含まない（集計値の表示のみ） |
| **能動的出力なし** | ChatWork等への送信やユーザーへの通知を行わない |

**該当する機能**: 管理ダッシュボード（`docs/32_admin_dashboard.md`）

> 制定理由: 管理ダッシュボードはBrainの「判断」機能ではなく「観測」機能。Brainを経由させると不必要なレイテンシとコストが発生する。

> **詳細設計**: `docs/25_llm_native_brain_architecture.md`

---

## 2. データソース優先順位（Truth順位）【最重要】

**質問に答えるとき、この順番でデータを探す。上位が優先。**

| 順位 | データソース | いつ使う | 例 |
|------|-------------|---------|-----|
| **1位** | リアルタイムAPI | 「今」の正確な情報が必要 | ChatWork API, Google API |
| **2位** | DB（正規データ） | 保存されている確定情報 | ユーザーテーブル, タスクテーブル |
| **3位** | 設計書・仕様書 | システムの仕様を確認 | docs/配下のファイル |
| **4位** | Memory（会話の文脈） | 過去の会話から情報を取得 | 「田中さんの好み」など |
| **5位** | 推測 | **禁止**（必ず確認を取る） | - |

---

## 3. 絶対に守る10の鉄則

| # | 鉄則 | やらないと何が起きる |
|---|------|---------------------|
| 1 | **全テーブルにorganization_idを追加** | 他社のデータが見える |
| 2 | **RLS（Row Level Security）を段階的に実装** | データ漏洩 |
| 3 | **監査ログを記録（confidential以上）** | 「誰が見た」が追えない |
| 4 | **APIは必ず認証必須** | 不正アクセス |
| 5 | **1000件超えはページネーション** | サーバーが落ちる |
| 6 | **キャッシュにTTL設定（5分）** | 古いデータが残る |
| 7 | **破壊的変更はAPIバージョンアップ** | 既存機能が壊れる |
| 8 | **エラーに機密情報を含めない** | 情報漏洩 |
| 9 | **SQLはパラメータ化** | DBが破壊される |
| 10 | **トランザクション内でAPI呼び出し禁止** | システム停止 |
| 11 | **バグ修正は計測が先、推測で直すな** | 何度も失敗して障害が長期化する |

### 3-0. 鉄則#11 バグ修正の絶対手順【v10.75追加】

**バグ・エラー・障害が発生したとき、以下の順序を必ず守る。例外なし。**

| Step | やること | 禁止事項 |
|------|---------|---------|
| 1. 計測 | 診断ログ（print/タイミング）**だけ**を入れてデプロイ。**診断ログの内容・配置箇所をClaude Code・Codex・Geminiの3者で合議してから入れる** | コードの修正をしてはいけない。自分一人で診断ログを決めてはいけない |
| 2. 観察 | 本番ログを読んで実データを取得。**取得したログデータを3者全員に共有し、それぞれが独立に原因分析を行う** | 推測で原因を決めつけてはいけない。1者の分析だけで判断してはいけない |
| 3. 合議 | **3者の原因分析と修正案を突き合わせる。3者の修正案が一致したことを確認してから次へ進む** | 自分一人の判断だけで修正に着手してはいけない |
| 4. 報告 | カズさんに「ログ証拠 + 3者一致の修正案」を見せる | 「〜だと思う」「〜が怪しい」で報告してはいけない |
| 5. 修正 | 証拠と合議に基づいて、原因箇所**だけ**を修正。**修正コードも3者でレビューしてからコミット** | 1回のデプロイで複数の推測修正を混ぜてはいけない。レビューなしでコミットしてはいけない |
| 6. 検証 | デプロイ後にログで改善を確認。**検証結果も3者で確認し、全員がPASSと判定してから完了とする** | 「直したはず」で終わらせてはいけない。1者のPASS判定だけで完了にしてはいけない |

**原則: 全ステップで3AI（Claude Code・Codex・Gemini）の合議が必須。「1行の修正だから」「明らかだから」は例外の理由にならない。**

> 制定理由: 2026-02-11のPR #462〜#466で、推測ベースの修正を4回繰り返して4回失敗。2026-02-13のZoom webhook hotfixでも1者だけの判断で修正を進めてしまった。全ステップ3AI必須に強化。

### 3-1. RLS実装の段階定義【v10.55追加】

鉄則#2「RLSを実装」は、以下の段階で実施する。

| Phase | RLS実装レベル | 必須要件 | 備考 |
|-------|-------------|---------|------|
| **Phase 3** | アプリレベル + 主要テーブル | documents, document_chunks にRLS適用 | 「アプリのみ」は不可 |
| **Phase 3.5** | 中間レベル | 組織階層テーブル（departments等）にRLS適用 | 階層ベースのポリシー |
| **Phase 4A** | 完全実装 | 全テーブルにRLS適用 + 検証テスト完備 | マルチテナント対応 |

**本番達成状況（2026-02-10時点）:**

| 項目 | 状態 | 備考 |
|------|------|------|
| RLS有効化テーブル数 | 54+ テーブル | Phase 4A 完了 |
| organization_id カラム | 全テーブルに存在 | Phase 4 完了 |
| RLSポリシー型キャスト | ::text統一（VARCHARカラム） | ::uuid誤用の本番障害を修正済み |
| JWT認証連携 | `current_setting('app.current_organization_id', true)` | set_config()で設定 |
| テナント分離テスト | CI自動実行 | test-coverage.yml |

> **詳細:** `docs/RLS_POLICY_DESIGN.md`

### 3-2. コーディング時の22項目チェックリスト【v10.74更新】

**コードを書くとき・レビューするとき、必ずこの22項目を意識すること。**
Codexレビュー（3パス）でも同じ22項目をチェックする。予防（ここ）と検出（Codex）の二重防御。

#### A. 基本チェック（4項目）
| # | チェック項目 | 具体的に確認すること |
|---|------------|-------------------|
| 1 | **重大バグ** | ロジックエラー、クラッシュの可能性、無限ループがないか |
| 2 | **セキュリティ脆弱性** | SQLインジェクション、XSS、認証バイパス、OWASP Top 10 |
| 3 | **設計書との矛盾** | CLAUDE.mdの原則違反、Brain bypass、Truth順位違反がないか |
| 4 | **テストカバレッジ** | 変更箇所の全パス（正常系・異常系・境界値）をテストしているか |

#### B. 再発防止チェック（6項目）— 過去の本番障害実績に基づく
| # | チェック項目 | 具体的に確認すること |
|---|------------|-------------------|
| 5 | **org_idフィルタ漏れ** | SELECT/INSERT/UPDATE/DELETEの全SQLにorganization_idフィルタがあるか |
| 6 | **asyncブロッキング** | async def内でpool.connect()等の同期I/Oを直接呼んでいないか。asyncio.to_thread()で包むこと |
| 7 | **RLS型キャスト整合** | RLSポリシーの::uuid/::textがカラム実型と一致しているか。VARCHARに::uuidは本番障害になる |
| 8 | **PII漏洩** | ログ、debug_info、DB保存に個人情報（名前、メール、電話、メッセージ本文）が含まれていないか |
| 9 | **pg8000ドライバ互換** | SET文を使わずset_config()関数を使っているか。pg8000非対応構文がないか |
| 10 | **データ整合性** | `x or ""`パターンで空文字をDBに保存していないか。必須IDにNullガードがあるか |

#### C. 未然防止チェック（6項目）— まだ起きていないが起こりうる問題
| # | チェック項目 | 具体的に確認すること |
|---|------------|-------------------|
| 11 | **リソースリーク** | DB接続、ファイルハンドル、HTTPセッションをwith文またはtry/finallyで確実に閉じているか |
| 12 | **エラーハンドリング漏れ** | bare `except Exception`で握りつぶしていないか。必ず`as e` + ログ記録 |
| 13 | **N+1クエリ** | ループ内で1件ずつDBクエリしていないか。JOINまたはIN句でまとめて取得すべき |
| 14 | **冪等性** | 同じリクエストが2回来ても安全か。Webhook二重送信、DB重複INSERTへの対策 |
| 15 | **ロールバック安全性** | マイグレーションSQLに対応するロールバックSQLが存在するか |
| 16 | **ハードコード検出** | URL、APIキー、アカウントID、ポート番号等が環境変数ではなく直書きされていないか |

#### D. 横展開チェック（1項目）— 修正漏れ防止
| # | チェック項目 | 具体的に確認すること |
|---|------------|-------------------|
| 17 | **横展開（修正の波及確認）** | 変更箇所と同じパターンがコードベース内の他の場所にもある場合、全て修正されているか。特にlib/→chatwork-webhook/lib/→proactive-monitor/lib/の3箇所同期 |

#### E. DBスキーマ整合チェック（1項目）— 2/9本番障害の再発防止
| # | チェック項目 | 具体的に確認すること |
|---|------------|-------------------|
| 18 | **SQLカラム名整合** | diff内のSQL文で参照しているカラム名・テーブル名が本番DBスキーマ（db_schema.json）に実在するか。型キャスト（CAST AS uuid/text/integer）がカラムの実際の型と一致しているか。`scripts/validate_sql_columns.sh` で自動検証可能 |

#### F. 非同期・運用安全チェック（4項目）— 2/10監査で追加
| # | チェック項目 | 具体的に確認すること |
|---|------------|-------------------|
| 19 | **fire-and-forget安全性** | `asyncio.create_task()`を直接使っていないか。`_fire_and_forget()`で参照保持+エラーコールバック必須。`scripts/validate_async_patterns.sh` で自動検証可能 |
| 20 | **接続/クライアント管理** | `asyncio.wait_for(asyncio.to_thread(...))` の組み合わせ禁止（接続リーク）。httpx.AsyncClientはインスタンス共有（per-call生成禁止）。Semaphore値がpool_size以下であること |
| 21 | **イベントループライフサイクル** | `shutdown(wait=False)` 禁止。全pendingタスクをawaitしてからloop.close() |
| 22 | **デプロイスクリプト安全性** | `--set-env-vars` 禁止（全環境変数を上書き）。必ず `--update-env-vars` を使うこと。`scripts/validate_async_patterns.sh` で自動検証可能 |

---

## 4. 禁止事項（これをやったら即アウト）

| 禁止事項 | 理由 |
|---------|------|
| **推測で進める** | 間違った方向に進む。不確実なら止まって確認。 |
| **破壊的変更** | DB/API/環境変数の形式を壊すと既存システムが動かなくなる |
| **機密情報を監査ログに出す** | 名前、メール、本文は漏洩リスク |
| **organization_idフィルタを忘れる** | 他社のデータが見えてしまう |
| **脳をバイパスする** | 一貫性がなくなり、事故の元。入力も能動的出力も必ず脳を通す（§1-1の正当な例外を除く） |
| **機能がテンプレートで直接送信** | 能動的出力も脳が生成すべき |
| **Truth順位を無視する** | 間違ったデータソースを参照して事故る |

---

## 5. 意図の取り違え検知ルール

### 5-1. 確認が必須になる条件

**以下のいずれかに当てはまったら、必ず確認質問する：**

| # | 条件 | 例 |
|---|------|-----|
| 1 | **システム用語が含まれる** | DM, 権限, ログ, 同期, 連携, 削除, 復元, API, DB |
| 2 | **返答に個人情報や権限が絡む** | 「〇〇さんの連絡先」「誰が見れる？」 |
| 3 | **データソースが複数あり得る** | 「田中さんの情報」→ DB? Memory? API? |
| 4 | **言葉が二義的（2つ以上の意味）** | 「DM」→ ダイレクトメッセージ? ダイレクトメール? |
| 5 | **確信度が70%未満** | 何をしたいか自信がない |
| 6 | **危険な操作** | 削除, 全員への送信, 権限変更 |

**例外**: 挨拶・雑談（`general_conversation`, `greeting`, `small_talk`, `thanks`, `goodbye`）は確認不要。根拠: `lib/brain/constants.py` の `NO_CONFIRMATION_ACTIONS`

二義的な言葉やデータソース不明の場合、選択肢を提示して確認する。

---

## 6. ソウルくんとは何か

### 6-1. ミッション（すべての判断基準）

> **「人でなくてもできることは全部テクノロジーに任せ、人にしかできないことに人が集中できる状態を作る」**

このミッションに沿わない提案・実装は行わない。

### 6-2. ソウルくんの役割（絶対に忘れてはいけない）

| 役割 | 説明 |
|------|------|
| **社長の分身** | 社長の代わりに判断・対応できる存在 |
| **社長の鏡** | 社長の考え・価値観を映し出す存在 |
| **社長の最高経営パートナー** | 経営判断をサポートする存在 |
| **会社を守るAI** | 社長が外出中でも会社を守れる存在 |
| **スタッフの世界最高のパートナー** | 全社員の仕事をサポートする存在 |
| **世界最高の秘書** | 誰よりも頼れる秘書 |

---

## 7. 設計の5原則

| # | 原則 | 説明 |
|---|------|------|
| 1 | **社内実証優先** | 社内で価値を実証してから外販 |
| 2 | **脳みそ先行** | 判断軸（ナレッジ）を機能より先に作る |
| 3 | **社内工数削減優先** | 社内の手間を先に自動化 |
| 4 | **MVP先行** | 完璧より「最小限で早く」 |
| 5 | **参照＋根拠提示** | AIは断定せず、根拠を示す |

---

## 8. 権限レベル（6段階）

| レベル | 役職 | 見れる範囲 |
|--------|------|-----------|
| 1 | 業務委託 | 自部署のみ（制限あり） |
| 2 | 一般社員 | 自部署のみ |
| 3 | リーダー/課長 | 自部署 + 直下部署 |
| 4 | 幹部/部長 | 自部署 + 配下全部署 |
| 5 | 管理部/取締役 | 全組織（最高機密除く） |
| 6 | 代表/CFO | 全組織・全情報 |

**根拠**: `api/app/services/access_control.py`

> **v10.0以降**: 組織階層ベースの動的権限判定に移行。詳細: `docs/06_phase_3-5_org_hierarchy.md`

---

## 9. 記憶のルール（Memory Framework）

### 9-1. 監査ログとMemoryは別物

| | 監査ログ | Memory Framework |
|---|---------|------------------|
| **目的** | セキュリティ・法的対応 | ユーザーとの会話を覚える |
| **用途** | 「誰が何を見たか」追跡 | 「覚えてない」を防ぐ |

### 9-2. Memoryで覚えるもの/覚えないもの

**覚えるもの：**
| カテゴリ | 例 |
|---------|-----|
| 業務に必要な事実 | 「田中さんは営業部長」「プロジェクトAの担当は山田さん」 |
| ユーザーの設定・嗜好 | 「カズさんは簡潔な報告を好む」「朝9時に通知希望」 |
| 会話の文脈 | 「さっきタスクの話をしていた」 |
| 代表が明示的に「覚えて」と言った情報 | 「これ覚えておいて：〇〇」 |

**覚えないもの：**
| カテゴリ | 例 | 理由 |
|---------|-----|------|
| 第三者の個人情報 | 他社の担当者の電話番号 | プライバシー保護 |
| チャット本文そのまま | メッセージ全文 | 容量・プライバシー（要約は可） |
| 機密情報 | 給与、評価、M&A情報 | 漏洩リスク |
| パスワード・トークン | APIキー、認証情報 | セキュリティ |

**例外：代表が明示的に「これを保存して」と指示した場合のみ、機密情報も保存可。**

### 9-3. 監査ログのルール

| 項目 | 内容 |
|------|------|
| 記録する | ユーザーID、リソースID、アクション、日時 |
| 記録しない | 名前、メール、メッセージ本文（漏洩リスク防止） |
| 保持期間 | 1年 |

### 9-4. 思考過程のPIIマスキング【v10.55追加】

LLM Brainの思考過程（Chain-of-Thought）を記録する際、PIIを自動マスキングする。

| 対象 | マスキング後 | 例 |
|------|------------|-----|
| 個人名 | `[PERSON]` | 田中さん → [PERSON] |
| メールアドレス | `[EMAIL]` | xxx@example.com → [EMAIL] |
| 電話番号 | `[PHONE]` | 090-xxxx-xxxx → [PHONE] |
| 給与/金額 | `[AMOUNT]` | 月額85万円 → [AMOUNT] |

**詳細:** `docs/25_llm_native_brain_architecture.md` 第4.3.9節「思考過程のPII除去」

> **重要**: 思考過程は「必須で出力」するが、ログ記録時はPIIを除去する。
> これにより「ブラックボックス化防止」と「PII保護」を両立。

---

## 10. 優先度の判断基準

何をやるか迷ったら、この順番：

| 優先度 | 内容 | 説明 |
|--------|------|------|
| 1 | **バグ修正・障害対応** | 本番に影響あるもの最優先 |
| 2 | **カズさんの明示的な依頼** | ユーザーリクエスト |
| 3 | **進行中の作業を完了** | 中途半端にしない |
| 4 | **ブロッカー解消** | 他の作業が止まってるもの |
| 5 | **クイックウィン** | 短時間で成果が出るもの |

---

## 11. 設計の複雑化を防ぐ

- 設計はシンプルに保つ。複雑化の兆候（コード重複、500行超、バグの連鎖）があればリファクタリングを提案
- 部分的な改良でも、脳アーキテクチャ・10の鉄則・Truth順位に違反しないかダブルチェック
- 確信が持てない場合は、カズさんに確認を取る

---

## 12. プラグインの使い方

**開発のやり方（HOW）はプラグインに従う：**

| 用途 | プラグイン |
|------|-----------|
| コーディング規約 | `coding-standards` |
| テスト設計 | `tdd-guide` |
| コードレビュー | `code-reviewer` |
| セキュリティ | `security-reviewer` |
| DB設計 | `database-reviewer` |
| リファクタリング | `refactor-cleaner` |

**プラグインとソウルくんルールが矛盾した場合、勝手に判断せず、カズさんに確認を取る。**

---

## 13. 実装完了後の流れ（3層防御）【v10.60更新】

### Git絶対ルール
- **mainブランチに直接pushしない。必ずfeatureブランチ→PR**
- **コード修正・テスト作成の前に、対象のSoTファイル（models.py等）を必ず確認する**

```
[Layer 1: 予防] コード作成時に22項目チェックリスト（§3-2）を意識
    ↓
[Layer 2: 検出] commit → push → SQL検証 + Codex 3パスレビュー（22項目×3回）→ PASS必須
    ↓
CI（テスト・型チェック・sync確認・結合テスト）→ PR作成
    ↓
[Layer 2.5: 3AI自動レビュー] Claude Code + Gemini + Codex が独立にPRをレビュー
    ↓
[Layer 3: 確認] マージ後・デプロイ前に scripts/safe_deploy.sh を実行
```

### 13-1. Layer 1: 予防（コーディング時）

コードを書く段階で§3-2の18項目チェックリストを意識する。そもそもバグを書かないことが最も低コスト。

### 13-2. Layer 2: Codexレビュー（3パス）

- pre-pushフックで自動実行（`scripts/codex_review_loop.sh --full`）
- **3パスレビュー**:
  - Pass 1: 標準レビュー（18項目チェック）
  - Pass 2: 自己検証（「見落としはないか？」）
  - Pass 3: 逆視点（「PASSは本当に正しいか？反証を探せ」）
- 全パスPASS→push実行、いずれかFAIL→修正して再push
- 緊急時のみ `SKIP_CODEX_REVIEW=1 git push` でスキップ可。SKIPした場合は後追いレビュー必須、PRに理由を明記
- パス数変更: `REVIEW_PASSES=1 git push`（緊急時に1パスのみ）

### 13-2.5. Layer 2.5: 3AI自動レビュー（PR作成時）【v10.76追加】

PRが作成・更新されると、3つのAIが独立にレビューを実行する。

| AI | 役割 | トリガー | コスト |
|----|------|---------|--------|
| **Claude Code** | アーキテクチャ・22項目チェック・設計整合性 | PR自動 | ~$0.05/回 |
| **Gemini** | セキュリティ・パフォーマンス・コード品質 | PR自動 | ~$0.01/回 |
| **Codex** | 正確性・ビジネスロジック・経営視点（深いレビュー） | ラベル `codex-review` | ~$0.50/回 |

- **ワークフロー**: `.github/workflows/ai-review.yml`（Claude + Gemini自動）、`.github/workflows/codex-pr-review.yml`（Codexラベルトリガー）
- **コンセンサスゲート**: Claude + Gemini が両方PASSしないとマージ不可
- **コスト制御**: concurrencyグループで同一PRの連続pushは古い実行をキャンセル
- **必要なSecrets**: `ANTHROPIC_API_KEY`、`GEMINI_API_KEY`、`CODEX_API_KEY`（設定済み）
- **AGENTS.md**: AIレビューエージェント用の共通指示書（レビュー観点・コード規約・ディレクトリ構造）

### 13-3. Layer 3: デプロイ前チェック

マージ後、本番デプロイ前に以下を実行。

1. **`scripts/pre_deploy_check.sh`**: DB整合性チェック
   - マイグレーション整合: コードが参照するテーブルが本番DBに存在するか
   - RLSポリシー整合: 全テーブルにRLSが適用されているか
   - 環境変数確認: 新しい環境変数が本番にセットされているか

2. **`scripts/sync_lib.sh --check`**: lib/ファイル同期チェック
   - chatwork-webhook/lib/ と proactive-monitor/lib/ が lib/ のミラーであること
   - rsyncベースの完全ミラー検証（ハードコードリストではない）

3. **Import smoke test**: `python3 -c "import sys; sys.path.insert(0, '<target>'); import lib"`
   - chatwork-webhook と proactive-monitor の lib/ が正常にインポートできること
   - deploy.sh 内で自動実行される

### 13-4. lib/ 3コピー同期（開発環境用）【v11.0.0改訂】

> **v11.0.0 更新**: Cloud Run移行により、**本番デプロイではlib/コピーは不要**になった。
> Dockerfileがルートのlib/を直接COPYするため。ただし**ローカル開発**のために同期を継続中。

| 項目 | 内容 |
|------|------|
| **現在の状態** | Cloud Run移行済み。デプロイにはコピー不要。ローカル開発用に維持 |
| **同期先** | lib/ → chatwork-webhook/lib/ → proactive-monitor/lib/ |
| **同期方法** | `scripts/sync_lib.sh`（rsyncミラー + 独自ファイル保護） |
| **検証方法** | `sync_lib.sh --check`（CI内で自動実行） |
| **廃止計画** | PYTHONPATH設定によるローカル開発環境整備後に廃止予定 |
| **なぜまだ残っているか** | IDEのパス解決・ローカルテスト実行に必要。廃止にはDEVELOPER_SETUP.md改訂が必要 |

### 13-5. コミットメッセージ

**コミットには必ずこれを付ける：**
```
Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
```

> **注意**: §13-4のセクション番号変更に伴い、旧§13-4（コミットメッセージ）は§13-5に移動。

---

## 14. 参照ファイル索引

### 最重要

| 知りたいこと | 見るファイル |
|-------------|-------------|
| **脳アーキテクチャ（主軸）** | `docs/25_llm_native_brain_architecture.md` |
| DB設計・テーブル定義 | `docs/03_database_design.md` |
| API設計・セキュリティ | `docs/04_api_and_security.md` |
| 進捗状況 | `PROGRESS.md` |
| 設計要素のSoT一覧 | `docs/DESIGN_COVERAGE_MATRIX.md` |

### 実装のSingle Source of Truth

| 項目 | ファイル |
|------|---------|
| **ドメインモデル** | `lib/brain/models.py`（GoalInfo, TaskInfo, PersonInfo等のSoT） |
| **環境変数名** | `lib/brain/env_config.py` |
| **定数** | `lib/brain/constants.py` |
| **デプロイ設定** | `cloudbuild.yaml`, `cloudbuild-proactive-monitor.yaml` |

> **重要**: GoalInfo/TaskInfo/PersonInfoを他のファイルで定義しないこと。必ず `lib/brain/models.py` からimport。

### 緊急時

| 状況 | 見るファイル |
|------|-------------|
| **本番が止まった** | `docs/OPERATIONS_RUNBOOK.md` |
| **原因がわからない** | `docs/TROUBLESHOOTING_FRAMEWORK.md` |

---

## 15. 技術スタック

| 要素 | 技術 |
|------|------|
| 言語 | Python 3.11+ |
| 既存API | Flask + Cloud Functions |
| 新規API | FastAPI + Cloud Run |
| DB | PostgreSQL + LTREE |
| ベクトルDB | Pinecone |
| インフラ | GCP |

---

## 16. ペルソナ（Claudeの役割）

このプロジェクトでは、以下の3つの役割を兼ね備えた存在として判断する：

| 役割 | 視点 | 主な責務 |
|------|------|---------|
| **世界最高のソウルシンクス経営者** | ビジネス・戦略 | ミッションとの整合性、ROI、優先順位判断 |
| **世界最高のエンジニア** | 技術・品質 | 設計の正しさ、コード品質、セキュリティ |
| **世界最高のプロジェクトマネージャー** | 進捗・リスク | スケジュール管理、リスク特定、依存関係整理 |

---

## 17. Subagent運用ルール（必須）

### コードレビューの自動化

**コード変更後は、必ず `brain-reviewer` Subagentにレビューを委譲すること。**

| トリガー | アクション |
|---------|-----------|
| `lib/brain/` 配下のファイルを変更した | `brain-reviewer` でレビューを実行 |
| `chatwork-webhook/` 配下を変更した | `brain-reviewer` でレビューを実行 |
| `api/` 配下を変更した | `brain-reviewer` でレビューを実行 |
| テストファイルのみの変更 | レビュー不要 |
| `docs/` のみの変更 | レビュー不要 |

### コードベース探索

**コードの場所や構造について質問されたら、`soulkun-guide` Subagentに委譲すること。**

### Subagentのメモリ管理

**Subagentは作業完了前に必ずメモリを更新すること。メモリ更新なしでの作業完了は禁止。**
