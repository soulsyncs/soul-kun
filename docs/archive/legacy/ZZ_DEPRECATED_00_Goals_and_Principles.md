> ⚠️ **DEPRECATED - 参照禁止**
>
> このファイルは **`docs/25_llm_native_brain_architecture.md`** に統合されました。
>
> | 統合先 | 25章 第3章「設計原則」 |
> |--------|----------------------|
> | 理由 | LLM常駐型脳アーキテクチャへの統合 |
> | 日付 | 2026-01-30 |
>
> **👉 参照すべきファイル:** [25章 LLM常駐型脳アーキテクチャ](../25_llm_native_brain_architecture.md)

---

# ソウルくん設計憲法 v1.1.0

> **このドキュメントは「単一の信頼できるソース（Single Source of Truth）」です。**
> すべての実装判断はこのドキュメントを参照し、矛盾する変更は禁止されます。

**作成日**: 2026年1月29日
**最終更新**: 2026年1月29日
**承認**: ソウルシンクス

---

## 目次

1. [最上位目的（Why）](#1-最上位目的why)
2. [成功定義（DoD）](#2-成功定義dod)
3. [絶対に守る思想・優先順位](#3-絶対に守る思想優先順位)
4. [データソース優先順位（Truth順位）](#4-データソース優先順位truth順位)
5. [意図の取り違え検知ルール](#5-意図の取り違え検知ルール)
6. [セキュリティ・権限ルール](#6-セキュリティ権限ルール)
7. [ルーティングの大原則](#7-ルーティングの大原則)
8. [確認質問の方針](#8-確認質問の方針)
9. [変えてはいけない領域](#9-変えてはいけない領域)
10. [観測・監査の必須要件](#10-観測監査の必須要件)

---

## 1. 最上位目的（Why）

### 1.1 ミッション

> **「人でなくてもできることは全部テクノロジーに任せ、人にしかできないことに人が集中できる状態を作る」**

**根拠**: `CLAUDE.md` 行35、`docs/01_philosophy_and_principles.md` 行10-15

### 1.2 ソウルくんの役割（絶対に忘れてはいけない）

| 役割 | 説明 |
|------|------|
| **社長の分身** | 社長の代わりに判断・対応できる存在 |
| **社長の鏡** | 社長の考え・価値観を映し出す存在 |
| **社長の最高経営パートナー** | 経営判断をサポートする存在 |
| **会社を守るAI** | 社長が外出中でも会社を守れる存在 |
| **スタッフの世界最高のパートナー** | 全社員の仕事をサポートする存在 |
| **世界最高の秘書** | 誰よりも頼れる秘書 |

**根拠**: `CLAUDE.md` セクション1-2

### 1.3 本質的価値

ソウルくんは単なる業務効率化ツールではなく、**組織構造を理解したアクセス制御**と**AIバックオフィス統合**を提供するシステムである。

**根拠**: `docs/01_philosophy_and_principles.md` 行49

### 1.4 5つの設計原則

| # | 原則 | 説明 |
|---|------|------|
| 1 | **社内実証優先** | 社内で価値を実証してからBPaaSに展開 |
| 2 | **脳みそ先行** | 判断軸（ナレッジ系）を機能（経理系等）より先に作る |
| 3 | **社内工数削減優先** | 外注業務より社内工数業務を先に自動化 |
| 4 | **MVP先行** | 完璧を目指さず、最小限の価値を早く届ける |
| 5 | **参照＋根拠提示** | AIは断定せず、根拠を示して参照させる |

**根拠**: `docs/01_philosophy_and_principles.md` 行67-76、`CLAUDE.md` 行68-77

---

## 2. 成功定義（DoD）

### 2.1 全機能共通の成功定義

- [ ] 10の鉄則をすべて遵守している
- [ ] 機密情報がログ・エラーメッセージに漏洩しない
- [ ] organization_idによるテナント分離が完全に実装されている
- [ ] 回帰テストが通過している
- [ ] セキュリティレビューが完了している

### 2.2 脳アーキテクチャの成功定義

- [ ] すべての入力が脳（BrainProcessor）を通る
- [ ] 確認モードが正しく発動する（確信度 < 0.7）
- [ ] ROUTED_INTENTがログに記録される
- [ ] MVV整合性チェックが機能する

**根拠**: `docs/13_brain_architecture.md` 行103-130、`lib/brain/decision.py` 行11-17

---

## 3. 絶対に守る思想・優先順位

### 3.1 10の鉄則（絶対ルール）

| # | 鉄則 | 補足 | 違反時のリスク |
|---|------|------|--------------|
| 1 | **全テーブルにorganization_idを追加** | テナント分離の前提 | データ漏洩 |
| 2 | **Row Level Security（RLS）を実装** | Phase 4Aで必須 | テナント間データ混在 |
| 3 | **監査ログを全confidential以上の操作で記録** | audit_logsテーブルに記録 | 監査対応不可 |
| 4 | **APIは必ず認証必須** | 例外なし | 不正アクセス |
| 5 | **ページネーションを1000件超えAPIに実装** | limit/offsetを使用 | メモリ爆発 |
| 6 | **キャッシュにTTLを設定（デフォルト5分）** | Redis使用時 | データ不整合 |
| 7 | **破壊的変更時はAPIバージョンアップ** | /api/v1/, /api/v2/ | 既存クライアント破壊 |
| 8 | **エラーメッセージに機密情報を含めない** | ユーザーID、内部パス等 | 情報漏洩 |
| 9 | **SQLインジェクション対策（パラメータ化）** | 直接文字列連結禁止 | DB破壊・データ漏洩 |
| 10 | **トランザクション内でAPI呼び出しをしない** | デッドロック防止 | システム停止 |

**根拠**: `CLAUDE.md` 行91-104、`docs/09_implementation_standards.md` 行324-337

### 3.2 脳アーキテクチャの7つの鉄則

| # | 鉄則 | 説明 | 違反時のリスク |
|---|------|------|--------------|
| 1 | **全入力は脳を通る** | 例外なし。バイパスルート禁止 | 機能ごとに異なる応答、一貫性欠如 |
| 2 | **脳は全記憶にアクセス** | 会話、人物、ナレッジ、タスク、嗜好 | 文脈喪失、「初めまして」の繰り返し |
| 3 | **脳が判断、機能は実行** | 機能に判断ロジックを持たせない | 責務混在、保守性低下 |
| 4 | **機能拡張も脳構造は変わらない** | カタログへの追加のみで対応 | 脳のコード肥大化 |
| 5 | **確認は脳の責務** | 曖昧な場合は脳が確認を判断 | UX断片化 |
| 6 | **状態管理は脳が統一管理** | 各機能が独自状態を持たない | 状態不整合、バグ温床 |
| 7 | **速度より正確性を優先** | 遅くても正確な応答を返す | 誤った動作、信頼喪失 |

**根拠**: `docs/13_brain_architecture.md` 行103-130

### 3.3 権限判定の責務分離

| 担当 | 責務 | 説明 |
|------|------|------|
| **脳（Brain）** | 「やっていいか」を判断 | 操作の許可・確認要否を決める |
| **AccessControl** | 「見せていいか」を強制 | 6段階の権限レベルでデータアクセスを制御 |

**重要：脳が「やっていい」と判断しても、AccessControlが「見せちゃダメ」ならデータは見せない。**

**根拠**: `CLAUDE.md` セクション2-2、`api/app/services/access_control.py`

### 3.4 優先度の判断基準

1. **安全性** > 速度。既存ユーザー影響ゼロ最優先
2. **バグ修正・障害対応** - 本番環境に影響があるもの
3. **ユーザーリクエスト** - 明示的な依頼
4. **進行中フェーズの完了** - 中途半端にしない
5. **依存関係の解消** - 他タスクのブロッカーになっているもの
6. **クイックウィン** - 短時間で成果が出せるもの

**根拠**: `CLAUDE.md` 行272-280

---

## 4. データソース優先順位（Truth順位）【最重要】

**質問に答えるとき、この順番でデータを探す。上位が優先。**

| 順位 | データソース | いつ使う | 例 |
|------|-------------|---------|-----|
| **1位** | リアルタイムAPI | 「今」の正確な情報が必要 | ChatWork API, Google API |
| **2位** | DB（正規データ） | 保存されている確定情報 | ユーザーテーブル, タスクテーブル |
| **3位** | 設計書・仕様書 | システムの仕様を確認 | docs/配下のファイル |
| **4位** | Memory（会話の文脈） | 過去の会話から情報を取得 | 「田中さんの好み」など |
| **5位** | 推測 | **禁止**（必ず確認を取る） | - |

### 4.1 適用例

| 質問 | 正しいデータソース | 理由 |
|------|-------------------|------|
| 「DMできる相手は誰？」 | **1位: ChatWork API** | 接続情報はAPIが持っている |
| 「田中さんの今日のタスクは？」 | **2位: DB** | タスクはDBに保存されている |
| 「この機能の仕様は？」 | **3位: 設計書** | 仕様は設計書に書いてある |
| 「田中さんの好きな食べ物は？」 | **4位: Memory** | 会話で覚えた情報 |
| 「たぶんこうだと思う」 | **5位: 禁止** | 推測はせず、確認を取る |

**根拠**: `CLAUDE.md` セクション3

---

## 5. 意図の取り違え検知ルール

### 5.1 確認が必須になる条件

**以下のいずれかに当てはまったら、必ず確認質問する：**

| # | 条件 | 例 |
|---|------|-----|
| 1 | **システム用語が含まれる** | DM, 権限, ログ, 同期, 連携, 削除, 復元, API, DB |
| 2 | **返答に個人情報や権限が絡む** | 「〇〇さんの連絡先」「誰が見れる？」 |
| 3 | **データソースが複数あり得る** | 「田中さんの情報」→ DB? Memory? API? |
| 4 | **言葉が二義的（2つ以上の意味）** | 「DM」→ ダイレクトメッセージ? ダイレクトメール? |
| 5 | **確信度が70%未満** | 何をしたいか自信がない |
| 6 | **危険な操作** | 削除, 全員への送信, 権限変更 |

### 5.2 確認テンプレート

**二義的な言葉があった場合：**
```
「〇〇」について確認させてください。
これは以下のどちらの意味ですか？

1. [解釈A]（例：ChatWorkで直接メッセージできる相手）
2. [解釈B]（例：過去に1対1で話したことがある相手）
```

**データソースが複数あり得る場合：**
```
「〇〇」の情報を取得します。
以下のどこから取得しますか？

1. [データソースA]（最新の情報）
2. [データソースB]（過去に保存した情報）
```

**根拠**: `CLAUDE.md` セクション4

---

## 6. セキュリティ・権限ルール

### 6.1 6段階の権限レベル

| レベル | 役職 | 見れる範囲 |
|--------|------|-----------|
| 1 | 業務委託 | 自部署のみ（制限あり） |
| 2 | 一般社員 | 自部署のみ |
| 3 | リーダー/課長 | 自部署 + 直下部署 |
| 4 | 幹部/部長 | 自部署 + 配下全部署 |
| 5 | 管理部/取締役 | 全組織（最高機密除く） |
| 6 | 代表/CFO | 全組織・全情報 |

**根拠**: `api/app/services/access_control.py`

### 6.2 機密区分システム

| 区分 | 説明 | アクセス権 | 例 |
|------|------|-----------|-----|
| `public` | 社外にも公開可能 | 全員 | 会社概要 |
| `internal` | 社員なら誰でも閲覧可 | 全社員 | 業務マニュアル、MVV |
| `confidential` | 部門/役職で閲覧制限 | 組織階層で判定 | 就業規則詳細、評価基準 |
| `restricted` | 経営陣のみ | 経営陣のみ | 財務情報、M&A情報 |

**根拠**: `docs/04_api_and_security.md` 行103-125、`CLAUDE.md` 行139-144

### 6.3 階層ベースのアクセス制御（5原則）

1. **動的権限計算**: 固定権限ではなく組織階層から動的に計算
2. **最小権限の原則**: デフォルトは「自部署のみ」
3. **階層継承**: 上位部署は下位部署を見れる（デフォルト）
4. **横展開禁止**: 兄弟部署は見れない（デフォルト）
5. **監査ログ必須**: confidential以上は必ずログに記録

**根拠**: `docs/04_api_and_security.md` 行1283-1335

### 6.4 テナント分離の絶対ルール

```python
# NG: organization_idのフィルタがない
documents = await Document.all()

# OK: 必ずorganization_idでフィルタ
documents = await Document.filter(organization_id=user.organization_id).all()
```

**根拠**: `CLAUDE.md` 行132-138

### 6.5 PII（個人識別情報）の取り扱い

- **ログへのPII出力禁止**: 名前、メールアドレス、本文等をログに出さない
- **エラーメッセージへのPII含有禁止**: ユーザーID、内部パスを含めない
- **監査ログは最小限**: 操作追跡に必要な情報のみ記録

**根拠**: `CLAUDE.md` 行100（鉄則8）、`lib/audit.py` 行24-27

---

## 7. ルーティングの大原則

### 7.1 判断の5ステップ

脳の判断層（`lib/brain/decision.py`）は以下の順序で処理する:

1. **状態チェック**: マルチステップセッション中か、pending操作があるか
2. **機能候補の抽出**: SYSTEM_CAPABILITIESから候補を抽出しスコアリング
3. **確認要否の判断**: 確信度・危険度に基づき確認モードを発動
4. **MVV整合性チェック**: NGパターン検出、トーン適切性
5. **実行コマンドの生成**: アクション名・パラメータ・確信度・理由

**根拠**: `lib/brain/decision.py` 行11-17

### 7.2 理解の6要素

1. **意図（Intent）**: 何をしたいのか
2. **対象（Entity）**: 誰/何について
3. **時間（Time）**: いつのこと
4. **緊急度（Urgency）**: どのくらい急ぎ
5. **感情（Emotion）**: どんな気持ち
6. **文脈（Context）**: 前の会話との繋がり

**根拠**: `lib/brain/understanding.py` 行11-18

### 7.3 スコアリングの重み付け

| 要素 | 重み | 説明 |
|------|------|------|
| キーワードマッチ | 35% | SYSTEM_CAPABILITIESのdecision_keywordsから判定 |
| 意図マッチ | 25% | 理解層の意図とアクションの一致度 |
| 文脈マッチ | 25% | エンティティの存在、過去の会話 |
| 人生軸整合 | 15% | ユーザーの価値観・長期目標との整合性 |

**根拠**: `lib/brain/decision.py` 行768-802

### 7.4 データソース優先ルール

**特定のデータソースを持つアクションは、汎用的なアクションより優先される**:

- `connection_query`（ChatWork接続情報）は、`memory_recall`（汎用記憶）より優先
- ルーティング優先度は `lib/brain/decision.py` の `_apply_priority_override` で制御

**根拠**: `lib/brain/decision.py` 行650-717

### 7.5 ROUTED_INTENTログ

すべてのルーティング結果は以下の形式でログに記録される:

```
ROUTED_INTENT=action_name candidates=[candidate1, candidate2, ...]
```

これにより、誤ルーティング時の原因追跡が可能になる。

**根拠**: `lib/brain/decision.py` 行439-443

---

## 8. 確認質問の方針

### 8.1 確認モードの発動条件

| 条件 | 発動 | 根拠 |
|------|------|------|
| 確信度 < 0.7 | Yes | `CONFIRMATION_THRESHOLD` |
| 危険なアクション（`DANGEROUS_ACTIONS`） | Yes | `DANGEROUS_ACTIONS`定数 |
| リスクレベルが`CONFIRMATION_REQUIRED_RISK_LEVELS`に含まれる | Yes | `RISK_LEVELS`定数 |
| 目標関連で曖昧（確信度 < 0.7かつ「目標」キーワード） | Yes（3択） | v10.45.0で追加 |

**根拠**: `lib/brain/decision.py` 行1079-1133、`lib/brain/constants.py`

### 8.2 確認質問のテンプレート

**通常の確認**:
```
「{ユーザーメッセージ}」は「{機能名}」でいいウル？
[はい / いいえ]
```

**危険な操作の確認**:
```
「{機能名}」は取り消せないウル。本当に実行していいウル？
[はい / いいえ]
```

**目標関連で曖昧な場合（3択）**:
```
目標のことだね 🐺 どれがやりたいウル？
[1️⃣ 新しく目標を作る / 2️⃣ 登録済みの目標を見る/整理する / 3️⃣ 目標の決め方を相談する]
```

**根拠**: `lib/brain/decision.py` 行1098-1127

### 8.3 確認を省略してよいケース

- 確信度 >= AUTO_EXECUTE_THRESHOLD（現在0.85）
- リスクレベルが低い
- 過去に同じ操作を許可した履歴がある

**根拠**: `lib/brain/constants.py`

---

## 9. 変えてはいけない領域

### 9.1 破壊的変更禁止項目

| 項目 | 説明 | 変更時の対応 |
|------|------|------------|
| **DBスキーマ（既存カラム）** | 既存カラムの削除・型変更 | マイグレーションで段階的に移行 |
| **APIレスポンス形式** | 既存フィールドの削除・名前変更 | APIバージョンアップ（/v2/） |
| **環境変数名** | 本番で使用中の環境変数名 | 非推奨化→移行期間→削除 |
| **ログフォーマット** | ROUTED_INTENTなど監視に使用中 | 新形式追加→監視切り替え→旧形式削除 |

**根拠**: `CLAUDE.md` 行99（鉄則7）、`docs/09_implementation_standards.md` 行56-75

### 9.2 APIバージョニングポリシー

- **URL パスベースバージョニング**: `/api/v1/tasks/overdue`
- **破壊的変更時**: 新バージョン作成（/api/v2/）
- **サポート期間**: v1は18ヶ月、v2は24ヶ月以上
- **非推奨化から終了まで**: 最低6ヶ月の移行期間

**根拠**: `docs/09_implementation_standards.md` 行25-129

### 9.3 変更禁止の判断基準

以下のいずれかに該当する場合は「変更禁止」:

1. **本番環境で稼働中**のシステムに影響する
2. **外部クライアント**（ChatWork、Pinecone等）が依存している
3. **監査ログ**に記録されるフォーマット
4. **既存のテスト**が依存しているデータ構造

---

## 10. 観測・監査の必須要件

### 10.1 監査ログとMemoryの違い

| | 監査ログ | Memory Framework |
|---|---------|------------------|
| **目的** | セキュリティ・法的対応 | ユーザーとの会話を覚える |
| **用途** | 「誰が何を見たか」追跡 | 「覚えてない」を防ぐ |
| **記録する** | ユーザーID、リソースID、アクション、日時 | 業務事実、ユーザー設定・嗜好、会話文脈 |
| **記録しない** | 名前、メール、本文（漏洩リスク） | 第三者PII、機密情報、パスワード |
| **保持期間** | 1年 | 1年（または無期限） |

**根拠**: `CLAUDE.md` セクション8

### 10.2 監査ログの記録対象

| 機密区分 | 記録要否 | 記録内容 |
|----------|---------|---------|
| `public` | 任意 | アクションのみ |
| `internal` | 任意 | アクションのみ |
| `confidential` | **必須** | ユーザーID、アクション、リソースID、機密区分 |
| `restricted` | **必須** | 上記 + 詳細ログ |

**根拠**: `CLAUDE.md` 行93（鉄則3）、`lib/audit.py` 行24-27

### 10.3 audit_logsテーブルの必須カラム

```sql
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL,  -- テナントID（必須）
    user_id UUID NOT NULL,          -- 実行ユーザーID
    action VARCHAR(100) NOT NULL,   -- 'view', 'create', 'update', 'delete', 'export'
    resource_type VARCHAR(50) NOT NULL,  -- 'document', 'knowledge', 'user', etc.
    resource_id UUID,               -- リソースID
    department_id UUID,             -- アクセスした部署
    classification VARCHAR(50),     -- 機密区分
    details JSONB,                  -- 詳細情報（PIIは含めない）
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

**根拠**: `docs/09_implementation_standards.md` 行872-906、`lib/audit.py` 行131-161

### 10.4 監査ログに含めてはいけない情報

- ユーザーの名前（user_idのみ）
- メッセージ本文
- パスワード、トークン
- 個人のメールアドレス
- 電話番号

**根拠**: 10の鉄則8（`CLAUDE.md` 行100）

### 10.5 原因追跡に必要なログ

| ログ種別 | 出力例 | 目的 |
|---------|--------|------|
| ROUTED_INTENT | `ROUTED_INTENT=connection_query candidates=[...]` | 誤ルーティング調査 |
| Audit | `📝 Audit logged: view document/doc_123 org=org_soulsyncs` | 操作追跡 |
| Error | `⚠️ Audit log failed (non-blocking): ...` | 障害調査 |

**根拠**: `lib/brain/decision.py` 行439-443、`lib/audit.py` 行164-174

### 10.6 ログの保持期間

| ログ種別 | 保持期間 | 根拠 |
|---------|---------|------|
| 監査ログ | 1年間 | `docs/security_and_bcp_guide.md` 行77-82 |
| アプリケーションログ | 90日 | Cloud Loggingデフォルト |
| エラーログ | 90日 | Cloud Loggingデフォルト |

---

## 付録A: 根拠ファイル一覧

| 項目 | ファイルパス |
|------|------------|
| 設計原則・思想 | `docs/01_philosophy_and_principles.md` |
| 10の鉄則 | `CLAUDE.md` セクション5 |
| データソース優先順位 | `CLAUDE.md` セクション3 |
| 意図取り違え検知 | `CLAUDE.md` セクション4 |
| 6段階権限レベル | `api/app/services/access_control.py` |
| セキュリティ・権限 | `docs/04_api_and_security.md` |
| 実装規約 | `docs/09_implementation_standards.md` |
| 脳アーキテクチャ | `docs/13_brain_architecture.md` |
| 判断層実装 | `lib/brain/decision.py` |
| 理解層実装 | `lib/brain/understanding.py` |
| 監査ログ実装 | `lib/audit.py` |
| 記憶ルール | `CLAUDE.md` セクション8 |
| セキュリティ・BCP | `docs/security_and_bcp_guide.md` |

---

## 付録B: 整合性チェックリスト

実装前に以下を確認すること:

### セキュリティ

- [ ] organization_idでフィルタしているか
- [ ] SQLはパラメータ化されているか
- [ ] エラーメッセージに機密情報がないか
- [ ] confidential以上の操作に監査ログがあるか

### ルーティング

- [ ] ROUTED_INTENTがログに出力されるか
- [ ] 確認モードが正しく発動するか
- [ ] MVV整合性チェックが機能するか
- [ ] Truth順位（データソース優先順位）を守っているか
- [ ] 意図取り違え検知ルールに従っているか

### 互換性

- [ ] 既存APIのレスポンス形式を壊していないか
- [ ] 既存テストが通過するか
- [ ] 環境変数名を変更していないか

---

## 付録C: 改訂履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1.0.0 | 2026-01-29 | 初版作成 |
| v1.1.0 | 2026-01-29 | データソース優先順位（Truth順位）、意図取り違え検知ルール、6段階権限レベル、権限判定の責務分離、記憶ルール詳細を追加 |

---

**このドキュメントについての質問・懸念は、実装前に必ず確認してください。**
**不確実な場合は止まって相談。推測で進めない。**
