# =============================================================================
# Cloud Build è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šï¼ˆproactive-monitor â†’ Cloud Runï¼‰
# =============================================================================
#
# ç›®çš„:
#   mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã«è‡ªå‹•ã§proactive-monitorã‚’Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤
#
# ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼ˆGCPã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è¨­å®šãŒå¿…è¦ï¼‰:
#   - åå‰: proactive-monitor-auto-deploy
#   - ã‚¤ãƒ™ãƒ³ãƒˆ: Push to a branch
#   - ãƒ–ãƒ©ãƒ³ãƒ: ^main$
#   - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚£ãƒ«ã‚¿: proactive-monitor/**, lib/**, cloudbuild-proactive-monitor.yaml
#   - æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«: cloudbuild-proactive-monitor.yaml
#
# v10.53.0: åˆç‰ˆä½œæˆï¼ˆå¤§è¦æ¨¡ä¿®ç¹•å¯¾å¿œï¼‰
# v10.71.0: deploy.sh ã¨æ•´åˆï¼ˆsync_lib.sh, SQLæ¤œè¨¼, traffic routingï¼‰
# v11.0.0: Cloud Runç§»è¡Œï¼ˆDocker build + Artifact Registry + gcloud run deployï¼‰
#          lib/ 3ã‚³ãƒ”ãƒ¼åŒæœŸä¸è¦åŒ–
# =============================================================================

substitutions:
  _REGION: asia-northeast1
  _SERVICE: proactive-monitor
  _REPO: cloud-run
  _TAG: ""  # gcloud builds submit æ™‚ã« --substitutions=_TAG=<sha> ã§æŒ‡å®šã€‚GitHub trigger ã§ã¯ ${_TAG} ã‚’ä½¿ç”¨

steps:
  # =============================================================================
  # Step 1: SQLã‚«ãƒ©ãƒ æ¤œè¨¼ï¼ˆdb_schema.json ã¨ç…§åˆï¼‰
  # =============================================================================
  - name: 'python:3.11-slim'
    id: 'sql-validation'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -eo pipefail
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” SQLã‚«ãƒ©ãƒ æ¤œè¨¼"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        if [ ! -f db_schema.json ]; then
          echo "âš ï¸ db_schema.json ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚SQLæ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          exit 0
        fi

        ./scripts/validate_sql_columns.sh --all
        echo "âœ… SQLã‚«ãƒ©ãƒ æ¤œè¨¼ PASS"

  # =============================================================================
  # Step 2: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ & Artifact Registry ã«ãƒ—ãƒƒã‚·ãƒ¥
  # =============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-build'
    args:
      - 'build'
      - '-f'
      - 'proactive-monitor/Dockerfile'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:${_TAG}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:latest'
      - '.'
    waitFor: ['sql-validation']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-push'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}'
    waitFor: ['docker-build']

  # =============================================================================
  # Step 3: Cloud Run ã«ãƒ‡ãƒ—ãƒ­ã‚¤
  # =============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-cloud-run'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE}'
      - '--image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:${_TAG}'
      - '--region=${_REGION}'
      - '--memory=512Mi'
      - '--timeout=540s'
      - '--no-allow-unauthenticated'
      - '--min-instances=0'
      - '--max-instances=5'
      - '--cpu=1'
      - '--update-env-vars=USE_BRAIN_ARCHITECTURE=true,ENVIRONMENT=production,LOG_EXECUTION_ID=true,OPERATIONS_GCS_BUCKET=soulkun-operations'
      - '--update-secrets=TAVILY_API_KEY=TAVILY_API_KEY:latest'
    waitFor: ['docker-push']

  # =============================================================================
  # Step 4: ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç¢ºèª
  # =============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'traffic-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -eo pipefail
        echo "ğŸ” ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç¢ºèª..."

        LATEST_REV=$$(gcloud run revisions list --service="${_SERVICE}" --region="${_REGION}" \
            --sort-by='~creationTimestamp' --limit=1 --format='value(name)' 2>/dev/null || true)
        TRAFFIC_REV=$$(gcloud run services describe "${_SERVICE}" --region="${_REGION}" \
            --format='value(status.traffic[0].revisionName)' 2>/dev/null || true)

        if [ -n "$$LATEST_REV" ] && [ -n "$$TRAFFIC_REV" ]; then
          if [ "$$LATEST_REV" = "$$TRAFFIC_REV" ]; then
            echo "âœ… ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯: $${LATEST_REV} (100%)"
          else
            echo "âš ï¸ ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒæ—§ãƒªãƒ“ã‚¸ãƒ§ãƒ³: $${TRAFFIC_REV}"
            echo "â†’ æœ€æ–°ãƒªãƒ“ã‚¸ãƒ§ãƒ³ $${LATEST_REV} ã«åˆ‡ã‚Šæ›¿ãˆä¸­..."
            gcloud run services update-traffic "${_SERVICE}" --region="${_REGION}" \
                --to-revisions="$${LATEST_REV}=100" 2>&1
            echo "âœ… ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆå®Œäº†: $${LATEST_REV} (100%)"
          fi
        else
          echo "âš ï¸ ãƒªãƒ“ã‚¸ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã€‚æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„"
        fi
    waitFor: ['deploy-cloud-run']

  # =============================================================================
  # Step 5: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
  # =============================================================================
  - name: 'gcr.io/cloud-builders/curl'
    id: 'notify'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… proactive-monitor Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ã‚³ãƒŸãƒƒãƒˆ: ${_TAG}"
        echo "ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"
        echo "ã‚¤ãƒ¡ãƒ¼ã‚¸: ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:${_TAG}"
        echo ""
        echo "å“è³ªãƒã‚§ãƒƒã‚¯:"
        echo "  âœ… SQLã‚«ãƒ©ãƒ æ¤œè¨¼"
        echo "  âœ… Docker ãƒ“ãƒ«ãƒ‰ & ãƒ—ãƒƒã‚·ãƒ¥"
        echo "  âœ… Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤"
        echo "  âœ… ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç¢ºèª"
        echo ""
    waitFor: ['traffic-check']

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ15åˆ† - Docker buildæ™‚é–“ã‚’è€ƒæ…®ï¼‰
timeout: '900s'

# ãƒ­ã‚°è¨­å®š
options:
  logging: CLOUD_LOGGING_ONLY
