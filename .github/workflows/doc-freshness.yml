name: Documentation Freshness Check

# =============================================================================
# è¨­è¨ˆæ›¸é®®åº¦ãƒã‚§ãƒƒã‚¯
#
# ç›®çš„:
#   è¨­è¨ˆæ›¸ãŒå¤ããªã£ã¦ã„ãªã„ã‹ã‚’å®šæœŸçš„ã«è‡ªå‹•æ¤œè¨¼
#
# ãƒˆãƒªã‚¬ãƒ¼:
#   - æ¯æœˆ1æ—¥9æ™‚ï¼ˆJSTï¼‰ã«è‡ªå‹•å®Ÿè¡Œ
#   - æ‰‹å‹•å®Ÿè¡Œ
#
# è¨­è¨ˆæ›¸å‚ç…§:
#   docs/DOCUMENTATION_FRESHNESS_POLICY.md
# =============================================================================

on:
  schedule:
    # æ¯æœˆ1æ—¥ 9:00 JSTï¼ˆUTC 0:00ï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      threshold_days:
        description: 'è­¦å‘Šé–¾å€¤ï¼ˆæ—¥æ•°ï¼‰'
        required: false
        type: number
        default: 90

jobs:
  check-freshness:
    name: Check Documentation Freshness
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Check last modified dates
        id: freshness
        run: |
          THRESHOLD_DAYS=${{ github.event.inputs.threshold_days || 90 }}
          TODAY=$(date +%s)
          ISSUES_FOUND=0

          echo "# è¨­è¨ˆæ›¸é®®åº¦ãƒ¬ãƒãƒ¼ãƒˆ" > freshness-report.md
          echo "" >> freshness-report.md
          echo "**ç”Ÿæˆæ—¥æ™‚:** $(date '+%Y-%m-%d %H:%M:%S')" >> freshness-report.md
          echo "**è­¦å‘Šé–¾å€¤:** ${THRESHOLD_DAYS}æ—¥" >> freshness-report.md
          echo "" >> freshness-report.md

          echo "## ã‚µãƒãƒªãƒ¼" >> freshness-report.md
          echo "" >> freshness-report.md

          # å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚«ã‚¦ãƒ³ãƒˆ
          OK_COUNT=0
          WARN_COUNT=0
          CRITICAL_COUNT=0

          echo "## è©³ç´°" >> freshness-report.md
          echo "" >> freshness-report.md
          echo "| ãƒ•ã‚¡ã‚¤ãƒ« | æœ€çµ‚æ›´æ–° | çµŒéæ—¥æ•° | çŠ¶æ…‹ |" >> freshness-report.md
          echo "|---------|---------|---------|------|" >> freshness-report.md

          for file in docs/*.md; do
            if [ -f "$file" ]; then
              # æœ€çµ‚æ›´æ–°æ—¥ã‚’å–å¾—
              LAST_MODIFIED=$(git log -1 --format="%ci" -- "$file" 2>/dev/null | cut -d' ' -f1)

              if [ -n "$LAST_MODIFIED" ]; then
                LAST_MODIFIED_TS=$(date -d "$LAST_MODIFIED" +%s 2>/dev/null || echo "0")
                if [ "$LAST_MODIFIED_TS" != "0" ]; then
                  DAYS_AGO=$(( (TODAY - LAST_MODIFIED_TS) / 86400 ))
                else
                  DAYS_AGO=9999
                  LAST_MODIFIED="ä¸æ˜"
                fi
              else
                DAYS_AGO=9999
                LAST_MODIFIED="ä¸æ˜"
              fi

              # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
              if [ "$DAYS_AGO" -gt "$THRESHOLD_DAYS" ]; then
                STATUS="ğŸ”´ è¦ç¢ºèª"
                CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
                ISSUES_FOUND=1
              elif [ "$DAYS_AGO" -gt 60 ]; then
                STATUS="ğŸŸ¡ æ³¨æ„"
                WARN_COUNT=$((WARN_COUNT + 1))
              else
                STATUS="âœ… OK"
                OK_COUNT=$((OK_COUNT + 1))
              fi

              BASENAME=$(basename "$file")
              echo "| $BASENAME | $LAST_MODIFIED | ${DAYS_AGO}æ—¥ | $STATUS |" >> freshness-report.md
            fi
          done

          # ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
          sed -i "/## ã‚µãƒãƒªãƒ¼/a\\
          \\
          | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ä»¶æ•° |\\
          |-----------|------|\\
          | âœ… OK | ${OK_COUNT} |\\
          | ğŸŸ¡ æ³¨æ„ | ${WARN_COUNT} |\\
          | ğŸ”´ è¦ç¢ºèª | ${CRITICAL_COUNT} |\\
          " freshness-report.md

          echo "" >> freshness-report.md
          echo "## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> freshness-report.md
          echo "" >> freshness-report.md

          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "- ğŸ”´ **${CRITICAL_COUNT}ä»¶**ã®è¨­è¨ˆæ›¸ãŒ${THRESHOLD_DAYS}æ—¥ä»¥ä¸Šæ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“" >> freshness-report.md
            echo "- [DOCUMENTATION_FRESHNESS_POLICY.md](docs/DOCUMENTATION_FRESHNESS_POLICY.md) ã«å¾“ã£ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„" >> freshness-report.md
          fi

          if [ "$WARN_COUNT" -gt 0 ]; then
            echo "- ğŸŸ¡ **${WARN_COUNT}ä»¶**ã®è¨­è¨ˆæ›¸ãŒ60æ—¥ä»¥ä¸Šæ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆä»Šå¾Œã®æ³¨æ„ãŒå¿…è¦ï¼‰" >> freshness-report.md
          fi

          if [ "$CRITICAL_COUNT" -eq 0 ] && [ "$WARN_COUNT" -eq 0 ]; then
            echo "- âœ… å…¨ã¦ã®è¨­è¨ˆæ›¸ã¯é©åˆ‡ã«ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™" >> freshness-report.md
          fi

          echo "" >> freshness-report.md
          echo "---" >> freshness-report.md
          echo "" >> freshness-report.md
          echo "**å‚ç…§:** [è¨­è¨ˆæ›¸é®®åº¦ç®¡ç†ãƒãƒªã‚·ãƒ¼](docs/DOCUMENTATION_FRESHNESS_POLICY.md)" >> freshness-report.md

          # çµæœã‚’å‡ºåŠ›
          cat freshness-report.md

          echo "issues_found=$ISSUES_FOUND" >> $GITHUB_OUTPUT
          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "warn_count=$WARN_COUNT" >> $GITHUB_OUTPUT

      - name: Upload freshness report
        uses: actions/upload-artifact@v4
        with:
          name: freshness-report
          path: freshness-report.md
          retention-days: 30

      - name: Generate summary
        run: |
          echo "# è¨­è¨ˆæ›¸é®®åº¦ãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat freshness-report.md >> $GITHUB_STEP_SUMMARY

      - name: Check for critical issues
        if: steps.freshness.outputs.critical_count > 0
        run: |
          echo "::warning::${{ steps.freshness.outputs.critical_count }}ä»¶ã®è¨­è¨ˆæ›¸ãŒé–¾å€¤ã‚’è¶…ãˆã¦å¤ããªã£ã¦ã„ã¾ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚"
