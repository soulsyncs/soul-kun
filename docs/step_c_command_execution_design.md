# Step C: 手足を与える — 安全な操作機能 設計書 v2

**作成日:** 2026-02-17
**更新日:** 2026-02-17
**作成者:** Claude Opus 4.6
**ステータス:** 3AIレビュー反映済み（CEO承認待ち）

---

## この設計書の目的

ソウル君に「自分でパソコンの操作ができる手足」を与えるための設計書です。
例えば「このデータを集計して」「この資料を作って」と言うだけで、
ソウル君が自分で作業して結果を返してくれるようになります。

**これは進化計画の中で最もパワフルだけど、最も慎重にやるべきステップです。**

---

## 3AIレビュー結果と設計変更（v2）

### レビュー実施

| レビュアー | 観点 | 結果 |
|-----------|------|------|
| **Claude** | セキュリティ・アーキテクチャ | CRITICAL 5件、IMPORTANT 9件 |
| **Gemini視点** | 実用性・Cloud Run制約 | BLOCKER 4件、簡素化提案 4件 |

### 最重要の発見（3AI共通）

**「任意のシェルコマンド実行」はCloud Run上で安全に実現できない。**

理由：
1. Cloud Run（gVisor）ではサンドボックスが実質機能しない（seccomp不可、ネットワーク分離不可）
2. `python3 -c "..."`がホワイトリストにあると、Pythonの標準ライブラリ経由で全制限を迂回可能
3. `awk`の`system()`、`find`の`-exec`で任意コマンド実行可能
4. シェルメタ文字（`&&`, `||`, `` ` ``, `$()`等）の体系的な対策が困難
5. プロセスレベルの制限ではカーネルレベルの境界にならない

### 設計方針の変更

| 項目 | 旧（v1） | 新（v2） |
|------|---------|---------|
| **実行方式** | 任意シェルコマンド + ホワイトリスト | **事前登録済みPython関数レジストリ** |
| **セキュリティモデル** | サンドボックス + コマンド検証 | **既存の3層アーキテクチャをそのまま活用** |
| **新ファイル** | command_executor.py + command_validator.py | **operation_registry.py（操作レジストリ）** |
| **複雑度** | 高（シェル解析、メタ文字対策、OS制限） | **低（既存パターンの拡張）** |
| **工期** | 10〜11週間 | **4〜5週間** |

---

## 現在の安全インフラ（既に稼働中）

Step 0で構築済みの安全装置がStep Cでも自動的に働きます。

| 安全装置 | 役割 | ファイル |
|---------|------|---------|
| **承認ゲート（ApprovalGate）** | 危険度に応じて自動実行/社長確認/二重チェックを振り分け | `lib/brain/approval_gate.py` |
| **番人（GuardianLayer）** | 7段階の安全チェック（危険操作、金額、PII等） | `lib/brain/guardian_layer.py` |
| **認可ゲート（AuthorizationGate）** | 価値観・記憶・整合性の3層チェック | `lib/brain/authorization_gate.py` |
| **緊急停止ボタン** | 1タップで全新機能を即停止 | `lib/brain/emergency_stop.py` |
| **監査ログ** | 全実行の記録（誰が・いつ・何を・なぜ・結果） | `lib/brain/audit_bridge.py` |
| **確認フロー** | 社長に「これ実行していい？」と聞く仕組み（10分で期限切れ） | `lib/brain/state_manager.py` |

---

## Step C-1: 操作レジストリ（事前登録方式）

### 何をするか

ソウル君が実行できる「操作メニュー」を作ります。
メニューにない操作は実行できません。メニューの各操作は事前にコードレビュー済みの安全なPython関数です。

### なぜ「任意コマンド実行」ではなく「事前登録方式」か

| 観点 | 任意コマンド実行 | 事前登録方式（採用） |
|------|---------------|-------------------|
| **安全性** | シェル解析・メタ文字・エスケープの全てを防ぐ必要あり | 関数は事前レビュー済み。入力パラメータのみ検証すればOK |
| **Cloud Run互換** | サンドボックスが機能しない（gVisor制約） | 普通のPython関数なので制約なし |
| **既存アーキテクチャ** | 新しいセキュリティ層が必要 | 既存の27個のToolと同じパターン |
| **保守性** | コマンド検証ロジックが複雑 | 関数ごとに単体テスト可能 |
| **価値** | 柔軟だが危険 | CEOのユースケースの90%をカバー |

### 設計方針

```
既存の SYSTEM_CAPABILITIES（27個のTool）
  ↓ 同じパターンで拡張
新しい OPERATION_CAPABILITIES（操作Tool）
  ↓
Brain が意図に応じて操作Toolを選択
  ↓
GuardianLayer → ApprovalGate → AuthorizationGate でチェック
  ↓
事前登録済みのPython関数が実行
  ↓
結果をPII除去してユーザーに返す
```

### 新規ファイル

```
lib/brain/operations/           — 操作関数ディレクトリ
lib/brain/operations/__init__.py
lib/brain/operations/registry.py    — 操作レジストリ（メニュー管理）
lib/brain/operations/data_ops.py    — データ集計・検索操作
lib/brain/operations/report_ops.py  — レポート生成操作
lib/brain/operations/file_ops.py    — ファイル操作（読み取り系）
```

---

## Step C-2: 読み取り系の操作（Phase 1）

### 操作メニュー（読み取りのみ）

| 操作名 | 説明 | 例 | 危険度 |
|--------|------|-----|--------|
| `data_aggregate` | CSVやデータの集計 | 「売上データを合計して」 | 低 |
| `data_search` | データの検索・フィルタ | 「先月の案件を一覧にして」 | 低 |
| `file_list` | ファイル一覧表示 | 「共有フォルダのファイルを見せて」 | 低 |
| `file_read` | ファイル内容の表示 | 「この資料の中身を見せて」 | 低 |
| `text_count` | テキストの集計（行数、文字数等） | 「このファイルは何行？」 | 低 |

### 各操作の安全制約

| 制約 | 内容 |
|------|------|
| **タイムアウト** | 最大30秒（超えたら自動停止） |
| **出力サイズ** | 最大10KB（超えた分は切り詰め） |
| **アクセス範囲** | 専用の作業ディレクトリ + GCS（指定バケット）のみ |
| **ネットワーク** | 関数内では外部通信しない（GCS APIのみ許可） |
| **入力検証** | パラメータは型付きスキーマで検証（パストラバーサル等を防止） |

### SYSTEM_CAPABILITIESへの登録

既存のToolと同じ方法で登録：

```python
# handlers/registry.py に追加
{
    "name": "data_aggregate",
    "description": "データの集計・合計・平均などを計算する",
    "params_schema": {
        "data_source": "集計対象のファイルパスまたはデータ名",
        "operation": "集計方法（sum, avg, count, group_by等）",
        "filters": "フィルタ条件（任意）"
    },
    "requires_confirmation": False,  # 読み取りのみなので自動実行OK
    "required_level": 5,            # 管理者以上
    "risk_level": "low",
}
```

---

## Step C-3: テストと安全性チェック

### 自動テスト項目

| テスト | 確認すること |
|--------|------------|
| 操作レジストリ検証 | 登録された操作だけ実行できるか |
| 未登録操作の拒否 | レジストリにない操作は確実にブロックされるか |
| タイムアウト検証 | 30秒で確実に停止するか |
| 出力サイズ制限 | 10KB超えが切り詰められるか |
| パストラバーサル検証 | `../../etc/passwd` 等の不正パスがブロックされるか |
| パラメータ型検証 | 不正な入力型（int→str等）がブロックされるか |
| PII除去検証 | 出力にパスワード等が含まれないか |
| 3層ゲート統合 | Guardian→Approval→Authorization の全層を通過するか |
| 緊急停止統合 | 緊急停止中は操作が即ブロックされるか |

### 手動テスト（社長と一緒に）

- 「売上データを集計して」→ 正しく集計できるか
- 「共有フォルダのファイル一覧を見せて」→ 正しく表示されるか
- 「サーバーを止めて」→ 未登録操作として確実にブロックされるか
- 緊急停止ボタン → 操作が即座に止まるか

---

## Step C-4: 番人の強化

### 追加するGuardianルール

| ルール | チェック内容 | アクション |
|--------|------------|----------|
| 操作レジストリチェック | 指定された操作がレジストリに登録済みか | BLOCK（未登録） |
| パラメータ長チェック | パラメータが異常に長くないか（>200文字） | CONFIRM |
| 連続実行チェック | 短時間に大量の操作がないか（>5回/分、バースト: >3回/10秒） | BLOCK |
| パス安全性チェック | 許可されたディレクトリ外へのアクセスがないか | BLOCK |
| 日次クォータ | 1日の操作回数上限（読み取り: 50回、書き込み: 20回） | BLOCK（超過） |

### constants.pyへの追加

```python
# lib/brain/constants.py に追加
RISK_LEVELS["data_aggregate"] = "low"
RISK_LEVELS["data_search"] = "low"
RISK_LEVELS["file_list"] = "low"
RISK_LEVELS["file_read"] = "low"
RISK_LEVELS["text_count"] = "low"
RISK_LEVELS["report_generate"] = "medium"    # C-5で追加
RISK_LEVELS["file_create"] = "medium"        # C-5で追加
RISK_LEVELS["csv_export"] = "medium"         # C-5で追加
```

---

## Step C-5: 書き込み系の操作（Phase 2）

### 第2段階で追加する操作

C-2の読み取りが2週間安定稼働した後に開放。

| 操作名 | 説明 | 条件 | 危険度 |
|--------|------|------|--------|
| `report_generate` | レポートを作成 | 出力先はGCSバケットのみ | 中 |
| `csv_export` | CSVファイルをエクスポート | 出力先はGCSバケットのみ | 中 |
| `file_create` | テキストファイルを作成 | 出力先はGCSバケットのみ | 中 |

### 書き込み系の安全制約

| 制約 | 内容 |
|------|------|
| **出力先** | GCSバケット（`gs://soulkun-operations/`）のみ。ローカルファイルシステムへの書き込み禁止 |
| **社長確認** | 全ての書き込み操作は実行前に社長に確認（`requires_confirmation: True`） |
| **ファイルサイズ** | 最大1MB/ファイル |
| **ファイル数** | 最大100ファイル/バケット（超えたら古いものから自動削除） |
| **削除** | **引き続き禁止**（手動でのみ可能） |

### なぜGCSか（Cloud Run制約への対応）

- Cloud Runのローカルファイルシステムは一時的（インスタンス終了で消失）
- GCSなら永続保存 + Pre-signed URLで安全にダウンロード可能
- GCSアクセスログで監査証跡が自動的に残る
- 既存の`MEETING_GCS_BUCKET`パターンと同じ方式

---

## Step C-6: 全体テストと安定化

### 安定化期間: 2週間

| 確認項目 | 基準 |
|---------|------|
| エラー率 | 1%以下 |
| タイムアウト発生率 | 5%以下 |
| 未登録操作ブロック率 | 100%（1回でも通ったら失格） |
| 緊急停止テスト | 週1回実施、3秒以内に停止 |

### 監視・アラート

| 項目 | 方法 |
|------|------|
| **メトリクス収集** | Cloud Logging + 管理ダッシュボード |
| **アラート** | エラー率 >5% → ChatWork通知、ブロック失敗 → 即座にChatWork + 緊急停止 |
| **ダッシュボード** | 管理画面に操作統計パネル追加（実行数、成功率、日次推移） |
| **コスト監視** | GCP Budget Alert（操作関連の日次コスト上限設定） |

---

## 承認フロー（既存の仕組みを活用）

```
ユーザー: 「売上データを集計して」
    ↓
[1] 脳（Brain）が意図を判断 → action: data_aggregate
    ↓
[2] 番人（GuardianLayer）が操作を検査
    ├─ 操作レジストリに登録済みか？
    ├─ パラメータは安全か？
    └─ レート制限内か？
    ↓
[3] 承認ゲート（ApprovalGate）が危険度を判定
    ├─ 低リスク（読み取り系）→ 自動実行
    ├─ 中リスク（書き込み系）→ 社長に確認
    └─ 高リスク → ブロック
    ↓
[4] 認可ゲート（AuthorizationGate）が3層チェック ← v1で欠落、v2で追加
    ├─ 価値観チェック（ValueAuthority）
    ├─ 記憶チェック（MemoryAuthority）
    └─ 整合性チェック（ExecutionExcellence）
    ↓
[5] 事前登録済みのPython関数を実行（30秒制限）
    ↓
[6] 結果をPII除去してユーザーに返す
    ↓
[7] 監査ログに記録（操作名、パラメータ、実行時間、結果サイズ、成否）
```

---

## スケジュール案

| ステップ | 内容 | 期間 |
|---------|------|------|
| C-1 | 操作レジストリ構築 + 基盤 | 1週間 |
| C-2 | 読み取り系操作実装（5操作） | 1週間 |
| C-3 | テスト・安全性検証 | 1週間 |
| C-4 | 番人強化 + constants.py更新 | 3日 |
| — | **読み取り系の安定運用期間** | **2週間** |
| C-5 | 書き込み系操作追加（3操作）+ GCS連携 | 1週間 |
| C-6 | 全体安定化 + 監視設定 | 2週間 |

**合計: 約4〜5週間**（v1の10〜11週間から大幅短縮）

---

## 3AIレビューで発見された問題と対応

### CRITICAL（対応済み）

| # | 問題 | 対応 |
|---|------|------|
| C1 | `python3 -c`で全セキュリティ迂回可能 | **削除** → 事前登録関数方式に変更 |
| C2 | `awk`の`system()`で任意コマンド実行 | **削除** → 事前登録関数方式に変更 |
| C3 | `find`の`-exec`で任意コマンド実行 | **削除** → 事前登録関数方式に変更 |
| C4 | シェルメタ文字の体系的対策が困難 | **解消** → シェル自体を使わない |
| C5 | 環境変数が`printenv`等で漏洩 | **解消** → シェル自体を使わない |

### IMPORTANT（対応済み）

| # | 問題 | 対応 |
|---|------|------|
| I1 | AuthorizationGateとの統合が未記載 | 承認フローに[4]として追加 |
| I2 | SYSTEM_CAPABILITIESへの登録が未記載 | C-2セクションに登録方法を明記 |
| I3 | コマンド解析パイプラインが未定義 | 解消（関数呼び出しなので解析不要） |
| I4 | ネットワーク制限の実装方法が不明 | GCS APIのみ許可、関数内で外部通信しない設計 |
| I5 | レート制限のスコープが不明 | ユーザー×組織、バースト制限、日次クォータを明記 |
| I6 | SIGKILLフォールバックがない | 解消（subprocess不使用、通常の関数タイムアウト） |
| I7 | メモリ制限の実装方法が不明 | 解消（通常のPython関数、Cloud Runコンテナ制限で十分） |
| I8 | バイナリ出力の処理が未定義 | 解消（関数が構造化データを返す、バイナリ出力なし） |
| I9 | 監査ログの詳細が不足 | 承認フロー[7]に記録項目を明記 |

### PRACTICAL BLOCKER（対応済み）

| # | 問題 | 対応 |
|---|------|------|
| P1 | Cloud Runでサンドボックスが機能しない | 解消（サンドボックス不使用） |
| P2 | ローカルファイルが永続しない | GCSバケットに変更 |
| P3 | コスト分析がない | 監視セクションにコスト監視を追加 |
| P4 | 監視・アラート設計がない | C-6に監視・アラートセクションを追加 |

---

## 次のアクション

1. ~~この設計書を3AIレビュー（Claude + Codex + Gemini）にかける~~ ✅ 完了
2. **カズさんに承認をもらう** ← 今ここ
3. C-1（操作レジストリ構築）から着手

---

## 参照

- 実行計画: `docs/execution_plan_mcp_evolution.md` Step C
- 脳の設計: `docs/25_llm_native_brain_architecture.md`
- 承認ゲート: `lib/brain/approval_gate.py`
- 番人: `lib/brain/guardian_layer.py`
- 認可ゲート: `lib/brain/authorization_gate.py`
- 緊急停止: `lib/brain/emergency_stop.py`
