# ç¬¬6ç«  Phase 3 Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æº è©³ç´°è¨­è¨ˆæ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** v1.0.0
**ä½œæˆæ—¥:** 2026-01-19
**æœ€çµ‚æ›´æ–°:** 2026-01-19
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** è¨­è¨ˆå®Œäº†ãƒ»å®Ÿè£…æº–å‚™å®Œäº†

---

## Document Contractï¼ˆSoTå®£è¨€ï¼‰

| é …ç›® | å†…å®¹ |
|------|------|
| **ã“ã®æ–‡æ›¸ã®å½¹å‰²** | Phase 3ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢ã®Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºéƒ¨åˆ†ã®è©³ç´°è¨­è¨ˆæ›¸ï¼ˆ05_phase3_knowledge_detailed_design.mdã®è£œéºï¼‰ |
| **æ›¸ãã“ã¨** | Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ è¨­è¨ˆã€ç›£è¦–ã‚¸ãƒ§ãƒ–è¨­è¨ˆã€ãƒ•ã‚©ãƒ«ãƒ€â†’æ¨©é™ãƒžãƒƒãƒ”ãƒ³ã‚°ã€ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºãƒ»ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²å®Ÿè£…ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€é‹ç”¨ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ |
| **æ›¸ã‹ãªã„ã“ã¨** | documents/document_chunksãƒ†ãƒ¼ãƒ–ãƒ«ã®åŸºæœ¬è¨­è¨ˆï¼ˆâ†’05_phase3_knowledge_detailed_design.mdï¼‰ã€Pineconeçµ±åˆã®è©³ç´°ï¼ˆâ†’åŒä¸Šï¼‰ã€æ¤œç´¢APIã®ä»•æ§˜ï¼ˆâ†’åŒä¸Šï¼‰ |
| **SoTï¼ˆã“ã®æ–‡æ›¸ãŒæ­£ï¼‰** | Googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã€ãƒ•ã‚©ãƒ«ãƒ€åâ†’classification/category/department_idãƒžãƒƒãƒ”ãƒ³ã‚°ã€google_drive_sync_logs/google_drive_sync_stateãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆã€watch_google_drive Cloud Functionä»•æ§˜ |
| **Owner** | Tech Lead |
| **æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼** | Googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã®å¤‰æ›´ã€æ¨©é™ãƒžãƒƒãƒ”ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ã®å¤‰æ›´ã€ç›£è¦–ã‚¸ãƒ§ãƒ–ä»•æ§˜ã®å¤‰æ›´ |

---

## ç›®æ¬¡

1. [æ¦‚è¦ã¨ç›®çš„](#1-æ¦‚è¦ã¨ç›®çš„)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](#2-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ)
3. [Googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ è¨­è¨ˆ](#3-googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ è¨­è¨ˆ)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¿½åŠ è¨­è¨ˆ](#4-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¿½åŠ è¨­è¨ˆ)
5. [Googleãƒ‰ãƒ©ã‚¤ãƒ–ç›£è¦–ã‚¸ãƒ§ãƒ–è¨­è¨ˆ](#5-googleãƒ‰ãƒ©ã‚¤ãƒ–ç›£è¦–ã‚¸ãƒ§ãƒ–è¨­è¨ˆ)
6. [ãƒ•ã‚©ãƒ«ãƒ€â†’æ¨©é™ãƒžãƒƒãƒ”ãƒ³ã‚°è¨­è¨ˆ](#6-ãƒ•ã‚©ãƒ«ãƒ€æ¨©é™ãƒžãƒƒãƒ”ãƒ³ã‚°è¨­è¨ˆ)
7. [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡¦ç†ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ](#7-ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡¦ç†ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ)
8. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ](#8-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ)
9. [é‹ç”¨è¨­è¨ˆ](#9-é‹ç”¨è¨­è¨ˆ)
10. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ](#10-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ)
11. [ãƒ†ã‚¹ãƒˆè¨­è¨ˆ](#11-ãƒ†ã‚¹ãƒˆè¨­è¨ˆ)
12. [å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#12-å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## 1. æ¦‚è¦ã¨ç›®çš„

### 1.1 æœ¬è¨­è¨ˆæ›¸ã®ä½ç½®ã¥ã‘

æœ¬è¨­è¨ˆæ›¸ã¯ã€Phase 3è©³ç´°è¨­è¨ˆæ›¸ï¼ˆ05_phase3_knowledge_detailed_design.mdï¼‰ã®è£œéºã¨ã—ã¦ã€
Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºæ©Ÿèƒ½ã®è©³ç´°è¨­è¨ˆã‚’å®šç¾©ã—ã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Phase 3 è¨­è¨ˆæ›¸æ§‹æˆ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

05_phase3_knowledge_detailed_design.md
â”œâ”€â”€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆdocuments, document_chunks, etc.ï¼‰
â”œâ”€â”€ Pineconeçµ±åˆè¨­è¨ˆ
â”œâ”€â”€ APIè¨­è¨ˆï¼ˆæ¤œç´¢ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
â”œâ”€â”€ å‡¦ç†ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ
â””â”€â”€ Phase 3.5é€£æºè¨­è¨ˆ

06_phase3_google_drive_integration.mdï¼ˆæœ¬æ›¸ï¼‰
â”œâ”€â”€ Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
â”œâ”€â”€ ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ è¨­è¨ˆ
â”œâ”€â”€ ç›£è¦–ã‚¸ãƒ§ãƒ–è¨­è¨ˆ
â”œâ”€â”€ ãƒ•ã‚©ãƒ«ãƒ€â†’æ¨©é™ãƒžãƒƒãƒ”ãƒ³ã‚°
â””â”€â”€ é‹ç”¨ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ
```

### 1.2 å®Ÿç¾ã™ã‚‹æ©Ÿèƒ½

**ã‚«ã‚ºã•ã‚“ã®è¦æœ›ï¼š**
> ã€ŒGoogleãƒ‰ãƒ©ã‚¤ãƒ–ã«è³‡æ–™ã‚’æ ¼ç´ã—ã¦ã€ã‚½ã‚¦ãƒ«ãã‚“ãŒè‡ªå‹•ã§æ±²ã¿å–ã‚Šã«è¡Œãã€‚
>  Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«æ ¼ç´ã™ã‚‹æƒ…å ±ã‚’å¤‰ãˆã¦ã„ã‘ã°æ›´æ–°ã‚‚æ¥½ã¡ã‚“ã€

**æœ¬è¨­è¨ˆã§å®Ÿç¾ã™ã‚‹ã“ã¨ï¼š**

| # | æ©Ÿèƒ½ | è©³ç´° |
|---|------|------|
| 1 | **è‡ªå‹•å–ã‚Šè¾¼ã¿** | Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã¨ã€5åˆ†ä»¥å†…ã«ã‚½ã‚¦ãƒ«ãã‚“ã®çŸ¥è­˜ã«åæ˜  |
| 2 | **è‡ªå‹•æ›´æ–°** | ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«å†å–ã‚Šè¾¼ã¿ |
| 3 | **è‡ªå‹•å‰Šé™¤** | ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€Pineconeã‹ã‚‰ã‚‚å‰Šé™¤ |
| 4 | **ãƒ•ã‚©ãƒ«ãƒ€â†’æ¨©é™** | ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã§æ©Ÿå¯†åŒºåˆ†ï¼ˆpublic/internal/confidentialï¼‰ã‚’è‡ªå‹•è¨­å®š |
| 5 | **éƒ¨ç½²åˆ¥ã‚¢ã‚¯ã‚»ã‚¹** | éƒ¨ç½²ãƒ•ã‚©ãƒ«ãƒ€ã«å…¥ã‚Œã‚‹ã¨ã€ãã®éƒ¨ç½²ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ |

### 1.3 è¨­è¨ˆåŽŸå‰‡

| # | åŽŸå‰‡ | æœ¬è¨­è¨ˆã§ã®é©ç”¨ |
|---|------|--------------|
| 1 | **ã‚·ãƒ³ãƒ—ãƒ«ãªé‹ç”¨** | ç¤¾å“¡ã¯Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥ã‚Œã‚‹ã ã‘ |
| 2 | **è‡ªå‹•åŒ–å„ªå…ˆ** | æ‰‹å‹•æ“ä½œã‚’æœ€å°åŒ–ï¼ˆç›£è¦–ã‚¸ãƒ§ãƒ–ã§è‡ªå‹•å‡¦ç†ï¼‰ |
| 3 | **ãƒ•ã‚©ãƒ«ãƒ€ï¼æ¨©é™** | ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ãŒãã®ã¾ã¾æ¨©é™è¨­å®šã«ãªã‚‹ |
| 4 | **å¤±æ•—ã«å¼·ã„** | ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒªãƒˆãƒ©ã‚¤ã€ãƒ­ã‚°è¨˜éŒ²ã€ã‚¢ãƒ©ãƒ¼ãƒˆ |
| 5 | **10ã®é‰„å‰‡æº–æ‹ ** | organization_idã€ç›£æŸ»ãƒ­ã‚°ã€etc. |

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### 2.1 å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æº å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    [ç¤¾å“¡]
                                      â”‚
                                      â”‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               Google Drive                                               â”‚
â”‚                                                                                          â”‚
â”‚   ðŸ“ ã‚½ã‚¦ãƒ«ãã‚“ç”¨ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆROOT_FOLDER_IDï¼‰                                               â”‚
â”‚   â”œâ”€â”€ ðŸ“ å…¨ç¤¾å…±æœ‰ï¼ˆpublicï¼‰                                                              â”‚
â”‚   â”‚   â”œâ”€â”€ ðŸ“ ä¼šç¤¾ç´¹ä»‹ï¼ˆcategory: Aï¼‰                                                     â”‚
â”‚   â”‚   â””â”€â”€ ðŸ“ ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ï¼ˆcategory: Fï¼‰                                                 â”‚
â”‚   â”œâ”€â”€ ðŸ“ ç¤¾å“¡é™å®šï¼ˆinternalï¼‰                                                            â”‚
â”‚   â”‚   â”œâ”€â”€ ðŸ“ MVVãƒ»ç†å¿µï¼ˆcategory: Aï¼‰                                                    â”‚
â”‚   â”‚   â””â”€â”€ ðŸ“ æ¥­å‹™ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆcategory: Bï¼‰                                               â”‚
â”‚   â””â”€â”€ ðŸ“ éƒ¨ç½²åˆ¥ï¼ˆconfidentialï¼‰                                                          â”‚
â”‚       â”œâ”€â”€ ðŸ“ å–¶æ¥­éƒ¨ï¼ˆdepartment_id: dept_salesï¼‰                                         â”‚
â”‚       â””â”€â”€ ðŸ“ ç·å‹™éƒ¨ï¼ˆdepartment_id: dept_adminï¼‰                                         â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ Google Drive API
                                      â”‚ (Changes API)
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Cloud Scheduler                                             â”‚
â”‚                         (5åˆ†ã”ã¨ã«ãƒˆãƒªã‚¬ãƒ¼)                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Cloud Functions                                             â”‚
â”‚                        (watch_google_drive)                                              â”‚
â”‚                                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚   â”‚ 1. å¤‰æ›´æ¤œçŸ¥      â”‚ â†’ â”‚ 2. ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†  â”‚ â†’ â”‚ 3. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ â”‚                       â”‚
â”‚   â”‚                 â”‚   â”‚                 â”‚   â”‚                 â”‚                       â”‚
â”‚   â”‚ ãƒ»æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«   â”‚   â”‚ ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰   â”‚   â”‚ ãƒ»ãƒãƒ£ãƒ³ã‚¯åŒ–    â”‚                       â”‚
â”‚   â”‚ ãƒ»æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«   â”‚   â”‚ ãƒ»ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º   â”‚   â”‚ ãƒ»ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°â”‚                       â”‚
â”‚   â”‚ ãƒ»å‰Šé™¤ãƒ•ã‚¡ã‚¤ãƒ«   â”‚   â”‚ ãƒ»æ¨©é™æ±ºå®š      â”‚   â”‚ ãƒ»Pineconeç™»éŒ² â”‚                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚                       â”‚
                          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Cloud SQL               â”‚   â”‚          Pinecone               â”‚
â”‚        (PostgreSQL)             â”‚   â”‚       (ãƒ™ã‚¯ã‚¿ãƒ¼DB)               â”‚
â”‚                                 â”‚   â”‚                                 â”‚
â”‚ ãƒ»documents                     â”‚   â”‚ ãƒ»soulkun-knowledge             â”‚
â”‚ ãƒ»document_versions             â”‚   â”‚   (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹)                 â”‚
â”‚ ãƒ»document_chunks               â”‚   â”‚                                 â”‚
â”‚ ãƒ»google_drive_sync_logs        â”‚   â”‚ ãƒ»org_soulsyncs                 â”‚
â”‚                                 â”‚   â”‚   (Namespace)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                       â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FastAPI (Cloud Run)                                         â”‚
â”‚                                                                                          â”‚
â”‚   POST /api/v1/knowledge/search                                                          â”‚
â”‚   â”œâ”€â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼                                                                        â”‚
â”‚   â”œâ”€â”€ ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½éƒ¨ç½²ã®è¨ˆç®—ï¼ˆPhase 3.5é€£æºï¼‰                                              â”‚
â”‚   â”œâ”€â”€ Pineconeæ¤œç´¢ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ï¼‰                                                  â”‚
â”‚   â”œâ”€â”€ å›žç­”ç”Ÿæˆï¼ˆGPT-4ï¼‰                                                                  â”‚
â”‚   â””â”€â”€ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆå›žç­” + å‡ºå…¸ + æ³¨æ„æ›¸ãï¼‰                                                â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                                   [ãƒ¦ãƒ¼ã‚¶ãƒ¼]
                              ã€ŒçµŒè²»ç²¾ç®—ã®ã‚„ã‚Šæ–¹ã¯ï¼Ÿã€
                                      â†“
                              ã€ŒçµŒè²»ç²¾ç®—ã¯ä»¥ä¸‹ã®æ‰‹é †ã§...
                               ï¼ˆå‡ºå…¸: çµŒè²»ç²¾ç®—ãƒžãƒ‹ãƒ¥ã‚¢ãƒ« p.5ï¼‰ã€
```

### 2.2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¸€è¦§

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | å½¹å‰² | æŠ€è¡“ |
|--------------|------|------|
| **Google Drive** | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ ¼ç´å ´æ‰€ | Google Workspace |
| **Cloud Scheduler** | å®šæœŸå®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ | GCP |
| **Cloud Functions** | ç›£è¦–ã‚¸ãƒ§ãƒ–å®Ÿè¡Œ | Python 3.11 |
| **Cloud SQL** | ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ ¼ç´ | PostgreSQL 15 |
| **Pinecone** | ãƒ™ã‚¯ã‚¿ãƒ¼æ¤œç´¢ | Pinecone Starter |
| **Cloud Run** | APIæä¾› | FastAPI |
| **OpenAI** | ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ãƒ»å›žç­”ç”Ÿæˆ | text-embedding-3-small, GPT-4 |

### 2.3 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è©³ç´°                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ æ™‚ã€‘
1. ç¤¾å“¡ãŒGoogleãƒ‰ãƒ©ã‚¤ãƒ–ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
2. Cloud Scheduler ãŒ5åˆ†ã”ã¨ã«ç›£è¦–ã‚¸ãƒ§ãƒ–ã‚’ãƒˆãƒªã‚¬ãƒ¼
3. Cloud Functions ãŒ Google Drive API Changes ã‚’å‘¼ã³å‡ºã—
4. æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œçŸ¥
5. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
6. ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‹ã‚‰ classification ã¨ department_id ã‚’æ±ºå®š
7. ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºï¼ˆPDF: PyMuPDF, DOCX: python-docxï¼‰
8. ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ï¼ˆ1000æ–‡å­—ã€200æ–‡å­—ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ï¼‰
9. ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆï¼ˆOpenAI text-embedding-3-smallï¼‰
10. PostgreSQL ã« documents, document_chunks ã‚’ä¿å­˜
11. Pinecone ã«ãƒ™ã‚¯ã‚¿ãƒ¼ã‚’ upsert

ã€ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°æ™‚ã€‘
1-4. åŒä¸Š
5. æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œçŸ¥
6. æ—¢å­˜ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’å–å¾—
7. æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆï¼ˆdocument_versionsï¼‰
8. æ—§ãƒãƒ£ãƒ³ã‚¯ã‚’ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆ
9. æ–°ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆ
10. Pinecone ã®æ—§ãƒ™ã‚¯ã‚¿ãƒ¼ã‚’å‰Šé™¤ã€æ–°ãƒ™ã‚¯ã‚¿ãƒ¼ã‚’ upsert

ã€ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤æ™‚ã€‘
1-4. åŒä¸Š
5. å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œçŸ¥
6. documents ã‚’ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆï¼ˆdeleted_at = NOW()ï¼‰
7. Pinecone ã‹ã‚‰ãƒ™ã‚¯ã‚¿ãƒ¼ã‚’å‰Šé™¤
```

---

## 3. Googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ è¨­è¨ˆ

### 3.1 æŽ¨å¥¨ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ 

```
ðŸ“ ã‚½ã‚¦ãƒ«ãã‚“ç”¨ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆROOT_FOLDER_IDï¼‰
â”‚
â”œâ”€â”€ ðŸ“ å…¨ç¤¾å…±æœ‰                          â† classification: "public"
â”‚   â”‚                                      èª°ã§ã‚‚é–²è¦§å¯èƒ½
â”‚   â”œâ”€â”€ ðŸ“ ä¼šç¤¾ç´¹ä»‹                      â† category: "A"
â”‚   â”‚   â”œâ”€â”€ ä¼šç¤¾æ¦‚è¦.pdf
â”‚   â”‚   â””â”€â”€ æ²¿é©.docx
â”‚   â”‚
â”‚   â””â”€â”€ ðŸ“ ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±                  â† category: "F"
â”‚       â”œâ”€â”€ ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§.pdf
â”‚       â””â”€â”€ æ–™é‡‘è¡¨.xlsx
â”‚
â”œâ”€â”€ ðŸ“ ç¤¾å“¡é™å®š                          â† classification: "internal"
â”‚   â”‚                                      ç¤¾å“¡ã®ã¿é–²è¦§å¯èƒ½
â”‚   â”œâ”€â”€ ðŸ“ MVVãƒ»ç†å¿µ                     â† category: "A"
â”‚   â”‚   â”œâ”€â”€ ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ“ã‚¸ãƒ§ãƒ³.pdf
â”‚   â”‚   â””â”€â”€ è¡Œå‹•æŒ‡é‡.docx
â”‚   â”‚
â”‚   â”œâ”€â”€ ðŸ“ æ¥­å‹™ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«                â† category: "B"
â”‚   â”‚   â”œâ”€â”€ çµŒè²»ç²¾ç®—ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«.pdf
â”‚   â”‚   â”œâ”€â”€ å‡ºå¼µç”³è«‹ã‚¬ã‚¤ãƒ‰.docx
â”‚   â”‚   â””â”€â”€ å‹¤æ€ å…¥åŠ›ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«.pdf
â”‚   â”‚
â”‚   â””â”€â”€ ðŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ                  â† category: "D"
â”‚       â”œâ”€â”€ è­°äº‹éŒ²ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.docx
â”‚       â””â”€â”€ å ±å‘Šæ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.xlsx
â”‚
â”œâ”€â”€ ðŸ“ å½¹å“¡é™å®š                          â† classification: "restricted"
â”‚   â”‚                                      å½¹å“¡ã®ã¿é–²è¦§å¯èƒ½
â”‚   â””â”€â”€ ðŸ“ çµŒå–¶æƒ…å ±
â”‚       â”œâ”€â”€ çµŒå–¶è¨ˆç”».pdf
â”‚       â””â”€â”€ è²¡å‹™å ±å‘Š.xlsx
â”‚
â””â”€â”€ ðŸ“ éƒ¨ç½²åˆ¥                            â† classification: "confidential"
    â”‚                                      è©²å½“éƒ¨ç½²ã®ã¿é–²è¦§å¯èƒ½
    â”œâ”€â”€ ðŸ“ å–¶æ¥­éƒ¨                        â† department_id: "dept_sales"
    â”‚   â”œâ”€â”€ ðŸ“ å–¶æ¥­ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«            â† category: "B"
    â”‚   â”‚   â””â”€â”€ å–¶æ¥­ãƒˆãƒ¼ã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ.pdf
    â”‚   â””â”€â”€ ðŸ“ é¡§å®¢æƒ…å ±                  â† category: "E"
    â”‚       â””â”€â”€ é¡§å®¢å¯¾å¿œãƒ«ãƒ¼ãƒ«.docx
    â”‚
    â”œâ”€â”€ ðŸ“ ç·å‹™éƒ¨                        â† department_id: "dept_admin"
    â”‚   â””â”€â”€ ðŸ“ å°±æ¥­è¦å‰‡                  â† category: "C"
    â”‚       â””â”€â”€ å°±æ¥­è¦å‰‡_2026.pdf
    â”‚
    â””â”€â”€ ðŸ“ é–‹ç™ºéƒ¨                        â† department_id: "dept_dev"
        â””â”€â”€ ðŸ“ é–‹ç™ºã‚¬ã‚¤ãƒ‰                â† category: "B"
            â””â”€â”€ ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„.md
```

### 3.2 ãƒ•ã‚©ãƒ«ãƒ€å‘½åè¦å‰‡

| ãƒ¬ãƒ™ãƒ« | ãƒ•ã‚©ãƒ«ãƒ€å | å½¹å‰² |
|-------|----------|------|
| **Level 1** | ã‚½ã‚¦ãƒ«ãã‚“ç”¨ãƒ•ã‚©ãƒ«ãƒ€ | ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆROOT_FOLDER_IDï¼‰ |
| **Level 2** | å…¨ç¤¾å…±æœ‰ / ç¤¾å“¡é™å®š / å½¹å“¡é™å®š / éƒ¨ç½²åˆ¥ | **æ©Ÿå¯†åŒºåˆ†**ã‚’æ±ºå®š |
| **Level 3** | éƒ¨ç½²åï¼ˆå–¶æ¥­éƒ¨ã€ç·å‹™éƒ¨ãªã©ï¼‰ | **éƒ¨ç½²ID**ã‚’æ±ºå®šï¼ˆLevel 2ãŒã€Œéƒ¨ç½²åˆ¥ã€ã®å ´åˆï¼‰ |
| **Level 3-4** | ã‚«ãƒ†ã‚´ãƒªåï¼ˆãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ã€ç†å¿µãªã©ï¼‰ | **ã‚«ãƒ†ã‚´ãƒª**ã‚’æ±ºå®š |

### 3.3 ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼

| å½¢å¼ | æ‹¡å¼µå­ | ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºæ–¹æ³• |
|------|-------|----------------|
| PDF | .pdf | PyMuPDF (fitz) |
| Word | .docx, .doc | python-docx |
| ãƒ†ã‚­ã‚¹ãƒˆ | .txt | ãã®ã¾ã¾ |
| Markdown | .md | ãã®ã¾ã¾ |
| HTML | .html | BeautifulSoup |
| Excel | .xlsx, .xls | openpyxlï¼ˆãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰ |
| PowerPoint | .pptx, .ppt | python-pptx |

### 3.4 é™¤å¤–ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

| é™¤å¤–æ¡ä»¶ | ç†ç”± |
|---------|------|
| ãƒ•ã‚¡ã‚¤ãƒ«åãŒ `.` ã§å§‹ã¾ã‚‹ | éš ã—ãƒ•ã‚¡ã‚¤ãƒ« |
| ãƒ•ã‚¡ã‚¤ãƒ«åãŒ `~$` ã§å§‹ã¾ã‚‹ | Officeä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ« |
| æ‹¡å¼µå­ãŒ `.tmp`, `.bak` | ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ« |
| ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ 50MB è¶… | å‡¦ç†è² è· |
| Google Docså½¢å¼ | ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå¿…è¦ï¼ˆå°†æ¥å¯¾å¿œï¼‰ |

---

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¿½åŠ è¨­è¨ˆ

### 4.1 documents ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®è¿½åŠ ã‚«ãƒ©ãƒ 

```sql
-- documents ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®è¿½åŠ ã‚«ãƒ©ãƒ ï¼ˆGoogleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºç”¨ï¼‰
ALTER TABLE documents ADD COLUMN IF NOT EXISTS google_drive_file_id VARCHAR(255);
ALTER TABLE documents ADD COLUMN IF NOT EXISTS google_drive_folder_path TEXT[];
ALTER TABLE documents ADD COLUMN IF NOT EXISTS google_drive_web_view_link TEXT;
ALTER TABLE documents ADD COLUMN IF NOT EXISTS google_drive_last_modified TIMESTAMPTZ;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE UNIQUE INDEX IF NOT EXISTS idx_documents_drive_file_id
ON documents(organization_id, google_drive_file_id)
WHERE google_drive_file_id IS NOT NULL;

-- ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON COLUMN documents.google_drive_file_id IS
'Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ•ã‚¡ã‚¤ãƒ«IDã€‚
Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºæ™‚ã«ä½¿ç”¨ã€‚NULLã®å ´åˆã¯æ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€‚';

COMMENT ON COLUMN documents.google_drive_folder_path IS
'Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ï¼ˆé…åˆ—ï¼‰ã€‚
ä¾‹: ["ã‚½ã‚¦ãƒ«ãã‚“ç”¨ãƒ•ã‚©ãƒ«ãƒ€", "ç¤¾å“¡é™å®š", "æ¥­å‹™ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«"]
æ¨©é™æ±ºå®šï¼ˆclassification, department_idï¼‰ã«ä½¿ç”¨ã€‚';

COMMENT ON COLUMN documents.google_drive_web_view_link IS
'Googleãƒ‰ãƒ©ã‚¤ãƒ–ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«é–²è¦§URLã€‚
å‡ºå…¸è¡¨ç¤ºã§ä½¿ç”¨ã€‚';

COMMENT ON COLUMN documents.google_drive_last_modified IS
'Googleãƒ‰ãƒ©ã‚¤ãƒ–ã§ã®æœ€çµ‚æ›´æ–°æ—¥æ™‚ã€‚
æ›´æ–°æ¤œçŸ¥ã«ä½¿ç”¨ï¼ˆã“ã®å€¤ã‚ˆã‚Šæ–°ã—ã„modifiedTimeã‚’æŒã¤ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°å¯¾è±¡ã¨ã™ã‚‹ï¼‰ã€‚';
```

### 4.2 google_drive_sync_logs ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ï¼‰

```sql
-- Googleãƒ‰ãƒ©ã‚¤ãƒ–åŒæœŸãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE google_drive_sync_logs (
    -- === ä¸»ã‚­ãƒ¼ ===
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- === ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ ===
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- === åŒæœŸæƒ…å ± ===
    sync_id VARCHAR(100) UNIQUE NOT NULL,           -- sync_20260119_100000_abc123
    sync_type VARCHAR(50) NOT NULL,                 -- 'scheduled', 'manual', 'initial'

    -- === å‡¦ç†çµ±è¨ˆ ===
    files_checked INT DEFAULT 0,                    -- ãƒã‚§ãƒƒã‚¯ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°
    files_added INT DEFAULT 0,                      -- è¿½åŠ ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°
    files_updated INT DEFAULT 0,                    -- æ›´æ–°ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°
    files_deleted INT DEFAULT 0,                    -- å‰Šé™¤ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°
    files_skipped INT DEFAULT 0,                    -- ã‚¹ã‚­ãƒƒãƒ—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°
    files_failed INT DEFAULT 0,                     -- å¤±æ•—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°

    -- === ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ===
    status VARCHAR(50) NOT NULL DEFAULT 'in_progress',
    -- 'in_progress': å®Ÿè¡Œä¸­
    -- 'completed': å®Œäº†
    -- 'completed_with_errors': ã‚¨ãƒ©ãƒ¼ã‚ã‚Šã§å®Œäº†
    -- 'failed': å¤±æ•—

    -- === ã‚¨ãƒ©ãƒ¼æƒ…å ± ===
    error_code VARCHAR(100),
    error_message TEXT,
    error_details JSONB,
    failed_files JSONB,                             -- å¤±æ•—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆ

    -- === ã‚¿ã‚¤ãƒŸãƒ³ã‚° ===
    started_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMPTZ,
    duration_ms INT,

    -- === Google Drive APIæƒ…å ± ===
    start_page_token VARCHAR(255),                  -- åŒæœŸé–‹å§‹æ™‚ã®ãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³
    new_page_token VARCHAR(255),                    -- åŒæœŸå®Œäº†å¾Œã®ãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³
    root_folder_id VARCHAR(255),                    -- ç›£è¦–å¯¾è±¡ã®ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ID

    -- === ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ ===
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

    -- === åˆ¶ç´„ ===
    CONSTRAINT valid_sync_status CHECK (
        status IN ('in_progress', 'completed', 'completed_with_errors', 'failed')
    )
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_drive_sync_logs_org ON google_drive_sync_logs(organization_id);
CREATE INDEX idx_drive_sync_logs_status ON google_drive_sync_logs(status);
CREATE INDEX idx_drive_sync_logs_started ON google_drive_sync_logs(started_at DESC);

-- ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON TABLE google_drive_sync_logs IS
'Googleãƒ‰ãƒ©ã‚¤ãƒ–åŒæœŸã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œãƒ­ã‚°ã€‚
5åˆ†ã”ã¨ã®å®šæœŸå®Ÿè¡Œã®è¨˜éŒ²ã¨ã€ã‚¨ãƒ©ãƒ¼è¿½è·¡ã«ä½¿ç”¨ã€‚';

COMMENT ON COLUMN google_drive_sync_logs.start_page_token IS
'Google Drive API Changes ã®ãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³ã€‚
å‰å›žã®åŒæœŸä»¥é™ã®å¤‰æ›´ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã€‚';
```

### 4.3 google_drive_sync_state ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ï¼‰

```sql
-- Googleãƒ‰ãƒ©ã‚¤ãƒ–åŒæœŸçŠ¶æ…‹ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³ã®æ°¸ç¶šåŒ–ï¼‰
CREATE TABLE google_drive_sync_state (
    -- === ä¸»ã‚­ãƒ¼ ===
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- === ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ ===
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- === åŒæœŸçŠ¶æ…‹ ===
    root_folder_id VARCHAR(255) NOT NULL,           -- ç›£è¦–å¯¾è±¡ã®ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ID
    page_token VARCHAR(255) NOT NULL,               -- æ¬¡å›žåŒæœŸé–‹å§‹æ™‚ã®ãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³
    last_sync_at TIMESTAMPTZ,                       -- æœ€å¾Œã«åŒæœŸã—ãŸæ—¥æ™‚
    last_sync_id UUID REFERENCES google_drive_sync_logs(id),

    -- === ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ ===
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

    -- === åˆ¶ç´„ ===
    CONSTRAINT unique_org_folder UNIQUE (organization_id, root_folder_id)
);

-- ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON TABLE google_drive_sync_state IS
'Googleãƒ‰ãƒ©ã‚¤ãƒ–åŒæœŸã®çŠ¶æ…‹ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚
çµ„ç¹”Ã—ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨ã«ãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿æŒã—ã€å·®åˆ†åŒæœŸã‚’å®Ÿç¾ã€‚';

COMMENT ON COLUMN google_drive_sync_state.page_token IS
'Google Drive API Changes ã®ãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³ã€‚
ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ä»¥é™ã®å¤‰æ›´ã‚’æ¬¡å›žåŒæœŸã§å–å¾—ã™ã‚‹ã€‚';
```

### 4.4 ERå›³ï¼ˆè¿½åŠ éƒ¨åˆ†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æº ERå›³ï¼ˆè¿½åŠ éƒ¨åˆ†ï¼‰                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       organizations         â”‚
â”‚        (ãƒ†ãƒŠãƒ³ãƒˆ)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                     â”‚
â”‚ name                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   google_drive_sync_state   â”‚          â”‚   google_drive_sync_logs    â”‚
â”‚      (åŒæœŸçŠ¶æ…‹)              â”‚          â”‚       (åŒæœŸãƒ­ã‚°)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                     â”‚          â”‚ id (PK)                     â”‚
â”‚ organization_id (FK)        â”‚          â”‚ organization_id (FK)        â”‚
â”‚ root_folder_id              â”‚          â”‚ sync_id                     â”‚
â”‚ page_token                  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ start_page_token            â”‚
â”‚ last_sync_at                â”‚          â”‚ new_page_token              â”‚
â”‚ last_sync_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ status                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ files_added                 â”‚
                                         â”‚ files_updated               â”‚
                                         â”‚ files_deleted               â”‚
                                         â”‚ failed_files                â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         documents           â”‚
â”‚      (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                     â”‚
â”‚ organization_id (FK)        â”‚
â”‚ title                       â”‚
â”‚ category                    â”‚
â”‚ classification              â”‚
â”‚ department_id (FK)          â”‚
â”‚ ...                         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ ã€Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºç”¨ã€‘     â”‚
â”‚ google_drive_file_id  â—€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ•ã‚¡ã‚¤ãƒ«ID
â”‚ google_drive_folder_path    â”‚     ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹é…åˆ—
â”‚ google_drive_web_view_link  â”‚     é–²è¦§URL
â”‚ google_drive_last_modified  â”‚     æœ€çµ‚æ›´æ–°æ—¥æ™‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Googleãƒ‰ãƒ©ã‚¤ãƒ–ç›£è¦–ã‚¸ãƒ§ãƒ–è¨­è¨ˆ

### 5.1 ç›£è¦–ã‚¸ãƒ§ãƒ–ã®æ¦‚è¦

| é …ç›® | å€¤ |
|------|-----|
| **å®Ÿè¡Œç’°å¢ƒ** | Cloud Functions (Python 3.11) |
| **ãƒˆãƒªã‚¬ãƒ¼** | Cloud Scheduler (5åˆ†ã”ã¨) |
| **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ** | 540ç§’ï¼ˆ9åˆ†ï¼‰ |
| **ãƒ¡ãƒ¢ãƒª** | 512MB |
| **ãƒªãƒˆãƒ©ã‚¤** | æœ€å¤§3å›žï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰ |

### 5.2 ç›£è¦–ã‚¸ãƒ§ãƒ–ã®ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç›£è¦–ã‚¸ãƒ§ãƒ–å‡¦ç†ãƒ•ãƒ­ãƒ¼                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Cloud Scheduler]
      â”‚
      â”‚ 5åˆ†ã”ã¨ã«ãƒˆãƒªã‚¬ãƒ¼
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Cloud Functions: watch_google_drive                            â”‚
â”‚                                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                â”‚
â”‚  â”‚ 1. åˆæœŸåŒ–            â”‚                                                                â”‚
â”‚  â”‚                     â”‚                                                                â”‚
â”‚  â”‚ ãƒ»ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿   â”‚                                                                â”‚
â”‚  â”‚ ãƒ»DBæŽ¥ç¶š            â”‚                                                                â”‚
â”‚  â”‚ ãƒ»åŒæœŸãƒ­ã‚°ä½œæˆ      â”‚                                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                â”‚
â”‚             â”‚                                                                            â”‚
â”‚             â–¼                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                â”‚
â”‚  â”‚ 2. ãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³å–å¾— â”‚                                                                â”‚
â”‚  â”‚                     â”‚                                                                â”‚
â”‚  â”‚ google_drive_sync_  â”‚                                                                â”‚
â”‚  â”‚ state ã‹ã‚‰å–å¾—      â”‚                                                                â”‚
â”‚  â”‚                     â”‚                                                                â”‚
â”‚  â”‚ åˆå›žã®å ´åˆ:         â”‚                                                                â”‚
â”‚  â”‚ getStartPageToken() â”‚                                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                â”‚
â”‚             â”‚                                                                            â”‚
â”‚             â–¼                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                â”‚
â”‚  â”‚ 3. å¤‰æ›´ãƒªã‚¹ãƒˆå–å¾—    â”‚                                                                â”‚
â”‚  â”‚                     â”‚                                                                â”‚
â”‚  â”‚ Google Drive API    â”‚                                                                â”‚
â”‚  â”‚ changes().list()    â”‚                                                                â”‚
â”‚  â”‚                     â”‚                                                                â”‚
â”‚  â”‚ ãƒ»æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«       â”‚                                                                â”‚
â”‚  â”‚ ãƒ»æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«       â”‚                                                                â”‚
â”‚  â”‚ ãƒ»å‰Šé™¤ãƒ•ã‚¡ã‚¤ãƒ«       â”‚                                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                â”‚
â”‚             â”‚                                                                            â”‚
â”‚             â–¼                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 4. å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†                                                               â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ 4.1 ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹å–å¾—                                                        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚     ãƒ»è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’å†å¸°çš„ã«å–å¾—                                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚     ãƒ»["ã‚½ã‚¦ãƒ«ãã‚“ç”¨ãƒ•ã‚©ãƒ«ãƒ€", "ç¤¾å“¡é™å®š", "æ¥­å‹™ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«"]                â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                              â”‚                                                    â”‚   â”‚
â”‚  â”‚                              â–¼                                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ 4.2 æ¨©é™æ±ºå®š                                                                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚     ãƒ»classification = determine_classification(folder_path)               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚     ãƒ»department_id = determine_department_id(folder_path)                 â”‚  â”‚   â”‚
â”‚  â”‚  â”‚     ãƒ»category = determine_category(folder_path)                           â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                              â”‚                                                    â”‚   â”‚
â”‚  â”‚                              â–¼                                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ 4.3 ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼ˆè¿½åŠ /æ›´æ–°/å‰Šé™¤ï¼‰                                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  [è¿½åŠ ã®å ´åˆ]                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰                                                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º                                                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²                                                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆ                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»DBä¿å­˜ï¼ˆdocuments, document_chunksï¼‰                                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»Pinecone upsert                                                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  [æ›´æ–°ã®å ´åˆ]                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»æ—¢å­˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—                                                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä½œæˆ                                                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»æ—§ãƒãƒ£ãƒ³ã‚¯ã‚’éžã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»æ–°ãƒãƒ£ãƒ³ã‚¯ä½œæˆï¼ˆè¿½åŠ ã¨åŒæ§˜ï¼‰                                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»Pinecone æ—§ãƒ™ã‚¯ã‚¿ãƒ¼å‰Šé™¤ â†’ æ–°ãƒ™ã‚¯ã‚¿ãƒ¼ upsert                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  [å‰Šé™¤ã®å ´åˆ]                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»documents.deleted_at = NOW()                                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ãƒ»Pinecone ã‹ã‚‰ãƒ™ã‚¯ã‚¿ãƒ¼å‰Šé™¤                                               â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                                                                            â”‚
â”‚             â–¼                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                â”‚
â”‚  â”‚ 5. ãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ â”‚                                                                â”‚
â”‚  â”‚                     â”‚                                                                â”‚
â”‚  â”‚ google_drive_sync_  â”‚                                                                â”‚
â”‚  â”‚ state ã‚’æ›´æ–°        â”‚                                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                â”‚
â”‚             â”‚                                                                            â”‚
â”‚             â–¼                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                â”‚
â”‚  â”‚ 6. åŒæœŸãƒ­ã‚°å®Œäº†      â”‚                                                                â”‚
â”‚  â”‚                     â”‚                                                                â”‚
â”‚  â”‚ ãƒ»status = completedâ”‚                                                                â”‚
â”‚  â”‚ ãƒ»çµ±è¨ˆæƒ…å ±ã‚’è¨˜éŒ²    â”‚                                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 Cloud Schedulerè¨­å®š

```yaml
# cloud_scheduler/watch_google_drive.yaml

name: watch-google-drive-soulsyncs
description: Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ã‚½ã‚¦ãƒ«ãã‚“ã®ãƒŠãƒ¬ãƒƒã‚¸DBã«åæ˜ 

# 5åˆ†ã”ã¨ã«å®Ÿè¡Œ
schedule: "*/5 * * * *"
timeZone: Asia/Tokyo

# ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®š
target:
  type: http
  uri: https://asia-northeast1-soulsyncs-prod.cloudfunctions.net/watch_google_drive
  httpMethod: POST
  headers:
    Content-Type: application/json
  body: |
    {
      "organization_id": "org_soulsyncs",
      "root_folder_id": "YOUR_ROOT_FOLDER_ID"
    }
  oidcToken:
    serviceAccountEmail: scheduler-sa@soulsyncs-prod.iam.gserviceaccount.com

# ãƒªãƒˆãƒ©ã‚¤è¨­å®š
retryConfig:
  retryCount: 3
  minBackoffDuration: 10s
  maxBackoffDuration: 300s
  maxDoublings: 3

# é‡è¤‡å®Ÿè¡Œé˜²æ­¢
attemptDeadline: 540s  # 9åˆ†ï¼ˆCloud Functionsã®æœ€å¤§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
```

### 5.4 ç’°å¢ƒå¤‰æ•°

```bash
# Cloud Functions ç’°å¢ƒå¤‰æ•°

# === å¿…é ˆ ===
ORGANIZATION_ID=org_soulsyncs
ROOT_FOLDER_ID=1ABC...XYZ                          # Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ ID
GOOGLE_SERVICE_ACCOUNT_KEY_PATH=/secrets/sa-key.json

# === ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ===
DATABASE_URL=postgresql://user:pass@host:5432/soulkun
DATABASE_POOL_SIZE=5

# === Pinecone ===
PINECONE_API_KEY=sk-...
PINECONE_ENVIRONMENT=us-east-1-aws
PINECONE_INDEX_NAME=soulkun-knowledge

# === OpenAI ===
OPENAI_API_KEY=sk-...
OPENAI_EMBEDDING_MODEL=text-embedding-3-small

# === è¨­å®š ===
CHUNK_SIZE=1000                                    # ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºï¼ˆæ–‡å­—æ•°ï¼‰
CHUNK_OVERLAP=200                                  # ãƒãƒ£ãƒ³ã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ï¼ˆæ–‡å­—æ•°ï¼‰
MAX_FILE_SIZE_MB=50                                # æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º
SYNC_INTERVAL_MINUTES=5                            # åŒæœŸé–“éš”
```

---

## 6. ãƒ•ã‚©ãƒ«ãƒ€â†’æ¨©é™ãƒžãƒƒãƒ”ãƒ³ã‚°è¨­è¨ˆ

### 6.1 ãƒžãƒƒãƒ”ãƒ³ã‚°è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

```python
# config/folder_mapping.py

"""
Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã¨æ¨©é™ã®ãƒžãƒƒãƒ”ãƒ³ã‚°è¨­å®š

ã€é‡è¦ã€‘
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ãƒ•ã‚©ãƒ«ãƒ€â†’æ¨©é™ã®å¯¾å¿œã‚’ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚ºã§ãã¾ã™ã€‚
å¤‰æ›´å¾Œã¯ç›£è¦–ã‚¸ãƒ§ãƒ–ã®å†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã§ã™ã€‚

ã€Phase 3.5é€£æºã€‘
Phase 3.5ï¼ˆçµ„ç¹”éšŽå±¤ï¼‰å®Œæˆå¾Œã¯ã€DEPARTMENT_MAPã‚’DBã‹ã‚‰å‹•çš„ã«å–å¾—ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚
"""

from typing import Optional
from dataclasses import dataclass


@dataclass
class FolderMapping:
    """ãƒ•ã‚©ãƒ«ãƒ€ãƒžãƒƒãƒ”ãƒ³ã‚°è¨­å®š"""

    # === æ©Ÿå¯†åŒºåˆ†ãƒžãƒƒãƒ”ãƒ³ã‚° ===
    # ã‚­ãƒ¼: ãƒ•ã‚©ãƒ«ãƒ€åï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ï¼‰
    # å€¤: classification
    CLASSIFICATION_MAP: dict[str, str] = None

    # === ã‚«ãƒ†ã‚´ãƒªãƒžãƒƒãƒ”ãƒ³ã‚° ===
    # ã‚­ãƒ¼: ãƒ•ã‚©ãƒ«ãƒ€åã«å«ã¾ã‚Œã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    # å€¤: category
    CATEGORY_MAP: dict[str, str] = None

    # === éƒ¨ç½²IDãƒžãƒƒãƒ”ãƒ³ã‚° ===
    # ã‚­ãƒ¼: ãƒ•ã‚©ãƒ«ãƒ€å
    # å€¤: department_id
    # â€» Phase 3.5é€£æºå¾Œã¯DBã‹ã‚‰å‹•çš„å–å¾—
    DEPARTMENT_MAP: dict[str, str] = None

    def __post_init__(self):
        if self.CLASSIFICATION_MAP is None:
            self.CLASSIFICATION_MAP = {
                # === Level 2 ãƒ•ã‚©ãƒ«ãƒ€ â†’ æ©Ÿå¯†åŒºåˆ† ===
                # æ—¥æœ¬èªž
                "å…¨ç¤¾å…±æœ‰": "public",
                "ç¤¾å“¡é™å®š": "internal",
                "å½¹å“¡é™å®š": "restricted",
                "éƒ¨ç½²åˆ¥": "confidential",

                # è‹±èªžï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
                "public": "public",
                "internal": "internal",
                "restricted": "restricted",
                "confidential": "confidential",
            }

        if self.CATEGORY_MAP is None:
            self.CATEGORY_MAP = {
                # === ã‚«ãƒ†ã‚´ãƒªA: ç†å¿µãƒ»å“²å­¦ ===
                "mvv": "A",
                "ç†å¿µ": "A",
                "ãƒŸãƒƒã‚·ãƒ§ãƒ³": "A",
                "ãƒ“ã‚¸ãƒ§ãƒ³": "A",
                "ãƒãƒªãƒ¥ãƒ¼": "A",
                "ä¼šç¤¾ç´¹ä»‹": "A",
                "ä¼šç¤¾æ¦‚è¦": "A",
                "æ²¿é©": "A",
                "çµŒå–¶": "A",

                # === ã‚«ãƒ†ã‚´ãƒªB: æ¥­å‹™ãƒžãƒ‹ãƒ¥ã‚¢ãƒ« ===
                "ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«": "B",
                "æ‰‹é †æ›¸": "B",
                "ã‚¬ã‚¤ãƒ‰": "B",
                "æ‰‹å¼•ã": "B",
                "è¦å®š": "B",

                # === ã‚«ãƒ†ã‚´ãƒªC: å°±æ¥­è¦å‰‡ ===
                "å°±æ¥­è¦å‰‡": "C",
                "äººäº‹": "C",
                "å‹¤æ€ ": "C",
                "çµ¦ä¸Ž": "C",
                "ç¦åˆ©åŽšç”Ÿ": "C",

                # === ã‚«ãƒ†ã‚´ãƒªD: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ===
                "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ": "D",
                "ã²ãªå½¢": "D",
                "ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ": "D",
                "æ›¸å¼": "D",

                # === ã‚«ãƒ†ã‚´ãƒªE: é¡§å®¢æƒ…å ± ===
                "é¡§å®¢": "E",
                "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ": "E",
                "å–å¼•å…ˆ": "E",

                # === ã‚«ãƒ†ã‚´ãƒªF: ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ± ===
                "ã‚µãƒ¼ãƒ“ã‚¹": "F",
                "æ–™é‡‘": "F",
                "ãƒ—ãƒ©ãƒ³": "F",
                "è£½å“": "F",
            }

        if self.DEPARTMENT_MAP is None:
            self.DEPARTMENT_MAP = {
                # === éƒ¨ç½²å â†’ éƒ¨ç½²ID ===
                # â€» Phase 3.5é€£æºå¾Œã¯DBã‹ã‚‰å‹•çš„å–å¾—ã«å¤‰æ›´
                "å–¶æ¥­éƒ¨": "dept_sales",
                "ç·å‹™éƒ¨": "dept_admin",
                "é–‹ç™ºéƒ¨": "dept_dev",
                "äººäº‹éƒ¨": "dept_hr",
                "çµŒç†éƒ¨": "dept_finance",
                "ãƒžãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨": "dept_marketing",
            }


# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
DEFAULT_CLASSIFICATION = "internal"
DEFAULT_CATEGORY = "B"
DEFAULT_DEPARTMENT_ID = None


# ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
_mapping_instance: Optional[FolderMapping] = None


def get_folder_mapping() -> FolderMapping:
    """ãƒ•ã‚©ãƒ«ãƒ€ãƒžãƒƒãƒ”ãƒ³ã‚°è¨­å®šã‚’å–å¾—"""
    global _mapping_instance
    if _mapping_instance is None:
        _mapping_instance = FolderMapping()
    return _mapping_instance
```

### 6.2 ãƒžãƒƒãƒ”ãƒ³ã‚°å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯

```python
# lib/folder_mapper.py

"""
ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‹ã‚‰ classification, category, department_id ã‚’æ±ºå®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
"""

from typing import Optional
from config.folder_mapping import (
    get_folder_mapping,
    DEFAULT_CLASSIFICATION,
    DEFAULT_CATEGORY,
    DEFAULT_DEPARTMENT_ID
)


class FolderMapper:
    """ãƒ•ã‚©ãƒ«ãƒ€â†’æ¨©é™ãƒžãƒƒãƒ”ãƒ³ã‚°ã‚¯ãƒ©ã‚¹"""

    def __init__(self, organization_id: str):
        self.organization_id = organization_id
        self.mapping = get_folder_mapping()

    def determine_classification(self, folder_path: list[str]) -> str:
        """
        ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‹ã‚‰æ©Ÿå¯†åŒºåˆ†ã‚’æ±ºå®š

        Args:
            folder_path: ãƒ•ã‚©ãƒ«ãƒ€åã®ãƒªã‚¹ãƒˆ
                ä¾‹: ["ã‚½ã‚¦ãƒ«ãã‚“ç”¨ãƒ•ã‚©ãƒ«ãƒ€", "ç¤¾å“¡é™å®š", "æ¥­å‹™ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«"]

        Returns:
            classification: "public", "internal", "confidential", "restricted"

        æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯:
        1. ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‚’ä¸Šã‹ã‚‰é †ã«ãƒã‚§ãƒƒã‚¯
        2. CLASSIFICATION_MAP ã«ä¸€è‡´ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€åãŒã‚ã‚Œã°ã€ãã®å€¤ã‚’è¿”ã™
        3. ä¸€è‡´ã™ã‚‹ã‚‚ã®ãŒãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆinternalï¼‰ã‚’è¿”ã™
        """
        for folder_name in folder_path:
            # å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„
            folder_name_lower = folder_name.lower()

            for key, classification in self.mapping.CLASSIFICATION_MAP.items():
                if key.lower() == folder_name_lower:
                    return classification

        return DEFAULT_CLASSIFICATION

    def determine_category(self, folder_path: list[str]) -> str:
        """
        ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’æ±ºå®š

        Args:
            folder_path: ãƒ•ã‚©ãƒ«ãƒ€åã®ãƒªã‚¹ãƒˆ

        Returns:
            category: "A", "B", "C", "D", "E", "F"

        æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯:
        1. ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‚’ä¸Šã‹ã‚‰é †ã«ãƒã‚§ãƒƒã‚¯
        2. CATEGORY_MAP ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒ•ã‚©ãƒ«ãƒ€åã«å«ã¾ã‚Œã¦ã„ã‚Œã°ã€ãã®å€¤ã‚’è¿”ã™
        3. ä¸€è‡´ã™ã‚‹ã‚‚ã®ãŒãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆBï¼‰ã‚’è¿”ã™
        """
        for folder_name in folder_path:
            folder_name_lower = folder_name.lower()

            for keyword, category in self.mapping.CATEGORY_MAP.items():
                if keyword.lower() in folder_name_lower:
                    return category

        return DEFAULT_CATEGORY

    def determine_department_id(self, folder_path: list[str]) -> Optional[str]:
        """
        ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‹ã‚‰éƒ¨ç½²IDã‚’æ±ºå®š

        Args:
            folder_path: ãƒ•ã‚©ãƒ«ãƒ€åã®ãƒªã‚¹ãƒˆ

        Returns:
            department_id: éƒ¨ç½²ID ã¾ãŸã¯ None

        æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯:
        1. classification ãŒ "confidential" ã§ãªã„å ´åˆã¯ None ã‚’è¿”ã™
        2. ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‚’ä¸Šã‹ã‚‰é †ã«ãƒã‚§ãƒƒã‚¯
        3. DEPARTMENT_MAP ã«ä¸€è‡´ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€åãŒã‚ã‚Œã°ã€ãã®å€¤ã‚’è¿”ã™
        4. ä¸€è‡´ã™ã‚‹ã‚‚ã®ãŒãªã‘ã‚Œã° None ã‚’è¿”ã™

        ã€Phase 3.5é€£æºã€‘
        Phase 3.5å®Œæˆå¾Œã¯ã€DEPARTMENT_MAP ã‚’DBã‹ã‚‰å‹•çš„ã«å–å¾—ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã€‚
        """
        # confidential ã§ãªã„å ´åˆã¯éƒ¨ç½²IDã¯ä¸è¦
        classification = self.determine_classification(folder_path)
        if classification != "confidential":
            return DEFAULT_DEPARTMENT_ID

        for folder_name in folder_path:
            folder_name_normalized = folder_name.strip()

            if folder_name_normalized in self.mapping.DEPARTMENT_MAP:
                return self.mapping.DEPARTMENT_MAP[folder_name_normalized]

        return DEFAULT_DEPARTMENT_ID

    def map_folder_to_permissions(
        self,
        folder_path: list[str]
    ) -> dict:
        """
        ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‹ã‚‰å…¨ã¦ã®æ¨©é™æƒ…å ±ã‚’å–å¾—

        Args:
            folder_path: ãƒ•ã‚©ãƒ«ãƒ€åã®ãƒªã‚¹ãƒˆ

        Returns:
            {
                "classification": "internal",
                "category": "B",
                "department_id": None
            }
        """
        return {
            "classification": self.determine_classification(folder_path),
            "category": self.determine_category(folder_path),
            "department_id": self.determine_department_id(folder_path)
        }


# === ä½¿ç”¨ä¾‹ ===
#
# mapper = FolderMapper("org_soulsyncs")
#
# # ä¾‹1: ç¤¾å“¡é™å®šã®æ¥­å‹™ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«
# path1 = ["ã‚½ã‚¦ãƒ«ãã‚“ç”¨ãƒ•ã‚©ãƒ«ãƒ€", "ç¤¾å“¡é™å®š", "æ¥­å‹™ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«"]
# result1 = mapper.map_folder_to_permissions(path1)
# # â†’ {"classification": "internal", "category": "B", "department_id": None}
#
# # ä¾‹2: å–¶æ¥­éƒ¨ã®é¡§å®¢æƒ…å ±
# path2 = ["ã‚½ã‚¦ãƒ«ãã‚“ç”¨ãƒ•ã‚©ãƒ«ãƒ€", "éƒ¨ç½²åˆ¥", "å–¶æ¥­éƒ¨", "é¡§å®¢æƒ…å ±"]
# result2 = mapper.map_folder_to_permissions(path2)
# # â†’ {"classification": "confidential", "category": "E", "department_id": "dept_sales"}
```

---

## 7. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡¦ç†ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

### 7.1 ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º

```python
# lib/text_extractor.py

"""
å„ç¨®ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
"""

import io
from abc import ABC, abstractmethod
from typing import Optional
import fitz  # PyMuPDF
from docx import Document as DocxDocument
from pptx import Presentation
from openpyxl import load_workbook
from bs4 import BeautifulSoup


class TextExtractor(ABC):
    """ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã®åŸºåº•ã‚¯ãƒ©ã‚¹"""

    @abstractmethod
    def extract(self, content: bytes) -> str:
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""
        pass

    @abstractmethod
    def extract_with_metadata(self, content: bytes) -> dict:
        """ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º"""
        pass


class PDFExtractor(TextExtractor):
    """PDFã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""

    def extract(self, content: bytes) -> str:
        """PDFã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""
        doc = fitz.open(stream=content, filetype="pdf")
        text = ""
        for page in doc:
            text += page.get_text()
        doc.close()
        return text

    def extract_with_metadata(self, content: bytes) -> dict:
        """PDFã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º"""
        doc = fitz.open(stream=content, filetype="pdf")

        pages = []
        for page_num, page in enumerate(doc, start=1):
            page_text = page.get_text()
            pages.append({
                "page_number": page_num,
                "text": page_text,
                "char_count": len(page_text)
            })

        metadata = {
            "total_pages": len(doc),
            "title": doc.metadata.get("title", ""),
            "author": doc.metadata.get("author", ""),
            "subject": doc.metadata.get("subject", ""),
            "creator": doc.metadata.get("creator", ""),
            "creation_date": doc.metadata.get("creationDate", ""),
        }

        doc.close()

        return {
            "text": "\n".join([p["text"] for p in pages]),
            "pages": pages,
            "metadata": metadata
        }


class DocxExtractor(TextExtractor):
    """Wordæ–‡æ›¸ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""

    def extract(self, content: bytes) -> str:
        """DOCXã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""
        doc = DocxDocument(io.BytesIO(content))
        text = "\n".join([para.text for para in doc.paragraphs])
        return text

    def extract_with_metadata(self, content: bytes) -> dict:
        """DOCXã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º"""
        doc = DocxDocument(io.BytesIO(content))

        paragraphs = []
        for i, para in enumerate(doc.paragraphs):
            if para.text.strip():
                paragraphs.append({
                    "index": i,
                    "text": para.text,
                    "style": para.style.name if para.style else None
                })

        # è¦‹å‡ºã—ã‚’æŠ½å‡º
        headings = [
            p for p in paragraphs
            if p["style"] and "Heading" in p["style"]
        ]

        metadata = {
            "total_paragraphs": len(paragraphs),
            "headings": headings,
            "author": doc.core_properties.author,
            "title": doc.core_properties.title,
            "created": str(doc.core_properties.created) if doc.core_properties.created else None,
            "modified": str(doc.core_properties.modified) if doc.core_properties.modified else None,
        }

        return {
            "text": "\n".join([p["text"] for p in paragraphs]),
            "paragraphs": paragraphs,
            "metadata": metadata
        }


class TextFileExtractor(TextExtractor):
    """ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""

    def extract(self, content: bytes) -> str:
        """TXT/MDã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""
        # UTF-8ã‚’è©¦ã—ã€å¤±æ•—ã—ãŸã‚‰Shift-JISã‚’è©¦ã™
        for encoding in ["utf-8", "shift-jis", "cp932", "euc-jp"]:
            try:
                return content.decode(encoding)
            except UnicodeDecodeError:
                continue

        # æœ€å¾Œã®æ‰‹æ®µ: errors='replace'
        return content.decode("utf-8", errors="replace")

    def extract_with_metadata(self, content: bytes) -> dict:
        """TXT/MDã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º"""
        text = self.extract(content)

        lines = text.split("\n")

        # Markdownã®è¦‹å‡ºã—ã‚’æŠ½å‡º
        headings = []
        for i, line in enumerate(lines):
            if line.startswith("#"):
                level = len(line) - len(line.lstrip("#"))
                heading_text = line.lstrip("#").strip()
                headings.append({
                    "line_number": i + 1,
                    "level": level,
                    "text": heading_text
                })

        return {
            "text": text,
            "metadata": {
                "total_lines": len(lines),
                "total_chars": len(text),
                "headings": headings
            }
        }


class HTMLExtractor(TextExtractor):
    """HTMLã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""

    def extract(self, content: bytes) -> str:
        """HTMLã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""
        soup = BeautifulSoup(content, "html.parser")

        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é™¤åŽ»
        for tag in soup(["script", "style", "nav", "footer", "header"]):
            tag.decompose()

        return soup.get_text(separator="\n", strip=True)

    def extract_with_metadata(self, content: bytes) -> dict:
        """HTMLã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º"""
        soup = BeautifulSoup(content, "html.parser")

        # ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
        title = soup.title.string if soup.title else ""

        # è¦‹å‡ºã—ã‚’æŠ½å‡º
        headings = []
        for level in range(1, 7):
            for heading in soup.find_all(f"h{level}"):
                headings.append({
                    "level": level,
                    "text": heading.get_text(strip=True)
                })

        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é™¤åŽ»
        for tag in soup(["script", "style", "nav", "footer", "header"]):
            tag.decompose()

        text = soup.get_text(separator="\n", strip=True)

        return {
            "text": text,
            "metadata": {
                "title": title,
                "headings": headings,
                "total_chars": len(text)
            }
        }


class ExcelExtractor(TextExtractor):
    """Excelã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""

    def extract(self, content: bytes) -> str:
        """XLSXã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""
        wb = load_workbook(io.BytesIO(content), read_only=True, data_only=True)

        texts = []
        for sheet in wb.worksheets:
            for row in sheet.iter_rows():
                row_texts = []
                for cell in row:
                    if cell.value is not None:
                        row_texts.append(str(cell.value))
                if row_texts:
                    texts.append("\t".join(row_texts))

        wb.close()
        return "\n".join(texts)

    def extract_with_metadata(self, content: bytes) -> dict:
        """XLSXã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º"""
        wb = load_workbook(io.BytesIO(content), read_only=True, data_only=True)

        sheets = []
        all_text = []

        for sheet in wb.worksheets:
            sheet_text = []
            for row in sheet.iter_rows():
                row_texts = []
                for cell in row:
                    if cell.value is not None:
                        row_texts.append(str(cell.value))
                if row_texts:
                    sheet_text.append("\t".join(row_texts))

            sheets.append({
                "name": sheet.title,
                "text": "\n".join(sheet_text)
            })
            all_text.extend(sheet_text)

        wb.close()

        return {
            "text": "\n".join(all_text),
            "metadata": {
                "total_sheets": len(sheets),
                "sheets": sheets
            }
        }


class PowerPointExtractor(TextExtractor):
    """PowerPointã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""

    def extract(self, content: bytes) -> str:
        """PPTXã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""
        prs = Presentation(io.BytesIO(content))

        texts = []
        for slide in prs.slides:
            for shape in slide.shapes:
                if hasattr(shape, "text"):
                    texts.append(shape.text)

        return "\n".join(texts)

    def extract_with_metadata(self, content: bytes) -> dict:
        """PPTXã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º"""
        prs = Presentation(io.BytesIO(content))

        slides = []
        all_text = []

        for slide_num, slide in enumerate(prs.slides, start=1):
            slide_text = []
            for shape in slide.shapes:
                if hasattr(shape, "text"):
                    slide_text.append(shape.text)

            slides.append({
                "slide_number": slide_num,
                "text": "\n".join(slide_text)
            })
            all_text.extend(slide_text)

        return {
            "text": "\n".join(all_text),
            "metadata": {
                "total_slides": len(slides),
                "slides": slides
            }
        }


# === ãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•° ===

EXTRACTOR_MAP = {
    "pdf": PDFExtractor,
    "docx": DocxExtractor,
    "doc": DocxExtractor,  # python-docx ã¯ .doc ã‚‚èª­ã‚ã‚‹å ´åˆãŒã‚ã‚‹
    "txt": TextFileExtractor,
    "md": TextFileExtractor,
    "html": HTMLExtractor,
    "htm": HTMLExtractor,
    "xlsx": ExcelExtractor,
    "xls": ExcelExtractor,
    "pptx": PowerPointExtractor,
    "ppt": PowerPointExtractor,
}


def get_extractor(file_type: str) -> Optional[TextExtractor]:
    """
    ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã«å¯¾å¿œã™ã‚‹ã‚¨ã‚¯ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—

    Args:
        file_type: ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ï¼ˆå°æ–‡å­—ï¼‰

    Returns:
        TextExtractor ã¾ãŸã¯ None
    """
    extractor_class = EXTRACTOR_MAP.get(file_type.lower())
    if extractor_class:
        return extractor_class()
    return None


def extract_text(content: bytes, file_type: str) -> str:
    """
    ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º

    Args:
        content: ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿
        file_type: ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­

    Returns:
        æŠ½å‡ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ

    Raises:
        ValueError: ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼
    """
    extractor = get_extractor(file_type)
    if extractor is None:
        raise ValueError(f"ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: {file_type}")
    return extractor.extract(content)


def extract_text_with_metadata(content: bytes, file_type: str) -> dict:
    """
    ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º

    Args:
        content: ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿
        file_type: ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­

    Returns:
        {"text": str, "metadata": dict, ...}

    Raises:
        ValueError: ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼
    """
    extractor = get_extractor(file_type)
    if extractor is None:
        raise ValueError(f"ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: {file_type}")
    return extractor.extract_with_metadata(content)
```

### 7.2 ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²

```python
# lib/chunker.py

"""
ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²æˆ¦ç•¥:
1. ã‚»ãƒžãƒ³ãƒ†ã‚£ãƒƒã‚¯ãªåŒºåˆ‡ã‚Šï¼ˆè¦‹å‡ºã—ã€æ®µè½ï¼‰ã‚’å„ªå…ˆ
2. æ–‡ã®é€”ä¸­ã§åˆ‡ã‚‰ãªã„
3. ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ã§æ–‡è„ˆã‚’ä¿æŒ
"""

import re
from dataclasses import dataclass
from typing import Optional


@dataclass
class Chunk:
    """ãƒãƒ£ãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿"""
    index: int                          # ãƒãƒ£ãƒ³ã‚¯ç•ªå·ï¼ˆ0å§‹ã¾ã‚Šï¼‰
    content: str                        # ãƒãƒ£ãƒ³ã‚¯ã®ãƒ†ã‚­ã‚¹ãƒˆ
    char_count: int                     # æ–‡å­—æ•°
    start_position: int                 # å…ƒæ–‡æ›¸ã§ã®é–‹å§‹ä½ç½®
    end_position: int                   # å…ƒæ–‡æ›¸ã§ã®çµ‚äº†ä½ç½®
    page_number: Optional[int] = None   # ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆPDFã®å ´åˆï¼‰
    section_title: Optional[str] = None # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
    section_hierarchy: list[str] = None # ã‚»ã‚¯ã‚·ãƒ§ãƒ³éšŽå±¤


class TextChunker:
    """ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²ã™ã‚‹ã‚¯ãƒ©ã‚¹"""

    # ã‚»ãƒžãƒ³ãƒ†ã‚£ãƒƒã‚¯ãªåŒºåˆ‡ã‚Šæ–‡å­—ï¼ˆå„ªå…ˆåº¦é †ï¼‰
    SEPARATORS = [
        "\n## ",      # Markdown H2
        "\n### ",     # Markdown H3
        "\n#### ",    # Markdown H4
        "\n\n",       # ç©ºè¡Œï¼ˆæ®µè½åŒºåˆ‡ã‚Šï¼‰
        "\n",         # æ”¹è¡Œ
        "ã€‚",         # æ—¥æœ¬èªžæ–‡æœ«
        "ï¼Ž",         # æ—¥æœ¬èªžãƒ”ãƒªã‚ªãƒ‰ï¼ˆå…¨è§’ï¼‰
        ". ",         # è‹±èªžæ–‡æœ«
        "ï¼",         # æ—¥æœ¬èªžæ„Ÿå˜†ç¬¦
        "ï¼Ÿ",         # æ—¥æœ¬èªžç–‘å•ç¬¦
        "! ",         # è‹±èªžæ„Ÿå˜†ç¬¦
        "? ",         # è‹±èªžç–‘å•ç¬¦
        "ã€",         # æ—¥æœ¬èªžèª­ç‚¹
        ", ",         # è‹±èªžã‚³ãƒ³ãƒž
        " ",          # ã‚¹ãƒšãƒ¼ã‚¹
        "",           # æœ€å¾Œã®æ‰‹æ®µï¼ˆæ–‡å­—å˜ä½ï¼‰
    ]

    def __init__(
        self,
        chunk_size: int = 1000,
        chunk_overlap: int = 200,
        min_chunk_size: int = 100
    ):
        """
        Args:
            chunk_size: ãƒãƒ£ãƒ³ã‚¯ã®æœ€å¤§æ–‡å­—æ•°
            chunk_overlap: ãƒãƒ£ãƒ³ã‚¯é–“ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—æ–‡å­—æ•°
            min_chunk_size: ãƒãƒ£ãƒ³ã‚¯ã®æœ€å°æ–‡å­—æ•°ï¼ˆã“ã‚Œã‚ˆã‚ŠçŸ­ã„ãƒãƒ£ãƒ³ã‚¯ã¯å‰ã®ãƒãƒ£ãƒ³ã‚¯ã«çµåˆï¼‰
        """
        self.chunk_size = chunk_size
        self.chunk_overlap = chunk_overlap
        self.min_chunk_size = min_chunk_size

    def split(self, text: str) -> list[Chunk]:
        """
        ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²

        Args:
            text: åˆ†å‰²ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ

        Returns:
            ãƒãƒ£ãƒ³ã‚¯ã®ãƒªã‚¹ãƒˆ
        """
        if not text or len(text) == 0:
            return []

        # è¦‹å‡ºã—ã‚’æŠ½å‡º
        headings = self._extract_headings(text)

        # åˆ†å‰²
        raw_chunks = self._split_text(text)

        # ãƒãƒ£ãƒ³ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        chunks = []
        current_position = 0
        current_heading = None
        current_hierarchy = []

        for i, chunk_text in enumerate(raw_chunks):
            # ã“ã®ãƒãƒ£ãƒ³ã‚¯ã«å«ã¾ã‚Œã‚‹è¦‹å‡ºã—ã‚’æ›´æ–°
            chunk_start = text.find(chunk_text, current_position)
            chunk_end = chunk_start + len(chunk_text)

            for heading in headings:
                if heading["position"] >= chunk_start and heading["position"] < chunk_end:
                    current_heading = heading["text"]
                    current_hierarchy = heading["hierarchy"]

            chunk = Chunk(
                index=i,
                content=chunk_text,
                char_count=len(chunk_text),
                start_position=chunk_start,
                end_position=chunk_end,
                section_title=current_heading,
                section_hierarchy=current_hierarchy.copy() if current_hierarchy else []
            )
            chunks.append(chunk)

            current_position = chunk_end - self.chunk_overlap

        return chunks

    def split_with_pages(
        self,
        pages: list[dict]
    ) -> list[Chunk]:
        """
        ãƒšãƒ¼ã‚¸æƒ…å ±ä»˜ãã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²ï¼ˆPDFç”¨ï¼‰

        Args:
            pages: [{"page_number": 1, "text": "..."}]

        Returns:
            ãƒãƒ£ãƒ³ã‚¯ã®ãƒªã‚¹ãƒˆï¼ˆpage_numberä»˜ãï¼‰
        """
        chunks = []
        chunk_index = 0

        for page in pages:
            page_number = page["page_number"]
            page_text = page["text"]

            # ãƒšãƒ¼ã‚¸å†…ã§ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²
            page_chunks = self._split_text(page_text)

            current_position = 0
            for chunk_text in page_chunks:
                chunk_start = page_text.find(chunk_text, current_position)
                chunk_end = chunk_start + len(chunk_text)

                chunk = Chunk(
                    index=chunk_index,
                    content=chunk_text,
                    char_count=len(chunk_text),
                    start_position=chunk_start,
                    end_position=chunk_end,
                    page_number=page_number
                )
                chunks.append(chunk)

                chunk_index += 1
                current_position = chunk_end - self.chunk_overlap

        return chunks

    def _split_text(self, text: str) -> list[str]:
        """
        ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†å‰²ï¼ˆå†å¸°çš„ï¼‰
        """
        if len(text) <= self.chunk_size:
            return [text]

        # å„ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã§åˆ†å‰²ã‚’è©¦ã¿ã‚‹
        for separator in self.SEPARATORS:
            if separator == "":
                # æœ€å¾Œã®æ‰‹æ®µ: æ–‡å­—æ•°ã§å¼·åˆ¶åˆ†å‰²
                return self._split_by_length(text)

            if separator in text:
                splits = self._split_by_separator(text, separator)
                if len(splits) > 1:
                    # å†å¸°çš„ã«åˆ†å‰²
                    result = []
                    for split in splits:
                        result.extend(self._split_text(split))
                    return self._merge_small_chunks(result)

        # ã©ã®ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã§ã‚‚åˆ†å‰²ã§ããªã„å ´åˆ
        return self._split_by_length(text)

    def _split_by_separator(self, text: str, separator: str) -> list[str]:
        """ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã§åˆ†å‰²"""
        splits = text.split(separator)

        # ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã‚’å¾©å…ƒï¼ˆæœ€å¾Œä»¥å¤–ï¼‰
        result = []
        for i, split in enumerate(splits):
            if i < len(splits) - 1:
                result.append(split + separator)
            else:
                result.append(split)

        return [s for s in result if s.strip()]

    def _split_by_length(self, text: str) -> list[str]:
        """æ–‡å­—æ•°ã§å¼·åˆ¶åˆ†å‰²"""
        chunks = []
        for i in range(0, len(text), self.chunk_size - self.chunk_overlap):
            chunk = text[i:i + self.chunk_size]
            if chunk.strip():
                chunks.append(chunk)
        return chunks

    def _merge_small_chunks(self, chunks: list[str]) -> list[str]:
        """å°ã•ã™ãŽã‚‹ãƒãƒ£ãƒ³ã‚¯ã‚’å‰ã®ãƒãƒ£ãƒ³ã‚¯ã«çµåˆ"""
        if not chunks:
            return chunks

        result = [chunks[0]]

        for chunk in chunks[1:]:
            if len(chunk) < self.min_chunk_size and result:
                result[-1] += chunk
            else:
                result.append(chunk)

        return result

    def _extract_headings(self, text: str) -> list[dict]:
        """è¦‹å‡ºã—ã‚’æŠ½å‡º"""
        headings = []

        # Markdownå½¢å¼ã®è¦‹å‡ºã—
        md_heading_pattern = r'^(#{1,6})\s+(.+)$'
        for match in re.finditer(md_heading_pattern, text, re.MULTILINE):
            level = len(match.group(1))
            heading_text = match.group(2)
            position = match.start()

            # éšŽå±¤ã‚’æ§‹ç¯‰
            hierarchy = [heading_text]  # ç°¡æ˜“ç‰ˆ

            headings.append({
                "level": level,
                "text": heading_text,
                "position": position,
                "hierarchy": hierarchy
            })

        return headings
```

---

## 8. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ

### 8.1 ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã¨å¯¾å¿œ

| ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ | ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ | å¯¾å¿œ | ãƒªãƒˆãƒ©ã‚¤ |
|-----------|------------|------|---------|
| Google Drive APIæŽ¥ç¶šã‚¨ãƒ©ãƒ¼ | GD_001 | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¢ãƒ©ãƒ¼ãƒˆ | 3å›ž |
| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•— | GD_002 | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¹ã‚­ãƒƒãƒ— | 3å›ž |
| ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹å–å¾—å¤±æ•— | GD_003 | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¹ã‚­ãƒƒãƒ— | 3å›ž |
| ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºå¤±æ•— | DOC_001 | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¹ã‚­ãƒƒãƒ— | ãªã— |
| ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å½¢å¼ | DOC_002 | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¹ã‚­ãƒƒãƒ— | ãªã— |
| ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºè¶…éŽ | DOC_003 | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¹ã‚­ãƒƒãƒ— | ãªã— |
| OpenAI APIæŽ¥ç¶šã‚¨ãƒ©ãƒ¼ | OAI_001 | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¢ãƒ©ãƒ¼ãƒˆ | 3å›ž |
| ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆå¤±æ•— | OAI_002 | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¹ã‚­ãƒƒãƒ— | 3å›ž |
| PineconeæŽ¥ç¶šã‚¨ãƒ©ãƒ¼ | PC_001 | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¢ãƒ©ãƒ¼ãƒˆ | 3å›ž |
| Pinecone upsertå¤±æ•— | PC_002 | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¢ãƒ©ãƒ¼ãƒˆ | 3å›ž |
| DBæŽ¥ç¶šã‚¨ãƒ©ãƒ¼ | DB_001 | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¢ãƒ©ãƒ¼ãƒˆ | 3å›ž |
| DBä¿å­˜å¤±æ•— | DB_002 | ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆ | 3å›ž |

### 8.2 ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥

```python
# lib/retry.py

from tenacity import (
    retry,
    stop_after_attempt,
    wait_exponential,
    retry_if_exception_type
)
from google.api_core.exceptions import GoogleAPIError
from openai import APIError as OpenAIAPIError
from pinecone.exceptions import PineconeException


# Google Drive APIç”¨ãƒªãƒˆãƒ©ã‚¤ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
google_drive_retry = retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=1, max=10),
    retry=retry_if_exception_type(GoogleAPIError)
)

# OpenAI APIç”¨ãƒªãƒˆãƒ©ã‚¤ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
openai_retry = retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=30),
    retry=retry_if_exception_type(OpenAIAPIError)
)

# Pineconeç”¨ãƒªãƒˆãƒ©ã‚¤ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
pinecone_retry = retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=1, max=10),
    retry=retry_if_exception_type(PineconeException)
)
```

### 8.3 ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

```python
# lib/alerting.py

import os
from lib.chatwork import ChatworkClient


ALERT_ROOM_ID = os.getenv("ALERT_CHATWORK_ROOM_ID")


async def send_alert(
    title: str,
    message: str,
    severity: str = "warning",  # "info", "warning", "error", "critical"
    details: dict = None
):
    """
    ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€ä¿¡

    Args:
        title: ã‚¢ãƒ©ãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«
        message: ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        severity: æ·±åˆ»åº¦
        details: è©³ç´°æƒ…å ±
    """
    severity_emoji = {
        "info": "â„¹ï¸",
        "warning": "âš ï¸",
        "error": "âŒ",
        "critical": "ðŸš¨"
    }

    emoji = severity_emoji.get(severity, "â„¹ï¸")

    alert_message = f"""
{emoji} {title}

{message}
"""

    if details:
        alert_message += "\nè©³ç´°:\n"
        for key, value in details.items():
            alert_message += f"ãƒ»{key}: {value}\n"

    client = ChatworkClient()
    await client.send_message(
        room_id=ALERT_ROOM_ID,
        message=alert_message
    )
```

---

## 9. é‹ç”¨è¨­è¨ˆ

### 9.1 ç›£è¦–é …ç›®

| é …ç›® | ç›£è¦–æ–¹æ³• | é–¾å€¤ | ã‚¢ãƒ©ãƒ¼ãƒˆ |
|------|---------|------|---------|
| ç›£è¦–ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œ | Cloud Monitoring | 15åˆ†ä»¥ä¸Šå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„ | Chatworké€šçŸ¥ |
| åŒæœŸã‚¨ãƒ©ãƒ¼çŽ‡ | google_drive_sync_logs | 5%ä»¥ä¸Š | Chatworké€šçŸ¥ |
| å‡¦ç†æ™‚é–“ | google_drive_sync_logs.duration_ms | 5åˆ†ä»¥ä¸Š | Chatworké€šçŸ¥ |
| Pinecone ãƒ™ã‚¯ã‚¿ãƒ¼æ•° | Pinecone Console | 100ä¸‡è¶… | Chatworké€šçŸ¥ |
| ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ã‚³ã‚¹ãƒˆ | OpenAI Dashboard | $50/æ—¥è¶… | Chatworké€šçŸ¥ |

### 9.2 ãƒ­ã‚°è¨­è¨ˆ

```python
# lib/logging_config.py

import logging
import json
from datetime import datetime


class StructuredLogger:
    """æ§‹é€ åŒ–ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ãƒ­ã‚¬ãƒ¼"""

    def __init__(self, name: str):
        self.logger = logging.getLogger(name)
        self.logger.setLevel(logging.INFO)

    def _log(self, level: str, message: str, **kwargs):
        log_entry = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": level,
            "message": message,
            "service": "watch_google_drive",
            **kwargs
        }
        self.logger.log(
            getattr(logging, level.upper()),
            json.dumps(log_entry, ensure_ascii=False)
        )

    def info(self, message: str, **kwargs):
        self._log("info", message, **kwargs)

    def warning(self, message: str, **kwargs):
        self._log("warning", message, **kwargs)

    def error(self, message: str, **kwargs):
        self._log("error", message, **kwargs)


# ä½¿ç”¨ä¾‹
# logger = StructuredLogger("watch_google_drive")
# logger.info("ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†å®Œäº†", file_id="abc123", file_name="manual.pdf", duration_ms=1500)
```

### 9.3 é‹ç”¨æ‰‹é †æ›¸

```markdown
# Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æº é‹ç”¨æ‰‹é †æ›¸

## æ—¥æ¬¡ç¢ºèª

1. Cloud Console â†’ Cloud Functions â†’ watch_google_drive ã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª
2. ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª
3. google_drive_sync_logs ãƒ†ãƒ¼ãƒ–ãƒ«ã§åŒæœŸçŠ¶æ³ã‚’ç¢ºèª

## ãƒ•ã‚¡ã‚¤ãƒ«ãŒåæ˜ ã•ã‚Œãªã„å ´åˆ

1. Googleãƒ‰ãƒ©ã‚¤ãƒ–ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã‹ç¢ºèª
2. ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆPDF, DOCX, TXT, MD, HTML, XLSX, PPTXï¼‰
3. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ50MBä»¥ä¸‹ã‹ç¢ºèª
4. google_drive_sync_logs ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª
5. å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆã¯ã€æ‰‹å‹•ã§ç›£è¦–ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ

## æ‰‹å‹•ã§ç›£è¦–ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ

```bash
gcloud functions call watch_google_drive \
  --data '{"organization_id": "org_soulsyncs", "root_folder_id": "YOUR_FOLDER_ID"}'
```

## ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’å¤‰æ›´ã™ã‚‹å ´åˆ

1. config/folder_mapping.py ã‚’ç·¨é›†
2. Cloud Functions ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤
3. æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ã‚’æ›´æ–°ã™ã‚‹å ´åˆã¯ã€ãƒ•ãƒ«ã‚·ãƒ³ã‚¯ã‚’å®Ÿè¡Œ

## ãƒ•ãƒ«ã‚·ãƒ³ã‚¯ï¼ˆå…¨ãƒ•ã‚¡ã‚¤ãƒ«å†å–ã‚Šè¾¼ã¿ï¼‰

```bash
gcloud functions call watch_google_drive \
  --data '{"organization_id": "org_soulsyncs", "root_folder_id": "YOUR_FOLDER_ID", "full_sync": true}'
```

æ³¨æ„: ãƒ•ãƒ«ã‚·ãƒ³ã‚¯ã¯å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å‡¦ç†ã™ã‚‹ãŸã‚ã€æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚
```

---

## 10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 10.1 èªè¨¼ãƒ»èªå¯

| å¯¾è±¡ | èªè¨¼æ–¹å¼ | èªå¯ |
|------|---------|------|
| Google Drive API | ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ | èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆdrive.readonlyï¼‰ |
| Cloud Functions | Cloud Schedulerï¼ˆOIDCï¼‰ | ç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿å®Ÿè¡Œå¯ |
| Cloud SQL | IAMèªè¨¼ | ç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿æŽ¥ç¶šå¯ |
| Pinecone | API Key | Secret Manager ã§ç®¡ç† |
| OpenAI | API Key | Secret Manager ã§ç®¡ç† |

### 10.2 ãƒ‡ãƒ¼ã‚¿ä¿è­·

| å¯¾è±¡ | ä¿è­·æ–¹æ³• |
|------|---------|
| Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€å‡¦ç†å®Œäº†æ¬¡ç¬¬ãƒ¡ãƒ¢ãƒªã‹ã‚‰å‰Šé™¤ |
| API Key | Secret Manager ã§ç®¡ç†ã€ã‚³ãƒ¼ãƒ‰ã«å«ã‚ãªã„ |
| DBæŽ¥ç¶šæƒ…å ± | Secret Manager ã§ç®¡ç† |
| ãƒ­ã‚° | æ©Ÿå¯†æƒ…å ±ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼‰ã‚’å«ã‚ãªã„ |

### 10.3 ç›£æŸ»ãƒ­ã‚°

```python
# 10ã®é‰„å‰‡ #3: ç›£æŸ»ãƒ­ã‚°

# Googleãƒ‰ãƒ©ã‚¤ãƒ–åŒæœŸã®ç›£æŸ»ãƒ­ã‚°
await AuditLog.create(
    organization_id=organization_id,
    user_id=None,  # ã‚·ã‚¹ãƒ†ãƒ å‡¦ç†
    action="google_drive_sync",
    resource_type="document",
    resource_id=document_id,
    details={
        "sync_id": sync_id,
        "file_id": google_drive_file_id,
        "operation": "add" | "update" | "delete",
        "classification": classification,
        "department_id": department_id
    }
)
```

---

## 11. ãƒ†ã‚¹ãƒˆè¨­è¨ˆ

### 11.1 ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

| # | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æœŸå¾…çµæžœ |
|---|-------------|---------|
| 1 | PDFè¿½åŠ  | documents, document_chunks, Pinecone ã«ç™»éŒ² |
| 2 | DOCXè¿½åŠ  | documents, document_chunks, Pinecone ã«ç™»éŒ² |
| 3 | TXTè¿½åŠ  | documents, document_chunks, Pinecone ã«ç™»éŒ² |
| 4 | 50MBè¶…ãƒ•ã‚¡ã‚¤ãƒ« | ã‚¹ã‚­ãƒƒãƒ—ã€ãƒ­ã‚°ã«è¨˜éŒ² |
| 5 | ã‚µãƒãƒ¼ãƒˆå¤–å½¢å¼ï¼ˆexeï¼‰ | ã‚¹ã‚­ãƒƒãƒ—ã€ãƒ­ã‚°ã«è¨˜éŒ² |
| 6 | ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–° | æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä½œæˆã€Pineconeæ›´æ–° |
| 7 | ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ | ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆã€Pineconeå‰Šé™¤ |
| 8 | ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹• | classification, department_idæ›´æ–° |
| 9 | å…¨ç¤¾å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ | classification = "public" |
| 10 | ç¤¾å“¡é™å®šãƒ•ã‚©ãƒ«ãƒ€ | classification = "internal" |
| 11 | éƒ¨ç½²åˆ¥ãƒ•ã‚©ãƒ«ãƒ€ | classification = "confidential", department_idè¨­å®š |
| 12 | Google Drive APIéšœå®³ | ãƒªãƒˆãƒ©ã‚¤ã€ã‚¢ãƒ©ãƒ¼ãƒˆ |
| 13 | OpenAI APIéšœå®³ | ãƒªãƒˆãƒ©ã‚¤ã€ã‚¢ãƒ©ãƒ¼ãƒˆ |
| 14 | Pineconeéšœå®³ | ãƒªãƒˆãƒ©ã‚¤ã€ã‚¢ãƒ©ãƒ¼ãƒˆ |

### 11.2 ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

```python
# tests/fixtures/google_drive.py

TEST_FILES = [
    {
        "file_id": "test_file_001",
        "name": "çµŒè²»ç²¾ç®—ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«.pdf",
        "mime_type": "application/pdf",
        "folder_path": ["ã‚½ã‚¦ãƒ«ãã‚“ç”¨ãƒ•ã‚©ãƒ«ãƒ€", "ç¤¾å“¡é™å®š", "æ¥­å‹™ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«"],
        "expected": {
            "classification": "internal",
            "category": "B",
            "department_id": None
        }
    },
    {
        "file_id": "test_file_002",
        "name": "å–¶æ¥­ãƒˆãƒ¼ã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ.docx",
        "mime_type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        "folder_path": ["ã‚½ã‚¦ãƒ«ãã‚“ç”¨ãƒ•ã‚©ãƒ«ãƒ€", "éƒ¨ç½²åˆ¥", "å–¶æ¥­éƒ¨", "å–¶æ¥­ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«"],
        "expected": {
            "classification": "confidential",
            "category": "B",
            "department_id": "dept_sales"
        }
    }
]
```

---

## 12. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### 12.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

- [ ] documents ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®è¿½åŠ ã‚«ãƒ©ãƒ ï¼ˆgoogle_drive_*ï¼‰
- [ ] google_drive_sync_logs ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] google_drive_sync_state ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
- [ ] ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

### 12.2 å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- [ ] lib/google_drive.pyï¼ˆGoogle Drive APIé€£æºï¼‰
- [ ] lib/folder_mapper.pyï¼ˆãƒ•ã‚©ãƒ«ãƒ€â†’æ¨©é™ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼‰
- [ ] lib/text_extractor.pyï¼ˆãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºï¼‰
- [ ] lib/chunker.pyï¼ˆãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ï¼‰
- [ ] lib/retry.pyï¼ˆãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥ï¼‰
- [ ] lib/alerting.pyï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ï¼‰
- [ ] config/folder_mapping.pyï¼ˆãƒžãƒƒãƒ”ãƒ³ã‚°è¨­å®šï¼‰

### 12.3 Cloud Functions

- [ ] watch_google_drive/main.pyï¼ˆç›£è¦–ã‚¸ãƒ§ãƒ–ï¼‰
- [ ] watch_google_drive/requirements.txt
- [ ] cloud_scheduler/watch_google_drive.yaml

### 12.4 è¨­å®š

- [ ] ç’°å¢ƒå¤‰æ•°è¨­å®š
- [ ] Secret Manager ã«APIã‚­ãƒ¼ç™»éŒ²
- [ ] ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
- [ ] Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ•ã‚©ãƒ«ãƒ€å…±æœ‰è¨­å®š

### 12.5 ãƒ†ã‚¹ãƒˆ

- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] E2Eãƒ†ã‚¹ãƒˆ

### 12.6 é‹ç”¨

- [ ] Cloud Monitoringè¨­å®š
- [ ] ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
- [ ] é‹ç”¨æ‰‹é †æ›¸

---

**[ðŸ“ ç›®æ¬¡ã«æˆ»ã‚‹](00_README.md)**
