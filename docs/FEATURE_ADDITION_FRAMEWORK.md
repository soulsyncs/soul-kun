# 新機能追加フレームワーク

**作成日:** 2026-01-30
**目的:** 新機能・新ツール追加時に「何をどこに書くか」を明確にし、設計の一貫性を保つ

---

## Document Contract（SoT宣言）

| 項目 | 内容 |
|------|------|
| **この文書の役割** | 新機能追加時の設計書更新ガイド |
| **書くこと** | 追加手順、更新すべき設計書一覧、チェックリスト |
| **書かないこと** | 個別機能の設計詳細（→各機能の設計書） |
| **SoT（この文書が正）** | 新機能追加プロセスの全仕様 |
| **Owner** | Tech Lead（連絡先: #dev チャンネル） |
| **更新トリガー** | プロセス変更時、新しい設計書カテゴリ追加時 |

---

## 1. 新機能追加の全体フロー

```
【新機能の要件定義】
        ↓
【Step 1】機能カテゴリの特定
        ↓
【Step 2】影響範囲の分析
        ↓
【Step 3】設計書の更新
        ↓
【Step 4】実装
        ↓
【Step 5】テスト追加
        ↓
【Step 6】ドキュメント最終確認
        ↓
【Step 7】PRマージ・デプロイ
```

---

## 2. Step 1: 機能カテゴリの特定

### 2.1 機能カテゴリ一覧

| カテゴリ | 説明 | 例 |
|---------|------|-----|
| **A. Brain機能** | 脳の判断ロジックに関わる | 新しい意図認識、確認フロー変更 |
| **B. Tool追加** | 脳が呼び出す新しいツール | Slack連携、カレンダー連携 |
| **C. API追加** | 外部公開する新しいAPI | 新しいエンドポイント |
| **D. データモデル変更** | DBスキーマの変更 | 新テーブル追加、カラム追加 |
| **E. インフラ変更** | 環境・デプロイ設定の変更 | 新しいCloud Function |
| **F. セキュリティ機能** | 権限・認証に関わる | 新しい権限レベル |
| **G. 外部連携** | 外部サービスとの連携 | 新しいAPI連携先 |

### 2.2 カテゴリ判定フロー

```
新機能を検討
      ↓
【Q1】脳の判断ロジックを変更する？
  → Yes → カテゴリA（Brain機能）
  → No → 次へ
      ↓
【Q2】脳が呼び出す新しいツールを追加する？
  → Yes → カテゴリB（Tool追加）
  → No → 次へ
      ↓
【Q3】外部に公開するAPIを追加する？
  → Yes → カテゴリC（API追加）
  → No → 次へ
      ↓
【Q4】DBスキーマを変更する？
  → Yes → カテゴリD（データモデル変更）
  → No → 次へ
      ↓
【Q5】環境・デプロイ設定を変更する？
  → Yes → カテゴリE（インフラ変更）
  → No → 次へ
      ↓
【Q6】権限・認証に関わる？
  → Yes → カテゴリF（セキュリティ機能）
  → No → 次へ
      ↓
【Q7】外部サービスと連携する？
  → Yes → カテゴリG（外部連携）
  → No → 既存機能の改善（軽微な変更）
```

**注意:** 複数カテゴリに該当する場合は、全てのカテゴリの手順を実行する。

---

## 3. Step 2: 影響範囲の分析

### 3.1 影響分析テンプレート

```markdown
## 新機能: [機能名]

### 概要
[機能の簡単な説明]

### カテゴリ
- [ ] A. Brain機能
- [ ] B. Tool追加
- [ ] C. API追加
- [ ] D. データモデル変更
- [ ] E. インフラ変更
- [ ] F. セキュリティ機能
- [ ] G. 外部連携

### 影響を受けるコンポーネント
| コンポーネント | 影響内容 | 変更規模 |
|---------------|---------|---------|
| [コンポーネント名] | [何が変わるか] | 大/中/小 |

### 影響を受ける設計書
| 設計書 | 更新内容 |
|--------|---------|
| [設計書名] | [何を追記するか] |

### リスク評価
| リスク | 影響度 | 対策 |
|--------|--------|------|
| [リスク内容] | 高/中/低 | [対策] |
```

### 3.2 影響範囲の確認方法

```bash
# 関連するファイルを検索
grep -r "[関連キーワード]" docs/
grep -r "[関連キーワード]" proactive-monitor/
grep -r "[関連キーワード]" api/

# 設計書の参照関係を確認
grep -r "参照:" docs/ | grep "[対象設計書]"
```

---

## 4. Step 3: 設計書の更新

### 4.1 カテゴリ別・更新すべき設計書

#### カテゴリA: Brain機能

| 設計書 | 更新内容 | 必須/推奨 |
|--------|---------|----------|
| `25_llm_native_brain_architecture.md` | 判断ロジックの追加 | **必須** |
| `CLAUDE.md` | 脳の鉄則に影響あれば更新 | 推奨 |
| `tests/test_prompt_regression.py` | テストケース追加 | **必須** |
| `DESIGN_COVERAGE_MATRIX.md` | SoT更新 | **必須** |

#### カテゴリB: Tool追加

| 設計書 | 更新内容 | 必須/推奨 |
|--------|---------|----------|
| `25_llm_native_brain_architecture.md` | Tool定義セクション更新 | **必須** |
| `TOOL_LIFECYCLE_POLICY.md` | 追加手順に従う | **必須** |
| `07_tool_catalog.md`（※未作成なら新規） | ツール仕様の追加 | **必須** |
| `04_api_and_security.md` | 必要に応じてAPI仕様 | 推奨 |
| `DESIGN_COVERAGE_MATRIX.md` | SoT更新 | **必須** |

> **Tool削除の場合:** → `TOOL_LIFECYCLE_POLICY.md` を参照（削除専用の手順あり）

#### カテゴリC: API追加

| 設計書 | 更新内容 | 必須/推奨 |
|--------|---------|----------|
| `04_api_and_security.md` | エンドポイント仕様追加 | **必須** |
| `api/openapi.yaml`（※あれば） | OpenAPI仕様更新 | 推奨 |
| `CLAUDE.md` | 鉄則違反がないか確認 | 推奨 |
| `DESIGN_COVERAGE_MATRIX.md` | SoT更新 | **必須** |

#### カテゴリD: データモデル変更

| 設計書 | 更新内容 | 必須/推奨 |
|--------|---------|----------|
| `03_database_design.md` | テーブル定義追加 | **必須** |
| `SECURITY_AUDIT_ORGANIZATION_ID.md` | organization_id確認 | **必須** |
| `RLS_POLICY_DESIGN.md` | RLSポリシー追加 | **必須** |
| `DESIGN_COVERAGE_MATRIX.md` | SoT更新 | **必須** |

#### カテゴリE: インフラ変更

| 設計書 | 更新内容 | 必須/推奨 |
|--------|---------|----------|
| `OPERATIONS_RUNBOOK.md` | 運用手順追加 | **必須** |
| `DISASTER_DRILL_PLAN.md` | 障害シナリオ追加 | 推奨 |
| `CLAUDE.md` | 環境変数など | 推奨 |
| `DESIGN_COVERAGE_MATRIX.md` | SoT更新 | **必須** |

#### カテゴリF: セキュリティ機能

| 設計書 | 更新内容 | 必須/推奨 |
|--------|---------|----------|
| `04_api_and_security.md` | セキュリティ仕様追加 | **必須** |
| `CLAUDE.md` | 権限レベル更新 | **必須** |
| `api/app/services/access_control.py` | 実装と設計の整合性 | **必須** |
| `SECURITY_AUDIT_ORGANIZATION_ID.md` | 監査項目追加 | **必須** |
| `DESIGN_COVERAGE_MATRIX.md` | SoT更新 | **必須** |

#### カテゴリG: 外部連携

| 設計書 | 更新内容 | 必須/推奨 |
|--------|---------|----------|
| `04_api_and_security.md` | 連携仕様追加 | **必須** |
| `OPERATIONS_RUNBOOK.md` | 障害対応手順追加 | **必須** |
| `DISASTER_DRILL_PLAN.md` | 障害シナリオ追加 | 推奨 |
| `TROUBLESHOOTING_FRAMEWORK.md` | トラブルシュート追加 | 推奨 |
| `DESIGN_COVERAGE_MATRIX.md` | SoT更新 | **必須** |

### 4.2 全カテゴリ共通・必ず確認する設計書

| 設計書 | 確認内容 |
|--------|---------|
| `CLAUDE.md` | 10の鉄則に違反していないか |
| `DESIGN_COVERAGE_MATRIX.md` | SoTが正しく設定されているか |
| `PROGRESS.md` | 進捗を記録 |

---

## 5. Step 4: 実装

### 5.1 実装前チェックリスト

- [ ] 設計書が全て更新されている
- [ ] CLAUDE.md の10の鉄則を再確認
- [ ] 脳アーキテクチャに違反していない
- [ ] セキュリティ要件を満たしている

### 5.2 実装時の注意点

| 注意点 | 詳細 |
|--------|------|
| **脳をバイパスしない** | 全入力は脳を通る（鉄則#1） |
| **organization_id** | 全クエリにフィルタを追加 |
| **監査ログ** | confidential以上は記録 |
| **エラーハンドリング** | 機密情報を含めない |

---

## 6. Step 5: テスト追加

### 6.1 テスト種別とカバレッジ

| テスト種別 | 必須カテゴリ | カバレッジ目標 |
|-----------|-------------|---------------|
| **ユニットテスト** | 全カテゴリ | 80%以上 |
| **統合テスト** | B, C, D, G | 主要パス100% |
| **プロンプト回帰テスト** | A, B | 該当ケース追加 |
| **セキュリティテスト** | D, F | 権限境界テスト |

### 6.2 テスト追加チェックリスト

- [ ] ユニットテスト追加（カバレッジ80%以上）
- [ ] 統合テスト追加（該当する場合）
- [ ] プロンプト回帰テスト追加（Brain/Tool変更時）
- [ ] セキュリティテスト追加（権限関連変更時）
- [ ] organization_id分離テスト追加（DB変更時）

---

## 7. Step 6: ドキュメント最終確認

### 7.1 最終チェックリスト

#### 設計書の整合性

- [ ] 全ての設計書が最新の実装を反映している
- [ ] SoT間で矛盾がない
- [ ] Document Contractが正しく記載されている
- [ ] 更新履歴に変更が記録されている

#### DESIGN_COVERAGE_MATRIX.md

- [ ] 新しいSoTが追加されている（必要な場合）
- [ ] 既存のSoTに影響があれば更新されている
- [ ] MECEが維持されている（漏れなくダブりなく）

#### PROGRESS.md

- [ ] 実装内容が記録されている
- [ ] バージョンが更新されている

---

## 8. Step 7: PRマージ・デプロイ

### 8.1 PRチェックリスト

- [ ] 全テストがパス
- [ ] コードレビュー完了
- [ ] 設計書レビュー完了（設計書変更がある場合）
- [ ] セキュリティレビュー完了（セキュリティ関連の場合）

### 8.2 デプロイ後の確認

- [ ] 本番環境で動作確認
- [ ] 監視アラートが正常
- [ ] エラーログに異常がない

---

## 9. 新機能追加の完全チェックリスト

### 9.1 事前チェック

- [ ] 機能カテゴリを特定した（セクション2）
- [ ] 影響範囲を分析した（セクション3）
- [ ] 更新すべき設計書を特定した（セクション4）

### 9.2 設計書更新チェック

- [ ] カテゴリ別の必須設計書を全て更新した
- [ ] DESIGN_COVERAGE_MATRIX.md を更新した
- [ ] Document Contractを正しく記載した

### 9.3 実装チェック

- [ ] CLAUDE.md の10の鉄則に違反していない
- [ ] organization_idフィルタを追加した（DB変更時）
- [ ] 脳をバイパスしていない

### 9.4 テストチェック

- [ ] ユニットテストを追加した（カバレッジ80%以上）
- [ ] 必要なテスト種別を全て追加した
- [ ] 全テストがパスする

### 9.5 最終チェック

- [ ] 設計書間で矛盾がない
- [ ] PROGRESS.md を更新した
- [ ] PRレビューを完了した

---

## 10. 例: Slack連携機能を追加する場合

### 10.1 カテゴリ特定

- **カテゴリB**: 脳が呼び出す新しいツール（Slack送信Tool）
- **カテゴリG**: 外部サービスとの連携（Slack API）

### 10.2 更新すべき設計書

| 設計書 | 更新内容 |
|--------|---------|
| `25_llm_native_brain_architecture.md` | Slack ToolのTool定義追加 |
| `04_api_and_security.md` | Slack API連携仕様 |
| `OPERATIONS_RUNBOOK.md` | Slack障害時の対応手順 |
| `DISASTER_DRILL_PLAN.md` | Slack障害シナリオ追加 |
| `TROUBLESHOOTING_FRAMEWORK.md` | Slackエラー→対処マッピング |
| `DESIGN_COVERAGE_MATRIX.md` | SoT追加 |
| `PROGRESS.md` | 実装記録 |

### 10.3 テスト追加

- ユニットテスト: Slack Tool単体テスト
- 統合テスト: 脳→Slack Tool→Slack API
- プロンプト回帰テスト: 「Slackに送って」の判定テスト

---

## 11. 関連ドキュメント

| ドキュメント | 参照内容 |
|-------------|---------|
| DESIGN_COVERAGE_MATRIX.md | SoT一覧、設計書マッピング |
| DESIGN_DEPRECATION_POLICY.md | 設計書の廃止方法 |
| DOCUMENTATION_FRESHNESS_POLICY.md | 設計書の鮮度管理 |
| **TOOL_LIFECYCLE_POLICY.md** | **Tool（手足）の追加/拡張/削除の安全手順** |
| CLAUDE.md | 10の鉄則、脳アーキテクチャ |

---

## 更新履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-30 | 初版作成 |
| 2026-01-30 | カテゴリBにTOOL_LIFECYCLE_POLICY.mdへの参照追加 |

---

**このファイルについての質問は、Tech Leadに連絡してください。**
