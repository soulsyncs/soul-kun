name: Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  # =====================================================
  # 1. lib/ã‚³ãƒ”ãƒ¼ã®åŒæœŸãƒã‚§ãƒƒã‚¯ï¼ˆv10.53.0æ‹¡å¼µï¼‰
  # =====================================================
  #
  # ãƒã‚§ãƒƒã‚¯å¯¾è±¡:
  #   - lib/text_utils.py
  #   - lib/goal_setting.py
  #   - lib/mvv_context.py
  #   - lib/report_generator.py
  #   - lib/audit.py
  #   - lib/memory/* (ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª)
  #   - lib/detection/* (ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª)
  #   - lib/business_day.py
  #   - lib/brain/* (ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª) â† v10.53.0è¿½åŠ ã€é‡è¦ã€‘
  #   - lib/feature_flags.py â† v10.53.0è¿½åŠ 
  #
  # =====================================================
  lib-sync-check:
    name: Check lib/ copies are in sync
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Check all lib/ copies are in sync
        run: |
          echo "ğŸ” Checking all lib/ copies are in sync..."
          echo ""

          ERRORS_FOUND=0

          # =====================================================
          # åŒæœŸãƒã‚§ãƒƒã‚¯é–¢æ•°
          # =====================================================
          check_sync() {
            local source="$1"
            local target="$2"

            if [ ! -f "$source" ]; then
              echo "âš ï¸ Source not found: $source"
              return 0
            fi

            if [ -f "$target" ]; then
              if ! diff -q "$source" "$target" > /dev/null 2>&1; then
                echo "âŒ OUT OF SYNC: $source â‰  $target"
                echo "   First 20 lines of diff:"
                diff "$source" "$target" | head -20
                echo ""
                return 1
              else
                echo "âœ… $target"
                return 0
              fi
            else
              echo "âš ï¸ Target not found: $target (may be intentional)"
              return 0
            fi
          }

          # =====================================================
          # 1. text_utils.py
          # =====================================================
          echo "ğŸ“¦ [1/11] text_utils.py"
          check_sync "lib/text_utils.py" "remind-tasks/lib/text_utils.py" || ERRORS_FOUND=1
          check_sync "lib/text_utils.py" "sync-chatwork-tasks/lib/text_utils.py" || ERRORS_FOUND=1
          check_sync "lib/text_utils.py" "chatwork-webhook/lib/text_utils.py" || ERRORS_FOUND=1
          check_sync "lib/text_utils.py" "check-reply-messages/lib/text_utils.py" || ERRORS_FOUND=1
          check_sync "lib/text_utils.py" "cleanup-old-data/lib/text_utils.py" || ERRORS_FOUND=1
          check_sync "lib/text_utils.py" "pattern-detection/lib/text_utils.py" || ERRORS_FOUND=1
          echo ""

          # =====================================================
          # 2. goal_setting.py
          # =====================================================
          echo "ğŸ“¦ [2/11] goal_setting.py"
          check_sync "lib/goal_setting.py" "chatwork-webhook/lib/goal_setting.py" || ERRORS_FOUND=1
          echo ""

          # =====================================================
          # 3. mvv_context.py
          # =====================================================
          echo "ğŸ“¦ [3/11] mvv_context.py"
          check_sync "lib/mvv_context.py" "chatwork-webhook/lib/mvv_context.py" || ERRORS_FOUND=1
          check_sync "lib/mvv_context.py" "report-generator/lib/mvv_context.py" || ERRORS_FOUND=1
          echo ""

          # =====================================================
          # 4. report_generator.py
          # =====================================================
          echo "ğŸ“¦ [4/11] report_generator.py"
          check_sync "lib/report_generator.py" "chatwork-webhook/lib/report_generator.py" || ERRORS_FOUND=1
          check_sync "lib/report_generator.py" "report-generator/lib/report_generator.py" || ERRORS_FOUND=1
          echo ""

          # =====================================================
          # 5. audit.py
          # =====================================================
          echo "ğŸ“¦ [5/11] audit.py"
          check_sync "lib/audit.py" "chatwork-webhook/lib/audit.py" || ERRORS_FOUND=1
          check_sync "lib/audit.py" "sync-chatwork-tasks/lib/audit.py" || ERRORS_FOUND=1
          check_sync "lib/audit.py" "pattern-detection/lib/audit.py" || ERRORS_FOUND=1
          echo ""

          # =====================================================
          # 6. memory/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          # =====================================================
          echo "ğŸ“¦ [6/11] memory/ directory"
          for file in lib/memory/*.py; do
            if [ -f "$file" ]; then
              basename=$(basename "$file")
              check_sync "$file" "chatwork-webhook/lib/memory/$basename" || ERRORS_FOUND=1
            fi
          done
          echo ""

          # =====================================================
          # 7. detection/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          # =====================================================
          echo "ğŸ“¦ [7/11] detection/ directory"
          for file in lib/detection/*.py; do
            if [ -f "$file" ]; then
              basename=$(basename "$file")
              check_sync "$file" "pattern-detection/lib/detection/$basename" || ERRORS_FOUND=1
            fi
          done
          echo ""

          # =====================================================
          # 8. business_day.py (v10.24.9è¿½åŠ )
          # =====================================================
          echo "ğŸ“¦ [8/11] business_day.py"
          check_sync "lib/business_day.py" "remind-tasks/lib/business_day.py" || ERRORS_FOUND=1
          check_sync "lib/business_day.py" "chatwork-webhook/lib/business_day.py" || ERRORS_FOUND=1
          echo ""

          # =====================================================
          # 9. brain/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (v10.53.0è¿½åŠ )ã€é‡è¦ã€‘
          # =====================================================
          # LLM Brainï¼ˆ25ç« ï¼‰ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæœŸãƒã‚§ãƒƒã‚¯
          # handler_wrappers.py ã¯æœ¬ç•ªå°‚ç”¨ãªã®ã§é™¤å¤–
          echo "ğŸ“¦ [9/11] brain/ directory (v10.53.0è¿½åŠ )"
          echo "   Checking chatwork-webhook/lib/brain/..."
          for file in lib/brain/*.py; do
            if [ -f "$file" ]; then
              basename=$(basename "$file")
              check_sync "$file" "chatwork-webhook/lib/brain/$basename" || ERRORS_FOUND=1
            fi
          done
          echo "   Checking proactive-monitor/lib/brain/..."
          for file in lib/brain/*.py; do
            if [ -f "$file" ]; then
              basename=$(basename "$file")
              check_sync "$file" "proactive-monitor/lib/brain/$basename" || ERRORS_FOUND=1
            fi
          done
          # ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚å†å¸°çš„ã«ãƒã‚§ãƒƒã‚¯
          echo "   Checking subdirectories..."
          for subdir in advanced_judgment agents deep_understanding execution_excellence learning_foundation memory_enhancement model_orchestrator outcome_learning self_awareness; do
            if [ -d "lib/brain/$subdir" ]; then
              for file in lib/brain/$subdir/*.py; do
                if [ -f "$file" ]; then
                  relpath="${file#lib/brain/}"
                  check_sync "$file" "chatwork-webhook/lib/brain/$relpath" || ERRORS_FOUND=1
                  check_sync "$file" "proactive-monitor/lib/brain/$relpath" || ERRORS_FOUND=1
                fi
              done
            fi
          done
          echo ""

          # =====================================================
          # 10. feature_flags.py (v10.53.0è¿½åŠ )
          # =====================================================
          echo "ğŸ“¦ [10/11] feature_flags.py"
          check_sync "lib/feature_flags.py" "chatwork-webhook/lib/feature_flags.py" || ERRORS_FOUND=1
          check_sync "lib/feature_flags.py" "proactive-monitor/lib/feature_flags.py" || ERRORS_FOUND=1
          check_sync "lib/feature_flags.py" "sync-chatwork-tasks/lib/feature_flags.py" || ERRORS_FOUND=1
          check_sync "lib/feature_flags.py" "remind-tasks/lib/feature_flags.py" || ERRORS_FOUND=1
          check_sync "lib/feature_flags.py" "watch-google-drive/lib/feature_flags.py" || ERRORS_FOUND=1
          check_sync "lib/feature_flags.py" "pattern-detection/lib/feature_flags.py" || ERRORS_FOUND=1
          echo ""

          # =====================================================
          # 11. ãã®ä»–ã®å…±é€šãƒ•ã‚¡ã‚¤ãƒ« (v10.53.0è¿½åŠ )
          # =====================================================
          echo "ğŸ“¦ [11/11] Other common files"
          check_sync "lib/config.py" "chatwork-webhook/lib/config.py" || ERRORS_FOUND=1
          check_sync "lib/db.py" "chatwork-webhook/lib/db.py" || ERRORS_FOUND=1
          check_sync "lib/secrets.py" "chatwork-webhook/lib/secrets.py" || ERRORS_FOUND=1
          echo ""

          # =====================================================
          # çµæœ
          # =====================================================
          if [ $ERRORS_FOUND -eq 1 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Some lib/ copies are OUT OF SYNC!"
            echo ""
            echo "To fix, run the sync script:"
            echo "  make sync"
            echo ""
            echo "Or manually copy files:"
            echo "  cp lib/<file>.py <target>/lib/<file>.py"
            echo ""
            echo "For directories:"
            echo "  rsync -av --exclude='__pycache__' lib/brain/ chatwork-webhook/lib/brain/"
            echo "  rsync -av --exclude='__pycache__' lib/brain/ proactive-monitor/lib/brain/"
            echo "  cp -r lib/memory/* chatwork-webhook/lib/memory/"
            echo "  cp -r lib/detection/* pattern-detection/lib/detection/"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All lib/ copies are in sync!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # =====================================================
  # 2. ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆv10.53.1è¿½åŠ ï¼‰
  # =====================================================
  #
  # èƒŒæ™¯:
  #   ç’°å¢ƒå¤‰æ•°åã®ä¸ä¸€è‡´ï¼ˆENABLE_LLM_BRAIN vs USE_BRAIN_ARCHITECTUREï¼‰ã§
  #   LLM BrainãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹å•é¡ŒãŒç™ºç”Ÿã—ãŸã€‚
  #   ã“ã®æ¤œè¨¼ã§å†ç™ºã‚’é˜²æ­¢ã™ã‚‹ã€‚
  #
  deploy-config-check:
    name: Check deploy configuration consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Validate deploy configuration
        run: |
          echo "ğŸ” Checking deploy configuration consistency..."
          echo ""

          # env_config.py ã‹ã‚‰æ­£ã—ã„ç’°å¢ƒå¤‰æ•°åã‚’å–å¾—
          ENV_CONFIG_FILE="lib/brain/env_config.py"

          if [ ! -f "$ENV_CONFIG_FILE" ]; then
            echo "âŒ $ENV_CONFIG_FILE not found"
            exit 1
          fi

          # ENV_BRAIN_ENABLED ã®å€¤ã‚’æŠ½å‡º
          EXPECTED_VAR=$(grep 'ENV_BRAIN_ENABLED = ' "$ENV_CONFIG_FILE" | sed 's/.*= "\(.*\)"/\1/')
          echo "Expected environment variable: $EXPECTED_VAR"
          echo ""

          ERRORS_FOUND=0

          # å„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          DEPLOY_FILES=(
            "cloudbuild.yaml"
            "cloudbuild-proactive-monitor.yaml"
            "chatwork-webhook/deploy.sh"
            "proactive-monitor/deploy.sh"
          )

          for file in "${DEPLOY_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Checking $file..."

              # æ­£ã—ã„å¤‰æ•°åãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
              if grep -q "$EXPECTED_VAR=true" "$file"; then
                echo "  âœ… $EXPECTED_VAR=true found"
              else
                echo "  âŒ $EXPECTED_VAR=true NOT found"
                ERRORS_FOUND=1
              fi

              # é–“é•ã£ãŸå¤‰æ•°åãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹
              for wrong_var in "ENABLE_LLM_BRAIN" "LLM_BRAIN_ENABLED" "BRAIN_ENABLED"; do
                if grep -q "$wrong_var" "$file"; then
                  echo "  âŒ Wrong variable name '$wrong_var' found"
                  ERRORS_FOUND=1
                fi
              done

              # èªè¨¼è¨­å®šï¼ˆ--no-allow-unauthenticated ãŒãªã„ã“ã¨ï¼‰
              if grep -q "\-\-no-allow-unauthenticated" "$file"; then
                echo "  âŒ --no-allow-unauthenticated found (causes auth errors)"
                ERRORS_FOUND=1
              fi
            fi
          done

          # feature_flags.py ã‚‚ãƒã‚§ãƒƒã‚¯ï¼ˆé–“é•ã£ãŸå¤‰æ•°åã‚’å‚ç…§ã—ã¦ã„ãªã„ã‹ï¼‰
          echo ""
          echo "Checking lib/feature_flags.py..."
          FF_FILE="lib/feature_flags.py"
          if [ -f "$FF_FILE" ]; then
            # enable_llm_brain ã®è¨­å®šã§ USE_BRAIN_ARCHITECTURE ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
            # ï¼ˆã‚³ãƒ¼ãƒ‰ãŒè¤‡æ•°è¡Œã«ã‚ãŸã‚‹å ´åˆã‚‚è€ƒæ…®ï¼‰
            if grep -A1 "self.enable_llm_brain" "$FF_FILE" | grep -q "\"$EXPECTED_VAR\""; then
              echo "  âœ… enable_llm_brain uses $EXPECTED_VAR"
            else
              echo "  âŒ enable_llm_brain does not use $EXPECTED_VAR"
              ERRORS_FOUND=1
            fi
            # ENABLE_LLM_BRAIN ãŒä½¿ã‚ã‚Œã¦ã„ãªã„ã‹ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ/ã‚³ãƒ¡ãƒ³ãƒˆä»¥å¤–ã§ï¼‰
            # é™¤å¤–: ã‚³ãƒ¡ãƒ³ãƒˆè¡Œï¼ˆ#ã§å§‹ã¾ã‚‹ï¼‰ã€docstringå†…ã€æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«å†…ã®èª¬æ˜
            if grep "ENABLE_LLM_BRAIN" "$FF_FILE" | grep -v "^#" | grep -v "# " | grep "_get_env_bool" | grep -q .; then
              echo "  âŒ Uses wrong variable name 'ENABLE_LLM_BRAIN' in _get_env_bool"
              ERRORS_FOUND=1
            fi
          fi

          echo ""
          if [ $ERRORS_FOUND -eq 1 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Deploy configuration errors found!"
            echo ""
            echo "Fix:"
            echo "  1. Use '$EXPECTED_VAR' (not ENABLE_LLM_BRAIN)"
            echo "  2. Use --allow-unauthenticated (not --no-allow-unauthenticated)"
            echo "  3. feature_flags.py must use '$EXPECTED_VAR' for enable_llm_brain"
            echo ""
            echo "Reference: lib/brain/env_config.py is the Single Source of Truth"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi

          echo "âœ… All deploy configurations are consistent!"

  # =====================================================
  # 3. ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡ºï¼ˆç›´æ¥åˆ‡ã‚Šè©°ã‚é˜²æ­¢ï¼‰
  # =====================================================
  #
  # æ¤œå‡ºå¯¾è±¡: ã‚¿ã‚¹ã‚¯è¡¨ç¤ºç”¨ã®ç›´æ¥åˆ‡ã‚Šè©°ã‚ï¼ˆ[:30], [:40]å½¢å¼ï¼‰
  # æ¤œå‡ºå¯¾è±¡å¤–:
  #   - ãƒ­ã‚°å‡ºåŠ›ç”¨ï¼ˆ[:500]ãªã©å¤§ããªæ•°å­—ï¼‰
  #   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆstr(e)[:50]ï¼‰
  #   - summary_previewï¼ˆãƒ­ã‚°å‡ºåŠ›ç”¨ï¼‰
  #   - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°å†…ã®å®šç¾©
  #
  # v10.53.1: ç•ªå·ã‚’2â†’3ã«å¤‰æ›´ï¼ˆdeploy-config-checkè¿½åŠ ã®ãŸã‚ï¼‰
  #
  forbidden-patterns-check:
    name: Check for forbidden patterns
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Check for direct truncation patterns
        run: |
          echo "ğŸ” Checking for forbidden truncation patterns..."
          echo "   (Checking for task display truncation, not log output)"

          # æ¤œå‡ºå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
          TARGET_FILES=(
            "remind-tasks/main.py"
            "sync-chatwork-tasks/main.py"
          )

          # =====================================================
          # ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆv10.17.1å¼·åŒ–ï¼‰
          # =====================================================
          # æ¤œå‡ºå¯¾è±¡:
          #   - body[:30], body[:40] + "..." å½¢å¼
          #   - task["body"][:30] + "..." å½¢å¼
          #   - task_body[:30] + "..." å½¢å¼
          #   - clean_task_name[:30] + "..." å½¢å¼
          #   - clean_body[:40] + "..." å½¢å¼
          #
          # é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³:
          #   - summary[:30]ï¼ˆãƒ­ã‚°å‡ºåŠ›ç”¨ãªã®ã§OKï¼‰
          #   - summary_previewï¼ˆãƒ­ã‚°å‡ºåŠ›ç”¨ãªã®ã§OKï¼‰
          #   - current_summary[:50]ï¼ˆãƒ­ã‚°/ç›£æŸ»ç”¨ãªã®ã§OKï¼‰
          #   - text[:max_length]ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°å†…ãªã®ã§OKï¼‰
          # =====================================================

          ERRORS_FOUND=0

          for file in "${TARGET_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Checking $file..."

              # ãƒ‘ã‚¿ãƒ¼ãƒ³1: body[:30] + "..." å½¢å¼ï¼ˆå¤‰æ•°åãŒbodyã§å§‹ã¾ã‚‹ï¼‰
              # ãŸã ã—ã€"summary" ã‚’å«ã‚€è¡Œã¯é™¤å¤–
              if grep -n 'body\[:3[0-9]\].*\.\.\.' "$file" | grep -v "summary" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous body truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³2: task["body"][:30] + "..." å½¢å¼
              if grep -n 'task\["body"\]\[:3[0-9]\].*\.\.\.' "$file" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous task[\"body\"] truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³3: task_info["body"][:30] + "..." å½¢å¼
              if grep -n 'task_info\["body"\]\[:3[0-9]\].*\.\.\.' "$file" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous task_info[\"body\"] truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³4: task_body[:30] ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆf-stringå†…ï¼‰
              if grep -n 'task_body\[:3[0-9]\]' "$file" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous task_body truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³5: clean_task_name[:30] + "..." å½¢å¼
              if grep -n 'clean_task_name\[:3[0-9]\].*\.\.\.' "$file" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous clean_task_name truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³6: clean_body[:4x] + "..." å½¢å¼ï¼ˆå…ƒã€…ã®ãƒã‚§ãƒƒã‚¯ï¼‰
              if grep -n 'clean_body\[:4[0-9]\].*\.\.\.' "$file" > /tmp/matches.txt 2>/dev/null; then
                if [ -s /tmp/matches.txt ]; then
                  echo "âŒ Found dangerous clean_body truncation pattern in $file:"
                  cat /tmp/matches.txt
                  ERRORS_FOUND=1
                fi
              fi
            fi
          done

          if [ $ERRORS_FOUND -eq 1 ]; then
            echo ""
            echo "âŒ Forbidden patterns found!"
            echo "   Use prepare_task_display_text() instead of direct truncation."
            exit 1
          fi

          echo "âœ… No forbidden truncation patterns found!"

      - name: Check for debug print statements
        run: |
          echo "ğŸ” Checking for debug print statements..."
          echo "   (Debug prints should not be committed to production code)"
          echo ""

          # æ¤œå‡ºå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå…¨main.pyãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
          TARGET_FILES=(
            "main.py"
            "chatwork-webhook/main.py"
            "sync-chatwork-tasks/main.py"
            "remind-tasks/main.py"
            "check-reply-messages/main.py"
            "cleanup-old-data/main.py"
            "pattern-detection/main.py"
          )

          ERRORS_FOUND=0

          for file in "${TARGET_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Checking $file..."

              # ãƒ‘ã‚¿ãƒ¼ãƒ³1: ğŸ” DEBUG: ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ˜ã‚‰ã‹ãªãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
              if grep -n 'ğŸ” DEBUG:' "$file" > /tmp/debug_matches.txt 2>/dev/null; then
                if [ -s /tmp/debug_matches.txt ]; then
                  echo "âŒ Found debug print in $file:"
                  cat /tmp/debug_matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³2: å—ä¿¡ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’ãƒ­ã‚°å‡ºåŠ›ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼‰
              if grep -n 'å—ä¿¡ãƒ‡ãƒ¼ã‚¿å…¨ä½“' "$file" > /tmp/debug_matches.txt 2>/dev/null; then
                if [ -s /tmp/debug_matches.txt ]; then
                  echo "âŒ Found full request data logging in $file:"
                  cat /tmp/debug_matches.txt
                  ERRORS_FOUND=1
                fi
              fi

              # ãƒ‘ã‚¿ãƒ¼ãƒ³3: json.dumps(data) ã‚’ãã®ã¾ã¾printï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼‰
              if grep -n 'print.*json\.dumps(data' "$file" > /tmp/debug_matches.txt 2>/dev/null; then
                if [ -s /tmp/debug_matches.txt ]; then
                  echo "âŒ Found raw data dump in $file:"
                  cat /tmp/debug_matches.txt
                  ERRORS_FOUND=1
                fi
              fi
            fi
          done

          if [ $ERRORS_FOUND -eq 1 ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Debug print statements found!"
            echo ""
            echo "These patterns are forbidden in production code:"
            echo "  - print(f\"ğŸ” DEBUG: ...\") - Use logging instead"
            echo "  - print(f\"ğŸ” å—ä¿¡ãƒ‡ãƒ¼ã‚¿å…¨ä½“: ...\") - Security risk"
            echo "  - print(json.dumps(data)) - Security risk"
            echo ""
            echo "Remove these debug statements before merging."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi

          echo "âœ… No debug print statements found!"

  # =====================================================
  # 4. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # =====================================================
  unit-tests:
    name: Run unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run text_utils tests
        run: |
          echo "ğŸ§ª Running lib/text_utils.py unit tests..."
          # ãƒ†ã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰å®Ÿè¡Œï¼ˆlib/ã¸ã®ãƒ‘ã‚¹ã‚’è§£æ±ºï¼‰
          cd $GITHUB_WORKSPACE
          PYTHONPATH=$GITHUB_WORKSPACE python -m pytest tests/test_text_utils_lib.py -v --tb=short --ignore-glob='**/embedding.py'
          echo "âœ… All tests passed!"

  # =====================================================
  # 5. å‹ãƒã‚§ãƒƒã‚¯ï¼ˆmypyï¼‰
  # =====================================================
  #
  # å¯¾è±¡: lib/brain/ ã®ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«
  # ç›®çš„: å‹ã®ä¸æ•´åˆã«ã‚ˆã‚‹æœ¬ç•ªéšœå®³ã‚’é˜²æ­¢
  #
  # =====================================================
  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy types-requests

      - name: Run mypy on lib/brain/
        run: |
          echo "ğŸ” Running mypy type check on lib/brain/..."
          echo ""

          # Phase 1: models.pyã¨type_safety.pyã®ã¿ã‚’å³æ ¼ãƒã‚§ãƒƒã‚¯
          # --follow-imports=skip ã§ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
          mypy lib/brain/models.py lib/brain/type_safety.py \
            --ignore-missing-imports \
            --follow-imports=skip \
            --no-error-summary \
            --show-error-codes \
            || {
              echo ""
              echo "âŒ Type errors found in lib/brain/models.py or type_safety.py"
              echo "Please fix type annotations before merging."
              exit 1
            }

          echo ""
          echo "âœ… Type check passed (models.py, type_safety.py)"
          echo ""
          echo "ğŸ“‹ Note: Other files in lib/brain/ will be checked in future phases."

  # =====================================================
  # æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  # =====================================================
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lib-sync-check, deploy-config-check, forbidden-patterns-check, unit-tests, type-check]
    steps:
      - name: All checks passed
        run: |
          echo "âœ… All quality checks passed!"
          echo ""
          echo "Checks completed:"
          echo "  - lib/ copies sync check (7 modules, 20+ targets)"
          echo "  - Deploy configuration consistency check"
          echo "  - Forbidden patterns check (truncation + debug prints)"
          echo "  - Unit tests"
          echo "  - Type check (mypy on lib/brain/)"
